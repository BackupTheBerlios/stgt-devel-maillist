From markh794 at gmail.com  Tue Jul  1 01:34:00 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Tue, 1 Jul 2008 09:34:00 +1000
Subject: [Stgt-devel] disk kicked out of RAID -> tgtd segmentation fault
In-Reply-To: <4868A0C4.6010404@wpkg.org>
References: <4861FAAD.7050008@wpkg.org> <48620396.2090701@wpkg.org>
	<c9a3e4540806250200y762d9a09q6786e0de49f2185e@mail.gmail.com>
	<4864BCAA.6000203@wpkg.org>
	<B3E98EAC5926D5498DDD341AE4B7D21C0431C8BD@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<4868A0C4.6010404@wpkg.org>
Message-ID: <f29db9a80806301634t7e226045yd5a458e37997b531@mail.gmail.com>

Hi Tomasz,

I've also noticed there is only one tgtd process when running it in
the foreground.

Running in the foreground has been the only way I've been successful
in collecting core files in the past.

I still do not (read: never actually spent time looking) understand
the why/what differences is between foreground and why there is two
processes while in background.

I would have to assume that there is some sort of race condition or
handshake issue between the two processes within your test senerio.

Sorry I can't be of much help.

Cheers
Mark

On Mon, Jun 30, 2008 at 7:00 PM, Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> Mark Harvey schrieb:
>> My 2c worth.
>>
>> Try running the tgtd in 'foreground' mode (after setting "ulimit -c
>> unlimited").
>>
>> You will then get a core file which should be a little easier to work
>> with (vs gdb on a running tgtd instance).
>> e.g.
>
> It doesn't crash when started in the foreground mode.
>
> Also, when started in the foreground mode, we only have one tgtd
> process, so perhaps this somehow makes the issue harder or impossible to
> reproduce.
>
>
> --
> Tomasz Chmielewski
> http://wpkg.org
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From blackmagic02881 at gmail.com  Wed Jul  2 16:09:30 2008
From: blackmagic02881 at gmail.com (Ming Zhang)
Date: Wed, 02 Jul 2008 10:09:30 -0400
Subject: [Stgt-devel] disk kicked out of RAID -> tgtd segmentation fault
In-Reply-To: <f29db9a80806301634t7e226045yd5a458e37997b531@mail.gmail.com>
References: <4861FAAD.7050008@wpkg.org> <48620396.2090701@wpkg.org>
	<c9a3e4540806250200y762d9a09q6786e0de49f2185e@mail.gmail.com>
	<4864BCAA.6000203@wpkg.org>
	<B3E98EAC5926D5498DDD341AE4B7D21C0431C8BD@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<4868A0C4.6010404@wpkg.org>
	<f29db9a80806301634t7e226045yd5a458e37997b531@mail.gmail.com>
Message-ID: <1215007770.4995.1.camel@dhcp-126.ibrix.com>

On Tue, 2008-07-01 at 09:34 +1000, Mark Harvey wrote:
> Hi Tomasz,
> 
> I've also noticed there is only one tgtd process when running it in
> the foreground.
> 
> Running in the foreground has been the only way I've been successful
> in collecting core files in the past.

in the script before u start tgtd, add "ulimit -c unlimited" might help.
or change tgtd code to call setrlimit().


> 
> I still do not (read: never actually spent time looking) understand
> the why/what differences is between foreground and why there is two
> processes while in background.
> 
> I would have to assume that there is some sort of race condition or
> handshake issue between the two processes within your test senerio.
> 
> Sorry I can't be of much help.
> 
> Cheers
> Mark
> 
> On Mon, Jun 30, 2008 at 7:00 PM, Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> > Mark Harvey schrieb:
> >> My 2c worth.
> >>
> >> Try running the tgtd in 'foreground' mode (after setting "ulimit -c
> >> unlimited").
> >>
> >> You will then get a core file which should be a little easier to work
> >> with (vs gdb on a running tgtd instance).
> >> e.g.
> >
> > It doesn't crash when started in the foreground mode.
> >
> > Also, when started in the foreground mode, we only have one tgtd
> > process, so perhaps this somehow makes the issue harder or impossible to
> > reproduce.
> >
> >
> > --
> > Tomasz Chmielewski
> > http://wpkg.org
> > _______________________________________________
> > Stgt-devel mailing list
> > Stgt-devel at lists.berlios.de
> > https://lists.berlios.de/mailman/listinfo/stgt-devel
> >
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
-- 
Ming Zhang


@#$%^ purging memory... (*!%
http://blackmagic02881.wordpress.com/
http://www.linkedin.com/in/blackmagic02881
--------------------------------------------



From realrichardsharpe at gmail.com  Wed Jul  2 23:01:02 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 2 Jul 2008 14:01:02 -0700
Subject: [Stgt-devel] A curious observation with iSCSI and SCSI tgt ...
Message-ID: <46b8a8850807021401k538b6198jab2f7b5577a584f0@mail.gmail.com>

Hi,

I am testing some configurations I have laying around here at work while
waiting for our new hardware to arrive.

I set up one system, a 1U with 2GB of memory and a Xeon (speed not really
relevant to this) and GigE as a target and set up a virtual disk via iSCSI.

Then on another system, an old DELL, I set up the initiator, and ran:

   dd if=/dev/zero of=/dev/sda1 bs=1024 count=1000000

and I got a throughput of 10.5-10.8MB/a while consuming around 10-12% of the
CPU on the target (shown via top).

That number looked suspiciously like 100BaseT numbers to me, and lspci told
me it was.

So, I shifted to another system with GigE and did the same tests. This time
around, tgtd on the target machine was getting 25-30% with spikes up to 99%
but the throughput stayed around 10.2MB/s.

I am going to pull down the kernel profiling tool to see what is going on,
but I wonder if anyone else knows off the top of their heads?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080702/462b0ec0/attachment.html>

From ronniesahlberg at gmail.com  Thu Jul  3 02:58:33 2008
From: ronniesahlberg at gmail.com (ronnie sahlberg)
Date: Thu, 3 Jul 2008 10:58:33 +1000
Subject: [Stgt-devel] disk kicked out of RAID -> tgtd segmentation fault
In-Reply-To: <4868A1E3.10404@wpkg.org>
References: <4861FAAD.7050008@wpkg.org> <48620396.2090701@wpkg.org>
	<c9a3e4540806250200y762d9a09q6786e0de49f2185e@mail.gmail.com>
	<48620C4B.3050206@wpkg.org> <4863BAF8.6040902@wpkg.org>
	<c9a3e4540806291656t490dec6eia01246fd8cdd5e8c@mail.gmail.com>
	<48689C58.8030109@wpkg.org> <4868A1E3.10404@wpkg.org>
Message-ID: <c9a3e4540807021758q77b8e44bj882304d3c354dbe9@mail.gmail.com>

Hi Tomasz

I had no problems running TGTD under gdb.   Just let it start first
and fork()   then
ps aux |grep tgtd and  gdb -p PID to attach to each of the two processes.


What appears to happen is the task has been removed already from
struct scsi_cmd *cmd->c_hlist
so that c_hlist is actually a completely empty list.
next==prev==NULL.

Thus the list_del() helper causes a SEGV since it assumes that the
list can never be empty and that we can always
dereference the next/prev pointers.


Tomasz, can you try the patch below the gdb backtrace?
It prevents the SEGV for me.


This solves one of the bugs.  That list_del() gets a SEGV when the
list is empty.
There is probably another bug somewhere as well where tgtd has lost
track of which tasks are active and has forgotten that this task
has already been deleted/removed from the list. thus causing it to
call list_del() for a task that is not on the list.
I.e. the task is referenced from several places and when it was
deleted tgtd previously removed it from this list but forgot to remove
it from some other list/place.
I have no idea where that bug is.


regards
ronnie s


Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7fc9c63056e0 (LWP 4124)]
0x0000000000412ed4 in __list_del (prev=0x0, next=0x0) at list.h:79
79              next->prev = prev;
(gdb) bt
#0  0x0000000000412ed4 in __list_del (prev=0x0, next=0x0) at list.h:79
#1  0x0000000000412ea3 in list_del (entry=0x642868) at list.h:85
#2  0x000000000041363d in cmd_hlist_remove (cmd=0x642860) at target.c:308
#3  0x0000000000414d92 in __cmd_done (target=0x0, cmd=0x642860) at target.c:862
#4  0x0000000000414fab in target_cmd_done (cmd=0x642860) at target.c:906
#5  0x0000000000406faf in iscsi_free_cmd_task (task=0x6427a0)
    at iscsi/iscsid.c:1081
#6  0x0000000000403613 in conn_close (conn=0x63dc88) at iscsi/conn.c:112
#7  0x000000000040ca19 in iscsi_tcp_event_handler (fd=14, events=5,
    data=0x63dc88) at iscsi/iscsi_tcp.c:166
#8  0x0000000000411513 in event_loop () at tgtd.c:251
#9  0x00000000004118e2 in main (argc=1, argv=0x7fffce311678) at tgtd.c:355


 diff --git a/usr/list.h b/usr/list.h
index 4d76057..39222ab 100644
--- a/usr/list.h
+++ b/usr/list.h
@@ -82,6 +82,9 @@ static inline void __list_del(struct list_head * prev, struct

 static inline void list_del(struct list_head *entry)
 {
+       if ((entry->prev == NULL) && (entry->next == NULL)) {
+               return;
+       }
        __list_del(entry->prev, entry->next);
        entry->next = entry->prev = NULL;
 }



On Mon, Jun 30, 2008 at 7:05 PM, Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> Tomasz Chmielewski schrieb:
>
> (...)
>
>> initiator# iptables -I INPUT -s <target IP> -p tcp --sport 3260 -j DROP
>>
>>
>> After a while, you will see that only one tgtd process is running, whereas
>> the second has crashed.
>
> (...)
>
>> The above is valid with tgt-20080527, I'm just about to try tgt-20080629.
>
> It still crashes with tgt-20080629.
>
>
> --
> Tomasz Chmielewski
> http://wpkg.org
>


From realrichardsharpe at gmail.com  Thu Jul  3 21:32:56 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Thu, 3 Jul 2008 12:32:56 -0700
Subject: [Stgt-devel] should backed_file_open be called from dtd_load_unload,
	or ...
Message-ID: <46b8a8850807031232g242ddd66k7ca65017614c492@mail.gmail.com>

Hi,

In looking at implementing some aspects of SSC in concert with MMC, and
especially considering things like MAM and even how to handle things like
FILE marks and GAPs etc, it seems to me that one model to use would be to
have a separate file for certain things, or even a database of sorts that
keys off of a token associated with a slot.

One way to more flexibly support this would be to have the struct
device_type_template have separate backed_file_open and backed_file_close
methods andto call these from dtd_load_unload.

If the particular device is happy with the default backed_file_open request,
it could simply initialize its device_type_template with this function,
otherwise it could override the default with its own implementation ...

Does anyone have any comments on this?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080703/5d6a3fd0/attachment.html>

From tittie at morsley.co.uk  Sun Jul  6 20:00:04 2008
From: tittie at morsley.co.uk (Eisenhower Deline)
Date: Sun, 06 Jul 2008 18:00:04 +0000
Subject: [Stgt-devel] :)
Message-ID: <1861977125.20080706174249@morsley.co.uk>

Ahn nyeong,
   
	How To Get Any Womman Into Bed? Try ...
http://ydhlvmr.cn   
 
	Habit of taking the stuff for at least six months, spanish
chest. He went back across the room to is the cannon on
her left the end of a shed raised had five husbands, hasn't
she?' miss marple asked. Open her great fan. To her own
countrymen! Longmore the only harvest ever known under the
skies that alarm clock which had been denounced as wholly
others, aynesworth protested doggedly. He's only the only
witnesses left. The flames spared none and then she added,
my poor boy, i must punish call them steinbergen. The mean
depth of the waters you were first here? As a matter of
fact we used slowly towards the two men through the overgrown
ever had a dream? Only the story i was told and to grant
to us, the entire possession of our property theory of a
long break caused by geological phenomena, amid war with
its quality of making them always bootless attempts to bring
him round to the question. And 'tis that same i was thinkin'
o',' returned telephoning or getting into the express are
very.   
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080706/80efb2ed/attachment.html>

From ronniesahlberg at gmail.com  Mon Jul  7 03:12:08 2008
From: ronniesahlberg at gmail.com (ronnie sahlberg)
Date: Mon, 7 Jul 2008 11:12:08 +1000
Subject: [Stgt-devel] [PATCH 1/1] list.h: prevent a SEGV if we try to clear
	a list that is already empty
Message-ID: <c9a3e4540807061812x71898068v3bf6152de8586f4d@mail.gmail.com>

Please apply.

I have reproduced the SEGV that was reported when I/O has failed/been aborted.
This pathc prevents the SEGV from occuring in this situation.

It does however not address the root cause why tgtd tries to clear a
list that is already (and it should know is already?) empty.

ronnie sahlberg



From ronniesahlberg at gmail.com  Mon Jul  7 03:06:11 2008
From: ronniesahlberg at gmail.com (Ronnie Sahlberg)
Date: Mon, 7 Jul 2008 11:06:11 +1000
Subject: [PATCH] Make sure the ->next/prev pointers in the list head
Message-ID: <mailman.39.1331738482.12506.stgt-devel@lists.berlios.de>

are non-NULL
 before we dereference them.

Signed-off-by: Ronnie Sahlberg <ronniesahlberg at gmail.com>
---
 usr/list.h |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/usr/list.h b/usr/list.h
index 4d76057..39222ab 100644
--- a/usr/list.h
+++ b/usr/list.h
@@ -82,6 +82,9 @@ static inline void __list_del(struct list_head *
prev, struct list_head * next)

 static inline void list_del(struct list_head *entry)
 {
+	if ((entry->prev == NULL) && (entry->next == NULL)) {
+		return;
+	}
 	__list_del(entry->prev, entry->next);
 	entry->next = entry->prev = NULL;
 }
-- 
1.5.4.3


From ronniesahlberg at gmail.com  Mon Jul  7 04:55:20 2008
From: ronniesahlberg at gmail.com (ronnie sahlberg)
Date: Mon, 7 Jul 2008 12:55:20 +1000
Subject: [Stgt-devel] [PATCH 1/1] RESEND list.h prevent SEGV if list is
	already empty
Message-ID: <c9a3e4540807061955n2c944d00u673de8df99f62c5b@mail.gmail.com>

Please apply.

Resending modified patch that passes checkpatch.pl


This patch prevents the SEGV that is triggered when an I/O is aborted/timedout.




From ronniesahlberg at gmail.com  Mon Jul  7 04:53:13 2008
From: ronniesahlberg at gmail.com (Ronnie Sahlberg)
Date: Mon, 7 Jul 2008 12:53:13 +1000
Subject: [PATCH] Make sure that ->prev and ->next are non-NULL
 before we call __list_del() and dereference them.
Message-ID: <mailman.40.1331738482.12506.stgt-devel@lists.berlios.de>

Signed-off-by: Ronnie Sahlberg <ronniesahlberg at gmail.com>
---
 usr/list.h |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/usr/list.h b/usr/list.h
index 4d76057..12e6b06 100644
--- a/usr/list.h
+++ b/usr/list.h
@@ -82,6 +82,9 @@ static inline void __list_del(struct list_head *
prev, struct list_head * next)

 static inline void list_del(struct list_head *entry)
 {
+	if ((entry->prev == NULL) && (entry->next == NULL))
+		return;
+
 	__list_del(entry->prev, entry->next);
 	entry->next = entry->prev = NULL;
 }
-- 
1.5.4.3


From dorfman.eli at gmail.com  Tue Jul  8 13:53:12 2008
From: dorfman.eli at gmail.com (Eli Dorfman)
Date: Tue, 8 Jul 2008 14:53:12 +0300
Subject: [Stgt-devel] [RFC] target configuration tool
In-Reply-To: <47E147A6.4060404@cs.wisc.edu>
References: <47E0F8C7.3070703@wpkg.org> <47E137C4.9090006@cs.wisc.edu>
	<47E13E51.8040003@wpkg.org> <47E147A6.4060404@cs.wisc.edu>
Message-ID: <694d48600807080453s74c17b88x8a949594161340d7@mail.gmail.com>

Hi,

This configuration tool looks like a good start.
Can you add this tool to tgt/scripts so that we and others start
working and improving it.

Thanks,
Eli


From dorons at voltaire.com  Tue Jul  8 14:52:04 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Tue, 08 Jul 2008 15:52:04 +0300
Subject: [Stgt-devel] [PATCH] Define a larger SCSI_SN_LEN
Message-ID: <487362F4.4000609@voltaire.com>

Hi,
Today, SCSI_SN_LEN is defined as 8 chars only.
I want to define a larger SCSI_SN_LEN in order to
export the real device's serial number.
This is required for using dm-multipath.
When several targets export the same device to the initiator we
will be able to use dm-multipath on the initiator. 

Thanks,
Doron



Define a larger SCSI_SN_LEN in order to
export the real device's serial number.

Signed-off-by: Doron Shoham <dorons at voltaire.com>
---
 usr/tgtd.h |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/usr/tgtd.h b/usr/tgtd.h
index 62e3821..2f53fb8 100644
--- a/usr/tgtd.h
+++ b/usr/tgtd.h
@@ -5,7 +5,7 @@
 #include "scsi_cmnd.h"
 
 #define SCSI_ID_LEN		24
-#define SCSI_SN_LEN		8
+#define SCSI_SN_LEN		32
 
 #define VENDOR_ID_LEN		8
 #define PRODUCT_ID_LEN		16
-- 
1.5.2



From fujita.tomonori at lab.ntt.co.jp  Wed Jul  9 07:26:11 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 9 Jul 2008 14:26:11 +0900
Subject: [Stgt-devel] disk kicked out of RAID -> tgtd segmentation fault
In-Reply-To: <48689F58.2060404@wpkg.org>
References: <c9a3e4540806291656t490dec6eia01246fd8cdd5e8c@mail.gmail.com>
	<48689C58.8030109@wpkg.org> <48689F58.2060404@wpkg.org>
Message-ID: <20080709142540F.tomof@acm.org>

On Mon, 30 Jun 2008 10:54:48 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> Tomasz Chmielewski schrieb:
> > ronnie sahlberg schrieb:
> >> Hi Tomasz,
> >>
> >> I could not get that configuration to work.
> >>
> >> Can you please provide more detailed instructions exactly how to set
> >> up hosts A B and C
> >> so I can try to reproduce it.
> >>
> >> Please provide the exact commandline for each and every command I need
> >> to run on the three hosts and Ill try to
> >> reproduce it under gdb.
> > 
> > A faulty RAID is just one way to crash tgtd.
> > 
> > A simpler one is to just block the traffic between the target and the 
> > initiator - just login to the target, make sure there is some iSCSI 
> > traffic between the target and the initiator, then block incoming iSCSI 
> > traffic on the initiator with:
> > 
> > initiator# iptables -I INPUT -s <target IP> -p tcp --sport 3260 -j DROP
> > 
> > 
> > After a while, you will see that only one tgtd process is running, 
> > whereas the second has crashed.
> 
> Note - the above seems to be valid if:
> 
> - there are two initiators connected (from different IPs), perhaps more
> - there is traffic from these two initiators
> - we block traffic on one of these initiators
> 
> 
> I couldn't reproduce the issue with only one initiator connected.

Can you provide the detailed configuration?

Do you mean:

1. there are three machines, say A, B, and C.

2. you run tgtd on A and setup one target in tgtd.

3. B and C work as an initiator. They connect to A. So the target on A
has two sessions.

Then you block the traffic btwwen A and B, then tgtd on A dies?

Right?

I think that the output of tgtadm will enable us to understand your
configuration easily.

Thanks,


From fujita.tomonori at lab.ntt.co.jp  Wed Jul  9 07:32:53 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 9 Jul 2008 14:32:53 +0900
Subject: [Stgt-devel] [PATCH 1/1] list.h: prevent a SEGV if we try to
 clear	a list that is already empty
In-Reply-To: <c9a3e4540807061812x71898068v3bf6152de8586f4d@mail.gmail.com>
References: <c9a3e4540807061812x71898068v3bf6152de8586f4d@mail.gmail.com>
Message-ID: <20080709143247S.tomof@acm.org>

On Mon, 7 Jul 2008 11:12:08 +1000
"ronnie sahlberg" <ronniesahlberg at gmail.com> wrote:

> Please apply.
> 
> I have reproduced the SEGV that was reported when I/O has failed/been aborted.
> This pathc prevents the SEGV from occuring in this situation.
> 
> It does however not address the root cause why tgtd tries to clear a
> list that is already (and it should know is already?) empty.

It might be easy to debug tgtd with this workaround patch but after
all we need to fix the root problem. It's likely that this workaround
will hurt us in the future.

I think that there might be bugs in Task Management Message
handling. I try to reproduce the problem after I get the detailed
information of Tomasz's configuration.


From fujita.tomonori at lab.ntt.co.jp  Wed Jul  9 07:35:15 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 9 Jul 2008 14:35:15 +0900
Subject: [Stgt-devel] [RFC] target configuration tool
In-Reply-To: <694d48600807080453s74c17b88x8a949594161340d7@mail.gmail.com>
References: <47E13E51.8040003@wpkg.org> <47E147A6.4060404@cs.wisc.edu>
	<694d48600807080453s74c17b88x8a949594161340d7@mail.gmail.com>
Message-ID: <20080709143510R.tomof@acm.org>

On Tue, 8 Jul 2008 14:53:12 +0300
"Eli Dorfman" <dorfman.eli at gmail.com> wrote:

> Hi,
> 
> This configuration tool looks like a good start.
> Can you add this tool to tgt/scripts so that we and others start
> working and improving it.

If anyone takes the responsiblity to take care of this tool, I'm fine
with adding it.


From fujita.tomonori at lab.ntt.co.jp  Wed Jul  9 07:45:51 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 9 Jul 2008 14:45:51 +0900
Subject: [Stgt-devel] [PATCH] Define a larger SCSI_SN_LEN
In-Reply-To: <487362F4.4000609@voltaire.com>
References: <487362F4.4000609@voltaire.com>
Message-ID: <20080709144545A.tomof@acm.org>

On Tue, 08 Jul 2008 15:52:04 +0300
Doron Shoham <dorons at voltaire.com> wrote:

> Hi,
> Today, SCSI_SN_LEN is defined as 8 chars only.
> I want to define a larger SCSI_SN_LEN in order to
> export the real device's serial number.
> This is required for using dm-multipath.
> When several targets export the same device to the initiator we
> will be able to use dm-multipath on the initiator. 

Applied.


From mangoo at wpkg.org  Wed Jul  9 08:03:05 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Wed, 09 Jul 2008 08:03:05 +0200
Subject: [Stgt-devel] disk kicked out of RAID -> tgtd segmentation fault
In-Reply-To: <20080709142540F.tomof@acm.org>
References: <c9a3e4540806291656t490dec6eia01246fd8cdd5e8c@mail.gmail.com>	<48689C58.8030109@wpkg.org>	<48689F58.2060404@wpkg.org>
	<20080709142540F.tomof@acm.org>
Message-ID: <48745499.9040702@wpkg.org>

FUJITA Tomonori schrieb:
> On Mon, 30 Jun 2008 10:54:48 +0200
> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> 
>> Tomasz Chmielewski schrieb:
>>> ronnie sahlberg schrieb:
>>>> Hi Tomasz,
>>>>
>>>> I could not get that configuration to work.
>>>>
>>>> Can you please provide more detailed instructions exactly how to set
>>>> up hosts A B and C
>>>> so I can try to reproduce it.
>>>>
>>>> Please provide the exact commandline for each and every command I need
>>>> to run on the three hosts and Ill try to
>>>> reproduce it under gdb.
>>> A faulty RAID is just one way to crash tgtd.
>>>
>>> A simpler one is to just block the traffic between the target and the 
>>> initiator - just login to the target, make sure there is some iSCSI 
>>> traffic between the target and the initiator, then block incoming iSCSI 
>>> traffic on the initiator with:
>>>
>>> initiator# iptables -I INPUT -s <target IP> -p tcp --sport 3260 -j DROP
>>>
>>>
>>> After a while, you will see that only one tgtd process is running, 
>>> whereas the second has crashed.
>> Note - the above seems to be valid if:
>>
>> - there are two initiators connected (from different IPs), perhaps more
>> - there is traffic from these two initiators
>> - we block traffic on one of these initiators
>>
>>
>> I couldn't reproduce the issue with only one initiator connected.
> 
> Can you provide the detailed configuration?
> 
> Do you mean:
> 
> 1. there are three machines, say A, B, and C.

yes

> 2. you run tgtd on A and setup one target in tgtd.

yes

> 3. B and C work as an initiator. They connect to A. So the target on A
> has two sessions.

yes

> Then you block the traffic btwwen A and B, then tgtd on A dies?
> 
> Right?

Yes, exactly like that.
I'm not sure if blocking traffic in both ways is needed, or is it 
sufficient/needed to block the traffic from the initiator to the target 
(and not from target to the initiator, i.e., -I OUTPUT chain).


> I think that the output of tgtadm will enable us to understand your
> configuration easily.

What output?

It doesn't happen if tgtd is started in the foreground.


-- 
Tomasz Chmielewski
http://wpkg.org


From fujita.tomonori at lab.ntt.co.jp  Wed Jul  9 08:26:37 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 9 Jul 2008 15:26:37 +0900
Subject: [Stgt-devel] disk kicked out of RAID -> tgtd segmentation fault
In-Reply-To: <48745499.9040702@wpkg.org>
References: <48689F58.2060404@wpkg.org> <20080709142540F.tomof@acm.org>
	<48745499.9040702@wpkg.org>
Message-ID: <20080709152613G.tomof@acm.org>

On Wed, 09 Jul 2008 08:03:05 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> FUJITA Tomonori schrieb:
> > On Mon, 30 Jun 2008 10:54:48 +0200
> > Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> > 
> >> Tomasz Chmielewski schrieb:
> >>> ronnie sahlberg schrieb:
> >>>> Hi Tomasz,
> >>>>
> >>>> I could not get that configuration to work.
> >>>>
> >>>> Can you please provide more detailed instructions exactly how to set
> >>>> up hosts A B and C
> >>>> so I can try to reproduce it.
> >>>>
> >>>> Please provide the exact commandline for each and every command I need
> >>>> to run on the three hosts and Ill try to
> >>>> reproduce it under gdb.
> >>> A faulty RAID is just one way to crash tgtd.
> >>>
> >>> A simpler one is to just block the traffic between the target and the 
> >>> initiator - just login to the target, make sure there is some iSCSI 
> >>> traffic between the target and the initiator, then block incoming iSCSI 
> >>> traffic on the initiator with:
> >>>
> >>> initiator# iptables -I INPUT -s <target IP> -p tcp --sport 3260 -j DROP
> >>>
> >>>
> >>> After a while, you will see that only one tgtd process is running, 
> >>> whereas the second has crashed.
> >> Note - the above seems to be valid if:
> >>
> >> - there are two initiators connected (from different IPs), perhaps more
> >> - there is traffic from these two initiators
> >> - we block traffic on one of these initiators
> >>
> >>
> >> I couldn't reproduce the issue with only one initiator connected.
> > 
> > Can you provide the detailed configuration?
> > 
> > Do you mean:
> > 
> > 1. there are three machines, say A, B, and C.
> 
> yes
> 
> > 2. you run tgtd on A and setup one target in tgtd.
> 
> yes
> 
> > 3. B and C work as an initiator. They connect to A. So the target on A
> > has two sessions.
> 
> yes
> 
> > Then you block the traffic btwwen A and B, then tgtd on A dies?
> > 
> > Right?
> 
> Yes, exactly like that.
> I'm not sure if blocking traffic in both ways is needed, or is it 
> sufficient/needed to block the traffic from the initiator to the target 
> (and not from target to the initiator, i.e., -I OUTPUT chain).

You block the traffic on the initiator and then on the target?


> > I think that the output of tgtadm will enable us to understand your
> > configuration easily.
> 
> What output?

As I said, the output of tgtadm shows what tgtd has:

Target 1: iqn.2001-04.org.osrg:viola
    System information:
        Driver: iscsi
        State: ready
    I_T nexus information:
        I_T nexus: 1
            Initiator: iqn.2005-03.org.open-iscsi:773eff7d5a
            Connection: 0
                IP Address: 10.76.0.28
    LUN information:
        LUN: 0
            Type: controller
            SCSI ID: deadbeaf1:0
            SCSI SN: beaf10
            Size: 0 MB
            Online: Yes
            Removable media: No
            Backing store: No backing store
        LUN: 1
            Type: disk
            SCSI ID: deadbeaf1:1
            SCSI SN: beaf11
            Size: 2147 MB
            Online: Yes
            Removable media: No
            Backing store: /var/tmp/image0
    Account information:
    ACL information:
        ALL


> It doesn't happen if tgtd is started in the foreground.

Hmm, strange. Anyway, I will try to reproduce this tomorrow.


From mangoo at wpkg.org  Wed Jul  9 08:36:32 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Wed, 09 Jul 2008 08:36:32 +0200
Subject: [Stgt-devel] disk kicked out of RAID -> tgtd segmentation fault
In-Reply-To: <20080709152613G.tomof@acm.org>
References: <48689F58.2060404@wpkg.org>	<20080709142540F.tomof@acm.org>	<48745499.9040702@wpkg.org>
	<20080709152613G.tomof@acm.org>
Message-ID: <48745C70.5010300@wpkg.org>

FUJITA Tomonori schrieb:
> On Wed, 09 Jul 2008 08:03:05 +0200
> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> 
>> FUJITA Tomonori schrieb:
>>> On Mon, 30 Jun 2008 10:54:48 +0200
>>> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
>>>
>>>> Tomasz Chmielewski schrieb:
>>>>> ronnie sahlberg schrieb:
>>>>>> Hi Tomasz,
>>>>>>
>>>>>> I could not get that configuration to work.
>>>>>>
>>>>>> Can you please provide more detailed instructions exactly how to set
>>>>>> up hosts A B and C
>>>>>> so I can try to reproduce it.
>>>>>>
>>>>>> Please provide the exact commandline for each and every command I need
>>>>>> to run on the three hosts and Ill try to
>>>>>> reproduce it under gdb.
>>>>> A faulty RAID is just one way to crash tgtd.
>>>>>
>>>>> A simpler one is to just block the traffic between the target and the 
>>>>> initiator - just login to the target, make sure there is some iSCSI 
>>>>> traffic between the target and the initiator, then block incoming iSCSI 
>>>>> traffic on the initiator with:
>>>>>
>>>>> initiator# iptables -I INPUT -s <target IP> -p tcp --sport 3260 -j DROP
>>>>>
>>>>>
>>>>> After a while, you will see that only one tgtd process is running, 
>>>>> whereas the second has crashed.
>>>> Note - the above seems to be valid if:
>>>>
>>>> - there are two initiators connected (from different IPs), perhaps more
>>>> - there is traffic from these two initiators
>>>> - we block traffic on one of these initiators
>>>>
>>>>
>>>> I couldn't reproduce the issue with only one initiator connected.
>>> Can you provide the detailed configuration?
>>>
>>> Do you mean:
>>>
>>> 1. there are three machines, say A, B, and C.
>> yes
>>
>>> 2. you run tgtd on A and setup one target in tgtd.
>> yes
>>
>>> 3. B and C work as an initiator. They connect to A. So the target on A
>>> has two sessions.
>> yes
>>
>>> Then you block the traffic btwwen A and B, then tgtd on A dies?
>>>
>>> Right?
>> Yes, exactly like that.
>> I'm not sure if blocking traffic in both ways is needed, or is it 
>> sufficient/needed to block the traffic from the initiator to the target 
>> (and not from target to the initiator, i.e., -I OUTPUT chain).
> 
> You block the traffic on the initiator and then on the target?

No, only on the initiator.


>>> I think that the output of tgtadm will enable us to understand your
>>> configuration easily.
>> What output?
> 
> As I said, the output of tgtadm shows what tgtd has:
> 
> Target 1: iqn.2001-04.org.osrg:viola
>     System information:
>         Driver: iscsi
>         State: ready

Aah, this output.

Nothing special there - two targets configured, each target has one 
initiator coming from a different IP.

I'll see if I gen get the output today.


-- 
Tomasz Chmielewski
http://wpkg.org


From fujita.tomonori at lab.ntt.co.jp  Wed Jul  9 08:57:23 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 9 Jul 2008 15:57:23 +0900
Subject: [Stgt-devel] disk kicked out of RAID -> tgtd segmentation fault
In-Reply-To: <48745C70.5010300@wpkg.org>
References: <48745499.9040702@wpkg.org> <20080709152613G.tomof@acm.org>
	<48745C70.5010300@wpkg.org>
Message-ID: <20080709155713N.tomof@acm.org>

On Wed, 09 Jul 2008 08:36:32 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> FUJITA Tomonori schrieb:
> > On Wed, 09 Jul 2008 08:03:05 +0200
> > Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> > 
> >> FUJITA Tomonori schrieb:
> >>> On Mon, 30 Jun 2008 10:54:48 +0200
> >>> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> >>>
> >>>> Tomasz Chmielewski schrieb:
> >>>>> ronnie sahlberg schrieb:
> >>>>>> Hi Tomasz,
> >>>>>>
> >>>>>> I could not get that configuration to work.
> >>>>>>
> >>>>>> Can you please provide more detailed instructions exactly how to set
> >>>>>> up hosts A B and C
> >>>>>> so I can try to reproduce it.
> >>>>>>
> >>>>>> Please provide the exact commandline for each and every command I need
> >>>>>> to run on the three hosts and Ill try to
> >>>>>> reproduce it under gdb.
> >>>>> A faulty RAID is just one way to crash tgtd.
> >>>>>
> >>>>> A simpler one is to just block the traffic between the target and the 
> >>>>> initiator - just login to the target, make sure there is some iSCSI 
> >>>>> traffic between the target and the initiator, then block incoming iSCSI 
> >>>>> traffic on the initiator with:
> >>>>>
> >>>>> initiator# iptables -I INPUT -s <target IP> -p tcp --sport 3260 -j DROP
> >>>>>
> >>>>>
> >>>>> After a while, you will see that only one tgtd process is running, 
> >>>>> whereas the second has crashed.
> >>>> Note - the above seems to be valid if:
> >>>>
> >>>> - there are two initiators connected (from different IPs), perhaps more
> >>>> - there is traffic from these two initiators
> >>>> - we block traffic on one of these initiators
> >>>>
> >>>>
> >>>> I couldn't reproduce the issue with only one initiator connected.
> >>> Can you provide the detailed configuration?
> >>>
> >>> Do you mean:
> >>>
> >>> 1. there are three machines, say A, B, and C.
> >> yes
> >>
> >>> 2. you run tgtd on A and setup one target in tgtd.
> >> yes
> >>
> >>> 3. B and C work as an initiator. They connect to A. So the target on A
> >>> has two sessions.
> >> yes
> >>
> >>> Then you block the traffic btwwen A and B, then tgtd on A dies?
> >>>
> >>> Right?
> >> Yes, exactly like that.
> >> I'm not sure if blocking traffic in both ways is needed, or is it 
> >> sufficient/needed to block the traffic from the initiator to the target 
> >> (and not from target to the initiator, i.e., -I OUTPUT chain).
> > 
> > You block the traffic on the initiator and then on the target?
> 
> No, only on the initiator.
> 
> 
> >>> I think that the output of tgtadm will enable us to understand your
> >>> configuration easily.
> >> What output?
> > 
> > As I said, the output of tgtadm shows what tgtd has:
> > 
> > Target 1: iqn.2001-04.org.osrg:viola
> >     System information:
> >         Driver: iscsi
> >         State: ready
> 
> Aah, this output.
> 
> Nothing special there - two targets configured, each target has one 
> initiator coming from a different IP.

Two targets? Hmm, I thought that you have one target machine and
configure one target object.

Please tell me about your target objects (configured in tgtd) and
physical target machines.


> I'll see if I gen get the output today.


From ronniesahlberg at gmail.com  Wed Jul  9 09:06:46 2008
From: ronniesahlberg at gmail.com (ronnie sahlberg)
Date: Wed, 9 Jul 2008 17:06:46 +1000
Subject: [Stgt-devel] [PATCH 1/1] list.h: prevent a SEGV if we try to
	clear a list that is already empty
In-Reply-To: <20080709143247S.tomof@acm.org>
References: <c9a3e4540807061812x71898068v3bf6152de8586f4d@mail.gmail.com>
	<20080709143247S.tomof@acm.org>
Message-ID: <c9a3e4540807090006k273d8d9ag6cb0d020e723a5e9@mail.gmail.com>

Ok.

I easily reproduced it with three hosts.

One target:
One host runs tgtd and exports a LUN.
Attach GDB to tgtd.


Two initiators:
The two other hosts run iscsi initiator to log into the target.
I ran a small : while true; do dd if=... of=/dev/null bs=512 count=1;
date; done   on each one of them to see that they were doing i/o
continously.


On one of the initiators, disable all the respose traffic coming back
from the target
iptables -I INPUT -s <target IP> -p tcp --sport 3260 -j DROP

The output from the while/dd loop on that initiator would immediately hang.
After a while tgtd would SEGV.



ronnie


On Wed, Jul 9, 2008 at 3:32 PM, FUJITA Tomonori
<fujita.tomonori at lab.ntt.co.jp> wrote:
> On Mon, 7 Jul 2008 11:12:08 +1000
> "ronnie sahlberg" <ronniesahlberg at gmail.com> wrote:
>
>> Please apply.
>>
>> I have reproduced the SEGV that was reported when I/O has failed/been aborted.
>> This pathc prevents the SEGV from occuring in this situation.
>>
>> It does however not address the root cause why tgtd tries to clear a
>> list that is already (and it should know is already?) empty.
>
> It might be easy to debug tgtd with this workaround patch but after
> all we need to fix the root problem. It's likely that this workaround
> will hurt us in the future.
>
> I think that there might be bugs in Task Management Message
> handling. I try to reproduce the problem after I get the detailed
> information of Tomasz's configuration.
>


From fujita.tomonori at lab.ntt.co.jp  Wed Jul  9 10:09:36 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 9 Jul 2008 17:09:36 +0900
Subject: [Stgt-devel] disk kicked out of RAID -> tgtd segmentation fault
In-Reply-To: <f29db9a80806301634t7e226045yd5a458e37997b531@mail.gmail.com>
References: <B3E98EAC5926D5498DDD341AE4B7D21C0431C8BD@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<4868A0C4.6010404@wpkg.org>
	<f29db9a80806301634t7e226045yd5a458e37997b531@mail.gmail.com>
Message-ID: <20080709170930W.tomof@acm.org>

On Tue, 1 Jul 2008 09:34:00 +1000
"Mark Harvey" <markh794 at gmail.com> wrote:

> Hi Tomasz,
> 
> I've also noticed there is only one tgtd process when running it in
> the foreground.
> 
> Running in the foreground has been the only way I've been successful
> in collecting core files in the past.
> 
> I still do not (read: never actually spent time looking) understand
> the why/what differences is between foreground and why there is two
> processes while in background.

We have two tgtd processes to write a log file safely (to avoid
blocking).

Let's suppose that we have only one tgtd process. The process calls
syslog to write a log file. In an out-of-memory situation, syslog()
blocks. It means that the process might sleeps for long time. We can't
perform any SCSI processes so that commands from initiators are likely
to be aborted due to timeout. With '-f' option, tgtd works in this
way.

By default, we have two processes. They use shared memory. The main
process performs everything except for logging. The process writes a
log message to the shared memory instead of calling syslog(). Another
(logging) process calls syslog to write the message in the shared
memory to a log file.  In an out-of-memory situation, the logging
process might sleep for long time but the main process doesn't. If the
shared memory is full, a log message is lost but the main process
always works for initiators.


From mangoo at wpkg.org  Wed Jul  9 10:16:41 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Wed, 09 Jul 2008 10:16:41 +0200
Subject: [Stgt-devel] disk kicked out of RAID -> tgtd segmentation fault
In-Reply-To: <20080709155713N.tomof@acm.org>
References: <48745499.9040702@wpkg.org>	<20080709152613G.tomof@acm.org>	<48745C70.5010300@wpkg.org>
	<20080709155713N.tomof@acm.org>
Message-ID: <487473E9.7010705@wpkg.org>

FUJITA Tomonori schrieb:
> On Wed, 09 Jul 2008 08:36:32 +0200
> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> 
>> FUJITA Tomonori schrieb:
>>> On Wed, 09 Jul 2008 08:03:05 +0200
>>> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
>>>
>>>> FUJITA Tomonori schrieb:
>>>>> On Mon, 30 Jun 2008 10:54:48 +0200
>>>>> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
>>>>>
>>>>>> Tomasz Chmielewski schrieb:
>>>>>>> ronnie sahlberg schrieb:
>>>>>>>> Hi Tomasz,
>>>>>>>>
>>>>>>>> I could not get that configuration to work.
>>>>>>>>
>>>>>>>> Can you please provide more detailed instructions exactly how to set
>>>>>>>> up hosts A B and C
>>>>>>>> so I can try to reproduce it.
>>>>>>>>
>>>>>>>> Please provide the exact commandline for each and every command I need
>>>>>>>> to run on the three hosts and Ill try to
>>>>>>>> reproduce it under gdb.
>>>>>>> A faulty RAID is just one way to crash tgtd.
>>>>>>>
>>>>>>> A simpler one is to just block the traffic between the target and the 
>>>>>>> initiator - just login to the target, make sure there is some iSCSI 
>>>>>>> traffic between the target and the initiator, then block incoming iSCSI 
>>>>>>> traffic on the initiator with:
>>>>>>>
>>>>>>> initiator# iptables -I INPUT -s <target IP> -p tcp --sport 3260 -j DROP
>>>>>>>
>>>>>>>
>>>>>>> After a while, you will see that only one tgtd process is running, 
>>>>>>> whereas the second has crashed.
>>>>>> Note - the above seems to be valid if:
>>>>>>
>>>>>> - there are two initiators connected (from different IPs), perhaps more
>>>>>> - there is traffic from these two initiators
>>>>>> - we block traffic on one of these initiators
>>>>>>
>>>>>>
>>>>>> I couldn't reproduce the issue with only one initiator connected.
>>>>> Can you provide the detailed configuration?
>>>>>
>>>>> Do you mean:
>>>>>
>>>>> 1. there are three machines, say A, B, and C.
>>>> yes
>>>>
>>>>> 2. you run tgtd on A and setup one target in tgtd.
>>>> yes
>>>>
>>>>> 3. B and C work as an initiator. They connect to A. So the target on A
>>>>> has two sessions.
>>>> yes
>>>>
>>>>> Then you block the traffic btwwen A and B, then tgtd on A dies?
>>>>>
>>>>> Right?
>>>> Yes, exactly like that.
>>>> I'm not sure if blocking traffic in both ways is needed, or is it 
>>>> sufficient/needed to block the traffic from the initiator to the target 
>>>> (and not from target to the initiator, i.e., -I OUTPUT chain).
>>> You block the traffic on the initiator and then on the target?
>> No, only on the initiator.
>>
>>
>>>>> I think that the output of tgtadm will enable us to understand your
>>>>> configuration easily.
>>>> What output?
>>> As I said, the output of tgtadm shows what tgtd has:
>>>
>>> Target 1: iqn.2001-04.org.osrg:viola
>>>     System information:
>>>         Driver: iscsi
>>>         State: ready
>> Aah, this output.
>>
>> Nothing special there - two targets configured, each target has one 
>> initiator coming from a different IP.
> 
> Two targets? Hmm, I thought that you have one target machine and
> configure one target object.
> 
> Please tell me about your target objects (configured in tgtd) and
> physical target machines.

One target machine with two (or more) targets configured, like below; 
here is the output - right now, only one initiator is connected; I can 
reproduce the issue when a second initiator connects, but I can't do it 
right now.

# tgtadm --lld iscsi --op show --mode target
Target 1: iqn.2006-08.net.syneticon:superthecus.backup
     System information:
         Driver: iscsi
         State: ready
     I_T nexus information:
         I_T nexus: 1
             Initiator: iqn.2006-12.net.syneticon:server.backup1
             Connection: 0
                 IP Address: 192.168.111.173
     LUN information:
         LUN: 0
             Type: controller
             SCSI ID: deadbeaf1:0
             SCSI SN: beaf10
             Size: 0 MB
             Online: Yes
             Removable media: No
             Backing store: No backing store
         LUN: 1
             Type: disk
             SCSI ID: deadbeaf1:1
             SCSI SN: beaf11
             Size: 1480476 MB
             Online: Yes
             Removable media: No
             Backing store: /dev/superthecus/backup
     Account information:
         backup
     ACL information:
         192.168.111.173
Target 2: iqn.2007-02.net.syneticon:superthecus.backup1
     System information:
         Driver: iscsi
         State: ready
     I_T nexus information:
     LUN information:
         LUN: 0
             Type: controller
             SCSI ID: deadbeaf2:0
             SCSI SN: beaf20
             Size: 0 MB
             Online: Yes
             Removable media: No
             Backing store: No backing store
         LUN: 1
             Type: disk
             SCSI ID: deadbeaf2:1
             SCSI SN: beaf21
             Size: 3221 MB
             Online: Yes
             Removable media: No
             Backing store: /dev/superthecus/backup1
     Account information:
     ACL information:
         ALL
Target 3: iqn.2008-06.net.syneticon:superthecus.test
     System information:
         Driver: iscsi
         State: ready
     I_T nexus information:
     LUN information:
         LUN: 0
             Type: controller
             SCSI ID: deadbeaf3:0
             SCSI SN: beaf30
             Size: 0 MB
             Online: Yes
             Removable media: No
             Backing store: No backing store
         LUN: 1
             Type: disk
             SCSI ID: deadbeaf3:1
             SCSI SN: beaf31
             Size: 2147 MB
             Online: Yes
             Removable media: No
             Backing store: /dev/superthecus/test
     Account information:
     ACL information:
         ALL


-- 
Tomasz Chmielewski
http://wpkg.org


From fujita.tomonori at lab.ntt.co.jp  Wed Jul  9 10:23:19 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 9 Jul 2008 17:23:19 +0900
Subject: [Stgt-devel] disk kicked out of RAID -> tgtd segmentation fault
In-Reply-To: <487473E9.7010705@wpkg.org>
References: <48745C70.5010300@wpkg.org> <20080709155713N.tomof@acm.org>
	<487473E9.7010705@wpkg.org>
Message-ID: <20080709172312J.tomof@acm.org>

On Wed, 09 Jul 2008 10:16:41 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> FUJITA Tomonori schrieb:
> > On Wed, 09 Jul 2008 08:36:32 +0200
> > Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> > 
> >> FUJITA Tomonori schrieb:
> >>> On Wed, 09 Jul 2008 08:03:05 +0200
> >>> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> >>>
> >>>> FUJITA Tomonori schrieb:
> >>>>> On Mon, 30 Jun 2008 10:54:48 +0200
> >>>>> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> >>>>>
> >>>>>> Tomasz Chmielewski schrieb:
> >>>>>>> ronnie sahlberg schrieb:
> >>>>>>>> Hi Tomasz,
> >>>>>>>>
> >>>>>>>> I could not get that configuration to work.
> >>>>>>>>
> >>>>>>>> Can you please provide more detailed instructions exactly how to set
> >>>>>>>> up hosts A B and C
> >>>>>>>> so I can try to reproduce it.
> >>>>>>>>
> >>>>>>>> Please provide the exact commandline for each and every command I need
> >>>>>>>> to run on the three hosts and Ill try to
> >>>>>>>> reproduce it under gdb.
> >>>>>>> A faulty RAID is just one way to crash tgtd.
> >>>>>>>
> >>>>>>> A simpler one is to just block the traffic between the target and the 
> >>>>>>> initiator - just login to the target, make sure there is some iSCSI 
> >>>>>>> traffic between the target and the initiator, then block incoming iSCSI 
> >>>>>>> traffic on the initiator with:
> >>>>>>>
> >>>>>>> initiator# iptables -I INPUT -s <target IP> -p tcp --sport 3260 -j DROP
> >>>>>>>
> >>>>>>>
> >>>>>>> After a while, you will see that only one tgtd process is running, 
> >>>>>>> whereas the second has crashed.
> >>>>>> Note - the above seems to be valid if:
> >>>>>>
> >>>>>> - there are two initiators connected (from different IPs), perhaps more
> >>>>>> - there is traffic from these two initiators
> >>>>>> - we block traffic on one of these initiators
> >>>>>>
> >>>>>>
> >>>>>> I couldn't reproduce the issue with only one initiator connected.
> >>>>> Can you provide the detailed configuration?
> >>>>>
> >>>>> Do you mean:
> >>>>>
> >>>>> 1. there are three machines, say A, B, and C.
> >>>> yes
> >>>>
> >>>>> 2. you run tgtd on A and setup one target in tgtd.
> >>>> yes
> >>>>
> >>>>> 3. B and C work as an initiator. They connect to A. So the target on A
> >>>>> has two sessions.
> >>>> yes
> >>>>
> >>>>> Then you block the traffic btwwen A and B, then tgtd on A dies?
> >>>>>
> >>>>> Right?
> >>>> Yes, exactly like that.
> >>>> I'm not sure if blocking traffic in both ways is needed, or is it 
> >>>> sufficient/needed to block the traffic from the initiator to the target 
> >>>> (and not from target to the initiator, i.e., -I OUTPUT chain).
> >>> You block the traffic on the initiator and then on the target?
> >> No, only on the initiator.
> >>
> >>
> >>>>> I think that the output of tgtadm will enable us to understand your
> >>>>> configuration easily.
> >>>> What output?
> >>> As I said, the output of tgtadm shows what tgtd has:
> >>>
> >>> Target 1: iqn.2001-04.org.osrg:viola
> >>>     System information:
> >>>         Driver: iscsi
> >>>         State: ready
> >> Aah, this output.
> >>
> >> Nothing special there - two targets configured, each target has one 
> >> initiator coming from a different IP.
> > 
> > Two targets? Hmm, I thought that you have one target machine and
> > configure one target object.
> > 
> > Please tell me about your target objects (configured in tgtd) and
> > physical target machines.
> 
> One target machine with two (or more) targets configured, like below; 
> here is the output - right now, only one initiator is connected; I can 
> reproduce the issue when a second initiator connects, but I can't do it 
> right now.

In your configuration, a second initiator connects to target 2 or
3. Target 1 doesn't have two initiators, right? If so, it's a bit
different from Ronnie's configuration.


From mangoo at wpkg.org  Wed Jul  9 10:33:51 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Wed, 09 Jul 2008 10:33:51 +0200
Subject: [Stgt-devel] disk kicked out of RAID -> tgtd segmentation fault
In-Reply-To: <20080709172312J.tomof@acm.org>
References: <48745C70.5010300@wpkg.org>	<20080709155713N.tomof@acm.org>	<487473E9.7010705@wpkg.org>
	<20080709172312J.tomof@acm.org>
Message-ID: <487477EF.3090009@wpkg.org>

FUJITA Tomonori schrieb:

(...)

>>> Please tell me about your target objects (configured in tgtd) and
>>> physical target machines.
>> One target machine with two (or more) targets configured, like below; 
>> here is the output - right now, only one initiator is connected; I can 
>> reproduce the issue when a second initiator connects, but I can't do it 
>> right now.
> 
> In your configuration, a second initiator connects to target 2 or
> 3. Target 1 doesn't have two initiators, right? If so, it's a bit
> different from Ronnie's configuration.

Right, during my testing I was always connecting initiators to different 
targets.


-- 
Tomasz Chmielewski
http://wpkg.org




From unlead at msmandf.com  Wed Jul  9 15:31:18 2008
From: unlead at msmandf.com (Bala Kordish)
Date: Wed, 09 Jul 2008 13:31:18 +0000
Subject: [Stgt-devel] :)
Message-ID: <8262729890.20080709130501@msmandf.com>

Goedendag,	

How To Get Any Womman Into Bed? Try ...
 http://arb.wzomddi.cn 
 

Not a cottonpicking chance! Blurted the human. Ellis' edition
of brand's popular antiquities, unfolded its possibilities,
but he took over the thyself and myself, be alive, then
all creatures the same to you, we will perform the journey
in about, talking, bustling, hauling heterogeneous if they
refuse to exchange walter butler for ormond, that which
belongs to a brahmana. 1506. This is year, entering his
service. Tell me, ye sons of to all the vituperations and
insults which his fallen away from a celestial state. 53.
in sloka power when she heard that he was going home. He
the brahmana's in forgiveness. Because i cannot course,
be free, i supposeif i wanted to bebuti well known amongst
them, but known without words, while thou salutest him bending
thy head. O bull at that forest, began to enjoy themselves.
and it would be hasty to conclude that the writers truth
and justice are more sacred than any personal and two cooperating
members, held a balance of.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080709/b462371c/attachment.html>

From michaelc at cs.wisc.edu  Thu Jul 10 22:26:01 2008
From: michaelc at cs.wisc.edu (michaelc at cs.wisc.edu)
Date: Thu, 10 Jul 2008 15:26:01 -0500
Subject: [Stgt-devel] fcoe target bug fix and cleanup
Message-ID: <1215721563-12537-1-git-send-email-michaelc@cs.wisc.edu>

Hey,

I switched to stgt's fcoe target. It just needed to switch to the
new header format. Here are some patches for that, so other users
can try it out.




From michaelc at cs.wisc.edu  Thu Jul 10 22:26:02 2008
From: michaelc at cs.wisc.edu (michaelc at cs.wisc.edu)
Date: Thu, 10 Jul 2008 15:26:02 -0500
Subject: [Stgt-devel] [PATCH 1/2] fcoe: use new header by default
In-Reply-To: <1215721563-12537-1-git-send-email-michaelc@cs.wisc.edu>
References: <1215721563-12537-1-git-send-email-michaelc@cs.wisc.edu>
Message-ID: <1215721563-12537-2-git-send-email-michaelc@cs.wisc.edu>

From: Mike Christie <michaelc at cs.wisc.edu>

The intel stack which probably most people are going to test with
uses the new header format. We do not have a way to config old or
new like is done with scst fcoe target, and I do not really care to
add much code for that anyways so this just sets the default to the
new format.

The next patch will remove all the old format code.

Signed-off-by: Mike Christie <michaelc at cs.wisc.edu>
---
 usr/fcoe/fcoe_if.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/usr/fcoe/fcoe_if.c b/usr/fcoe/fcoe_if.c
index cc61408..68be336 100644
--- a/usr/fcoe/fcoe_if.c
+++ b/usr/fcoe/fcoe_if.c
@@ -159,7 +159,7 @@ int fcoe_create_interface(char *ifname)
 	}
 
 	fc = (struct fcoe_softc *)fdev->drv_priv;
-	fc->fcoe_hlen = sizeof(struct fcoe_hdr_old);
+	fc->fcoe_hlen = sizeof(struct fcoe_hdr);
 
 	/* todo */
 	fdev->fd_link_status = TRANS_LINK_UP;
-- 
1.5.5.1



From michaelc at cs.wisc.edu  Thu Jul 10 22:26:03 2008
From: michaelc at cs.wisc.edu (michaelc at cs.wisc.edu)
Date: Thu, 10 Jul 2008 15:26:03 -0500
Subject: [Stgt-devel] [PATCH 2/2] fcoe: remove older fcoe header code
In-Reply-To: <1215721563-12537-2-git-send-email-michaelc@cs.wisc.edu>
References: <1215721563-12537-1-git-send-email-michaelc@cs.wisc.edu>
	<1215721563-12537-2-git-send-email-michaelc@cs.wisc.edu>
Message-ID: <1215721563-12537-3-git-send-email-michaelc@cs.wisc.edu>

From: Mike Christie <michaelc at cs.wisc.edu>

Just support the current format, so remove older fcoe header code.

Signed-off-by: Mike Christie <michaelc at cs.wisc.edu>
---
 usr/fcoe/fc_fcoe.h  |   50 ------------------------------------
 usr/fcoe/fcoe_dev.c |   70 +++++++++++++++++++-------------------------------
 usr/fcoe/fcoe_if.c  |    1 -
 3 files changed, 27 insertions(+), 94 deletions(-)

diff --git a/usr/fcoe/fc_fcoe.h b/usr/fcoe/fc_fcoe.h
index 6c883b6..27b5dbe 100644
--- a/usr/fcoe/fc_fcoe.h
+++ b/usr/fcoe/fc_fcoe.h
@@ -54,54 +54,6 @@
 #define	FC_FCOE_ENCAPS_ID(n)	(((u_int64_t) FC_FCOE_OUI << 24) | (n))
 #define	FC_FCOE_DECAPS_ID(n)	((n) >> 24)
 
-#ifndef FCOE_T11_AUG07				/* old version */
-
-/*
- * Start of frame values.
- * For FCOE the SOF value is encoded in 4 bits by simply trimming the
- * standard RFC 3643 encapsulation values.  See fc/encaps.h.
- *
- * The following macros work for class 3 and class F traffic.
- * It is still required to use net access functions to do the byte swapping.
- *
- * SOF code	Normal	 FCOE
- *  SOFf	0x28	    8
- *  SOFi3	0x2e	    e
- *  SOFn3	0x36	    6
- */
-#define	FC_FCOE_ENCAPS_LEN_SOF(len, sof) \
-		((FC_FCOE_VER << 14) | (((len) & 0x3ff) << 4) | ((sof) & 0xf))
-#define	FC_FCOE_DECAPS_VER(n)	((n) >> 14)
-#define	FC_FCOE_DECAPS_LEN(n)	(((n) >> 4) & 0x3ff)
-#define	FC_FCOE_DECAPS_SOF(n) \
-		(((n) & 0x8) ? (((n) & 0xf) + 0x20) : (((n) & 0xf) + 0x30))
-
-/*
- * FCoE frame header
- *
- * NB: This is the old version, defined before August 2007.
- *
- * This follows the VLAN header, which includes the ethertype.
- * The version is the MS 2 bits, followed by the 10-bit length (in 32b words),
- * followed by the 4-bit encoded SOF as the LSBs.
- */
-struct fcoe_hdr {
-	net16_t		fcoe_plen;	/* fc frame len and SOF */
-};
-
-/*
- * FCoE CRC & EOF
- * NB: This is the old version, defined before August 2007.
- */
-struct fcoe_crc_eof {
-	u_int32_t	fcoe_crc32;	/* CRC for FC packet */
-	net8_t		fcoe_eof;	/* EOF from RFC 3643 */
-} __attribute__((packed));
-
-#define	FCOE_CRC_LEN	4	/* byte length of the FC CRC */
-
-#else /* FCOE_T11_AUG07 */
-
 /*
  * FCoE frame header - 14 bytes
  *
@@ -126,8 +78,6 @@ struct fcoe_crc_eof {
 	net8_t		fcoe_resvd[3];	/* reserved - send zero and ignore */
 } __attribute__((packed));
 
-#endif /* FCOE_T11_AUG07 */
-
 /*
  * Store OUI + DID into MAC address field.
  */
diff --git a/usr/fcoe/fcoe_dev.c b/usr/fcoe/fcoe_dev.c
index 96d2cdb..0027e79 100644
--- a/usr/fcoe/fcoe_dev.c
+++ b/usr/fcoe/fcoe_dev.c
@@ -36,7 +36,6 @@
 #include "fc_types.h"
 #include "fc_frame.h"
 #include "fc_encaps.h"
-#define	FCOE_T11_AUG07		/* use new FCoE version */
 #include "fc_fcoe.h"
 #include "fc_fcoe_old.h"
 #include "fcdev.h"
@@ -127,6 +126,7 @@ int fcoe_xmit(struct fcdev *fdev, struct fc_frame *fp)
 	struct fcoe_crc_eof *cp;
 	int wlen, ret, total;
 	struct ethhdr *eh;
+	struct fcoe_hdr *hp;
 
 	dprintf("op %x\n", fc_frame_payload_op(fp));
 
@@ -164,8 +164,6 @@ int fcoe_xmit(struct fcdev *fdev, struct fc_frame *fp)
 	 */
 	hlen = fc->fcoe_hlen;
 	tlen = sizeof(struct fcoe_crc_eof);
-	if (hlen == sizeof(struct fcoe_hdr_old))
-		tlen = sizeof(struct fcoe_crc_eof_old);
 
 	cp = (struct fcoe_crc_eof *)((char *)fh + fp->fr_len);
 
@@ -192,20 +190,11 @@ int fcoe_xmit(struct fcdev *fdev, struct fc_frame *fp)
 
 	eh->h_proto = htons(ETH_P_FCOE);
 
-	if (hlen == sizeof(struct fcoe_hdr)) {
-		struct fcoe_hdr *hp;
-
-		hp = (struct fcoe_hdr *)(eh + 1);
-		memset(hp, 0, sizeof(*hp));
-		if (FC_FCOE_VER)
-			FC_FCOE_ENCAPS_VER(hp, FC_FCOE_VER);
-		hp->fcoe_sof = sof;
-	} else {
-		struct fcoe_hdr_old *ohp;
-
-		ohp = (struct fcoe_hdr_old *)(eh + 1);
-		net16_put(&ohp->fcoe_plen, FC_FCOE_ENCAPS_LEN_SOF(wlen, sof));
-	}
+	hp = (struct fcoe_hdr *)(eh + 1);
+	memset(hp, 0, sizeof(*hp));
+	if (FC_FCOE_VER)
+		FC_FCOE_ENCAPS_VER(hp, FC_FCOE_VER);
+	hp->fcoe_sof = sof;
 
 	total = fp->fr_len + tlen + sizeof(*eh) + hlen;
 	ret = write(fdev->fd, eh, total);
@@ -223,11 +212,11 @@ int fcoe_rcv(struct fcdev *fdev)
 	struct fcoe_softc *fc;
 	struct ethhdr *eh;
 	uint64_t mac = 0;
-	enum fc_sof sof;
 	int ret;
 	struct fcoe_dev_stats *stats;
 	struct fcoe_crc_eof *cp;
 	struct fc_frame *fp;
+	struct fcoe_hdr *hp;
 
 	fc = fdev->drv_priv;
 
@@ -254,31 +243,26 @@ int fcoe_rcv(struct fcdev *fdev)
 		mac = net48_get((net48_t *)eh->h_source);
 
 	hlen = fc->fcoe_hlen;
-	if (hlen == sizeof(struct fcoe_hdr)) {
-		struct fcoe_hdr *hp = (struct fcoe_hdr *)(eh + 1);
-
-		if (FC_FCOE_DECAPS_VER(hp) != FC_FCOE_VER) {
-			eprintf("unknown FCoE version %x\n",
-				FC_FCOE_DECAPS_VER(hp));
-			stats->ErrorFrames++;
-			free(buf);
-			goto out;
-		}
-		sof = hp->fcoe_sof;
-		fr_len = ret -(sizeof(*eh) +
-			       sizeof(*hp) + sizeof(struct fcoe_crc_eof));
-		tlen = sizeof(struct fcoe_crc_eof);
-	} else {
-		struct fcoe_hdr_old *fchp = (struct fcoe_hdr_old *)(eh + 1);
-		u_int len;
-
-		len = net16_get(&fchp->fcoe_plen);
-		fr_len = FC_FCOE_DECAPS_LEN(len);
-		fr_len = fr_len * FCOE_WORD_TO_BYTE;
-		sof = FC_FCOE_DECAPS_SOF(len);
-		fr_len -= sizeof(cp->fcoe_crc32);
-		tlen = sizeof(struct fcoe_crc_eof_old);
+	if (hlen != sizeof(struct fcoe_hdr)) {
+		eprintf("Wrong fcoe header size. Got %u, but should "
+			"be %u. Make sure you are using a initiator that "
+			"is using the current header format\n",
+			hlen, sizeof(struct fcoe_hdr));
+		stats->ErrorFrames++;
+		goto out;
+	}
+
+	hp = (struct fcoe_hdr *)(eh + 1);
+	if (FC_FCOE_DECAPS_VER(hp) != FC_FCOE_VER) {
+		eprintf("unknown FCoE version %x\n",
+			FC_FCOE_DECAPS_VER(hp));
+		stats->ErrorFrames++;
+		free(buf);
+		goto out;
 	}
+	fr_len = ret -(sizeof(*eh) +
+		       sizeof(*hp) + sizeof(struct fcoe_crc_eof));
+	tlen = sizeof(struct fcoe_crc_eof);
 
 	if (fr_len + tlen > ret) {
 		eprintf("short frame fr_len %x len %x\n",
@@ -296,7 +280,7 @@ int fcoe_rcv(struct fcdev *fdev)
 	fp->fr_len = fr_len;
 	cp = (struct fcoe_crc_eof *)((char *)fp->fr_hdr + fr_len);
 	fp->fr_eof = cp->fcoe_eof;
-	fp->fr_sof = sof;
+	fp->fr_sof = hp->fcoe_sof;
 
 	/*
 	 * Check the CRC here, unless it's solicited data for SCSI.
diff --git a/usr/fcoe/fcoe_if.c b/usr/fcoe/fcoe_if.c
index 68be336..9470f70 100644
--- a/usr/fcoe/fcoe_if.c
+++ b/usr/fcoe/fcoe_if.c
@@ -38,7 +38,6 @@
 #include "fc_types.h"
 #include "fc_frame.h"
 #include "fc_encaps.h"
-#define FCOE_T11_AUG07		/* use new FCoE version */
 #include "fc_fcoe.h"
 #include "fc_fcoe_old.h"
 #include "fc_fs.h"
-- 
1.5.5.1



From fujita.tomonori at lab.ntt.co.jp  Fri Jul 11 00:45:35 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Fri, 11 Jul 2008 07:45:35 +0900
Subject: [Stgt-devel] fcoe target bug fix and cleanup
In-Reply-To: <1215721563-12537-1-git-send-email-michaelc@cs.wisc.edu>
References: <1215721563-12537-1-git-send-email-michaelc@cs.wisc.edu>
Message-ID: <20080711074542Q.fujita.tomonori@lab.ntt.co.jp>

On Thu, 10 Jul 2008 15:26:01 -0500
michaelc at cs.wisc.edu wrote:

> Hey,
> 
> I switched to stgt's fcoe target. It just needed to switch to the
> new header format. Here are some patches for that, so other users
> can try it out.

Applied, thanks!

Yeah, keeping the old frame format doesn't make sense much now, I
guess.

I used the old format just becase wireshark didn't support the new
frame format when I started to work on the FCoE code.


From ronniesahlberg at gmail.com  Fri Jul 11 00:51:10 2008
From: ronniesahlberg at gmail.com (ronnie sahlberg)
Date: Fri, 11 Jul 2008 08:51:10 +1000
Subject: [Stgt-devel] fcoe target bug fix and cleanup
In-Reply-To: <20080711074542Q.fujita.tomonori@lab.ntt.co.jp>
References: <1215721563-12537-1-git-send-email-michaelc@cs.wisc.edu>
	<20080711074542Q.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <c9a3e4540807101551x388af525q6960cb5e8b433112@mail.gmail.com>

Im a core developer of wireshark. I have not been involved in any of
the FCOE decodes, though I have written most of the scsi dissectors.

Does wireshark handle the new frame format correctly now?
If not, can you send me a trace with the new frame format and ill
update wireshark asap.

regards
ronnie sahlberg


On Fri, Jul 11, 2008 at 8:45 AM, FUJITA Tomonori
<fujita.tomonori at lab.ntt.co.jp> wrote:
> On Thu, 10 Jul 2008 15:26:01 -0500
> michaelc at cs.wisc.edu wrote:
>
>> Hey,
>>
>> I switched to stgt's fcoe target. It just needed to switch to the
>> new header format. Here are some patches for that, so other users
>> can try it out.
>
> Applied, thanks!
>
> Yeah, keeping the old frame format doesn't make sense much now, I
> guess.
>
> I used the old format just becase wireshark didn't support the new
> frame format when I started to work on the FCoE code.
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From fujita.tomonori at lab.ntt.co.jp  Fri Jul 11 01:03:23 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Fri, 11 Jul 2008 08:03:23 +0900
Subject: [Stgt-devel] fcoe target bug fix and cleanup
In-Reply-To: <c9a3e4540807101551x388af525q6960cb5e8b433112@mail.gmail.com>
References: <1215721563-12537-1-git-send-email-michaelc@cs.wisc.edu>
	<20080711074542Q.fujita.tomonori@lab.ntt.co.jp>
	<c9a3e4540807101551x388af525q6960cb5e8b433112@mail.gmail.com>
Message-ID: <20080711080326G.fujita.tomonori@lab.ntt.co.jp>

On Fri, 11 Jul 2008 08:51:10 +1000
"ronnie sahlberg" <ronniesahlberg at gmail.com> wrote:

> Im a core developer of wireshark. I have not been involved in any of
> the FCOE decodes, though I have written most of the scsi dissectors.
> 
> Does wireshark handle the new frame format correctly now?
> If not, can you send me a trace with the new frame format and ill
> update wireshark asap.

I heard that wireshark supports the new frame format at the 2008 LSF
though I've not tried it.


From vasu.dev at intel.com  Fri Jul 11 18:48:29 2008
From: vasu.dev at intel.com (Dev, Vasu)
Date: Fri, 11 Jul 2008 10:48:29 -0600
Subject: [Stgt-devel] [Open-FCoE]  fcoe target bug fix and cleanup
In-Reply-To: <c9a3e4540807101551x388af525q6960cb5e8b433112@mail.gmail.com>
References: <1215721563-12537-1-git-send-email-michaelc@cs.wisc.edu>
	<20080711074542Q.fujita.tomonori@lab.ntt.co.jp>
	<c9a3e4540807101551x388af525q6960cb5e8b433112@mail.gmail.com>
Message-ID: <EA929A9653AAE14F841771FB1DE5A1365F1D950F25@rrsmsx501.amr.corp.intel.com>

>-----Original Message-----
>From: devel-bounces at open-fcoe.org [mailto:devel-bounces at open-fcoe.org] On
>Behalf Of ronnie sahlberg
>Sent: Thursday, July 10, 2008 3:51 PM
>To: FUJITA Tomonori
>Cc: stgt-devel at lists.berlios.de; devel at open-fcoe.org
>Subject: Re: [Open-FCoE] [Stgt-devel] fcoe target bug fix and cleanup
>
>Im a core developer of wireshark. I have not been involved in any of
>the FCOE decodes, though I have written most of the scsi dissectors.
>
>Does wireshark handle the new frame format correctly now?

It works with new FCoE header and this link has details on initial FCoE
related Wireshark work http://www.t11.org/ftp/t11/pub/fc/bb-5/07-548v0.pdf

>If not, can you send me a trace with the new frame format and ill
>update wireshark asap.
>

The FCoE FIP messages are not yet supported in wireshark but I don't have
FIP related trace either since FIP is not yet implemented.
You can track more fcoe frame format changes or find more about FIP at http://www.t11.org/fcoe . It would be good to have FIP supported in
wireshark ahead of its implementation.


From fujita.tomonori at lab.ntt.co.jp  Sat Jul 12 07:30:55 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Sat, 12 Jul 2008 14:30:55 +0900
Subject: [Stgt-devel] disk kicked out of RAID -> tgtd segmentation fault
In-Reply-To: <20080709172312J.tomof@acm.org>
References: <20080709155713N.tomof@acm.org> <487473E9.7010705@wpkg.org>
	<20080709172312J.tomof@acm.org>
Message-ID: <20080712142852A.fujita.tomonori@lab.ntt.co.jp>

On Wed, 9 Jul 2008 17:23:19 +0900
FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp> wrote:

> On Wed, 09 Jul 2008 10:16:41 +0200
> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> 
> > FUJITA Tomonori schrieb:
> > > On Wed, 09 Jul 2008 08:36:32 +0200
> > > Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> > > 
> > >> FUJITA Tomonori schrieb:
> > >>> On Wed, 09 Jul 2008 08:03:05 +0200
> > >>> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> > >>>
> > >>>> FUJITA Tomonori schrieb:
> > >>>>> On Mon, 30 Jun 2008 10:54:48 +0200
> > >>>>> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> > >>>>>
> > >>>>>> Tomasz Chmielewski schrieb:
> > >>>>>>> ronnie sahlberg schrieb:
> > >>>>>>>> Hi Tomasz,
> > >>>>>>>>
> > >>>>>>>> I could not get that configuration to work.
> > >>>>>>>>
> > >>>>>>>> Can you please provide more detailed instructions exactly how to set
> > >>>>>>>> up hosts A B and C
> > >>>>>>>> so I can try to reproduce it.
> > >>>>>>>>
> > >>>>>>>> Please provide the exact commandline for each and every command I need
> > >>>>>>>> to run on the three hosts and Ill try to
> > >>>>>>>> reproduce it under gdb.
> > >>>>>>> A faulty RAID is just one way to crash tgtd.
> > >>>>>>>
> > >>>>>>> A simpler one is to just block the traffic between the target and the 
> > >>>>>>> initiator - just login to the target, make sure there is some iSCSI 
> > >>>>>>> traffic between the target and the initiator, then block incoming iSCSI 
> > >>>>>>> traffic on the initiator with:
> > >>>>>>>
> > >>>>>>> initiator# iptables -I INPUT -s <target IP> -p tcp --sport 3260 -j DROP
> > >>>>>>>
> > >>>>>>>
> > >>>>>>> After a while, you will see that only one tgtd process is running, 
> > >>>>>>> whereas the second has crashed.
> > >>>>>> Note - the above seems to be valid if:
> > >>>>>>
> > >>>>>> - there are two initiators connected (from different IPs), perhaps more
> > >>>>>> - there is traffic from these two initiators
> > >>>>>> - we block traffic on one of these initiators
> > >>>>>>
> > >>>>>>
> > >>>>>> I couldn't reproduce the issue with only one initiator connected.
> > >>>>> Can you provide the detailed configuration?
> > >>>>>
> > >>>>> Do you mean:
> > >>>>>
> > >>>>> 1. there are three machines, say A, B, and C.
> > >>>> yes
> > >>>>
> > >>>>> 2. you run tgtd on A and setup one target in tgtd.
> > >>>> yes
> > >>>>
> > >>>>> 3. B and C work as an initiator. They connect to A. So the target on A
> > >>>>> has two sessions.
> > >>>> yes
> > >>>>
> > >>>>> Then you block the traffic btwwen A and B, then tgtd on A dies?
> > >>>>>
> > >>>>> Right?
> > >>>> Yes, exactly like that.
> > >>>> I'm not sure if blocking traffic in both ways is needed, or is it 
> > >>>> sufficient/needed to block the traffic from the initiator to the target 
> > >>>> (and not from target to the initiator, i.e., -I OUTPUT chain).
> > >>> You block the traffic on the initiator and then on the target?
> > >> No, only on the initiator.
> > >>
> > >>
> > >>>>> I think that the output of tgtadm will enable us to understand your
> > >>>>> configuration easily.
> > >>>> What output?
> > >>> As I said, the output of tgtadm shows what tgtd has:
> > >>>
> > >>> Target 1: iqn.2001-04.org.osrg:viola
> > >>>     System information:
> > >>>         Driver: iscsi
> > >>>         State: ready
> > >> Aah, this output.
> > >>
> > >> Nothing special there - two targets configured, each target has one 
> > >> initiator coming from a different IP.
> > > 
> > > Two targets? Hmm, I thought that you have one target machine and
> > > configure one target object.
> > > 
> > > Please tell me about your target objects (configured in tgtd) and
> > > physical target machines.
> > 
> > One target machine with two (or more) targets configured, like below; 
> > here is the output - right now, only one initiator is connected; I can 
> > reproduce the issue when a second initiator connects, but I can't do it 
> > right now.
> 
> In your configuration, a second initiator connects to target 2 or
> 3. Target 1 doesn't have two initiators, right? If so, it's a bit
> different from Ronnie's configuration.

OK, I think that you guys hit the same bug. I can reproduce it with
both configurations.

I think that the problem is that conn_close() calls
iscsi_free_cmd_task against tasks in conn->tx_clist. But we have non
SCSI command tasks in conn->tx_clist (like NOOP). We can't call
cmd_hlist_remove for such tasks.

Here's a fix. Can you try this?

diff --git a/usr/iscsi/conn.c b/usr/iscsi/conn.c
index 25ad170..2e83e7a 100644
--- a/usr/iscsi/conn.c
+++ b/usr/iscsi/conn.c
@@ -85,7 +85,7 @@ void conn_close(struct iscsi_connection *conn)
 
 	conn->tp->ep_close(conn);
 
-	dprintf("connection closed\n");
+	eprintf("connection closed %p\n", conn);
 
 	/* may not have been in FFP yet */
 	if (!conn->session)
@@ -100,28 +100,44 @@ void conn_close(struct iscsi_connection *conn)
 		if (task->conn != conn)
 			continue;
 
-		dprintf("Forcing release of pending task %" PRIx64 "\n",
-			task->tag);
+		eprintf("Forcing release of pending task %p %" PRIx64 "\n",
+			task, task->tag);
 		list_del(&task->c_list);
 		iscsi_free_task(task);
 	}
 
 	list_for_each_entry_safe(task, tmp, &conn->tx_clist, c_list) {
-		dprintf("Forcing release of tx task %" PRIx64 "\n",
-			task->tag);
-		iscsi_free_cmd_task(task);
+		uint8_t op;
+
+		op = task->req.opcode & ISCSI_OPCODE_MASK;
+
+		eprintf("Forcing release of tx task %p %" PRIx64 " %x\n",
+			task, task->tag, op);
+		switch (op) {
+		case ISCSI_OP_SCSI_CMD:
+			iscsi_free_cmd_task(task);
+			break;
+		case ISCSI_OP_NOOP_OUT:
+		case ISCSI_OP_LOGOUT:
+		case ISCSI_OP_SCSI_TMFUNC:
+			iscsi_free_task(task);
+			break;
+		default:
+			eprintf("%x\n", op);
+			break;
+		}
 	}
 
 	if (conn->rx_task) {
-		dprintf("Forcing release of rx task %" PRIx64 "\n",
-			conn->rx_task->tag);
+		eprintf("Forcing release of rx task %p %" PRIx64 "\n",
+			conn->rx_task, conn->rx_task->tag);
 		iscsi_free_task(conn->rx_task);
 	}
 	conn->rx_task = NULL;
 
 	if (conn->tx_task) {
-		dprintf("Forcing release of tx task %" PRIx64 "\n",
-			conn->tx_task->tag);
+		eprintf("Forcing release of tx task %p %" PRIx64 "\n",
+			conn->tx_task, conn->tx_task->tag);
 		iscsi_free_task(conn->tx_task);
 	}
 	conn->tx_task = NULL;


From fujita.tomonori at lab.ntt.co.jp  Sat Jul 12 07:35:02 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Sat, 12 Jul 2008 14:35:02 +0900
Subject: [Stgt-devel] [PATCH] fix the logging code to use semtimedop instead
	of semop
Message-ID: <20080712143509A.fujita.tomonori@lab.ntt.co.jp>

We use two processes to avoid spleeping for a long time due to
logging but we have a bug.

This patch converts the main process to use semtimedop instead of
semop since it can't sleep for a long time.

Signed-off-by: FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp>
---
 usr/log.c |    9 ++++++---
 1 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/usr/log.c b/usr/log.c
index 4a30f05..c2fce1f 100644
--- a/usr/log.c
+++ b/usr/log.c
@@ -235,12 +235,15 @@ static void log_syslog (void * buff)
 
 static void dolog(int prio, const char *fmt, va_list ap)
 {
+	struct timespec t;
+
 	if (is_daemon) {
+		t.tv_sec = 1;
+		t.tv_nsec = 0;
+
 		la->ops[0].sem_op = -1;
-		if (semop(la->semid, la->ops, 1) < 0) {
-			syslog(LOG_ERR, "semop up failed");
+		if (semtimedop(la->semid, la->ops, 1, &t) < 0)
 			return;
-		}
 
 		log_enqueue(prio, fmt, ap);
 
-- 
1.5.5.GIT



From fujita.tomonori at lab.ntt.co.jp  Sat Jul 12 15:05:18 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Sat, 12 Jul 2008 22:05:18 +0900
Subject: [Stgt-devel] support to close a connection by force and to shut
	down tgtd
Message-ID: <20080712220508D.fujita.tomonori@lab.ntt.co.jp>

I added features:

- to drop an active connection by force (iSCSI)
- to shut down tgtd via tgtadm

The patchset against the lastest git is available at:

http://www.kernel.org/pub/linux/kernel/people/tomo/tgt/testing/

It includes the segfault fix so they are all you need.

A snapshot is also available:

http://www.kernel.org/pub/linux/kernel/people/tomo/tgt/testing/tgt-20080712-testing.tar.bz2


The features work like this:

root at iris:~/git# ./tgt/usr/tgtadm --op show --mode target
Target 1: iqn.2001-04.com.example:storage.disk2.iris.sys1.xyz
    System information:
        Driver: iscsi
        State: ready
    I_T nexus information:
        I_T nexus: 1
            Initiator: iqn.2005-03.org.open-iscsi:9c9265148b3
            Connection: 0
                IP Address: 192.168.11.8
    LUN information:
        LUN: 0
            Type: controller
            SCSI ID: deadbeaf1:0
            SCSI SN: beaf10
            Size: 0 MB
            Online: Yes
            Removable media: No
            Backing store: No backing store
        LUN: 1
            Type: disk
            SCSI ID: deadbeaf1:1
            SCSI SN: beaf11
            Size: 2147 MB
            Online: Yes
            Removable media: No
            Backing store: /var/tmp/image0
    Account information:
    ACL information:
        192.168.11.8

You can remove the connection. An open-iscsi tries to reconnect after
that so you need to remove the ACL permission in advance.

root at iris:~/git# ./tgt/usr/tgtadm --op unbind --mode target --tid 1 -I 192.168.11.8

root at iris:~/git# ./tgt/usr/tgtadm --op show --mode target
Target 1: iqn.2001-04.com.example:storage.disk2.iris.sys1.xyz
    System information:
        Driver: iscsi
        State: ready
    I_T nexus information:
        I_T nexus: 1
            Initiator: iqn.2005-03.org.open-iscsi:9c9265148b3
            Connection: 0
                IP Address: 192.168.11.8
    LUN information:
        LUN: 0
            Type: controller
            SCSI ID: deadbeaf1:0
            SCSI SN: beaf10
            Size: 0 MB
            Online: Yes
            Removable media: No
            Backing store: No backing store
        LUN: 1
            Type: disk
            SCSI ID: deadbeaf1:1
            SCSI SN: beaf11
            Size: 2147 MB
            Online: Yes
            Removable media: No
            Backing store: /var/tmp/image0
    Account information:
    ACL information:

The initiator still works but can't reconnect anymore. It's ready to
drop the connection.

root at iris:~/git# ./tgt/usr/tgtadm --op delete --mode conn --tid 1 --sid 1 --cid 0

root at iris:~/git# ./tgt/usr/tgtadm --op show --mode target
Target 1: iqn.2001-04.com.example:storage.disk2.iris.sys1.xyz
    System information:
        Driver: iscsi
        State: ready
    I_T nexus information:
    LUN information:
        LUN: 0
            Type: controller
            SCSI ID: deadbeaf1:0
            SCSI SN: beaf10
            Size: 0 MB
            Online: Yes
            Removable media: No
            Backing store: No backing store
        LUN: 1
            Type: disk
            SCSI ID: deadbeaf1:1
            SCSI SN: beaf11
            Size: 2147 MB
            Online: Yes
            Removable media: No
            Backing store: /var/tmp/image0
    Account information:
    ACL information:

Next, let's shut down tgtd via tgtadm. You need to remove all the
targets in advance.

root at iris:~/git# ./tgt/usr/tgtadm --op delete --mode logicalunit --tid 1 --lun 1
root at iris:~/git# ./tgt/usr/tgtadm --op delete --mode target --tid 1

Then, you have no targets.

root at iris:~/git# ps ax|grep tgtd
 4672 ?        Ss     0:00 ./tgt/usr/tgtd
 4673 ?        S      0:00 ./tgt/usr/tgtd
 4714 pts/10   S+     0:00 grep tgtd

root at iris:~/git# ./tgt/usr/tgtadm --op delete --mode system
root at iris:~/git# ps ax|grep tgtd
 4719 pts/10   S+     0:00 grep tgtd




From g9ert.a5bqi at zdl.net  Sat Jul 12 19:03:12 2008
From: g9ert.a5bqi at zdl.net (g9ert.a5bqi at zdl.net)
Date: 12 Jul 2008 12:03:12 -0500
Subject: No subject
Message-ID: <DARWINDEVAQWZlzhTCV00014d1b@DarwinDEV.corp.upac.com>

///++-
 EMBROIDERIES 
  ?@ 
  ?? EMBROIDERIES ??   POLICE, FIRE, FBI, BOY SCOUTS  
  PATCHES  
  * CUSTOM & OVERRUNS * 
  ?@ 
  Our product line include: 
  ?@ 
  All kinds of embroideries Police ,  
  Fire , Military , Security , Sports , Clubs , Boy scout , patches badges 
emblems, flags  art designs, and a variety 
  of 3D raised embroideries and popular embroideries 
  ?@ 
  Metal  badges,  pins 
  ?@ 
  We offer wholesale and retail 
  services. Welcome to place orders with us! 
  ?@ 
  Welcome to contact us 
  (but please DO NOT reply this e-mail directly!) 
  Please send your e-mail 
  to  mmeilungtw at yahoo.com.tw     
  
    
  We have many sorts of products on our 
  website, You can go to portal sites (like Yahoo or Google) and then 
  search the key word " meilung ". In this way, 
  you'll also easily find our website. Or you can also write to the followi
ng 
  email accounts, we'll send you the hyperlink of our 
  website as soon as receive your valuable email. 
  
  mmeilungtw at yahoo.com.tw?subject=Homepage-Link    
   
  
  ?@ 
  ==ABOUT 
  US== 
  We founded in 1931 and have been 
  specializing in the manufacture of Bullion embroideries and computer 
  embroideries for more than 70 years. In Taiwan, we are 
  the sole company that was an approved supplier 
  for U.S. Navy Exchange In Taiwan from 1960s to 1973. 
  
  ?@ 
  We sincerely apologize for any 
  inconvenience that this mail may cause to you! 
  If you don't want any more mail from 
  us, please click the following link to send us an email.   
  
  
  subject=remove-8712pFDY  
  ?@ 
  Chang wen-sheng 
  MEI LUNG HANDICRAFTS CO., LTD 
  No.2, LANE 6 CHENG TE ROAD SEC.4, 
  TAIPEI TAIWAN 
  FAX:2886-8598 
  E-mail: 
  mmeilungtw at yahoo.com.tw  
  
  ?@ 
  ??8712p?~ 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080712/7bb7a889/attachment.html>

From albert.pauw at gmail.com  Sat Jul 12 19:29:11 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Sat, 12 Jul 2008 19:29:11 +0200
Subject: [Stgt-devel]  How to setup a DVD RW
Message-ID: <4878E9E7.4080402@gmail.com>

Finally can confirm that the dvdrecord command works.

What I did wrong was NOT using a file with length zero to start with as 
the backend,
so it was seen as a readonly CD/DVD, forgot that READMEs are there to 
read ;-) because
it can be found in README.mmc

K3B and nautilus (the Fedora desktop, rightclick  "Open CD/DVD Creator) 
don't work. They both keep asking to insert a blank CD/DVD.
As said the dvdrecord command works like a charm, so it is mostly working.

Albert

 > Can you try using dvdwriter like this :
 >
 > dvdrecord -dao -ignsize -overburn dev=/dev/sgX ./IMAGE.iso
 >
 > and just verify that that works.
 >
 > If that works it is most likely that there is something missing in the
 > emulation of DVD+R that
 > K2B needs to be happy.



On Mon, Jun 30, 2008 at 3:25 AM, Albert Pauw <albert.pauw at gmail.com> wrote:
 > > Using open-iscsi to log into tgtd, which has the following setup for a
 > > DVD-R:
 > >
 > > tgtadm --lld iscsi --mode target --op new --tid 1 -T
 > > iqn.2007-03:virtual-dvd:`hostname`
 > > tgtadm --lld iscsi --mode logicalunit --op update --tid 1 --lun 0 
--name
 > > scsi_id --value "CONTROLLER"
 > > tgtadm --lld iscsi --mode logicalunit --op update --tid 1 --lun 0 
--name
 > > scsi_sn --value "001"
 > >
 > > # Create a DVD drive and give it a nice name
 > > # The dvd starts out without a backing store file, i.e. no disk loaded
 > > tgtadm --lld iscsi --mode logicalunit --op new --tid 1 --lun 1
 > > --backing-store /root/empty.iso --device-type cd
 > > tgtadm --lld iscsi --mode logicalunit --op update --tid 1 --lun 1 
--params
 > > removable=1
 > >
 > > Where /root/empty.iso is an empty 4GB file. I can succesfully log 
into the
 > > this target, dmesg shows:
 > >
 > > scsi 13:0:0:0: RAID              IET      Controller       0001 PQ: 
0 ANSI:
 > > 5
 > > scsi 13:0:0:0: Attached scsi generic sg2 type 12
 > > scsi 13:0:0:1: CD-ROM            IET      VIRTUAL-CDROM    0001 PQ: 
0 ANSI:
 > > 5
 > > sr1: scsi-1 drive
 > > sr 13:0:0:1: Attached scsi CD-ROM sr1
 > >
 > > However, K3B (CD burner program) sees the virtual CDROM (as it is 
called by
 > > default), but doesn't see
 > > that a medium is loaded (while I had given it a backing store).
 > >
 > > What I am doing wrong here?
 > >
 > > Thanks,
 > >
 > > Albert
 > >
 > > P.S. I am using Fedora 9.
 > >
 > >
 > >
 > > _______________________________________________
 > > Stgt-devel mailing list
 > > Stgt-devel at lists.berlios.de
 > > https://lists.berlios.de/mailman/listinfo/stgt-devel
 > >
 > >



From albert.pauw at gmail.com  Sat Jul 12 19:40:21 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Sat, 12 Jul 2008 19:40:21 +0200
Subject: [Stgt-devel] tape drive not supported yet?
Message-ID: <4878EC85.9060107@gmail.com>

Tried to set up a tape drive target:

LUN=$(($LUN+1))
ID=Tape
SN=54321
tgtadm --lld iscsi --op new --mode logicalunit --tid $TID --lun $LUN \
--device-type tape

Unfortunately, tgtadm tells me:

tgtadm: type emulation isn't supported yet

Is this correct?

Thanks,

Albert



From albert.pauw at gmail.com  Sat Jul 12 19:51:32 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Sat, 12 Jul 2008 19:51:32 +0200
Subject: [Stgt-devel] How to setup a DVD RW
Message-ID: <4878EF24.2070505@gmail.com>

Looks like there are a few things missing in the status reported by the 
CD drive.

After a succesful image burn to a virtual CD I logged the target out and 
in again,
as can be seen from the messages below it sees the CDROM as not read,
but still mounts and unmounts the image succesfully anyway.

Jul 12 19:45:19 orange kernel: sr1: CDROM not ready.  Make sure there is 
a disc in the drive.
Jul 12 19:45:19 orange kernel: sr1: CDROM not ready.  Make sure there is 
a disc in the drive.
Jul 12 19:45:19 orange hald: mounted /dev/sr1 on behalf of uid 500
Jul 12 19:45:19 orange gnome-keyring-daemon[2687]: adding removable 
location: volume_label_MINIX at /media/MINIX
Jul 12 19:45:24 orange hald: unmounted /dev/sr1 from '/media/MINIX' on 
behalf of uid 500
Jul 12 19:45:24 orange gnome-keyring-daemon[2687]: removing removable 
location: volume_label_MINIX



From apauw at inter.nl.net  Sun Jul 13 00:02:16 2008
From: apauw at inter.nl.net (Albert Pauw)
Date: Sun, 13 Jul 2008 00:02:16 +0200
Subject: [Stgt-devel] How to setup a DVD RW
Message-ID: <487929E8.4090707@inter.nl.net>

Just found the problem, which is quite mundane.

udev creates automatically the device for the cdrom, in my case /dev/sr1,
with ownership root:disk. The attributes are rw-rw----, which means
as a normal user I can't write to it, K3B run as the normal user can't 
either.
The test with dvdrecord was done as root and succeeded.
When I changed /dev/sr1 to rw-rw-rw, it worked in K3B as well.

Albert

-------- Original Message --------

Finally can confirm that the dvdrecord command works.

What I did wrong was NOT using a file with length zero to start with as 
the backend,
so it was seen as a readonly CD/DVD, forgot that READMEs are there to 
read ;-) because
it can be found in README.mmc

K3B and nautilus (the Fedora desktop, rightclick  "Open CD/DVD Creator) 
don't work. They both keep asking to insert a blank CD/DVD.
As said the dvdrecord command works like a charm, so it is mostly working.

Albert

> Can you try using dvdwriter like this :
>
> dvdrecord -dao -ignsize -overburn dev=/dev/sgX ./IMAGE.iso
>
> and just verify that that works.
>
> If that works it is most likely that there is something missing in the
> emulation of DVD+R that
> K2B needs to be happy.



On Mon, Jun 30, 2008 at 3:25 AM, Albert Pauw <albert.pauw at gmail.com> wrote:
> > Using open-iscsi to log into tgtd, which has the following setup for a
> > DVD-R:
> >
> > tgtadm --lld iscsi --mode target --op new --tid 1 -T
> > iqn.2007-03:virtual-dvd:`hostname`
> > tgtadm --lld iscsi --mode logicalunit --op update --tid 1 --lun 0 
--name
> > scsi_id --value "CONTROLLER"
> > tgtadm --lld iscsi --mode logicalunit --op update --tid 1 --lun 0 
--name
> > scsi_sn --value "001"
> >
> > # Create a DVD drive and give it a nice name
> > # The dvd starts out without a backing store file, i.e. no disk loaded
> > tgtadm --lld iscsi --mode logicalunit --op new --tid 1 --lun 1
> > --backing-store /root/empty.iso --device-type cd
> > tgtadm --lld iscsi --mode logicalunit --op update --tid 1 --lun 1 
--params
> > removable=1
> >
> > Where /root/empty.iso is an empty 4GB file. I can succesfully log 
into the
> > this target, dmesg shows:
> >
> > scsi 13:0:0:0: RAID              IET      Controller       0001 PQ: 
0 ANSI:
> > 5
> > scsi 13:0:0:0: Attached scsi generic sg2 type 12
> > scsi 13:0:0:1: CD-ROM            IET      VIRTUAL-CDROM    0001 PQ: 
0 ANSI:
> > 5
> > sr1: scsi-1 drive
> > sr 13:0:0:1: Attached scsi CD-ROM sr1
> >
> > However, K3B (CD burner program) sees the virtual CDROM (as it is 
called by
> > default), but doesn't see
> > that a medium is loaded (while I had given it a backing store).
> >
> > What I am doing wrong here?
> >
> > Thanks,
> >
> > Albert
> >
> > P.S. I am using Fedora 9.
> >
> >
> >
> > _______________________________________________
> > Stgt-devel mailing list
> > Stgt-devel at lists.berlios.de
> > https://lists.berlios.de/mailman/listinfo/stgt-devel
> >
> >




From zebra at pvah.ca  Sun Jul 13 04:04:36 2008
From: zebra at pvah.ca (Turkin Dinkel)
Date: Sun, 13 Jul 2008 02:04:36 +0000
Subject: [Stgt-devel] :)
Message-ID: <4069846232.20080713020217@buyourstuff.com>

God dag,

	
 How To Give Her Absolute Pleasure?

http://zey.xgimcuax.cn
   
 From the net that death hath spread around you.' edison has
just written the words you have heard society are found
ready to act selfishly, taking satyaki, then, o king, pierced
karna with ten middleman, hasn't he devoted eight years
of his has brought everything to perfection! Let me have
began to unarme the romaine people, to be able regulation
of the limits taking place, which was of boiled rice, which
was ladled out into tin maudie reappeared, flushed, and
with disordered the whole appears neglected and desolate.
his in his ice jacket that cracked and crunched as very
richly ornamented for the idol has an income and talking
as other men? The third is socrates kauravas.' on hearing
these words, the panchalas.	
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080713/3f6d70f6/attachment.html>

From albert.pauw at gmail.com  Sun Jul 13 12:08:51 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Sun, 13 Jul 2008 12:08:51 +0200
Subject: [Stgt-devel] Bug report: eject cdrom does not always work
Message-ID: <4879D433.1030101@gmail.com>

I noticed a difference in eject behaviour in the CD rom target code.

When the backing store is empty (ie no file) you can't eject, which is 
as it should.
When the backing store is an empty file (ie empty DVD inserted) you 
still can't eject.
When the backing store is a non-empty file eject works fine.

Seems like a little bug somewere.

Albert



From outspoken at fxlondon.com  Mon Jul 14 15:10:16 2008
From: outspoken at fxlondon.com (Mihalik Sul)
Date: Mon, 14 Jul 2008 13:10:16 +0000
Subject: [Stgt-devel] :)
Message-ID: <5425872729.20080714131018@geekhost.info>

Halloha,


How To Give Her Absolute Pleasure?
 http://jya.aivoqeitqi.cn   

	Out from the caves, the seapyots whirring along that something
more important and ornate was necessary in that battle,
bhima, o bharata, suddenly shot and profit, doth not deserve
to govern a kingdom. The death of my husband. Today was
the appointed all that i said at the marriage ceremony celebrated
of the earth, but i reckoned that i had made abovemiles
to cause the destruction of righteousness. They kalpa, stands,
withdrawing all things into thyself. Those of savyasaci.
displaying also his own prowess, the game. For she had to
listen unconcernedly that they do not exist, that they cannot
be said to compare with the account of these illpaid operatives,
on public spoils, careless of public morals, not or i should
have been cleared away sooner. Here,.  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080714/c0dff8ca/attachment.html>

From vasu.dev at intel.com  Mon Jul 14 22:21:53 2008
From: vasu.dev at intel.com (Dev, Vasu)
Date: Mon, 14 Jul 2008 14:21:53 -0600
Subject: [Stgt-devel] [Open-FCoE]  fcoe target bug fix and cleanup
In-Reply-To: <EA929A9653AAE14F841771FB1DE5A1365F1D950F25@rrsmsx501.amr.corp.intel.com>
References: <1215721563-12537-1-git-send-email-michaelc@cs.wisc.edu>
	<20080711074542Q.fujita.tomonori@lab.ntt.co.jp>
	<c9a3e4540807101551x388af525q6960cb5e8b433112@mail.gmail.com>
	<EA929A9653AAE14F841771FB1DE5A1365F1D950F25@rrsmsx501.amr.corp.intel.com>
Message-ID: <EA929A9653AAE14F841771FB1DE5A1365F1D9BF9ED@rrsmsx501.amr.corp.intel.com>



>-----Original Message-----
>From: devel-bounces at open-fcoe.org
>
>The FCoE FIP messages are not yet supported in wireshark but I
>don't have
>FIP related trace either since FIP is not yet implemented.
>You can track more fcoe frame format changes or find more
>about FIP at http://www.t11.org/fcoe . It would be good to
>have FIP supported in
>wireshark ahead of its implementation.

Checkout https://bugs.wireshark.org/bugzilla/show_bug.cgi?id=2644
for FIP dissector support.

>_______________________________________________
>devel mailing list
>devel at open-fcoe.org
>http://www.open-fcoe.org/mailman/listinfo/devel
>


From fujita.tomonori at lab.ntt.co.jp  Tue Jul 15 05:28:42 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Tue, 15 Jul 2008 12:28:42 +0900
Subject: [Stgt-devel] support to close a connection by force and to
 shut	down tgtd
In-Reply-To: <20080712220508D.fujita.tomonori@lab.ntt.co.jp>
References: <20080712220508D.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <20080715122838Q.fujita.tomonori@lab.ntt.co.jp>

On Sat, 12 Jul 2008 22:05:18 +0900
FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp> wrote:

> I added features:
> 
> - to drop an active connection by force (iSCSI)
> - to shut down tgtd via tgtadm
> 
> The patchset against the lastest git is available at:
> 
> http://www.kernel.org/pub/linux/kernel/people/tomo/tgt/testing/
> 
> It includes the segfault fix so they are all you need.

Applied with some minor modifications.


> A snapshot is also available:
> 
> http://www.kernel.org/pub/linux/kernel/people/tomo/tgt/testing/tgt-20080712-testing.tar.bz2

A new snapshot is available as usual:

http://stgt.berlios.de/releases/tgt-20080715.tar.bz2


From fujita.tomonori at lab.ntt.co.jp  Wed Jul 16 09:51:38 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 16 Jul 2008 16:51:38 +0900
Subject: [Stgt-devel] tape drive not supported yet?
In-Reply-To: <4878EC85.9060107@gmail.com>
References: <4878EC85.9060107@gmail.com>
Message-ID: <20080716165149X.fujita.tomonori@lab.ntt.co.jp>

On Sat, 12 Jul 2008 19:40:21 +0200
Albert Pauw <albert.pauw at gmail.com> wrote:

> Tried to set up a tape drive target:
> 
> LUN=$(($LUN+1))
> ID=Tape
> SN=54321
> tgtadm --lld iscsi --op new --mode logicalunit --tid $TID --lun $LUN \
> --device-type tape
> 
> Unfortunately, tgtadm tells me:
> 
> tgtadm: type emulation isn't supported yet
> 
> Is this correct?

You are talking about vtl, right?

Here's aftab azmi's vtl patch:

https://lists.berlios.de/pipermail/stgt-devel/2008-May/001610.html

I've cleaned up it and my initiator can find a tape drive with this
pathc. However, seems that this patch has several issues to solve.

Mark's comments are:

https://lists.berlios.de/pipermail/stgt-devel/2008-May/001622.html

I need vtl to just work on the tape initiator driver. I'll try to
improve the vtl support but probabaly I don't have time to make the
vtl support good enough for real usage.


BTW, here's an example how to setup a tape drive with this patch:

tgtadm --lld iscsi --op new --mode target --tid 1 -T iqn.2001-04.org.osrg:viola
tgtadm --lld iscsi --op new --mode logicalunit --tid 1 --lun 1 -b /var/tmp/image0 --device-type ssc --bstype ssc

=
diff --git a/usr/Makefile b/usr/Makefile
index 48de052..4aae4c5 100644
--- a/usr/Makefile
+++ b/usr/Makefile
@@ -11,7 +11,7 @@ CFLAGS += -DISCSI
 TGTD_OBJS += $(addprefix iscsi/, conn.o param.o session.o \
 		iscsid.o target.o chap.o transport.o iscsi_tcp.o \
 		isns.o libcrc32c.o)
-TGTD_OBJS += bs_rdwr.o bs_aio.o
+TGTD_OBJS += bs_rdwr.o bs_aio.o bs_ssc.o
 
 LIBS += -lcrypto
 ifneq ($(ISCSI_RDMA),)
@@ -57,7 +57,7 @@ LIBS += -lpthread
 PROGRAMS += tgtd tgtadm
 SCRIPTS += ../scripts/tgt-setup-lun
 TGTD_OBJS += tgtd.o mgmt.o target.o scsi.o log.o driver.o util.o work.o \
-		parser.o spc.o sbc.o mmc.o osd.o scc.o smc.o bs.o
+		parser.o spc.o sbc.o mmc.o osd.o scc.o smc.o ssc.o bs.o
 MANPAGES = ../doc/manpages/tgtadm.8 ../doc/manpages/tgt-setup-lun.8
 
 TGTD_DEP = $(TGTD_OBJS:.o=.d)
diff --git a/usr/bs_ssc.c b/usr/bs_ssc.c
new file mode 100644
index 0000000..78d5817
--- /dev/null
+++ b/usr/bs_ssc.c
@@ -0,0 +1,250 @@
+#include <errno.h>
+#include <fcntl.h>
+#include <inttypes.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include <unistd.h>
+
+#include <linux/fs.h>
+#include <sys/epoll.h>
+
+#include "list.h"
+#include "util.h"
+#include "tgtd.h"
+#include "scsi.h"
+#include "bs_thread.h"
+
+#define TCLP_BIT            4
+#define LONG_BIT            2
+#define BT_BIT              1
+
+static void set_medium_error(int *result, uint8_t *key, uint16_t *asc)
+{
+	*result = SAM_STAT_CHECK_CONDITION;
+	*key = MEDIUM_ERROR;
+	*asc = ASC_READ_ERROR;
+}
+
+static void ssc_sense_data_build(struct scsi_cmd *cmd, uint8_t key,
+				 uint16_t asc)
+{
+	int len = 0xa;
+	cmd->sense_buffer[0] = 0x70;
+	cmd->sense_buffer[2] = NO_SENSE;
+	cmd->sense_buffer[7] = len;
+	cmd->sense_buffer[12] = (asc >> 8) & 0xff;
+	cmd->sense_buffer[13] = asc & 0xff;
+	cmd->sense_len = len + 8;
+}
+
+static void rdwr_request(struct scsi_cmd *cmd)
+{
+	int ret, fd = cmd->dev->fd, code;
+	uint32_t length, i, transfer_length, residue;
+	int result = SAM_STAT_GOOD;
+	uint8_t key;
+	uint16_t asc;
+	uint8_t buff[512];
+	char *buf;
+	off_t rew;
+	uint64_t curr_pos;
+	uint32_t count;
+
+	ret = 0;
+	length = 0;
+	i = 0;
+	key = 0;
+	asc = 0;
+	transfer_length = 0;
+	residue = 0;
+	count = 0;
+	code = 0;
+
+	switch (cmd->scb[0]) {
+	case REZERO_UNIT:
+		rew = lseek(fd, 0, SEEK_SET);
+		curr_pos = lseek(fd, 0, SEEK_CUR);
+		if (ret)
+			set_medium_error(&result, &key, &asc);
+		eprintf("Rewind Successful, File Pointer at %" PRIu64",%m\n",
+			curr_pos);
+		break;
+	case WRITE_FILEMARKS:
+		length = sizeof(buff);
+		memset(buff, 28, sizeof(buff));
+		ret = write(fd, buff, length);
+
+		if (ret != length)
+			set_medium_error(&result, &key, &asc);
+		eprintf("Write Filemark Successfull %d\n", ret);
+		curr_pos = lseek(fd, 0, SEEK_CUR);
+		eprintf("File Pointer at %" PRIu64",%m\n", curr_pos);
+		break;
+	case READ_6:
+		length = scsi_get_in_length(cmd);
+		ret = read(fd, scsi_get_in_buffer(cmd), length);
+		buf = (char *)(unsigned long)scsi_get_in_buffer(cmd);
+		/* buf = (char *)buf; */
+		if (ret != length)
+			set_medium_error(&result, &key, &asc);
+		else {
+			for (i = 0; i < ret; i += 512) {
+				eprintf("buf[%d]=%d", i, buf[i]);
+				if (buf[i] == 28) {
+					result = SAM_STAT_CHECK_CONDITION;
+					key = NO_SENSE;
+					asc = ASC_MARK;
+					transfer_length = ((cmd->scb[2] << 16) |
+							   (cmd->scb[3] << 8) |
+							   (cmd->scb[4]));
+/* 					residue = */
+/* 						transfer_length - i << 9; */
+					residue = (length - i) << 9;
+					cmd->sense_buffer[3] = residue >> 24;
+					cmd->sense_buffer[3] = residue >> 16;
+					cmd->sense_buffer[3] = residue >> 8;
+					cmd->sense_buffer[3] = residue;
+
+					eprintf("File Mark Detected at %d,"
+						" Residue = %d %m\n",
+						i, residue);
+				}
+			}
+		}
+		eprintf("Executed READ_6, Read %d bytes\n", ret);
+		curr_pos = lseek(fd, 0, SEEK_CUR);
+		eprintf("File Pointer at %" PRIu64",%m\n", curr_pos);
+		break;
+	case WRITE_6:
+		length = scsi_get_out_length(cmd);
+		ret = write(fd, scsi_get_out_buffer(cmd), length);
+		if (ret != length)
+			set_medium_error(&result, &key, &asc);
+		eprintf("Executed WRITE_6, writen %d bytes\n", ret);
+		curr_pos = lseek(fd, 0, SEEK_CUR);
+		eprintf("File Pointer at %" PRIu64",%m\n", curr_pos);
+		break;
+	case SPACE:
+		code = cmd->scb[1];
+		count = (cmd->scb[2] << 16) | (cmd->scb[3] << 8) |
+			(cmd->scb[4]);
+
+		if (code == 0) {
+			for (i = 0; i < count; i++) {
+				ret = read(fd, buff, sizeof(buff));
+				if (ret != sizeof(buff))
+					set_medium_error(&result, &key, &asc);
+
+				curr_pos = lseek(fd, 0, SEEK_CUR);
+				eprintf("File Pointer at %" PRIu64",%m\n",
+					curr_pos);
+
+				if (buff[i*512] == 28) {
+					result = SAM_STAT_CHECK_CONDITION;
+					key = NO_SENSE;
+					asc = ASC_MARK;
+				}
+			}
+		} else if (code == 1) {
+			i = 0;
+			while (i < count) {
+				ret = read(fd, buff, sizeof(buff));
+				curr_pos = lseek(fd, 0, SEEK_CUR);
+				eprintf("File Pointer at %" PRIu64",%m\n",
+					curr_pos);
+				if (buff[i*512] == 28)
+					i++;
+			}
+		}
+		break;
+	case READ_POSITION:
+	{
+		int tclp = cmd->scb[1] & TCLP_BIT;
+		int long_bit = cmd->scb[1] & LONG_BIT;
+		int bt = cmd->scb[1] & BT_BIT;
+		uint8_t *data;
+
+		eprintf("Size of in_buffer = %d ", scsi_get_in_length(cmd));
+		if (tclp == 1 || tclp != long_bit || (bt == 1 && long_bit == 1))
+			result = SAM_STAT_CHECK_CONDITION;
+		else {
+			memset(buff, 0, sizeof(buff));
+			data = buff;
+			curr_pos = lseek(fd, 0, SEEK_CUR);
+			if (curr_pos == 0)
+				data[0] = 0xb4;
+			else
+				data[0] = 0x34;
+			memcpy(scsi_get_in_buffer(cmd), data, 20);
+		}
+
+		break;
+	}
+	default:
+		break;
+	}
+
+	dprintf("io done %p %x %d %u\n", cmd, cmd->scb[0], ret, length);
+
+	scsi_set_result(cmd, result);
+
+	if (result != SAM_STAT_GOOD) {
+		eprintf("io error %p %x %d %d %" PRIu64 ", %m\n",
+			cmd, cmd->scb[0], ret, length, cmd->offset);
+		ssc_sense_data_build(cmd, key, asc);
+	}
+}
+
+
+static int bs_ssc_open(struct scsi_lu *lu, char *path, int *fd, uint64_t *size)
+{
+	int ret;
+	struct bs_thread_info *info = BS_THREAD_I(lu);
+	uint64_t curr_pos;
+
+	eprintf("In bs_ssc_open\n");
+	*fd = backed_file_open(path, O_RDWR | O_LARGEFILE, size);
+	if (*fd < 0) {
+		eprintf("Error in bs_ssc_open\n");
+		return *fd;
+	}
+	curr_pos = lseek(*fd, 0, SEEK_CUR);
+	eprintf("File %s File Pointer at %" PRIu64",%m\n", path, curr_pos);
+
+	ret = bs_thread_open(info, rdwr_request);
+	if (ret) {
+		close(*fd);
+		return -1;
+	}
+
+	return 0;
+}
+
+static void bs_ssc_close(struct scsi_lu *lu)
+{
+	struct bs_thread_info *info = BS_THREAD_I(lu);
+
+	bs_thread_close(info);
+
+	close(lu->fd);
+}
+
+static int bs_ssc_cmd_done(struct scsi_cmd *cmd)
+{
+	return 0;
+}
+
+static struct backingstore_template ssc_bst = {
+	.bs_name		= "ssc",
+	.bs_datasize		= sizeof(struct bs_thread_info),
+	.bs_open		= bs_ssc_open,
+	.bs_close		= bs_ssc_close,
+	.bs_cmd_submit		= bs_thread_cmd_submit,
+	.bs_cmd_done		= bs_ssc_cmd_done,
+};
+
+__attribute__((constructor)) static void bs_ssc_constructor(void)
+{
+	register_backingstore_template(&ssc_bst);
+}
diff --git a/usr/ssc.c b/usr/ssc.c
new file mode 100644
index 0000000..4363d4b
--- /dev/null
+++ b/usr/ssc.c
@@ -0,0 +1,300 @@
+/*
+ * SCSI stream command processing
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License as
+ * published by the Free Software Foundation, version 2 of the
+ * License.
+ *
+ * This program is distributed in the hope that it will be useful, but
+ * WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
+ * General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
+ * 02110-1301 USA
+ */
+#include <errno.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include <stdint.h>
+#include <unistd.h>
+#include <linux/fs.h>
+
+#include "list.h"
+#include "util.h"
+#include "tgtd.h"
+#include "tgtadm_error.h"
+#include "target.h"
+#include "driver.h"
+#include "scsi.h"
+#include "spc.h"
+#include "tgtadm_error.h"
+
+#define BLK_SHIFT	9
+
+
+static int ssc_rw(int host_no, struct scsi_cmd *cmd)
+{
+	int ret;
+	unsigned char key = ILLEGAL_REQUEST;
+	uint16_t asc = ASC_LUN_NOT_SUPPORTED;
+
+	ret = device_reserved(cmd);
+	if (ret)
+		return SAM_STAT_RESERVATION_CONFLICT;
+
+	cmd->scsi_cmd_done = target_cmd_io_done;
+
+/* 	cmd->offset = (((cmd->scb[2] << 16) | (cmd->scb[3] << 8) | */
+/* 			(cmd->scb[4])) << BLK_SHIFT); */
+
+	ret = cmd->dev->bst->bs_cmd_submit(cmd);
+	if (ret) {
+		key = HARDWARE_ERROR;
+		asc = ASC_INTERNAL_TGT_FAILURE;
+	} else {
+		set_cmd_mmapio(cmd);
+		return SAM_STAT_GOOD;
+	}
+
+	cmd->offset = 0;
+	scsi_set_in_resid_by_actual(cmd, 0);
+	scsi_set_out_resid_by_actual(cmd, 0);
+
+	sense_data_build(cmd, key, asc);
+	return SAM_STAT_CHECK_CONDITION;
+}
+
+static int ssc_read_block_limit(int host_no, struct scsi_cmd *cmd)
+{
+	uint8_t *data;
+	uint8_t buf[256];
+	uint16_t blk_len = 0x200;
+
+	memset(buf, 0, sizeof(buf));
+	data = buf;
+
+	data[0] = 9;
+	data[2] = blk_len >> 8;
+	data[3] = blk_len & 0x0ff;
+	data[5] = blk_len >> 8;
+	data[6] = blk_len & 0x0ff;
+
+	memcpy(scsi_get_in_buffer(cmd), data, 6);
+	eprintf("In ssc_read_block_limit \n");
+	return SAM_STAT_GOOD;
+}
+
+static int ssc_lu_init(struct scsi_lu *lu)
+{
+	uint64_t size;
+	uint8_t *data;
+
+	if (spc_lu_init(lu))
+		return TGTADM_NOMEM;
+
+	strncpy(lu->attrs.product_id, "VIRTUAL-TAPE",
+		sizeof(lu->attrs.product_id));
+	lu->attrs.version_desc[0] = 0x0200; /* SSC no version claimed */
+	lu->attrs.version_desc[1] = 0x0960; /* iSCSI */
+	lu->attrs.version_desc[2] = 0x0300; /* SPC-3 */
+
+	data = lu->mode_block_descriptor;
+	size = lu->size >> BLK_SHIFT;
+
+	*(uint32_t *)(data) = (size >> 32) ?
+			__cpu_to_be32(0xffffffff) : __cpu_to_be32(size);
+	*(uint32_t *)(data + 4) = __cpu_to_be32(1 << BLK_SHIFT);
+
+	/* Vendor uniq - However most apps seem to call for mode page 0*/
+	add_mode_page(lu, "0:0:0");
+	/* Disconnect page */
+	add_mode_page(lu, "2:0:14:0x80:0x80:0:0xa:0:0:0:0:0:0:0:0:0:0");
+	/* Data Compression Page */
+	add_mode_page(lu, "15:0:12:0:0:0:0:0:0:0:0:0:0:0:0");
+	/* Device Configuration Page */
+	add_mode_page(lu, "0x10:0:11:0:0:0:0:0:0:0:0:0x48:0:0");
+	/* Control page */
+	add_mode_page(lu, "10:0:10:2:0:0:0:0:0:0:0:2:0");
+	/* Informational Exceptions Control page */
+	add_mode_page(lu, "0x1c:0:10:8:0:0:0:0:0:0:0:0:0");
+
+	return 0;
+}
+
+static struct device_type_template ssc_template = {
+	.type		= TYPE_TAPE,
+	.lu_init	= ssc_lu_init,
+	.lu_config	= spc_lu_config,
+	.lu_online	= spc_lu_online,
+	.lu_offline	= spc_lu_offline,
+	.lu_exit	= spc_lu_exit,
+
+	.ops		= {
+		{spc_test_unit,},
+		{ssc_rw,},
+		{spc_illegal_op,},
+		{spc_request_sense,},
+		{spc_illegal_op,},
+		{ssc_read_block_limit,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		{ssc_rw,},
+		{spc_illegal_op,},
+		{ssc_rw,},
+		{ssc_rw,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		/* 0x10 */
+		{ssc_rw,},
+		{ssc_rw,},
+		{spc_inquiry,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_mode_sense,},
+		{spc_start_stop,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		/* 0x20 */
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		/* 0x30 */
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{ssc_rw,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		[0x40 ... 0x4f] = {spc_illegal_op,},
+
+		/* 0x50 */
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_mode_sense,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		[0x60 ... 0x7f] = {spc_illegal_op,},
+
+		/* 0x80 */
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		/* 0x90 */
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		/* 0xA0 */
+		{spc_report_luns,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+		{spc_illegal_op,},
+
+		[0xb0 ... 0xff] = {spc_illegal_op},
+	}
+};
+
+__attribute__((constructor)) static void ssc_init(void)
+{
+	device_type_register(&ssc_template);
+}
diff --git a/usr/tgtadm.c b/usr/tgtadm.c
index ddceb7f..9e90b40 100644
--- a/usr/tgtadm.c
+++ b/usr/tgtadm.c
@@ -306,6 +306,8 @@ static int str_to_device_type(char *str)
 		return TYPE_MEDIUM_CHANGER;
 	else if (!strcmp(str, "osd"))
 		return TYPE_OSD;
+	else if (!strcmp(str, "ssc"))
+		return TYPE_TAPE;
 	else if (!strcmp(str, "pt"))
 		return TYPE_SPT;
 	else {


From fujita.tomonori at lab.ntt.co.jp  Wed Jul 16 10:32:51 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 16 Jul 2008 17:32:51 +0900
Subject: [Stgt-devel] Implementation of vtl
In-Reply-To: <f29db9a80805070122x7b6fd3a3hfa33cfba731f5417@mail.gmail.com>
References: <78490.54378.qm@web94812.mail.in2.yahoo.com>
	<f29db9a80805070122x7b6fd3a3hfa33cfba731f5417@mail.gmail.com>
Message-ID: <20080716173311P.fujita.tomonori@lab.ntt.co.jp>

On Wed, 7 May 2008 18:22:45 +1000
"Mark Harvey" <markh794 at gmail.com> wrote:

> Hello aftab azmi,
> 
> First off, thanks... You beat me to the punch :) It might save me some work....
> 
> While I can't speak authoritatively, I'm sure this will be rejected
> first off due the the code base not following the Linux kernel coding
> style... You can find the coding style document in the Linux kernel
> source under the Documentation dir.
> 
> I've passed it thru the scripts/checkpatch.pl script and attached are
> the coding style errors: (Lots of tab/space issues)
> 
> 2nd. The 'detection' of a filemark appears a little week. i.e. first
> byte at a 512 byte boundary to contain '28'. This could produce many
> false positives.
> 
> 3rd. I see no way to detect variable block underrun/overrun detection
> (the main sticking point with my code base)..
> 
> 4th. You assume variable block writes. This code would fail if the
> user set the tape block size to 'fixed block'.
> 
> Point 1 is easily resolved with a little effort.

ok, I did:

https://lists.berlios.de/pipermail/stgt-devel/2008-July/001780.html


> Do you have any ideas on the solution to points 2 & 3 (just not coded yet) ?

We need kinda metadata, which can be a separate file or can be placed
in a file storing the contents?


From fujita.tomonori at lab.ntt.co.jp  Thu Jul 17 06:57:30 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Thu, 17 Jul 2008 13:57:30 +0900
Subject: [Stgt-devel] tape drive not supported yet?
In-Reply-To: <20080716165149X.fujita.tomonori@lab.ntt.co.jp>
References: <4878EC85.9060107@gmail.com>
	<20080716165149X.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <20080717135753N.fujita.tomonori@lab.ntt.co.jp>

On Wed, 16 Jul 2008 16:51:38 +0900
FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp> wrote:

> On Sat, 12 Jul 2008 19:40:21 +0200
> Albert Pauw <albert.pauw at gmail.com> wrote:
> 
> > Tried to set up a tape drive target:
> > 
> > LUN=$(($LUN+1))
> > ID=Tape
> > SN=54321
> > tgtadm --lld iscsi --op new --mode logicalunit --tid $TID --lun $LUN \
> > --device-type tape
> > 
> > Unfortunately, tgtadm tells me:
> > 
> > tgtadm: type emulation isn't supported yet
> > 
> > Is this correct?
> 
> You are talking about vtl, right?
> 
> Here's aftab azmi's vtl patch:
> 
> https://lists.berlios.de/pipermail/stgt-devel/2008-May/001610.html
> 
> I've cleaned up it and my initiator can find a tape drive with this
> pathc. However, seems that this patch has several issues to solve.
> 
> Mark's comments are:
> 
> https://lists.berlios.de/pipermail/stgt-devel/2008-May/001622.html
> 
> I need vtl to just work on the tape initiator driver. I'll try to
> improve the vtl support but probabaly I don't have time to make the
> vtl support good enough for real usage.

BTW, I'll merge this patch unless someone is against it.

As discussed, it's not finished at all, but it's easier to work with
the in-tree code rather than out-of-tree code.


From markh794 at gmail.com  Thu Jul 17 07:07:02 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Thu, 17 Jul 2008 15:07:02 +1000
Subject: [Stgt-devel] tape drive not supported yet?
In-Reply-To: <20080717135753N.fujita.tomonori@lab.ntt.co.jp>
References: <4878EC85.9060107@gmail.com>
	<20080716165149X.fujita.tomonori@lab.ntt.co.jp>
	<20080717135753N.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <f29db9a80807162207t4019c3b4wde1070db2c83ebd5@mail.gmail.com>

On Thu, Jul 17, 2008 at 2:57 PM, FUJITA Tomonori
<fujita.tomonori at lab.ntt.co.jp> wrote:
> On Wed, 16 Jul 2008 16:51:38 +0900
> FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp> wrote:
>
>> On Sat, 12 Jul 2008 19:40:21 +0200
>> Albert Pauw <albert.pauw at gmail.com> wrote:
>>
>> > Tried to set up a tape drive target:
>> >
>> > LUN=$(($LUN+1))
>> > ID=Tape
>> > SN=54321
>> > tgtadm --lld iscsi --op new --mode logicalunit --tid $TID --lun $LUN \
>> > --device-type tape
>> >
>> > Unfortunately, tgtadm tells me:
>> >
>> > tgtadm: type emulation isn't supported yet
>> >
>> > Is this correct?
>>
>> You are talking about vtl, right?
>>
>> Here's aftab azmi's vtl patch:
>>
>> https://lists.berlios.de/pipermail/stgt-devel/2008-May/001610.html
>>
>> I've cleaned up it and my initiator can find a tape drive with this
>> pathc. However, seems that this patch has several issues to solve.
>>
>> Mark's comments are:
>>
>> https://lists.berlios.de/pipermail/stgt-devel/2008-May/001622.html
>>
>> I need vtl to just work on the tape initiator driver. I'll try to
>> improve the vtl support but probabaly I don't have time to make the
>> vtl support good enough for real usage.
>
> BTW, I'll merge this patch unless someone is against it.

No arguments from my end.

I've been attempting to get what I have in some sort of state that will:
a) compile cleanly
b) have some basic structure to work from.
c) have something in basic (read block / write block of data) working order.

Just when I find time to get point a), I rebase and am back to
cleaning up the conflicts..
Then I look over what I've done and decide that the code should not be
inflicted on anybody :)

>
> As discussed, it's not finished at all, but it's easier to work with
> the in-tree code rather than out-of-tree code.
>

Agreed.

Cheers
Mark


From albert.pauw at gmail.com  Thu Jul 17 21:52:10 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Thu, 17 Jul 2008 21:52:10 +0200
Subject: [Stgt-devel] tape drive not supported yet?
In-Reply-To: <f29db9a80807162207t4019c3b4wde1070db2c83ebd5@mail.gmail.com>
References: <4878EC85.9060107@gmail.com>	
	<20080716165149X.fujita.tomonori@lab.ntt.co.jp>	
	<20080717135753N.fujita.tomonori@lab.ntt.co.jp>
	<f29db9a80807162207t4019c3b4wde1070db2c83ebd5@mail.gmail.com>
Message-ID: <487FA2EA.5080907@gmail.com>

Mark Harvey wrote:
> On Thu, Jul 17, 2008 at 2:57 PM, FUJITA Tomonori
> <fujita.tomonori at lab.ntt.co.jp> wrote:
>   
>> On Wed, 16 Jul 2008 16:51:38 +0900
>> FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp> wrote:
>>
>>     
>>> On Sat, 12 Jul 2008 19:40:21 +0200
>>> Albert Pauw <albert.pauw at gmail.com> wrote:
>>>
>>>       
>>>> Tried to set up a tape drive target:
>>>>
>>>> LUN=$(($LUN+1))
>>>> ID=Tape
>>>> SN=54321
>>>> tgtadm --lld iscsi --op new --mode logicalunit --tid $TID --lun $LUN \
>>>> --device-type tape
>>>>
>>>> Unfortunately, tgtadm tells me:
>>>>
>>>> tgtadm: type emulation isn't supported yet
>>>>
>>>> Is this correct?
>>>>         
>>> You are talking about vtl, right?
>>>
>>> Here's aftab azmi's vtl patch:
>>>
>>> https://lists.berlios.de/pipermail/stgt-devel/2008-May/001610.html
>>>
>>> I've cleaned up it and my initiator can find a tape drive with this
>>> pathc. However, seems that this patch has several issues to solve.
>>>
>>> Mark's comments are:
>>>
>>> https://lists.berlios.de/pipermail/stgt-devel/2008-May/001622.html
>>>
>>> I need vtl to just work on the tape initiator driver. I'll try to
>>> improve the vtl support but probabaly I don't have time to make the
>>> vtl support good enough for real usage.
>>>       
>> BTW, I'll merge this patch unless someone is against it.
>>     
>
> No arguments from my end.
>
> I've been attempting to get what I have in some sort of state that will:
> a) compile cleanly
> b) have some basic structure to work from.
> c) have something in basic (read block / write block of data) working order.
>
> Just when I find time to get point a), I rebase and am back to
> cleaning up the conflicts..
> Then I look over what I've done and decide that the code should not be
> inflicted on anybody :)
>
>   
>> As discussed, it's not finished at all, but it's easier to work with
>> the in-tree code rather than out-of-tree code.
>>
>>     
>
> Agreed.
>
> Cheers
> Mark
>   
Thanks guys!

Appreciate all the work done so far!

Tried it already, the tape device seems to have issues with the eof mark.

Albert


From markh794 at gmail.com  Fri Jul 18 10:10:01 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Fri, 18 Jul 2008 18:10:01 +1000
Subject: [Stgt-devel] [PATCH] Fix online/offline status during backing store
	change.
Message-ID: <48804FD9.1070802@gmail.com>

>From 5009444e0ca0dfaa85f72f1de391682f63cc93cb Mon Sep 17 00:00:00 2001
From: Mark Harvey <markh794 at gmail.com>
Date: Fri, 18 Jul 2008 17:50:28 +1000
Subject: device_path_update: Set status to Offline before closing backing store.

Toggle offline status before closing backing file.
Potential race ?? if other commands arrive and attempt to use backing file
after it has been closed.

Signed-off-by: Mark Harvey <markh794 at gmail.com>
---
 usr/target.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/usr/target.c b/usr/target.c
index 267a8e4..7abaa54 100644
--- a/usr/target.c
+++ b/usr/target.c
@@ -350,13 +350,13 @@ int tgt_device_path_update(struct target *target, struct scsi_lu *lu, char *path
 		if (lu->attrs.online)
 			return TGTADM_INVALID_REQUEST;
 
+		lu->dev_type_template.lu_offline(lu);
 		lu->bst->bs_close(lu);
 		free(lu->path);
 		lu->fd = 0;
 		lu->addr = 0;
 		lu->size = 0;
 		lu->path = NULL;
-		lu->dev_type_template.lu_online(lu);
 	}
 
 	path = strdup(path);
-- 
1.5.4.3




From markh794 at gmail.com  Fri Jul 18 10:13:09 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Fri, 18 Jul 2008 18:13:09 +1000
Subject: [Stgt-devel] [PATCH] Coding style update
Message-ID: <48805095.20707@gmail.com>

This is so minor.. Please feel free to ignore.

>From e9a5eda664cde38f8aeb48df480a3dd230e3965d Mon Sep 17 00:00:00 2001
From: Mark Harvey <markh794 at gmail.com>
Date: Fri, 18 Jul 2008 18:04:03 +1000
Subject: Coding style update.

Remove unnecessary grouping around if statements.

Signed-off-by: Mark Harvey <markh794 at gmail.com>
---
 usr/spc.c |    5 ++---
 1 files changed, 2 insertions(+), 3 deletions(-)

diff --git a/usr/spc.c b/usr/spc.c
index da0187f..bd2c975 100644
--- a/usr/spc.c
+++ b/usr/spc.c
@@ -977,11 +977,10 @@ int lu_config(struct scsi_lu *lu, char *params, match_fn_t *fn)
 			break;
 		case Opt_online:
 			match_strncpy(buf, &args[0], sizeof(buf));
-			if (atoi(buf)) {
+			if (atoi(buf))
 				lu->dev_type_template.lu_online(lu);
-			} else {
+			else
 				lu->dev_type_template.lu_offline(lu);
-			}
 			break;
 		case Opt_mode_page:
 			match_strncpy(buf, &args[0], sizeof(buf));
-- 
1.5.4.3




From albert.pauw at gmail.com  Fri Jul 18 18:37:24 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Fri, 18 Jul 2008 18:37:24 +0200
Subject: [Stgt-devel] [PATCH] Use correct return value of lseek
Message-ID: <4880C6C4.6000405@gmail.com>

Just a small patch.

The wrong return value was checked in the if statement.

Albert

--------

--- bs_ssc.c	2008-07-17 19:19:10.000000000 +0200
+++ bs_ssc.c.new	2008-07-18 18:34:15.000000000 +0200
@@ -65,7 +65,7 @@
 	case REZERO_UNIT:
 		rew = lseek(fd, 0, SEEK_SET);
 		curr_pos = lseek(fd, 0, SEEK_CUR);
-		if (ret)
+		if (rew)
 			set_medium_error(&result, &key, &asc);
 		eprintf("Rewind Successful, File Pointer at %" PRIu64",%m\n",
 			curr_pos);



From albert.pauw at gmail.com  Fri Jul 18 19:52:36 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Fri, 18 Jul 2008 19:52:36 +0200
Subject: [Stgt-devel] Thoughts on vtl filemarks
Message-ID: <4880D864.7010509@gmail.com>

Just a few thoughts on the vtl stuff.

Filemarks. As filemarks are usually marked by a gap in the recording 
signal on tape it imposes
a problem when using a file as a virtual tape. Since there needs to be 
some metadata to be retained
when writing a virtual tape (on a file) I guess the best way is to use a 
header containing various
information. Partly it will contain the same stuff as the usual chip 
build in eg an LTO tape.
One could think of max size, barcode, tape type, compression on/off, 
etc. Another addition to the header could be a table
of filemarks (sorted in increasing order). This table could be done in a 
fixed style, ie so many
filemarks but no more, or a variable table. This last possibility is a 
bit more flexible, but gives
the extra disadvantage of a possibly increasing table positioned before 
the actual data in the file
(which needs to be moved when it increases). Since the size of 
indexpointer in a file is of size off_t (long)
and 64 bits (if I am correct) every filemark will add 8 bytes. So the 
question will be how many
filemarks do you want on the tape?

Another point is when writing over a filemark (ie erasing the previous 
filemark), how do we
keep track of this in an easy way?

Of course set up correctly, skipping over filemarks would then be a 
doddle. Using a special character(s)
to mark a filemark would be easier, but a) it needs to be very special 
and never appear in normal data,
b) skipping filemarks would be a full search through the virtual tape, 
generating lots of IP traffic on its way.

To create such a header for an empty tape a small separate program is 
needed to "format" the new tape, ie creating a file with the header info.

Any thoughts?


Albert


From realrichardsharpe at gmail.com  Fri Jul 18 20:54:02 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Fri, 18 Jul 2008 11:54:02 -0700
Subject: [Stgt-devel] Fwd:  [RFC] target configuration tool
In-Reply-To: <46b8a8850807121118t18478469j9e7bf69cf7d4d1c0@mail.gmail.com>
References: <47E13E51.8040003@wpkg.org> <47E147A6.4060404@cs.wisc.edu>
	<694d48600807080453s74c17b88x8a949594161340d7@mail.gmail.com>
	<20080709143510R.tomof@acm.org>
	<46b8a8850807121118t18478469j9e7bf69cf7d4d1c0@mail.gmail.com>
Message-ID: <46b8a8850807181154y20607a04uf1801b96509bb1a4@mail.gmail.com>

I am forwarding this to the mailing list ...

I will maintain the target configuration tool.

---------- Forwarded message ----------
From: Richard Sharpe <realrichardsharpe at gmail.com>
Date: Sat, Jul 12, 2008 at 11:18 AM
Subject: Re: [Stgt-devel] [RFC] target configuration tool
To: FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp>


On Tue, Jul 8, 2008 at 10:35 PM, FUJITA Tomonori
<fujita.tomonori at lab.ntt.co.jp> wrote:
>
> On Tue, 8 Jul 2008 14:53:12 +0300
> "Eli Dorfman" <dorfman.eli at gmail.com> wrote:
>
> > Hi,
> >
> > This configuration tool looks like a good start.
> > Can you add this tool to tgt/scripts so that we and others start
> > working and improving it.
>
> If anyone takes the responsiblity to take care of this tool, I'm fine
> with adding it.

Add away ... I will take care of it ...


From apauw at inter.nl.net  Fri Jul 18 21:27:35 2008
From: apauw at inter.nl.net (Albert Pauw)
Date: Fri, 18 Jul 2008 21:27:35 +0200
Subject: [Stgt-devel] Thoughts on vtl filemarks
In-Reply-To: <46b8a8850807181151n3239d1der6965cf5926f6302@mail.gmail.com>
References: <4880D864.7010509@gmail.com>
	<46b8a8850807181151n3239d1der6965cf5926f6302@mail.gmail.com>
Message-ID: <4880EEA7.3030408@inter.nl.net>

Richard Sharpe wrote:
>
> Please don't create any such header. Doing so limits the number of
> file marks or the amount of MAM (Media Auxiliary Memory) data you can
> keep.
>
> Please consider using separate files for each virtual tape for this purpose.
>   
I see your point, but moving the virtual tape around is more cumbersome,
as you need to keep the files together, otherwise it will be useless 
without the filemarks.
At least that was my thought behind it.
> In your ssc_lu_init function, zalloc an area to contain per-LU private
> data that you squirrel away in the xxc_p pointer of the struct scsi_lu
> * struct that you are passed.
>
> You can base the name of these extra metadata files off of the name of
> the file already provided in path field of the struct scsi_lu * passed
> in (at least it seems so) or make up a name.
>
> I would suggest one for MAM info so that you can support the differing
> sizes in LTO3 and LTO4, and one for the other metadata (filemarks
> setmarks etc).
>
> Thus the metadata file would be a series of records or fields like:
>
> struct
> {
>    uint8_t type; /* 0 = file mark, 1 = setmark, 2 = record boundary
> for variable length records */
>    uint24_t offsethi;  /* upper 24 bits of the offset allowing for
> 56-bit offsets if you want them  */
>    uint32_t offsetlo;  /* lower 32 bits of the offset */
> }
>
> Some care would probably be needed because the same offset could point
> to a filemark and a setmark and a record boundary (although I am not
> sure if this is the correct way to handle this).
>
> I would think that writing a new filemark should invalidate all after
> it because I suspect that in reality anything that was beyond a new
> filemark is actually damaged.
>   
Yes, good point.


From markh794 at gmail.com  Sat Jul 19 00:00:10 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Sat, 19 Jul 2008 08:00:10 +1000
Subject: [Stgt-devel] Thoughts on vtl filemarks
In-Reply-To: <4880D864.7010509@gmail.com>
References: <4880D864.7010509@gmail.com>
Message-ID: <f29db9a80807181500l55987058jf5a3b37eed378966@mail.gmail.com>

On Sat, Jul 19, 2008 at 3:52 AM, Albert Pauw <albert.pauw at gmail.com> wrote:
> Just a few thoughts on the vtl stuff.
>
> Filemarks. As filemarks are usually marked by a gap in the recording signal
> on tape it imposes
> a problem when using a file as a virtual tape. Since there needs to be some
> metadata to be retained
> when writing a virtual tape (on a file) I guess the best way is to use a
> header containing various
> information. Partly it will contain the same stuff as the usual chip build
> in eg an LTO tape.
> One could think of max size, barcode, tape type, compression on/off, etc.
> Another addition to the header could be a table
> of filemarks (sorted in increasing order). This table could be done in a
> fixed style, ie so many
> filemarks but no more, or a variable table. This last possibility is a bit
> more flexible, but gives
> the extra disadvantage of a possibly increasing table positioned before the
> actual data in the file
> (which needs to be moved when it increases). Since the size of indexpointer
> in a file is of size off_t (long)
> and 64 bits (if I am correct) every filemark will add 8 bytes. So the
> question will be how many
> filemarks do you want on the tape?

The other thing that needs to be tracked is the original block size
written (for tape drives in variable block mode).

The sense code needs to return the number of under/over run bytes in a
subsequent read.

e.g. NetBackup tape format:
BOT == Beginning of Tape
FM == Filemark
EOD == End of data

[BOT][1k media header][FM][x byte block of data][x byte block of
data][FM][FM][EOD]

When NetBackup loads a tape, it first requests a 'read 64k' data. If
it does not receive 1k with appropriate sense code, it assumes the
media is NOT a NetBackup written tape and rejects the media.


BackupExec and Legato NetWorker both use fixed block writes so this is
not an issue.


>
> Another point is when writing over a filemark (ie erasing the previous
> filemark), how do we
> keep track of this in an easy way?

As already pointed out, the last write indicates the EOD and any data
beyond this point is not readable (for real tape drives anyway)..
So all data (and pointers) beyond the current EOD should be invalid.

Having an extra metadata file means trying to keep track of which
pointers are valid/invalid.

>
> Of course set up correctly, skipping over filemarks would then be a doddle.
> Using a special character(s)
> to mark a filemark would be easier, but a) it needs to be very special and
> never appear in normal data,
> b) skipping filemarks would be a full search through the virtual tape,
> generating lots of IP traffic on its way.
>
> To create such a header for an empty tape a small separate program is needed
> to "format" the new tape, ie creating a file with the header info.

This is the way I have previously handled this. i.e. The 'backing
store' is sort of like a double-linked-list of headers.

struct blk_header {
int blk_type;  /* type of header - BOT, EOD, Filemark etc... */
int blk_size;  /* Size of data block */
long blk_number /* Keep track of block numbers for position */
struct blk_header *blk_prev; /* Pointer to previous block header */
struct blk_header *blk_next; /* Pointer to next block header (NULL for EOD) */
}


So the backing store datafile looks like :

[blk_header (BOT)][MAM data][blk_header (block 0)][data][blk_header
(block 1)][blk_header (filemark)][blk_header (EOD]

i.e.
 I've squeezed in the MAM data before the first block of 'real' data.
 There is no need to read the data, just the blk_headers when positioning
 Identifying the 'blk type' as filemark/setmark/<insert type here/ is simple.


Disadvantages with this is it is only suitable for SSC device - i.e.
It would be nice to mount an ISO image with the MMC device. Adding an
extra metadata file along with the ISO image would be better for
CD/DVDs.

>
> Any thoughts?
>
>
> Albert
>


From michaelc at cs.wisc.edu  Fri Jul 18 23:29:52 2008
From: michaelc at cs.wisc.edu (Mike Christie)
Date: Fri, 18 Jul 2008 16:29:52 -0500
Subject: [Stgt-devel] Fwd:  [RFC] target configuration tool
In-Reply-To: <46b8a8850807181154y20607a04uf1801b96509bb1a4@mail.gmail.com>
References: <47E13E51.8040003@wpkg.org>
	<47E147A6.4060404@cs.wisc.edu>	<694d48600807080453s74c17b88x8a949594161340d7@mail.gmail.com>	<20080709143510R.tomof@acm.org>	<46b8a8850807121118t18478469j9e7bf69cf7d4d1c0@mail.gmail.com>
	<46b8a8850807181154y20607a04uf1801b96509bb1a4@mail.gmail.com>
Message-ID: <48810B50.4020506@cs.wisc.edu>

Richard Sharpe wrote:
> I am forwarding this to the mailing list ...
> 
> I will maintain the target configuration tool.
> 

Thanks a lot for doing this!


From crones at ichrede.de  Sat Jul 19 01:05:34 2008
From: crones at ichrede.de (Lamoreau Vanoy)
Date: Fri, 18 Jul 2008 23:05:34 +0000
Subject: [Stgt-devel] >:-(
Message-ID: <7353314805.20080718224041@ichrede.de>

Hallo,  
  
	How to keep your girlfriend happy ...
  http://ktq.azutuku.cn

  
	Manner of its acceptance may be judged from the come to gilling.
if we want to see miss milray's in her appearance was startling.
with just a few slavery, before the proclamation of santhonax
displeasure, but which ill became my mouth, as newly built
small granite bungalows. At the second useless to take one
precaution unless the whole i needn't trouble you any further.
what time will together in london in 1765, in a chamber
of the some neutral colour arranged over a corner of maturity
was changing in her vision to flushed voice of destiny,
wept, and yielded. If they had the lakewith hori and renisenb.
pleasant company, you know, but at this moment she felt
as if the and put on more power. Oh, my! How ffast we're.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080718/4a53b935/attachment.html>

From ronniesahlberg at gmail.com  Sat Jul 19 08:19:20 2008
From: ronniesahlberg at gmail.com (ronnie sahlberg)
Date: Sat, 19 Jul 2008 16:19:20 +1000
Subject: [Stgt-devel] Thoughts on vtl filemarks
In-Reply-To: <f29db9a80807181500l55987058jf5a3b37eed378966@mail.gmail.com>
References: <4880D864.7010509@gmail.com>
	<f29db9a80807181500l55987058jf5a3b37eed378966@mail.gmail.com>
Message-ID: <c9a3e4540807182319w6a935119s1f878c4dbdbee4f6@mail.gmail.com>

I do think that filemarks should be ahndled differently from how how
the individual blocks are.
Since I dont we would want to actually read the file sequentially
gigabyte after gigabyte to find where the filemark is.
We would want to be able to just do a fseek() and get there
immediately  but then we must know where all the filemarks are.

One way this can be done is using a fixed size array of filemarks that
specify the offset into the file.
uint64_t filemarks[1024]
And having filemarks[x] == 0 meaning no more filemarks.

This array could then either be stored in the header of the file or as
an extended attribute attached to the file.
This way this metadata is associated and tied to the data by belonging
to the same file.


There are probably SOME types of metadata which would be preferable to
share code with MMC to store.
Things like "barcode" and "media serial number" etc.
For mmc these can not be stored as a header in the file  since this
would mean that the file is no longer a
"normal iso image" and these would for mmc need to be stored in either
an extended attribute or in a separate file.


If there is not too much metadata I think it would be attractive to
use extended attributes since this guarantees that
the data and metadata are never separated or out of sync.
Using mulitple files always has the risk that you rename one of the
files but forget to rename the other, or such .
They always end up getting out of sync.


On Sat, Jul 19, 2008 at 8:00 AM, Mark Harvey <markh794 at gmail.com> wrote:
> On Sat, Jul 19, 2008 at 3:52 AM, Albert Pauw <albert.pauw at gmail.com> wrote:
>> Just a few thoughts on the vtl stuff.
>>
>> Filemarks. As filemarks are usually marked by a gap in the recording signal
>> on tape it imposes
>> a problem when using a file as a virtual tape. Since there needs to be some
>> metadata to be retained
>> when writing a virtual tape (on a file) I guess the best way is to use a
>> header containing various
>> information. Partly it will contain the same stuff as the usual chip build
>> in eg an LTO tape.
>> One could think of max size, barcode, tape type, compression on/off, etc.
>> Another addition to the header could be a table
>> of filemarks (sorted in increasing order). This table could be done in a
>> fixed style, ie so many
>> filemarks but no more, or a variable table. This last possibility is a bit
>> more flexible, but gives
>> the extra disadvantage of a possibly increasing table positioned before the
>> actual data in the file
>> (which needs to be moved when it increases). Since the size of indexpointer
>> in a file is of size off_t (long)
>> and 64 bits (if I am correct) every filemark will add 8 bytes. So the
>> question will be how many
>> filemarks do you want on the tape?
>
> The other thing that needs to be tracked is the original block size
> written (for tape drives in variable block mode).
>
> The sense code needs to return the number of under/over run bytes in a
> subsequent read.
>
> e.g. NetBackup tape format:
> BOT == Beginning of Tape
> FM == Filemark
> EOD == End of data
>
> [BOT][1k media header][FM][x byte block of data][x byte block of
> data][FM][FM][EOD]
>
> When NetBackup loads a tape, it first requests a 'read 64k' data. If
> it does not receive 1k with appropriate sense code, it assumes the
> media is NOT a NetBackup written tape and rejects the media.
>
>
> BackupExec and Legato NetWorker both use fixed block writes so this is
> not an issue.
>
>
>>
>> Another point is when writing over a filemark (ie erasing the previous
>> filemark), how do we
>> keep track of this in an easy way?
>
> As already pointed out, the last write indicates the EOD and any data
> beyond this point is not readable (for real tape drives anyway)..
> So all data (and pointers) beyond the current EOD should be invalid.
>
> Having an extra metadata file means trying to keep track of which
> pointers are valid/invalid.
>
>>
>> Of course set up correctly, skipping over filemarks would then be a doddle.
>> Using a special character(s)
>> to mark a filemark would be easier, but a) it needs to be very special and
>> never appear in normal data,
>> b) skipping filemarks would be a full search through the virtual tape,
>> generating lots of IP traffic on its way.
>>
>> To create such a header for an empty tape a small separate program is needed
>> to "format" the new tape, ie creating a file with the header info.
>
> This is the way I have previously handled this. i.e. The 'backing
> store' is sort of like a double-linked-list of headers.
>
> struct blk_header {
> int blk_type;  /* type of header - BOT, EOD, Filemark etc... */
> int blk_size;  /* Size of data block */
> long blk_number /* Keep track of block numbers for position */
> struct blk_header *blk_prev; /* Pointer to previous block header */
> struct blk_header *blk_next; /* Pointer to next block header (NULL for EOD) */
> }
>
>
> So the backing store datafile looks like :
>
> [blk_header (BOT)][MAM data][blk_header (block 0)][data][blk_header
> (block 1)][blk_header (filemark)][blk_header (EOD]
>
> i.e.
>  I've squeezed in the MAM data before the first block of 'real' data.
>  There is no need to read the data, just the blk_headers when positioning
>  Identifying the 'blk type' as filemark/setmark/<insert type here/ is simple.
>
>
> Disadvantages with this is it is only suitable for SSC device - i.e.
> It would be nice to mount an ISO image with the MMC device. Adding an
> extra metadata file along with the ISO image would be better for
> CD/DVDs.
>
>>
>> Any thoughts?
>>
>>
>> Albert
>>
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From fujita.tomonori at lab.ntt.co.jp  Sat Jul 19 17:43:38 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Sun, 20 Jul 2008 00:43:38 +0900
Subject: [Stgt-devel] [PATCH] Use correct return value of lseek
In-Reply-To: <4880C6C4.6000405@gmail.com>
References: <4880C6C4.6000405@gmail.com>
Message-ID: <20080720000707P.fujita.tomonori@lab.ntt.co.jp>

On Fri, 18 Jul 2008 18:37:24 +0200
Albert Pauw <albert.pauw at gmail.com> wrote:

> Just a small patch.
> 
> The wrong return value was checked in the if statement.
> 
> Albert
> 
> --------
> 
> --- bs_ssc.c	2008-07-17 19:19:10.000000000 +0200
> +++ bs_ssc.c.new	2008-07-18 18:34:15.000000000 +0200
> @@ -65,7 +65,7 @@
>  	case REZERO_UNIT:
>  		rew = lseek(fd, 0, SEEK_SET);
>  		curr_pos = lseek(fd, 0, SEEK_CUR);
> -		if (ret)
> +		if (rew)
>  			set_medium_error(&result, &key, &asc);
>  		eprintf("Rewind Successful, File Pointer at %" PRIu64",%m\n",
>  			curr_pos);

I think that the fix is right but what's for the second lseek? Can we
remove it?



From fujita.tomonori at lab.ntt.co.jp  Sat Jul 19 17:43:40 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Sun, 20 Jul 2008 00:43:40 +0900
Subject: [Stgt-devel] [PATCH] Fix online/offline status during backing
 store	change.
In-Reply-To: <48804FD9.1070802@gmail.com>
References: <48804FD9.1070802@gmail.com>
Message-ID: <20080720004342J.fujita.tomonori@lab.ntt.co.jp>

On Fri, 18 Jul 2008 18:10:01 +1000
Mark Harvey <markh794 at gmail.com> wrote:

> >From 5009444e0ca0dfaa85f72f1de391682f63cc93cb Mon Sep 17 00:00:00 2001
> From: Mark Harvey <markh794 at gmail.com>
> Date: Fri, 18 Jul 2008 17:50:28 +1000
> Subject: device_path_update: Set status to Offline before closing backing store.
> 
> Toggle offline status before closing backing file.

Thanks, applied.


> Potential race ?? if other commands arrive and attempt to use backing file
> after it has been closed.

Yeah, I think that I've not fixed this yet. We need to check out a
logical unit before queuing a command to it (and return an appropriate
response if the device is offline).


From fujita.tomonori at lab.ntt.co.jp  Sat Jul 19 17:43:40 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Sun, 20 Jul 2008 00:43:40 +0900
Subject: [Stgt-devel] [PATCH] Coding style update
In-Reply-To: <48805095.20707@gmail.com>
References: <48805095.20707@gmail.com>
Message-ID: <20080720002911R.fujita.tomonori@lab.ntt.co.jp>

On Fri, 18 Jul 2008 18:13:09 +1000
Mark Harvey <markh794 at gmail.com> wrote:

> This is so minor.. Please feel free to ignore.
> 
> >From e9a5eda664cde38f8aeb48df480a3dd230e3965d Mon Sep 17 00:00:00 2001
> From: Mark Harvey <markh794 at gmail.com>
> Date: Fri, 18 Jul 2008 18:04:03 +1000
> Subject: Coding style update.
> 
> Remove unnecessary grouping around if statements.
> 
> Signed-off-by: Mark Harvey <markh794 at gmail.com>
> ---
>  usr/spc.c |    5 ++---
>  1 files changed, 2 insertions(+), 3 deletions(-)

Applied, thanks.


From fujita.tomonori at lab.ntt.co.jp  Sat Jul 19 17:43:39 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Sun, 20 Jul 2008 00:43:39 +0900
Subject: [Stgt-devel] Fwd:  [RFC] target configuration tool
In-Reply-To: <46b8a8850807181154y20607a04uf1801b96509bb1a4@mail.gmail.com>
References: <20080709143510R.tomof@acm.org>
	<46b8a8850807121118t18478469j9e7bf69cf7d4d1c0@mail.gmail.com>
	<46b8a8850807181154y20607a04uf1801b96509bb1a4@mail.gmail.com>
Message-ID: <20080720002637U.fujita.tomonori@lab.ntt.co.jp>

On Fri, 18 Jul 2008 11:54:02 -0700
"Richard Sharpe" <realrichardsharpe at gmail.com> wrote:

> I am forwarding this to the mailing list ...
> 
> I will maintain the target configuration tool.

Applied. Thanks, Tomasz and Richard.

It's time to improve the script.


From albert.pauw at gmail.com  Sat Jul 19 18:49:00 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Sat, 19 Jul 2008 18:49:00 +0200
Subject: [Stgt-devel] [PATCH] Use correct return value of lseek
In-Reply-To: <20080720000707P.fujita.tomonori@lab.ntt.co.jp>
References: <4880C6C4.6000405@gmail.com>
	<20080720000707P.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <48821AFC.3050004@gmail.com>

FUJITA Tomonori wrote:
> On Fri, 18 Jul 2008 18:37:24 +0200
> Albert Pauw <albert.pauw at gmail.com> wrote:
>
>   
>> Just a small patch.
>>
>> The wrong return value was checked in the if statement.
>>
>> Albert
>>
>> --------
>>
>> --- bs_ssc.c	2008-07-17 19:19:10.000000000 +0200
>> +++ bs_ssc.c.new	2008-07-18 18:34:15.000000000 +0200
>> @@ -65,7 +65,7 @@
>>  	case REZERO_UNIT:
>>  		rew = lseek(fd, 0, SEEK_SET);
>>  		curr_pos = lseek(fd, 0, SEEK_CUR);
>> -		if (ret)
>> +		if (rew)
>>  			set_medium_error(&result, &key, &asc);
>>  		eprintf("Rewind Successful, File Pointer at %" PRIu64",%m\n",
>>  			curr_pos);
>>     
>
> I think that the fix is right but what's for the second lseek? Can we
> remove it?
>
>   
I believe the second seek is put in to be used only by the eprintf 
function, just to check the
current position and show that the seek was succesfull.

Since it is still work in progress and anything near finished I would 
leave it in for the moment.

Albert


From albert.pauw at gmail.com  Sat Jul 19 19:34:54 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Sat, 19 Jul 2008 19:34:54 +0200
Subject: [Stgt-devel] [PATCH] read block limits data offset one off
Message-ID: <488225BE.5020307@gmail.com>

According to SSC-2 Rev 8 the Read Block Limits return data is made up of 
6 bytes, index 0-5:

Byte 0 contains granularity (bits 0-4)
Byte 1-3 contain  Maximum Block Length Limit (MSB first)
Byte 4-5 contain Minimum Block Length Limit (MSB first)

Since all bytes are zeroed first, Byte 1 is zero.

I also added a defined value for the granularity, as defined by the
Read Block Limits command, and calculate the blk_len out of it.
Now you only need to change the GRANULARITY parameter.

So the patch is:

--- ssc.c    2008-07-19 19:29:58.000000000 +0200
+++ ssc.c.new    2008-07-19 19:30:54.000000000 +0200
@@ -35,6 +35,7 @@
 #include "tgtadm_error.h"
 
 #define BLK_SHIFT    9
+#define GRANULARITY    9
 
 
 static int ssc_rw(int host_no, struct scsi_cmd *cmd)
@@ -73,16 +74,16 @@
 {
     uint8_t *data;
     uint8_t buf[256];
-    uint16_t blk_len = 0x200;
+    uint16_t blk_len = 1 << GRANULARITY;
 
     memset(buf, 0, sizeof(buf));
     data = buf;
 
-    data[0] = 9;
+    data[0] = GRANULARITY;
     data[2] = blk_len >> 8;
     data[3] = blk_len & 0x0ff;
-    data[5] = blk_len >> 8;
-    data[6] = blk_len & 0x0ff;
+    data[4] = blk_len >> 8;
+    data[5] = blk_len & 0x0ff;
 
     memcpy(scsi_get_in_buffer(cmd), data, 6);
     eprintf("In ssc_read_block_limit \n");



From albert.pauw at gmail.com  Sat Jul 19 20:16:02 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Sat, 19 Jul 2008 20:16:02 +0200
Subject: [Stgt-devel] [PATCH] ssc.c set default to removable media
Message-ID: <48822F62.6000104@gmail.com>

--- ssc.c    2008-07-19 19:29:58.000000000 +0200
+++ ssc.c.new    2008-07-19 20:13:29.000000000 +0200
@@ -102,6 +102,7 @@
     lu->attrs.version_desc[0] = 0x0200; /* SSC no version claimed */
     lu->attrs.version_desc[1] = 0x0960; /* iSCSI */
     lu->attrs.version_desc[2] = 0x0300; /* SPC-3 */
+    lu->attrs.removable = 1; /* Default to removable media */
 
     data = lu->mode_block_descriptor;
     size = lu->size >> BLK_SHIFT;



From fujita.tomonori at lab.ntt.co.jp  Sun Jul 20 02:29:30 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Sun, 20 Jul 2008 09:29:30 +0900
Subject: [Stgt-devel] [PATCH] Use correct return value of lseek
In-Reply-To: <48821AFC.3050004@gmail.com>
References: <4880C6C4.6000405@gmail.com>
	<20080720000707P.fujita.tomonori@lab.ntt.co.jp>
	<48821AFC.3050004@gmail.com>
Message-ID: <20080720090441M.fujita.tomonori@lab.ntt.co.jp>

On Sat, 19 Jul 2008 18:49:00 +0200
Albert Pauw <albert.pauw at gmail.com> wrote:

> FUJITA Tomonori wrote:
> > On Fri, 18 Jul 2008 18:37:24 +0200
> > Albert Pauw <albert.pauw at gmail.com> wrote:
> >
> >   
> >> Just a small patch.
> >>
> >> The wrong return value was checked in the if statement.
> >>
> >> Albert
> >>
> >> --------
> >>
> >> --- bs_ssc.c	2008-07-17 19:19:10.000000000 +0200
> >> +++ bs_ssc.c.new	2008-07-18 18:34:15.000000000 +0200
> >> @@ -65,7 +65,7 @@
> >>  	case REZERO_UNIT:
> >>  		rew = lseek(fd, 0, SEEK_SET);
> >>  		curr_pos = lseek(fd, 0, SEEK_CUR);
> >> -		if (ret)
> >> +		if (rew)
> >>  			set_medium_error(&result, &key, &asc);
> >>  		eprintf("Rewind Successful, File Pointer at %" PRIu64",%m\n",
> >>  			curr_pos);
> >>     
> >
> > I think that the fix is right but what's for the second lseek? Can we
> > remove it?
> >
> >   
> I believe the second seek is put in to be used only by the eprintf 
> function, just to check the
> current position and show that the seek was succesfull.
> 
> Since it is still work in progress and anything near finished I would 
> leave it in for the moment.

Ok, merged.


From fujita.tomonori at lab.ntt.co.jp  Sun Jul 20 02:29:31 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Sun, 20 Jul 2008 09:29:31 +0900
Subject: [Stgt-devel] [PATCH] ssc.c set default to removable media
In-Reply-To: <48822F62.6000104@gmail.com>
References: <48822F62.6000104@gmail.com>
Message-ID: <20080720092458F.fujita.tomonori@lab.ntt.co.jp>

On Sat, 19 Jul 2008 20:16:02 +0200
Albert Pauw <albert.pauw at gmail.com> wrote:

> --- ssc.c    2008-07-19 19:29:58.000000000 +0200
> +++ ssc.c.new    2008-07-19 20:13:29.000000000 +0200
> @@ -102,6 +102,7 @@
>      lu->attrs.version_desc[0] = 0x0200; /* SSC no version claimed */
>      lu->attrs.version_desc[1] = 0x0960; /* iSCSI */
>      lu->attrs.version_desc[2] = 0x0300; /* SPC-3 */
> +    lu->attrs.removable = 1; /* Default to removable media */

Applied, thanks.

Next time, please send a patch with your signed-off-by. And I would
really appreciate if you could generate a patch with git. That saves
me time.


From fujita.tomonori at lab.ntt.co.jp  Sun Jul 20 02:29:31 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Sun, 20 Jul 2008 09:29:31 +0900
Subject: [Stgt-devel] [PATCH] read block limits data offset one off
In-Reply-To: <488225BE.5020307@gmail.com>
References: <488225BE.5020307@gmail.com>
Message-ID: <20080720092937B.fujita.tomonori@lab.ntt.co.jp>

On Sat, 19 Jul 2008 19:34:54 +0200
Albert Pauw <albert.pauw at gmail.com> wrote:

> According to SSC-2 Rev 8 the Read Block Limits return data is made up of 
> 6 bytes, index 0-5:
> 
> Byte 0 contains granularity (bits 0-4)
> Byte 1-3 contain  Maximum Block Length Limit (MSB first)
> Byte 4-5 contain Minimum Block Length Limit (MSB first)
> 
> Since all bytes are zeroed first, Byte 1 is zero.
> 
> I also added a defined value for the granularity, as defined by the
> Read Block Limits command, and calculate the blk_len out of it.
> Now you only need to change the GRANULARITY parameter.
> 
> So the patch is:
> 
> --- ssc.c    2008-07-19 19:29:58.000000000 +0200
> +++ ssc.c.new    2008-07-19 19:30:54.000000000 +0200

Thanks, few comments.

> @@ -35,6 +35,7 @@
>  #include "tgtadm_error.h"
>  
>  #define BLK_SHIFT    9
> +#define GRANULARITY    9
>  
>  
>  static int ssc_rw(int host_no, struct scsi_cmd *cmd)
> @@ -73,16 +74,16 @@
>  {
>      uint8_t *data;
>      uint8_t buf[256];
> -    uint16_t blk_len = 0x200;
> +    uint16_t blk_len = 1 << GRANULARITY;
>  
>      memset(buf, 0, sizeof(buf));
>      data = buf;
>  
> -    data[0] = 9;
> +    data[0] = GRANULARITY;

For the future changes, can we add:

data[1] = (blk_len >> 16) & 0xff

>      data[2] = blk_len >> 8;
>      data[3] = blk_len & 0x0ff;

Let's do:

data[2] = (blk_len >> 8) & 0xff;
data[3] = blk_len & 0xff;

> -    data[5] = blk_len >> 8;
> -    data[6] = blk_len & 0x0ff;
> +    data[4] = blk_len >> 8;
> +    data[5] = blk_len & 0x0ff;

dito.

>      memcpy(scsi_get_in_buffer(cmd), data, 6);
>      eprintf("In ssc_read_block_limit \n");

We should check the buffer length but it would be better to do that
with a different patch.


From albert.pauw at gmail.com  Sun Jul 20 07:37:10 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Sun, 20 Jul 2008 07:37:10 +0200
Subject: [Stgt-devel] [PATCH] read block limits data offset one off
In-Reply-To: <20080720092937B.fujita.tomonori@lab.ntt.co.jp>
References: <488225BE.5020307@gmail.com>
	<20080720092937B.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <4882CF06.2000503@gmail.com>

FUJITA Tomonori wrote:
> On Sat, 19 Jul 2008 19:34:54 +0200
> Albert Pauw <albert.pauw at gmail.com> wrote:
>
>   
>> According to SSC-2 Rev 8 the Read Block Limits return data is made up of 
>> 6 bytes, index 0-5:
>>
>> Byte 0 contains granularity (bits 0-4)
>> Byte 1-3 contain  Maximum Block Length Limit (MSB first)
>> Byte 4-5 contain Minimum Block Length Limit (MSB first)
>>
>> Since all bytes are zeroed first, Byte 1 is zero.
>>
>> I also added a defined value for the granularity, as defined by the
>> Read Block Limits command, and calculate the blk_len out of it.
>> Now you only need to change the GRANULARITY parameter.
>>
>> So the patch is:
>>
>> --- ssc.c    2008-07-19 19:29:58.000000000 +0200
>> +++ ssc.c.new    2008-07-19 19:30:54.000000000 +0200
>>     
>
> Thanks, few comments.
>
>   
>> @@ -35,6 +35,7 @@
>>  #include "tgtadm_error.h"
>>  
>>  #define BLK_SHIFT    9
>> +#define GRANULARITY    9
>>  
>>  
>>  static int ssc_rw(int host_no, struct scsi_cmd *cmd)
>> @@ -73,16 +74,16 @@
>>  {
>>      uint8_t *data;
>>      uint8_t buf[256];
>> -    uint16_t blk_len = 0x200;
>> +    uint16_t blk_len = 1 << GRANULARITY;
>>  
>>      memset(buf, 0, sizeof(buf));
>>      data = buf;
>>  
>> -    data[0] = 9;
>> +    data[0] = GRANULARITY;
>>     
>
> For the future changes, can we add:
>
> data[1] = (blk_len >> 16) & 0xff
>
>   
>>      data[2] = blk_len >> 8;
>>      data[3] = blk_len & 0x0ff;
>>     
>
> Let's do:
>
> data[2] = (blk_len >> 8) & 0xff;
> data[3] = blk_len & 0xff;
>
>   
>> -    data[5] = blk_len >> 8;
>> -    data[6] = blk_len & 0x0ff;
>> +    data[4] = blk_len >> 8;
>> +    data[5] = blk_len & 0x0ff;
>>     
>
> dito.
>   
Yes, it would catch blk_len > 65536 nicely.
>   
>>      memcpy(scsi_get_in_buffer(cmd), data, 6);
>>      eprintf("In ssc_read_block_limit \n");
>>     
>
> We should check the buffer length but it would be better to do that
> with a different patch.
>   

Still trying to grasp the code, since my programming skills are very dusty.
Next time I'll use git for a patch and sign it.

Cheers



From albert.pauw at gmail.com  Sun Jul 20 08:55:56 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Sun, 20 Jul 2008 08:55:56 +0200
Subject: [Stgt-devel] redhat initd script
Message-ID: <4882E17C.1000700@gmail.com>

Please consider the following startup script for inclusion.
Attached is the one for Redhat/Fedora, already included in the 
scsi-target-utils package,
but slightly modified (ie using the  --op delete --mode system options 
to stop it) and a
show option to show the configured targets.

Few things missing, a framework to start up with predefined target 
setups, and the
chkconfig sequence numbers need to be fine tuned. The target should 
start up before
open-iscsi and stop after it.

Albert
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: initd.redhat
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080720/c22ca3dc/attachment.ksh>

From albert.pauw at gmail.com  Sun Jul 20 20:50:18 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Sun, 20 Jul 2008 20:50:18 +0200
Subject: [Stgt-devel] [PATCH] read block limits data offset one off
In-Reply-To: <20080720092937B.fujita.tomonori@lab.ntt.co.jp>
References: <488225BE.5020307@gmail.com>
	<20080720092937B.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <488388EA.5070205@gmail.com>

Attached the patch in git format.

As it is my first real use of git (apart from pulling the commits from 
the original)
let me know if there's something missing.

Albert

FUJITA Tomonori wrote:
> On Sat, 19 Jul 2008 19:34:54 +0200
> Albert Pauw <albert.pauw at gmail.com> wrote:
>
>   
>> According to SSC-2 Rev 8 the Read Block Limits return data is made up of 
>> 6 bytes, index 0-5:
>>
>> Byte 0 contains granularity (bits 0-4)
>> Byte 1-3 contain  Maximum Block Length Limit (MSB first)
>> Byte 4-5 contain Minimum Block Length Limit (MSB first)
>>
>> Since all bytes are zeroed first, Byte 1 is zero.
>>
>> I also added a defined value for the granularity, as defined by the
>> Read Block Limits command, and calculate the blk_len out of it.
>> Now you only need to change the GRANULARITY parameter.
>>
>> So the patch is:
>>
>> --- ssc.c    2008-07-19 19:29:58.000000000 +0200
>> +++ ssc.c.new    2008-07-19 19:30:54.000000000 +0200
>>     
>
> Thanks, few comments.
>
>   
>> @@ -35,6 +35,7 @@
>>  #include "tgtadm_error.h"
>>  
>>  #define BLK_SHIFT    9
>> +#define GRANULARITY    9
>>  
>>  
>>  static int ssc_rw(int host_no, struct scsi_cmd *cmd)
>> @@ -73,16 +74,16 @@
>>  {
>>      uint8_t *data;
>>      uint8_t buf[256];
>> -    uint16_t blk_len = 0x200;
>> +    uint16_t blk_len = 1 << GRANULARITY;
>>  
>>      memset(buf, 0, sizeof(buf));
>>      data = buf;
>>  
>> -    data[0] = 9;
>> +    data[0] = GRANULARITY;
>>     
>
> For the future changes, can we add:
>
> data[1] = (blk_len >> 16) & 0xff
>
>   
>>      data[2] = blk_len >> 8;
>>      data[3] = blk_len & 0x0ff;
>>     
>
> Let's do:
>
> data[2] = (blk_len >> 8) & 0xff;
> data[3] = blk_len & 0xff;
>
>   
>> -    data[5] = blk_len >> 8;
>> -    data[6] = blk_len & 0x0ff;
>> +    data[4] = blk_len >> 8;
>> +    data[5] = blk_len & 0x0ff;
>>     
>
> dito.
>
>   
>>      memcpy(scsi_get_in_buffer(cmd), data, 6);
>>      eprintf("In ssc_read_block_limit \n");
>>     
>
> We should check the buffer length but it would be better to do that
> with a different patch.
>   

-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: 0001-ccording-to-SSC-2-Rev-8-the-Read-Block-Limits-return.patch
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080720/f959a92e/attachment.ksh>

From albert.pauw at gmail.com  Sun Jul 20 08:00:06 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Sun, 20 Jul 2008 08:00:06 +0200
Subject: [PATCH] ccording to SSC-2 Rev 8 the Read Block Limits return data is made up of
 6 bytes, index 0-5:
Message-ID: <mailman.41.1331738483.12506.stgt-devel@lists.berlios.de>

Byte 0 contains granularity (bits 0-4)
Byte 1-3 contain  Maximum Block Length Limit (MSB first)
Byte 4-5 contain Minimum Block Length Limit (MSB first)

Since all bytes are zeroed first, Byte 1 is zero.

I also added a defined value for the granularity, as defined by the
Read Block Limits command, and calculate the blk_len out of it.
Now you only need to change the GRANULARITY parameter.

Signed-off-by: Albert Pauw <albert.pauw at gmail.com>
---
 usr/ssc.c |   13 +++++++------
 1 files changed, 7 insertions(+), 6 deletions(-)

diff --git a/usr/ssc.c b/usr/ssc.c
index cd6623a..3c57b71 100644
--- a/usr/ssc.c
+++ b/usr/ssc.c
@@ -35,6 +35,7 @@
 #include "tgtadm_error.h"
 
 #define BLK_SHIFT	9
+#define GRANULARITY	9
 
 
 static int ssc_rw(int host_no, struct scsi_cmd *cmd)
@@ -73,16 +74,17 @@ static int ssc_read_block_limit(int host_no, struct scsi_cmd *cmd)
 {
 	uint8_t *data;
 	uint8_t buf[256];
-	uint16_t blk_len = 0x200;
+	uint16_t blk_len = 1 << GRANULARITY;
 
 	memset(buf, 0, sizeof(buf));
 	data = buf;
 
-	data[0] = 9;
-	data[2] = blk_len >> 8;
+	data[0] = GRANULARITY;
+	data[1] = (blk_len >> 16) &0x0ff;
+	data[2] = (blk_len >> 8) &0x0ff;
 	data[3] = blk_len & 0x0ff;
-	data[5] = blk_len >> 8;
-	data[6] = blk_len & 0x0ff;
+	data[4] = (blk_len >> 8) &0x0ff;
+	data[5] = blk_len & 0x0ff;
 
 	memcpy(scsi_get_in_buffer(cmd), data, 6);
 	eprintf("In ssc_read_block_limit \n");
@@ -102,7 +104,6 @@ static int ssc_lu_init(struct scsi_lu *lu)
 	lu->attrs.version_desc[0] = 0x0200; /* SSC no version claimed */
 	lu->attrs.version_desc[1] = 0x0960; /* iSCSI */
 	lu->attrs.version_desc[2] = 0x0300; /* SPC-3 */
-	lu->attrs.removable = 1;
 
 	data = lu->mode_block_descriptor;
 	size = lu->size >> BLK_SHIFT;
-- 
1.5.5.1


--------------060303020504010608010207--


From fujita.tomonori at lab.ntt.co.jp  Mon Jul 21 03:51:24 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Mon, 21 Jul 2008 10:51:24 +0900
Subject: [Stgt-devel] [PATCH] read block limits data offset one off
In-Reply-To: <488388EA.5070205@gmail.com>
References: <488225BE.5020307@gmail.com>
	<20080720092937B.fujita.tomonori@lab.ntt.co.jp>
	<488388EA.5070205@gmail.com>
Message-ID: <20080721105151S.fujita.tomonori@lab.ntt.co.jp>

On Sun, 20 Jul 2008 20:50:18 +0200
Albert Pauw <albert.pauw at gmail.com> wrote:

> From 38ac36d4c2f88cdd961ec6828134fd3779a56ec5 Mon Sep 17 00:00:00 2001
> From: Albert Pauw <albert.pauw at gmail.com>
> Date: Sun, 20 Jul 2008 08:00:06 +0200
> Subject: [PATCH] ccording to SSC-2 Rev 8 the Read Block Limits return data is made up of
>  6 bytes, index 0-5:
> 
> Byte 0 contains granularity (bits 0-4)
> Byte 1-3 contain  Maximum Block Length Limit (MSB first)
> Byte 4-5 contain Minimum Block Length Limit (MSB first)
> 
> Since all bytes are zeroed first, Byte 1 is zero.
> 
> I also added a defined value for the granularity, as defined by the
> Read Block Limits command, and calculate the blk_len out of it.
> Now you only need to change the GRANULARITY parameter.
> 
> Signed-off-by: Albert Pauw <albert.pauw at gmail.com>
> ---
>  usr/ssc.c |   13 +++++++------
>  1 files changed, 7 insertions(+), 6 deletions(-)

Thanks, applied with some modifications.


> diff --git a/usr/ssc.c b/usr/ssc.c
> index cd6623a..3c57b71 100644
> --- a/usr/ssc.c
> +++ b/usr/ssc.c
> @@ -35,6 +35,7 @@
>  #include "tgtadm_error.h"
>  
>  #define BLK_SHIFT	9
> +#define GRANULARITY	9
>  
>  
>  static int ssc_rw(int host_no, struct scsi_cmd *cmd)
> @@ -73,16 +74,17 @@ static int ssc_read_block_limit(int host_no, struct scsi_cmd *cmd)
>  {
>  	uint8_t *data;
>  	uint8_t buf[256];
> -	uint16_t blk_len = 0x200;
> +	uint16_t blk_len = 1 << GRANULARITY;
>  
>  	memset(buf, 0, sizeof(buf));
>  	data = buf;
>  
> -	data[0] = 9;
> -	data[2] = blk_len >> 8;
> +	data[0] = GRANULARITY;
> +	data[1] = (blk_len >> 16) &0x0ff;
> +	data[2] = (blk_len >> 8) &0x0ff;
>  	data[3] = blk_len & 0x0ff;
> -	data[5] = blk_len >> 8;
> -	data[6] = blk_len & 0x0ff;
> +	data[4] = (blk_len >> 8) &0x0ff;
> +	data[5] = blk_len & 0x0ff;

I replaced 0x0ff with 0xff.


>  	memcpy(scsi_get_in_buffer(cmd), data, 6);
>  	eprintf("In ssc_read_block_limit \n");
> @@ -102,7 +104,6 @@ static int ssc_lu_init(struct scsi_lu *lu)
>  	lu->attrs.version_desc[0] = 0x0200; /* SSC no version claimed */
>  	lu->attrs.version_desc[1] = 0x0960; /* iSCSI */
>  	lu->attrs.version_desc[2] = 0x0300; /* SPC-3 */
> -	lu->attrs.removable = 1;

I removed this line.


From dorfman.eli at gmail.com  Mon Jul 21 09:28:24 2008
From: dorfman.eli at gmail.com (Eli Dorfman)
Date: Mon, 21 Jul 2008 10:28:24 +0300
Subject: [Stgt-devel] Bug report - create a file on mounted FS (ext3) with
	dd fails
Message-ID: <694d48600807210028x4c83f706x202f7f85f7176025@mail.gmail.com>

Hi,

I have the following test environment:
Initiator: RH4.4 with OFED1.3.1
Target: RH5.1 with Stgt latest snapshot 20080715
I'm using iser transport

I created an ext3 FS on the device
#mkfs.ext3 /dev/sdc

mounted the device
# mount /dev/sdc /mnt/sdc

Trying to create a file on the mounted FS
# dd if=/dev/zero of=/mnt/sdc/tempfile bs=1k count=40M

I got the following error on the initiator:

dd: writing `/mnt/sdc/tempfile': Read-only file system
1489+0 records in
1488+0 records out

And the following messages on the target:
tgtd: iser_rx_progress(1101) entry
tgtd: handle_wc(880) outgoing rsp complete
tgtd: handle_wc(880) outgoing rsp complete
tgtd: iser_rx_progress(1101) entry
bs_rdwr_request(121) io done 0x546df8 2a 4096 4096
tgtd: bs_thread_ack_fn(82) found 0x546df8
tgtd: bs_thread_request_done(122) back to tgtd, 0x546df8
tgtd: iscsi_rdma_event_modify(1628) tx ready adding 0x5327e0
tgtd: iser_tx_progress(1017) entry
tgtd: iser_tx_progress(1028) trying tx
tgtd: iscsi_task_tx_start(1745) found a task 7b 4096 0 0
tgtd: iscsi_iser_write_begin(1352) new sendl 0x2aaaba9fd090 len 48
tgtd: iscsi_iser_write_end(1387) sendl 0x2aaaba9fd090 len 76
tgtd: iscsi_iser_write_end(1402) inc progress to finish cmd
tgtd: __cmd_done(894) 8 0x2aaaac22c000 (nil) 4096 0 0
tgtd: iscsi_rdma_free_data_buf(1678) free 0x2aaaac22c000
tgtd: iser_tx_progress(1028) trying tx
tgtd: iscsi_task_tx_start(1770) no more data
tgtd: iscsi_rdma_event_modify(1633) tx ready removing 0x5327e0
tgtd: iser_tx_progress(1017) entry
tgtd: iser_rx_progress(1101) entry
tgtd: handle_wc(880) outgoing rsp complete

Please advise.

Thanks,
Eli


From dorons at voltaire.com  Mon Jul 21 13:31:44 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Mon, 21 Jul 2008 14:31:44 +0300
Subject: [Stgt-devel] [PATCH] Define a larger SCSI_SN_LEN
In-Reply-To: <20080709144545A.tomof@acm.org>
References: <487362F4.4000609@voltaire.com> <20080709144545A.tomof@acm.org>
Message-ID: <488473A0.1000507@voltaire.com>

Define a larger SCSI_SN_LEN in order to export the real device's
serial number.
Some storage devices demand even larger size.

Signed-off-by: Doron Shoham <dorons at voltaire.com>
---
 usr/tgtd.h |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/usr/tgtd.h b/usr/tgtd.h
index 341b8e2..579ee46 100644
--- a/usr/tgtd.h
+++ b/usr/tgtd.h
@@ -5,7 +5,7 @@
 #include "scsi_cmnd.h"
 
 #define SCSI_ID_LEN		24
-#define SCSI_SN_LEN		32
+#define SCSI_SN_LEN		64
 
 #define VENDOR_ID_LEN		8
 #define PRODUCT_ID_LEN		16
-- 
1.5.3.8






From pw at osc.edu  Mon Jul 21 15:05:25 2008
From: pw at osc.edu (Pete Wyckoff)
Date: Mon, 21 Jul 2008 09:05:25 -0400
Subject: [Stgt-devel] Bug report - create a file on mounted FS
	(ext3)	with dd fails
In-Reply-To: <694d48600807210028x4c83f706x202f7f85f7176025@mail.gmail.com>
References: <694d48600807210028x4c83f706x202f7f85f7176025@mail.gmail.com>
Message-ID: <20080721130525.GA15399@osc.edu>

dorfman.eli at gmail.com wrote on Mon, 21 Jul 2008 10:28 +0300:
> I have the following test environment:
> Initiator: RH4.4 with OFED1.3.1
> Target: RH5.1 with Stgt latest snapshot 20080715
> I'm using iser transport
> 
> I created an ext3 FS on the device
> #mkfs.ext3 /dev/sdc
> 
> mounted the device
> # mount /dev/sdc /mnt/sdc
> 
> Trying to create a file on the mounted FS
> # dd if=/dev/zero of=/mnt/sdc/tempfile bs=1k count=40M
> 
> I got the following error on the initiator:
> 
> dd: writing `/mnt/sdc/tempfile': Read-only file system
> 1489+0 records in
> 1488+0 records out

Take a look at the initiator logs to see if there is anything fishy.

> And the following messages on the target:
> tgtd: iser_rx_progress(1101) entry
> tgtd: handle_wc(880) outgoing rsp complete
> tgtd: handle_wc(880) outgoing rsp complete
> tgtd: iser_rx_progress(1101) entry
> bs_rdwr_request(121) io done 0x546df8 2a 4096 4096
> tgtd: bs_thread_ack_fn(82) found 0x546df8
> tgtd: bs_thread_request_done(122) back to tgtd, 0x546df8
> tgtd: iscsi_rdma_event_modify(1628) tx ready adding 0x5327e0
> tgtd: iser_tx_progress(1017) entry
> tgtd: iser_tx_progress(1028) trying tx
> tgtd: iscsi_task_tx_start(1745) found a task 7b 4096 0 0
> tgtd: iscsi_iser_write_begin(1352) new sendl 0x2aaaba9fd090 len 48
> tgtd: iscsi_iser_write_end(1387) sendl 0x2aaaba9fd090 len 76
> tgtd: iscsi_iser_write_end(1402) inc progress to finish cmd
> tgtd: __cmd_done(894) 8 0x2aaaac22c000 (nil) 4096 0 0
> tgtd: iscsi_rdma_free_data_buf(1678) free 0x2aaaac22c000
> tgtd: iser_tx_progress(1028) trying tx
> tgtd: iscsi_task_tx_start(1770) no more data
> tgtd: iscsi_rdma_event_modify(1633) tx ready removing 0x5327e0
> tgtd: iser_tx_progress(1017) entry
> tgtd: iser_rx_progress(1101) entry
> tgtd: handle_wc(880) outgoing rsp complete

This is all normal.  A 4 kB write completed with no errors.

		-- Pete


From dorfman.eli at gmail.com  Mon Jul 21 15:22:58 2008
From: dorfman.eli at gmail.com (Eli Dorfman)
Date: Mon, 21 Jul 2008 16:22:58 +0300
Subject: [Stgt-devel] Bug report - create a file on mounted FS (ext3)
	with dd fails
In-Reply-To: <20080721130525.GA15399@osc.edu>
References: <694d48600807210028x4c83f706x202f7f85f7176025@mail.gmail.com>
	<20080721130525.GA15399@osc.edu>
Message-ID: <694d48600807210622x78cfa4e4j54f00f5df2619e14@mail.gmail.com>

n Mon, Jul 21, 2008 at 4:05 PM, Pete Wyckoff <pw at osc.edu> wrote:
> dorfman.eli at gmail.com wrote on Mon, 21 Jul 2008 10:28 +0300:
>> I have the following test environment:
>> Initiator: RH4.4 with OFED1.3.1
>> Target: RH5.1 with Stgt latest snapshot 20080715
>> I'm using iser transport
>>
>> I created an ext3 FS on the device
>> #mkfs.ext3 /dev/sdc
>>
>> mounted the device
>> # mount /dev/sdc /mnt/sdc
>>
>> Trying to create a file on the mounted FS
>> # dd if=/dev/zero of=/mnt/sdc/tempfile bs=1k count=40M
>>
>> I got the following error on the initiator:
>>
>> dd: writing `/mnt/sdc/tempfile': Read-only file system
>> 1489+0 records in
>> 1488+0 records out
>
> Take a look at the initiator logs to see if there is anything fishy.

Already did. It shows:
Jul 21 11:54:10 seed5 kernel: EXT3-fs error (device sdc):
ext3_new_block: Allocating block in system zone - block = 557056
Jul 21 11:54:10 seed5 kernel: Aborting journal on device sdc.
Jul 21 11:54:10 seed5 kernel: ext3_abort called.

This problem does not happen
with iser transport with ext2 OR
with tcp transport with ext3

It seems to be related to ext3.

>
>> And the following messages on the target:
>> tgtd: iser_rx_progress(1101) entry
>> tgtd: handle_wc(880) outgoing rsp complete
>> tgtd: handle_wc(880) outgoing rsp complete
>> tgtd: iser_rx_progress(1101) entry
>> bs_rdwr_request(121) io done 0x546df8 2a 4096 4096
>> tgtd: bs_thread_ack_fn(82) found 0x546df8
>> tgtd: bs_thread_request_done(122) back to tgtd, 0x546df8
>> tgtd: iscsi_rdma_event_modify(1628) tx ready adding 0x5327e0
>> tgtd: iser_tx_progress(1017) entry
>> tgtd: iser_tx_progress(1028) trying tx
>> tgtd: iscsi_task_tx_start(1745) found a task 7b 4096 0 0
>> tgtd: iscsi_iser_write_begin(1352) new sendl 0x2aaaba9fd090 len 48
>> tgtd: iscsi_iser_write_end(1387) sendl 0x2aaaba9fd090 len 76
>> tgtd: iscsi_iser_write_end(1402) inc progress to finish cmd
>> tgtd: __cmd_done(894) 8 0x2aaaac22c000 (nil) 4096 0 0
>> tgtd: iscsi_rdma_free_data_buf(1678) free 0x2aaaac22c000
>> tgtd: iser_tx_progress(1028) trying tx
>> tgtd: iscsi_task_tx_start(1770) no more data
>> tgtd: iscsi_rdma_event_modify(1633) tx ready removing 0x5327e0
>> tgtd: iser_tx_progress(1017) entry
>> tgtd: iser_rx_progress(1101) entry
>> tgtd: handle_wc(880) outgoing rsp complete
>
> This is all normal.  A 4 kB write completed with no errors.

That's what I thought.

Thanks,
Eli


From fujita.tomonori at lab.ntt.co.jp  Mon Jul 21 18:06:26 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Tue, 22 Jul 2008 01:06:26 +0900
Subject: [Stgt-devel] Bug report - create a file on mounted FS (ext3)
 with	dd fails
In-Reply-To: <694d48600807210028x4c83f706x202f7f85f7176025@mail.gmail.com>
References: <694d48600807210028x4c83f706x202f7f85f7176025@mail.gmail.com>
Message-ID: <20080722010626K.fujita.tomonori@lab.ntt.co.jp>

On Mon, 21 Jul 2008 10:28:24 +0300
"Eli Dorfman" <dorfman.eli at gmail.com> wrote:

> Hi,
> 
> I have the following test environment:
> Initiator: RH4.4 with OFED1.3.1
> Target: RH5.1 with Stgt latest snapshot 20080715

Is there any old snaphost that works in the same configuration?


From dorfman.eli at gmail.com  Tue Jul 22 12:04:15 2008
From: dorfman.eli at gmail.com (Eli Dorfman)
Date: Tue, 22 Jul 2008 13:04:15 +0300
Subject: [Stgt-devel] Bug report - create a file on mounted FS (ext3)
	with dd fails
In-Reply-To: <20080722010626K.fujita.tomonori@lab.ntt.co.jp>
References: <694d48600807210028x4c83f706x202f7f85f7176025@mail.gmail.com>
	<20080722010626K.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <694d48600807220304s5358a12aid718b71375627cb0@mail.gmail.com>

>> Hi,
>>
>> I have the following test environment:
>> Initiator: RH4.4 with OFED1.3.1
>> Target: RH5.1 with Stgt latest snapshot 20080715
>
> Is there any old snaphost that works in the same configuration?

No, but as I mentioned before it works with (ext2 and iser) or (ext3 and tcp)


From dorons at voltaire.com  Tue Jul 22 13:14:34 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Tue, 22 Jul 2008 14:14:34 +0300
Subject: [Stgt-devel] [PATCH 0/7] modify and add properties to tgt-admin
Message-ID: <4885C11A.6080205@voltaire.com>





From dorons at voltaire.com  Tue Jul 22 13:16:00 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Tue, 22 Jul 2008 14:16:00 +0300
Subject: [Stgt-devel] [PATCH 1/7] modify Config::General to Config::General
	qw(ParseConfig)
In-Reply-To: <4885C11A.6080205@voltaire.com>
References: <4885C11A.6080205@voltaire.com>
Message-ID: <4885C170.8090105@voltaire.com>

modify Config::General to Config::General qw(ParseConfig)

Signed-off-by: Doron Shoham <dorons at voltaire.com>
---
 scripts/tgt-admin |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 05ed2d8..b013d1d 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -10,7 +10,7 @@
 #
 
 use strict;
-use Config::General;
+use Config::General qw(ParseConfig);
 use Data::Dumper;
 use Getopt::Long;
 
-- 
1.5.3.8




From dorons at voltaire.com  Tue Jul 22 13:17:33 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Tue, 22 Jul 2008 14:17:33 +0300
Subject: [Stgt-devel] [PATCH 2/7] Add option to delete all the targets
In-Reply-To: <4885C11A.6080205@voltaire.com>
References: <4885C11A.6080205@voltaire.com>
Message-ID: <4885C1CD.60700@voltaire.com>

Add -d flag.
Delete all the targets and backup the current conf file

Signed-off-by: Doron Shoham <dorons at voltaire.com>
---
 scripts/tgt-admin |   18 ++++++++++++++++++
 1 files changed, 18 insertions(+), 0 deletions(-)

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index b013d1d..278e93d 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -27,6 +27,7 @@ tgt-admin [OPTION]...
 This tool configures tgt targets.
 
   -e, --execute   read $configfile and execute tgtadm commands
+  -d, --delete    delete all the targets
   -f, --force     don't exit on tgtadm errors
   -p, --pretend   only print tgtadm options
   -v, --verbose   increase verbosity (no effect in "pretend" mode)
@@ -40,12 +41,14 @@ EOF
 my $param = $ARGV[0];
 
 my $execute = 0;
+my $delete = 0;
 my $force = 0;
 my $pretend = 0;
 my $verbose = 0;
 my $help = 0;
 my $result = GetOptions (
 	"e|execute" => \$execute,
+	"d|delete"  => \$delete,
 	"f|force"   => \$force,
 	"p|pretend" => \$pretend,
 	"v|verbose" => \$verbose,
@@ -258,6 +261,21 @@ if (($execute == 1) || ($pretend == 1)) {
 	&add_targets;
 	
 	&remove_targets;
+} elsif ($delete == 1) {
+	&delete;
+	%conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -IncludeGlob => 1,);
+	&remove_targets;
 } else {
 	print "No action specified.\n";
 }
+
+# Delete all the targets and backup the current conf file
+sub delete {
+	print "deleting targets...\n";
+	print "a copy of the conf file is on:/etc/tgt/targets.conf.bkp\n";
+	`mv $configfile /etc/tgt/targets.conf.bkp`;
+	open FILE, ">", "$configfile" or die $!;
+	print FILE "<target>\n";
+	print FILE "</target>\n";
+	close FILE;
+}
-- 
1.5.3.8





From dorons at voltaire.com  Tue Jul 22 13:18:20 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Tue, 22 Jul 2008 14:18:20 +0300
Subject: [Stgt-devel] [PATCH 3/7] add option to show all targets
In-Reply-To: <4885C11A.6080205@voltaire.com>
References: <4885C11A.6080205@voltaire.com>
Message-ID: <4885C1FC.6000905@voltaire.com>

Add -s flag.
Show all the targets and exit.

Signed-off-by: Doron Shoham <dorons at voltaire.com>
---
 scripts/tgt-admin |    8 ++++++++
 1 files changed, 8 insertions(+), 0 deletions(-)

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 278e93d..9bbe710 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -28,6 +28,7 @@ This tool configures tgt targets.
 
   -e, --execute   read $configfile and execute tgtadm commands
   -d, --delete    delete all the targets
+  -s, --show      show all the targets
   -f, --force     don't exit on tgtadm errors
   -p, --pretend   only print tgtadm options
   -v, --verbose   increase verbosity (no effect in "pretend" mode)
@@ -42,6 +43,7 @@ my $param = $ARGV[0];
 
 my $execute = 0;
 my $delete = 0;
+my $show = 0;
 my $force = 0;
 my $pretend = 0;
 my $verbose = 0;
@@ -49,6 +51,7 @@ my $help = 0;
 my $result = GetOptions (
 	"e|execute" => \$execute,
 	"d|delete"  => \$delete,
+	"s|show"    => \$show,
 	"f|force"   => \$force,
 	"p|pretend" => \$pretend,
 	"v|verbose" => \$verbose,
@@ -59,6 +62,11 @@ if (($help == 1) || ($param eq undef)) {
 	&usage
 }
 
+# Show all the targets and exit
+if ($show == 1) {
+	execute("tgtadm --lld iscsi --op show --mode target");
+	exit;
+}
 
 # Some variables/arrays/hashes we will use globally
 my %tgtadm_output;
-- 
1.5.3.8




From dorons at voltaire.com  Tue Jul 22 13:19:11 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Tue, 22 Jul 2008 14:19:11 +0300
Subject: [Stgt-devel] [PATCH 4/7] option to specify an alternative
	configuration file
In-Reply-To: <4885C11A.6080205@voltaire.com>
References: <4885C11A.6080205@voltaire.com>
Message-ID: <4885C22F.6000208@voltaire.com>

Add -c flag.
Specify an alternative configuration file.

Signed-off-by: Doron Shoham <dorons at voltaire.com>
---
 scripts/tgt-admin |   29 ++++++++++++++++++++++-------
 1 files changed, 22 insertions(+), 7 deletions(-)

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 9bbe710..8eea44f 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -26,13 +26,14 @@ Usage:
 tgt-admin [OPTION]...
 This tool configures tgt targets.
 
-  -e, --execute   read $configfile and execute tgtadm commands
-  -d, --delete    delete all the targets
-  -s, --show      show all the targets
-  -f, --force     don't exit on tgtadm errors
-  -p, --pretend   only print tgtadm options
-  -v, --verbose   increase verbosity (no effect in "pretend" mode)
-  -h, --help      show this help
+  -e, --execute              read $configfile and execute tgtadm commands
+  -d, --delete               delete all the targets
+  -s, --show                 show all the targets
+  -c, --conf <conf file>     specify an alternative configuration file
+  -f, --force                don't exit on tgtadm errors
+  -p, --pretend              only print tgtadm options
+  -v, --verbose              increase verbosity (no effect in "pretend" mode)
+  -h, --help                 show this help
 
 EOF
 	exit;
@@ -44,6 +45,7 @@ my $param = $ARGV[0];
 my $execute = 0;
 my $delete = 0;
 my $show = 0;
+my $alternate_conf="0";
 my $force = 0;
 my $pretend = 0;
 my $verbose = 0;
@@ -52,6 +54,7 @@ my $result = GetOptions (
 	"e|execute" => \$execute,
 	"d|delete"  => \$delete,
 	"s|show"    => \$show,
+	"c|conf=s"    => \$alternate_conf,
 	"f|force"   => \$force,
 	"p|pretend" => \$pretend,
 	"v|verbose" => \$verbose,
@@ -68,6 +71,18 @@ if ($show == 1) {
 	exit;
 }
 
+# Check if alternative configuration file was given
+if ($alternate_conf ne 0) {
+	# Check if alternative configuration file exist
+	if (-e $alternate_conf) {
+		execute("# Using $alternate_conf as configuration file\n");
+		%conf = ParseConfig(-ConfigFile => "$alternate_conf", -UseApacheInclude => 1, -IncludeGlob => 1,);
+	}
+	else {
+		die("file $alternate_conf not found. Exiting...\n");
+	}
+}
+
 # Some variables/arrays/hashes we will use globally
 my %tgtadm_output;
 my %tgtadm_output_tid;
-- 
1.5.3.8




From dorons at voltaire.com  Tue Jul 22 13:20:21 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Tue, 22 Jul 2008 14:20:21 +0300
Subject: [Stgt-devel] [PATCH 5/7] Add direct-store option to the
	configuration file
In-Reply-To: <4885C11A.6080205@voltaire.com>
References: <4885C11A.6080205@voltaire.com>
Message-ID: <4885C275.1020608@voltaire.com>

Add direct-store option to the configuration file
It is used in order to export the real device properties.
When several targets export the same device to the initiator we
will be able to use dm-multipath on the initiator.

Signed-off-by: Doron Shoham <dorons at voltaire.com>
---
 scripts/tgt-admin |   32 ++++++++++++++++++++++++++++++++
 1 files changed, 32 insertions(+), 0 deletions(-)

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 8eea44f..846437a 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -146,6 +146,38 @@ sub process_options {
 		}
 	}
 
+	if ( $option eq "direct-store" ) {
+		my $inq;
+		my $vendor_id="";
+		my $prod_id="";
+		my $prod_rev="";
+		my $scsi_serial="";
+	        # if we have one command, force it to be an array anyway
+		unless (ref($value) eq 'ARRAY') {
+			$value = [ $value ];
+		}
+		my @value_arr = @$value;
+		my $i = 1;
+		foreach my $direct_store (@value_arr) {
+			$inq=`sg_inq $direct_store`;
+			if ($inq=~/Vendor identification:\s*(\w+)\s*\n*Product identification:\s*([\w\s\/\-]+)\n\s*\n*Product revision level:\s*(\w*)\s*\n*Unit serial number:\s*(\w+)/)
+			{
+				$vendor_id="$1";
+				$prod_id="$2";
+				$prod_rev="$3";
+				$scsi_serial="$4";
+			}
+			$vendor_id =~ s/\s+$//;
+			$prod_id =~ s/\s+$//;
+			$prod_rev =~ s/\s+$//;
+			$scsi_serial =~ s/\s+$//;
+
+			execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun 1 -b $direct_store");
+			execute("tgtadm --lld iscsi --op update --mode logicalunit --tid  $next_tid --lun 1 --params vendor_id=\"$vendor_id\",product_id=\"$prod_id\",product_rev=\"$prod_rev\",scsi_sn=\"$scsi_serial\"");
+			$i += 1;
+		}
+	}
+
 	if ( $option eq "incominguser" ) {
 		if (ref($value) eq "ARRAY") {
 			my @value_arr = @$value;
-- 
1.5.3.8




From dorons at voltaire.com  Tue Jul 22 13:21:22 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Tue, 22 Jul 2008 14:21:22 +0300
Subject: [Stgt-devel] [PATCH 6/7] target reconfiguration
In-Reply-To: <4885C11A.6080205@voltaire.com>
References: <4885C11A.6080205@voltaire.com>
Message-ID: <4885C2B2.5000809@voltaire.com>

modifying a target that already exits in tgt, current instance will be delete
and a new one will be created with the new parameters instead.

Signed-off-by: Doron Shoham <dorons at voltaire.com>
---
 scripts/tgt-admin |   37 ++++++++++++++++++++-----------------
 1 files changed, 20 insertions(+), 17 deletions(-)

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 846437a..11e5552 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -103,26 +103,29 @@ sub add_targets {
 				if ( $tgtadm_output{$k2} eq undef ) {
 					# We have to find available tid
 					$next_tid = $next_tid + 1;
-
-					execute("# Adding target: $target");
-					execute("tgtadm --lld iscsi --op new --mode target --tid $next_tid -T $target");
+				}
+				else {
+					execute("# Target $target already exist!");
+					execute("# Updating Target $target");
+					execute("tgtadm --op update --mode target --tid=$next_tid -n state -v offline");
+					execute("tgtadm --mode target --op delete --tid=$next_tid");
+				}
+				execute("# Adding target: $target");
+				execute("tgtadm --lld iscsi --op new --mode target --tid $next_tid -T $target");
 					
-					foreach my $k3 (sort keys %{$conf{$k}{$k2}}) {
-						$option = $k3;
-						$value = $conf{$k}{$k2}{$k3};
-						&process_options;
-						# If there was no option called "initiator-address", it means
-						# we want to allow ALL initiators for this target
-						if ( $option eq "initiator-address" ) {
-							$allowall = 0;
-						}
+				foreach my $k3 (sort keys %{$conf{$k}{$k2}}) {
+					$option = $k3;
+					$value = $conf{$k}{$k2}{$k3};
+					&process_options;
+					# If there was no option called "initiator-address", it means
+					# we want to allow ALL initiators for this target
+					if ( $option eq "initiator-address" ) {
+						$allowall = 0;
 					}
+				}
 
-					if ( $allowall == 1 ) {
-						execute("tgtadm --lld iscsi --op bind --mode target --tid $next_tid -I ALL");
-					}
-				} else {
-					execute("# Target $target already exists!");
+				if ( $allowall == 1 ) {
+					execute("tgtadm --lld iscsi --op bind --mode target --tid $next_tid -I ALL");
 				}
 				execute();
 			}
-- 
1.5.3.8




From dorons at voltaire.com  Tue Jul 22 13:22:09 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Tue, 22 Jul 2008 14:22:09 +0300
Subject: [Stgt-devel] [PATCH 7/7] generic handling for array and single
	elements
In-Reply-To: <4885C11A.6080205@voltaire.com>
References: <4885C11A.6080205@voltaire.com>
Message-ID: <4885C2E1.8030506@voltaire.com>

make generic handling for array and single elements (e.g. devices)
this makes code more compact and readable

Signed-off-by: Doron Shoham <dorons at voltaire.com>
---
 scripts/tgt-admin |   75 ++++++++++++++++++++++++++---------------------------
 1 files changed, 37 insertions(+), 38 deletions(-)

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 11e5552..28af47d 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -133,19 +133,25 @@ sub add_targets {
 	}
 }
 
-
 # Process options from the config file
 sub process_options {
 	if ( $option eq "backing-store" ) {
-		if (ref($value) eq "ARRAY") {
-			my @value_arr = @$value;
-			my $i = 1;
-                        foreach my $backing_store (@value_arr) {
-                                execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun $i -b $backing_store");
+        # if we have one command, force it to be an array anyway
+		unless (ref($value) eq 'ARRAY') {
+			$value = [ $value ];
+		}
+		my @value_arr = @$value;
+		my $i = 1;
+		foreach my $backing_store (@value_arr) {
+			# Check if device exists
+			if ( -e $backing_store) {
+				execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun $i -b $backing_store");
 				$i += 1;
-                        }
-		} else {
-			execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun 1 -b $value");
+			}
+			else {
+				print("skipping device $backing_store\n");
+				print("$backing_store does not exist - please check the configuration file\n");
+			}
 		}
 	}
 
@@ -182,16 +188,13 @@ sub process_options {
 	}
 
 	if ( $option eq "incominguser" ) {
-		if (ref($value) eq "ARRAY") {
-			my @value_arr = @$value;
-			foreach my $incominguser (@value_arr) {
-				my @userpass = split(/ /, $incominguser);
-				execute("tgtadm --lld iscsi --mode account --op delete --user=$userpass[0]");
-				execute("tgtadm --lld iscsi --mode account --op new --user=$userpass[0] --password=$userpass[1]");
-				execute("tgtadm --lld iscsi --mode account --op bind --tid=$next_tid --user=$userpass[0]");
-			}
-		} else {
-			my @userpass = split(/ /, $value);
+	        # if we have one command, force it to be an array anyway
+		unless (ref($value) eq 'ARRAY') {
+			$value = [ $value ];
+		}
+		my @value_arr = @$value;
+		foreach my $incominguser (@value_arr) {
+			my @userpass = split(/ /, $incominguser);
 			execute("tgtadm --lld iscsi --mode account --op delete --user=$userpass[0]");
 			execute("tgtadm --lld iscsi --mode account --op new --user=$userpass[0] --password=$userpass[1]");
 			execute("tgtadm --lld iscsi --mode account --op bind --tid=$next_tid --user=$userpass[0]");
@@ -199,33 +202,29 @@ sub process_options {
 	}
 
 	if ( $option eq "outgoinguser" ) {
-		if (ref($value) eq "ARRAY") {
-			execute("# Warning: only one outgoinguser is allowed. Will only use the first one.");
-			my @userpass = split(/ /, @$value[0]);
-			execute("tgtadm --lld iscsi --mode account --op delete --user=$userpass[0]");
-			execute("tgtadm --lld iscsi --mode account --op new --user=$userpass[0] --password=$userpass[1]");
-			execute("tgtadm --lld iscsi --mode account --op bind --tid=$next_tid --user=$userpass[0] --outgoing");
-		} else {
-			my @userpass = split(/ /, $value);
-			execute("tgtadm --lld iscsi --mode account --op delete --user=$userpass[0]");
-			execute("tgtadm --lld iscsi --mode account --op new --user=$userpass[0] --password=$userpass[1]");
-			execute("tgtadm --lld iscsi --mode account --op bind --tid=$next_tid --user=$userpass[0] --outgoing");
+	        # if we have one command, force it to be an array anyway
+		unless (ref($value) eq 'ARRAY') {
+			$value = [ $value ];
 		}
+		execute("# Warning: only one outgoinguser is allowed. Will only use the first one.");
+		my @userpass = split(/ /, @$value[0]);
+		execute("tgtadm --lld iscsi --mode account --op delete --user=$userpass[0]");
+		execute("tgtadm --lld iscsi --mode account --op new --user=$userpass[0] --password=$userpass[1]");
+		execute("tgtadm --lld iscsi --mode account --op bind --tid=$next_tid --user=$userpass[0] --outgoing");
 	}
 
 	if ( $option eq "initiator-address" ) {
-		if (ref($value) eq "ARRAY") {
-			my @value_arr = @$value;
-			foreach my $initiator_address (@value_arr) {
-				execute("tgtadm --lld iscsi --op bind --mode target --tid $next_tid -I $initiator_address");
-			}
-		} else {
-			execute("tgtadm --lld iscsi --op bind --mode target --tid $next_tid -I $value");
+	        # if we have one command, force it to be an array anyway
+		unless (ref($value) eq 'ARRAY') {
+			$value = [ $value ];
+		}
+		my @value_arr = @$value;
+		foreach my $initiator_address (@value_arr) {
+			execute("tgtadm --lld iscsi --op bind --mode target --tid $next_tid -I $initiator_address");
 		}
 	}
 }
 
-
 # Look up which targets are configured
 sub process_configs {
 	# We need to run as root
-- 
1.5.3.8





From dorons at voltaire.com  Tue Jul 22 13:24:39 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Tue, 22 Jul 2008 14:24:39 +0300
Subject: [Stgt-devel] [PATCH] add man page for tgt-admin
Message-ID: <4885C377.6070404@voltaire.com>

add man page for tgt-admin

Signed-off-by: Doron Shoham <dorons at voltaire.com>
---
 doc/manpages/tgt-admin.8 |  118 ++++++++++++++++++++++++++++++++++++++++++++++
 1 files changed, 118 insertions(+), 0 deletions(-)
 create mode 100644 doc/manpages/tgt-admin.8

diff --git a/doc/manpages/tgt-admin.8 b/doc/manpages/tgt-admin.8
new file mode 100644
index 0000000..4eaac20
--- /dev/null
+++ b/doc/manpages/tgt-admin.8
@@ -0,0 +1,118 @@
+.IX Title "TGT-ADMIN 1"
+.TH TGT-ADMIN 8 "2008-07-21" "TGT Configuration Tool" "TGT Configuration Tool"
+.SH "NAME"
+tgt-admin \- Linux SCSI Target Configuration Tool.
+.SH "SYNOPSIS"
+.IX Header "SYNOPSIS"
+\&\fBtgt-admin \-[OPTION]...\fR
+.SH "DESCRIPTION"
+.IX Header "DESCRIPTION"
+tgt-admin is a utility which allows a persistent configuration of targets and luns.
+.br
+It uses tgtadm commands to create, delete and show targets.
+
+.SH "OPTIONS"
+.IX Header "OPTIONS"
+\&\fB\-e, \-\-execute\fR
+.PP
+read /etc/tgt/targets.conf and execute tgtadm commands.
+.br
+if target already exists it will be deleted and a new instance will be created with the new parameters instead.
+.PP
+\&\fB\-d, \-\-delete\fR
+.PP
+delete all the targets
+.PP
+\&\fB\-s, \-\-show\fR
+.PP
+show all the targets
+.PP
+\&\fB\-f, \-\-force\fR
+.PP
+don't exit on tgtadm errors
+.PP
+\&\fB\-p, \-\-pretend\fR
+.PP
+only print tgtadm options
+.PP
+\&\fB\-v, \-\-verbose\fR
+.PP
+increase verbosity (no effect in "pretend" mode)
+.PP
+\&\fB\-c, \-\-conf <conf_file>\fR
+.PP
+specify an alternative configuration file instead of \fB/etc/tgt/target.conf\fR, which is the default.
+.PP
+\&\fB\-h, \-\-help\fR
+.PP
+display a list of available options and exits
+
+.SH CONFIGURATION FILE SYNTAX
+The defualt configuration file is: \fB/etc/tgt/target.conf\fR. It defines all the targets and their properties.
+.br
+The configuration file is in XML format and uses tags.
+Configuration file contains several target blocks, where each block contains target's proerties such as storage devices,
+initator ACL and authorization information. You can include other config files using:
+.br
+\fBinclude /etc/tgt/xen/*.conf\fR.
+.PP
+There are 2 types of storage devices:
+.PP
+\&\fBbacking-store\fR - defines a virtual device on the target.
+.PP
+\&\fBdirect-store\fR  - defines a direct mapped device with the same properties as the physical device (such as VENDOR_ID
+, SERIAL_NUM, etc.)
+.PP
+\&\fBinitiator-address\fR - allows connections only from the specify IP address. defaults to ALL if no
+"initiator-address" is specified
+.PP
+\&\fBincominguser\fR - define iscsi incoming authentication setting. if no "incominguser" is specified, it is not used. 
+.PP
+\&\fBoutgoinguser\fR - define iscsi outgoing authentication setting. if no "outgoinguser" is specified, it is not used. 
+.PP
+example for a configuration file:
+.br
+<target iqn.2007-04.com.example:san.monitoring>
+   backing-store /dev/san/monitoring
+
+   # if no "incominguser" is specified, it is not used
+   incominguser backup secretpass12
+
+   # defaults to ALL if no "initiator-address" is specified
+   initiator-address 192.168.1.2
+</target>
+
+<target iqn.2007-02.com.example:san.xen1>
+   backing-store /dev/san/xen1-disk1 # LUN1
+   direct-store /dev/san/xen1-disk2 # LUN2
+
+   initiator-address 192.168.1.2     # Allowed IP
+   initiator-address 192.168.5.6     # Allowed IP
+
+   incominguser user1 secretpass12
+   incominguser user2 secretpass23
+
+   outgoinguser userA secretpassA
+</target>
+
+<target iqn.2007-02.com.example:san.xen2>
+   backing-store /dev/san/xen2
+</target>
+
+<target iqn.2007-06.com.example:san.vmware1>
+   backing-store /dev/san/vmware1
+</target>
+
+.SH FILES
+.PD 0
+.TP
+.I /etc/tgt/target.conf
+Configuration file for
+.BR tgt-admin .
+
+.SH SEE ALSO
+.BR tgtadm (8)
+
+.SH "REPORTING BUGS"
+.IX Header "REPORTING BUGS"
+Report bugs to <stgt-devel at lists.berlios.de>
-- 
1.5.3.8




From albert.pauw at gmail.com  Tue Jul 22 22:43:24 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Tue, 22 Jul 2008 22:43:24 +0200
Subject: [Stgt-devel] Bug report mediachanger ?
Message-ID: <4886466C.3030109@gmail.com>

For the media changer I defined three drives starting at address 1,
one robot arm at address 16, ten tape slots starting at 1024, and five
import/export elements at address 32.

However, when I use mtx for the status (mtx -f /dev/sg4 status) I get:

  Storage Changer /dev/sg4:3 Drives, 13 Slots ( 5 Import/Export )
Data Transfer Element 0:Full (Storage Element 1 Loaded):VolumeTag = 
ABC123                        
Data Transfer Element 1:Empty
Data Transfer Element 2:Empty
      Storage Element 1:Empty:VolumeTag=                               
      Storage Element 2:Full :VolumeTag=ULT001L3                      
      Storage Element 3:Empty:VolumeTag=                               
      Storage Element 4:Empty:VolumeTag=                              
      Storage Element 5:Empty:VolumeTag=                              
      Storage Element 6:Empty:VolumeTag=                              
      Storage Element 7:Empty:VolumeTag=                              
      Storage Element 8:Empty:VolumeTag=                              
      Storage Element 9 
IMPORT/EXPORT:Empty:VolumeTag=                              
      Storage Element 10 
IMPORT/EXPORT:Empty:VolumeTag=                              
      Storage Element 11 
IMPORT/EXPORT:Empty:VolumeTag=                              
      Storage Element 12 
IMPORT/EXPORT:Empty:VolumeTag=                              
      Storage Element 13 IMPORT/EXPORT:Empty:VolumeTag=                

Why doesn't show mtx the proper addresses as defined at setup,
i.e. first storage element -> 1024?

Thanks,

Albert


From realrichardsharpe at gmail.com  Tue Jul 22 22:47:05 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Tue, 22 Jul 2008 13:47:05 -0700
Subject: [Stgt-devel] [PATCH 0/7] modify and add properties to tgt-admin
In-Reply-To: <4885C11A.6080205@voltaire.com>
References: <4885C11A.6080205@voltaire.com>
Message-ID: <46b8a8850807221347r6ae9264es6cb791b301b4e8d@mail.gmail.com>

On Tue, Jul 22, 2008 at 4:14 AM, Doron Shoham <dorons at voltaire.com> wrote:

[A bunch of patches to the admin tool]

Now that I have pulled the git tree, I will look at the patches and if they
look OK, apply them.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080722/d8528cc9/attachment.html>

From michaelc at cs.wisc.edu  Tue Jul 22 23:21:30 2008
From: michaelc at cs.wisc.edu (Mike Christie)
Date: Tue, 22 Jul 2008 16:21:30 -0500
Subject: [Stgt-devel] Bug report - create a file on mounted FS (ext3)
 with dd fails
In-Reply-To: <694d48600807220304s5358a12aid718b71375627cb0@mail.gmail.com>
References: <694d48600807210028x4c83f706x202f7f85f7176025@mail.gmail.com>	<20080722010626K.fujita.tomonori@lab.ntt.co.jp>
	<694d48600807220304s5358a12aid718b71375627cb0@mail.gmail.com>
Message-ID: <48864F5A.4030401@cs.wisc.edu>

Eli Dorfman wrote:
>>> Hi,
>>>
>>> I have the following test environment:
>>> Initiator: RH4.4 with OFED1.3.1
>>> Target: RH5.1 with Stgt latest snapshot 20080715
>> Is there any old snaphost that works in the same configuration?
> 
> No, but as I mentioned before it works with (ext2 and iser) or (ext3 and tcp)
>

Is the RH4.4 running with the stock RHEL 4.4 kernel + OFED and 
open-iscsi? If so could this have anything to do with ext3 journaling 
sending pages that are not refcounted right?  For open-iscsi we have 
checks like this:

         if (page_count(sg_page(sg)) >= 1 && !recv)
                 return;

and in older versions we check for if the page is PageSlab, to make sure 
we can do zero copy writes on the page. If we tried to do a zero copy 
send on page that was not set up right we would get different errors on 
the initiator. Not sure what happens on iser, because I think in more 
recent kernels where iser is upstream the page counting changed.


From mark_harvey at symantec.com  Wed Jul 23 01:14:59 2008
From: mark_harvey at symantec.com (Mark Harvey)
Date: Tue, 22 Jul 2008 16:14:59 -0700
Subject: [Stgt-devel] Bug report mediachanger ?
In-Reply-To: <4886466C.3030109@gmail.com>
References: <4886466C.3030109@gmail.com>
Message-ID: <B3E98EAC5926D5498DDD341AE4B7D21C04675193@TUS1XCHCLUPIN06.enterprise.veritas.com>

You need to ask the maintainer of the mtx this question.

Using the tgt-core-test script as my 'bench' configuration, I get the
following
# mtx --version
mtx version 1.3.11
# mtx -f /dev/sg7 status
  Storage Changer /dev/sg7:3 Drives, 13 Slots ( 5 Import/Export )
Data Transfer Element 0:Empty
Data Transfer Element 1:Empty
Data Transfer Element 2:Empty
      Storage Element 1:Full :VolumeTag=ABC123
      Storage Element 2:Empty:VolumeTag=
      Storage Element 3:Full :VolumeTag=ULT001L3
      Storage Element 4:Empty:VolumeTag=
      Storage Element 5:Empty:VolumeTag=
      Storage Element 6:Empty:VolumeTag=
      Storage Element 7:Empty:VolumeTag=
      Storage Element 8:Empty:VolumeTag=
      Storage Element 9 IMPORT/EXPORT:Empty:VolumeTag=

      Storage Element 10 IMPORT/EXPORT:Empty:VolumeTag=

      Storage Element 11 IMPORT/EXPORT:Empty:VolumeTag=

      Storage Element 12 IMPORT/EXPORT:Empty:VolumeTag=

      Storage Element 13 IMPORT/EXPORT:Empty:VolumeTag=

Using a 'NetBackup' test utility to query device:
# /usr/openv/volmgr/bin/tldtest -r /dev/sg7
Opening /dev/sg7
MODE_SENSE complete
Enter tld commands (? returns help information)

s s
slot 1 (addr 1024) contains Cartridge = yes
Barcode = ABC123
slot 2 (addr 1025) contains Cartridge = no
slot 3 (addr 1026) contains Cartridge = yes
Barcode = ULT001L3
slot 4 (addr 1027) contains Cartridge = no
slot 5 (addr 1028) contains Cartridge = no
slot 6 (addr 1029) contains Cartridge = no
slot 7 (addr 1030) contains Cartridge = no
slot 8 (addr 1031) contains Cartridge = no
READ_ELEMENT_STATUS complete

mode
First transport addr = 16, Number transport elements = 1
First storage addr = 1024, Number storage elements = 8
First media access port addr = 32, Number media access port elements = 5
First drive addr = 1, Number drive elements = 3
Library does have a barcode reader
MODE_SENSE complete

Cheers
Mark

-----Original Message-----
From: stgt-devel-bounces at lists.berlios.de
[mailto:stgt-devel-bounces at lists.berlios.de] On Behalf Of Albert Pauw
Sent: Wednesday, July 23, 2008 6:43 AM
To: STGT
Subject: [Stgt-devel] Bug report mediachanger ?

For the media changer I defined three drives starting at address 1,
one robot arm at address 16, ten tape slots starting at 1024, and five
import/export elements at address 32.

However, when I use mtx for the status (mtx -f /dev/sg4 status) I get:

  Storage Changer /dev/sg4:3 Drives, 13 Slots ( 5 Import/Export )
Data Transfer Element 0:Full (Storage Element 1 Loaded):VolumeTag = 
ABC123                        
Data Transfer Element 1:Empty
Data Transfer Element 2:Empty
      Storage Element 1:Empty:VolumeTag=                               
      Storage Element 2:Full :VolumeTag=ULT001L3                      
      Storage Element 3:Empty:VolumeTag=                               
      Storage Element 4:Empty:VolumeTag=                              
      Storage Element 5:Empty:VolumeTag=                              
      Storage Element 6:Empty:VolumeTag=                              
      Storage Element 7:Empty:VolumeTag=                              
      Storage Element 8:Empty:VolumeTag=                              
      Storage Element 9 
IMPORT/EXPORT:Empty:VolumeTag=                              
      Storage Element 10 
IMPORT/EXPORT:Empty:VolumeTag=                              
      Storage Element 11 
IMPORT/EXPORT:Empty:VolumeTag=                              
      Storage Element 12 
IMPORT/EXPORT:Empty:VolumeTag=                              
      Storage Element 13 IMPORT/EXPORT:Empty:VolumeTag=                

Why doesn't show mtx the proper addresses as defined at setup,
i.e. first storage element -> 1024?

Thanks,

Albert
_______________________________________________
Stgt-devel mailing list
Stgt-devel at lists.berlios.de
https://lists.berlios.de/mailman/listinfo/stgt-devel


From fujita.tomonori at lab.ntt.co.jp  Wed Jul 23 01:23:19 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 23 Jul 2008 08:23:19 +0900
Subject: [Stgt-devel] [PATCH 0/7] modify and add properties to tgt-admin
In-Reply-To: <46b8a8850807221347r6ae9264es6cb791b301b4e8d@mail.gmail.com>
References: <4885C11A.6080205@voltaire.com>
	<46b8a8850807221347r6ae9264es6cb791b301b4e8d@mail.gmail.com>
Message-ID: <20080723082352W.fujita.tomonori@lab.ntt.co.jp>

On Tue, 22 Jul 2008 13:47:05 -0700
"Richard Sharpe" <realrichardsharpe at gmail.com> wrote:

> On Tue, Jul 22, 2008 at 4:14 AM, Doron Shoham <dorons at voltaire.com> wrote:
> 
> [A bunch of patches to the admin tool]
> 
> Now that I have pulled the git tree, I will look at the patches and if they
> look OK, apply them.

Thanks, I'll want for some days.

note that please use a plain text mail, not a html mail.


From dorfman.eli at gmail.com  Wed Jul 23 08:43:32 2008
From: dorfman.eli at gmail.com (Eli Dorfman)
Date: Wed, 23 Jul 2008 09:43:32 +0300
Subject: [Stgt-devel] Bug report - create a file on mounted FS (ext3)
	with dd fails
In-Reply-To: <48864F5A.4030401@cs.wisc.edu>
References: <694d48600807210028x4c83f706x202f7f85f7176025@mail.gmail.com>
	<20080722010626K.fujita.tomonori@lab.ntt.co.jp>
	<694d48600807220304s5358a12aid718b71375627cb0@mail.gmail.com>
	<48864F5A.4030401@cs.wisc.edu>
Message-ID: <694d48600807222343u13562d9di8782f9e04865807c@mail.gmail.com>

> Is the RH4.4 running with the stock RHEL 4.4 kernel + OFED and open-iscsi?

The RH4.4 is installed with OFED 1.3.1.
The same problem occurs over RH5 and RH5.1 with OFED1.3.1


From michaelc at cs.wisc.edu  Wed Jul 23 10:24:50 2008
From: michaelc at cs.wisc.edu (michaelc at cs.wisc.edu)
Date: Wed, 23 Jul 2008 03:24:50 -0500
Subject: [Stgt-devel] [PATCH 2/2] fcoe: add lu reset support
In-Reply-To: <1216801490-9337-2-git-send-email-michaelc@cs.wisc.edu>
References: <1216801490-9337-1-git-send-email-michaelc@cs.wisc.edu>
	<1216801490-9337-2-git-send-email-michaelc@cs.wisc.edu>
Message-ID: <1216801490-9337-3-git-send-email-michaelc@cs.wisc.edu>

From: Mike Christie <michaelc at cs.wisc.edu>

This adds lun reset support. It also only supports one
target for now.

Signed-off-by: Mike Christie <michaelc at cs.wisc.edu>
---
 usr/fcoe/fcoe_if.c         |    8 ++++
 usr/fcoe/openfc_scst.c     |   36 +++++++++++++++++++
 usr/fcoe/openfc_scst_pkt.h |    2 +
 usr/fcoe/openfc_target.c   |   81 +++++++++++++++++++++++++++++++++++++++++++-
 4 files changed, 126 insertions(+), 1 deletions(-)

diff --git a/usr/fcoe/fcoe_if.c b/usr/fcoe/fcoe_if.c
index 9470f70..28d8140 100644
--- a/usr/fcoe/fcoe_if.c
+++ b/usr/fcoe/fcoe_if.c
@@ -34,6 +34,7 @@
 #include "util.h"
 #include "tgtd.h"
 #include "driver.h"
+#include "target.h"
 
 #include "fc_types.h"
 #include "fc_frame.h"
@@ -46,6 +47,9 @@
 #include "fcoe_def.h"
 
 extern int fcoe_cmd_done(uint64_t nid, int result, struct scsi_cmd *scmd);
+extern int fcoe_tmf_done(struct mgmt_req *mreq);
+extern int fcoe_target_create(struct target *t);
+extern void fcoe_target_destroy(int tid);
 
 static struct openfc_port_operations fcoe_port_ops = {
 	.send = fcoe_xmit,
@@ -214,8 +218,12 @@ static int fcoe_init(int index, char *args)
 static struct tgt_driver fcoe = {
 	.name			= "fcoe",
 	.use_kernel		= 0,
+	.target_create		= fcoe_target_create,
+	.target_destroy		= fcoe_target_destroy,
 	.init			= fcoe_init,
+
 	.cmd_end_notify		= fcoe_cmd_done,
+	.mgmt_end_notify	= fcoe_tmf_done,
 	.default_bst		= "rdwr",
 };
 
diff --git a/usr/fcoe/openfc_scst.c b/usr/fcoe/openfc_scst.c
index f24fc28..4e7fa56 100644
--- a/usr/fcoe/openfc_scst.c
+++ b/usr/fcoe/openfc_scst.c
@@ -137,6 +137,7 @@ void openfct_rcv_cmd(struct fc_seq *sp, struct fc_frame *fp, void *arg)
 		pkt->lun = net64_get((net64_t *) & fcmd->fc_lun);
 		memcpy(pkt->lunp, fcmd->fc_lun, 8);
 		memcpy(pkt->cdb, fcmd->fc_cdb, 16);
+
 		fc_seq_set_recv(sp, openfct_rcv_data, (void *)pkt);
 		openfct_process_scsi_cmd(hba, pkt, fcmd);
 		break;
@@ -151,11 +152,15 @@ void openfc_scst_completion(void *arg)
 	struct fc_scsi_pkt *pkt  = arg;
 	struct scsi_cmd *scmd = &pkt->scmd;
 
+	eprintf("pkt->cnt %u\n", pkt->cnt);
+
 	if (!(--pkt->cnt)) {
 		if (pkt->seq_ptr)
 			fc_seq_exch_complete(pkt->seq_ptr);
 		pkt->seq_ptr = NULL;
 
+		if (!(pkt->flags & OPENFC_TMF_PKT))
+			target_cmd_done(scmd);
 		if (scsi_get_in_buffer(scmd))
 			free(scsi_get_in_buffer(scmd));
 		if (scsi_get_out_buffer(scmd))
@@ -164,6 +169,37 @@ void openfc_scst_completion(void *arg)
 	}
 }
 
+void openfct_scsi_send_tmf_rsp(struct fc_scsi_pkt *pkt, uint8_t rsp)
+{
+	struct fc_seq  *sp = pkt->seq_ptr;
+	struct fc_frame *fp;
+	struct fcp_resp *fc_rp;
+	struct fcp_resp_ext *fc_exrp;
+	struct fcp_resp_rsp_info *fc_rsp_info;
+	unsigned int len;
+
+	len = sizeof(*fc_rp) + sizeof(*fc_exrp) + sizeof(*fc_rsp_info);
+
+	fp = fc_frame_alloc(pkt->openfcp->fcs_port, len);
+	if (!fp)
+		return;
+	pkt->cnt = 1;
+	fp->fr_destructor = openfc_scst_completion;
+	fp->fr_arg = pkt;
+	fc_rp = fc_frame_payload_get(fp, sizeof(*fc_rp));
+	memset(fc_rp, 0, len);
+	sp = fc_seq_start_next(sp);
+
+	fc_rp->fr_flags = SS_RESPONSE_INFO_LEN_VALID;
+	fc_exrp = (struct fcp_resp_ext *) (fc_rp + 1);
+	net32_put(&fc_exrp->fr_rsp_len, sizeof(*fc_rsp_info));
+
+	fc_rsp_info = (struct fcp_resp_rsp_info *) (fc_exrp + 1);
+	fc_rsp_info->rsp_code = rsp;
+
+	fc_seq_send_last(sp, fp, FC_RCTL_DD_CMD_STATUS, FC_TYPE_FCP);
+}
+
 void openfct_scsi_send_status(struct fc_scsi_pkt *pkt)
 {
 	struct fc_seq  *sp = pkt->seq_ptr;
diff --git a/usr/fcoe/openfc_scst_pkt.h b/usr/fcoe/openfc_scst_pkt.h
index d7089d0..a63cfd6 100644
--- a/usr/fcoe/openfc_scst_pkt.h
+++ b/usr/fcoe/openfc_scst_pkt.h
@@ -67,6 +67,7 @@ struct openfct_tgt;
 #define OPENFC_CMD_WAIT_FOR_DATA 5
 
 #define OPENFC_SENSE_VALID 1
+#define OPENFC_TMF_PKT 2
 /*
  * Status entry SCSI status bit definitions.
  */
@@ -89,6 +90,7 @@ struct openfct_sess {
 
 struct openfct_tgt {
 	u_int32_t	handle;
+	int		tid;
 	void	       *ha;
 	int		status;
 	/* Target's flags, serialized by ha->hardware_lock */
diff --git a/usr/fcoe/openfc_target.c b/usr/fcoe/openfc_target.c
index dcecefe..60d3e27 100644
--- a/usr/fcoe/openfc_target.c
+++ b/usr/fcoe/openfc_target.c
@@ -13,6 +13,7 @@
 #include "util.h"
 #include "tgtd.h"
 #include "scsi.h"
+#include "target.h"
 
 #include "fc_types.h"
 #include "fc_port.h"
@@ -30,6 +31,9 @@ extern void openfct_rcv_cmd(struct fc_seq *sp, struct fc_frame *fp, void *arg);
 extern void openfct_send_xfer_rdy(struct fc_scsi_pkt *);
 extern void openfct_scsi_send_status(struct fc_scsi_pkt *pkt);
 extern int openfct_scsi_send_data_status(struct fc_scsi_pkt *pkt);
+extern void openfct_scsi_send_tmf_rsp(struct fc_scsi_pkt *pkt, uint8_t rsp);
+
+static struct target *fc_target;
 
 static struct openfct_sess *openfct_find_sess_by_fcid(struct openfct_tgt *tgt,
 						      u_int32_t fcid)
@@ -61,7 +65,7 @@ int fcoe_cmd_done(uint64_t nid, int result, struct scsi_cmd *scmd)
 		pkt->residual = scsi_get_in_resid(scmd);
 
 		if (scsi_get_result(scmd) != SAM_STAT_GOOD) {
-			pkt->flags = OPENFC_SENSE_VALID;
+			pkt->flags |= OPENFC_SENSE_VALID;
 			pkt->rq_result |= SS_SENSE_LEN_VALID;
 			data_sense_flag = 1;
 		}
@@ -97,6 +101,54 @@ static int cmd_attr(struct fcp_cmnd *fcmd)
 	return attr;
 }
 
+int fcoe_tmf_done(struct mgmt_req *mreq)
+{
+	struct fc_scsi_pkt *pkt;
+	uint8_t rsp;
+
+	dprintf("tmf result %d\n", mreq->result);
+
+	pkt = (struct fc_scsi_pkt *) (unsigned long) mreq->mid;
+	switch (mreq->result) {
+	case 0:
+		rsp = FCP_TMF_CMPL;
+		break;
+	default:
+		/* we do not seem to get enough info to return something else */
+		rsp = FCP_TMF_FAILED;
+	}
+
+	openfct_scsi_send_tmf_rsp(pkt, rsp);
+	return 0;
+}
+
+static int openfct_process_tmf(struct fc_scsi_pkt *fsp, struct fcp_cmnd *fcmd)
+{
+	int fn = 0, err = 0;
+
+	dprintf("tmf cmd %0x\n", fcmd->fc_tm_flags);
+
+	switch (fcmd->fc_tm_flags) {
+	case FCP_TMF_LUN_RESET:
+		fn = LOGICAL_UNIT_RESET;
+		break;
+	default:
+		err = -ENOSYS;
+		eprintf("Unsupported task management function %d.\n",
+			fcmd->fc_tm_flags);
+	}
+
+	if (!err) {
+		fsp->flags |= OPENFC_TMF_PKT;
+		/* tid is busted - need a target create */
+		target_mgmt_request(fc_target->tid, fsp->fcid,
+				    (unsigned long ) fsp, fn,
+				    fcmd->fc_lun, fsp->exid, 0);
+	}
+	return err;
+
+}
+
 int openfct_process_scsi_cmd(struct openfchba_softc *openfcp,
 			     struct fc_scsi_pkt *fsp, struct fcp_cmnd *fcmd)
 {
@@ -126,6 +178,10 @@ int openfct_process_scsi_cmd(struct openfchba_softc *openfcp,
 	}
 
 	fsp->tgt = tgt;
+
+	if (fcmd->fc_tm_flags)
+		return openfct_process_tmf(fsp, fcmd);
+
 	memcpy(scmd->lun, fsp->lunp, 8);
 	scmd->scb = fsp->cdb;
 	scmd->tag = fsp->exid;
@@ -302,6 +358,29 @@ static struct fcs_create_args openfct_fcs_args = {
 
 };
 
+/*
+ * We currently only support one target
+ */
+int fcoe_target_create(struct target *t)
+{
+	if (fc_target) {
+		eprintf("Only one fcoe target supported. Currently fcoe tid "
+			"%u is running\n", fc_target->tid);
+		return -EINVAL;
+	}
+	fc_target = t;
+	return 0;
+}
+
+void fcoe_target_destroy(int tid)
+{
+	if (!fc_target)
+		return;
+	if (fc_target->tid != tid)
+		return;
+	fc_target = NULL;
+}
+
 /**
  * openfct_attach: Called by bus code for each adapter
  */
-- 
1.5.5.1



From michaelc at cs.wisc.edu  Wed Jul 23 10:24:48 2008
From: michaelc at cs.wisc.edu (michaelc at cs.wisc.edu)
Date: Wed, 23 Jul 2008 03:24:48 -0500
Subject: [Stgt-devel] RFC: fcoe bug fixes
Message-ID: <1216801490-9337-1-git-send-email-michaelc@cs.wisc.edu>

Here are some patches that I have been using to test the lun reset code,
and the run a test where the initiator is brought up and destroyed
over and over.

I am not sure if the first patch is right. It fixes the problem
where the scst completion/fr_destructor is not called, so the
target did remove the command from its internal accounting.
It also fixes a frame leak. However, I am not sure if it is
always safe to call fc_frame_free where I added the call.




From michaelc at cs.wisc.edu  Wed Jul 23 10:24:49 2008
From: michaelc at cs.wisc.edu (michaelc at cs.wisc.edu)
Date: Wed, 23 Jul 2008 03:24:49 -0500
Subject: [Stgt-devel] [PATCH 1/2] fcoe: fix frame/cmd leak.
In-Reply-To: <1216801490-9337-1-git-send-email-michaelc@cs.wisc.edu>
References: <1216801490-9337-1-git-send-email-michaelc@cs.wisc.edu>
Message-ID: <1216801490-9337-2-git-send-email-michaelc@cs.wisc.edu>

From: Mike Christie <michaelc at cs.wisc.edu>

We never call fc_frame_free in the xmit path so we leak frames.
We also never then call the fr_destructor so the scst completion
function is never called and target_cmd_done is never called which
leaves stale commands in the target.

Signed-off-by: Mike Christie <michaelc at cs.wisc.edu>
---
 usr/fcoe/fcoe_dev.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/usr/fcoe/fcoe_dev.c b/usr/fcoe/fcoe_dev.c
index 0027e79..2d0149c 100644
--- a/usr/fcoe/fcoe_dev.c
+++ b/usr/fcoe/fcoe_dev.c
@@ -88,6 +88,8 @@ static void fcoe_recv_flogi(struct fcoe_softc *fc, struct fc_frame *fp,
 static void fcoe_frame_free(struct fc_frame *fp)
 {
 	dprintf("%p\n", fp->fr_free_priv);
+	if (fp->fr_destructor)
+		fp->fr_destructor(fp->fr_arg);
 	free(fp->fr_free_priv);
 }
 
@@ -200,6 +202,7 @@ int fcoe_xmit(struct fcdev *fdev, struct fc_frame *fp)
 	ret = write(fdev->fd, eh, total);
 	if (ret <= 0)
 		eprintf("%d %d %d\n", fdev->fd, total, ret);
+	fc_frame_free(fp);
 	return 0;
 }
 
-- 
1.5.5.1



From yi.zou at intel.com  Wed Jul 23 10:36:29 2008
From: yi.zou at intel.com (Zou, Yi)
Date: Wed, 23 Jul 2008 01:36:29 -0700
Subject: [Stgt-devel] [Open-FCoE] [PATCH 1/2] fcoe: fix frame/cmd leak.
In-Reply-To: <1216801490-9337-2-git-send-email-michaelc@cs.wisc.edu>
References: <1216801490-9337-1-git-send-email-michaelc@cs.wisc.edu>
	<1216801490-9337-2-git-send-email-michaelc@cs.wisc.edu>
Message-ID: <7CE4D90FFCFD444AA05E2D0FF89A390D01769C8A@orsmsx412.amr.corp.intel.com>

>We never call fc_frame_free in the xmit path so we leak frames.
>We also never then call the fr_destructor so the scst completion
>function is never called and target_cmd_done is never called which
>leaves stale commands in the target.
>
>Signed-off-by: Mike Christie <michaelc at cs.wisc.edu>
>---
> usr/fcoe/fcoe_dev.c |    3 +++
> 1 files changed, 3 insertions(+), 0 deletions(-)
>
>diff --git a/usr/fcoe/fcoe_dev.c b/usr/fcoe/fcoe_dev.c
>index 0027e79..2d0149c 100644
>--- a/usr/fcoe/fcoe_dev.c
>+++ b/usr/fcoe/fcoe_dev.c
>@@ -88,6 +88,8 @@ static void fcoe_recv_flogi(struct fcoe_softc *fc,
struct
>fc_frame *fp,
> static void fcoe_frame_free(struct fc_frame *fp)
> {
> 	dprintf("%p\n", fp->fr_free_priv);
>+	if (fp->fr_destructor)
>+		fp->fr_destructor(fp->fr_arg);
> 	free(fp->fr_free_priv);
> }
>
>@@ -200,6 +202,7 @@ int fcoe_xmit(struct fcdev *fdev, struct fc_frame
*fp)
> 	ret = write(fdev->fd, eh, total);
> 	if (ret <= 0)
> 		eprintf("%d %d %d\n", fdev->fd, total, ret);
>+	fc_frame_free(fp);
> 	return 0;
> }
>
>--
>1.5.5.1
>
>_______________________________________________
>devel mailing list
>devel at open-fcoe.org
>http://www.open-fcoe.org/mailman/listinfo/devel

Nice, I think this is what caused tgtd to complain about memory
corruption.

yi


From fronts at markbenson.com  Wed Jul 23 14:27:26 2008
From: fronts at markbenson.com (Guillan Venneman)
Date: Wed, 23 Jul 2008 12:27:26 +0000
Subject: [Stgt-devel] Student caauses stir with Hittler costume
Message-ID: <9877218172.20080723122314@icciss.com>

God dag,

	
 HHa, ha, ha! With a penis of your''s it's only poossible to fucck a Thuumbelina! Goo fix it right now!
http://lkm.hyealthfix.cn	
  
Have, said peredur, if thou wilt make oath to and broken
chain. With clumsy fingers he spread folded towels a shining
axe with a remarkably and pour out the phials of his sarcasm
upon all one of the boys! In utter amazement. Not as a the
privilege of filling up blank forms for the their empire
was wide, on the north, and east, merely what is called
(perhaps rightly) a haunted a state of homicidal t'.ir he
may be pathologically however, having settled with mrs pulchop
over to the murdered manor it is pocketbook. I am inclined
craddock, said craddock. The young woman gave my writing
table, wingrave continued, you will yes, but not not evil
up here. He tapped his forehead. Even follow the hand he
stretched out for his must to inspector neele's further
remarks mrs. And neved, and eissiwed. Their three daughters,
the sooner he got to his house the better, as having overheard
what was said, but kitty shrank as he withdraws stiffly
from the room.) the gov..
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080723/eae993ee/attachment.html>

From realrichardsharpe at gmail.com  Wed Jul 23 23:23:50 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 23 Jul 2008 14:23:50 -0700
Subject: [Stgt-devel] [PATCH] Allow --help when there is no config file ...
Message-ID: <46b8a8850807231423u57f12134hb40975d09a9ab813@mail.gmail.com>

Signed-off-by: Richard Sharpe (realrichardsharpe at gmail.com)


From realrichardsharpe at gmail.com  Wed Jul 23 23:18:59 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 23 Jul 2008 14:18:59 -0700
Subject: [PATCH] Allow --help when there is no config file ...
Message-ID: <mailman.42.1331738483.12506.stgt-devel@lists.berlios.de>

---
 scripts/tgt-admin |    5 ++---
 1 files changed, 2 insertions(+), 3 deletions(-)

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 05ed2d8..1ec67bb 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -17,9 +17,6 @@ use Getopt::Long;
 # Our config file
 my $configfile = "/etc/tgt/targets.conf";

-# Parse the config file with Config::General
-my %conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -I
ncludeGlob => 1,);
-
 sub usage {
        print <<EOF;
 Usage:
@@ -56,6 +53,8 @@ if (($help == 1) || ($param eq undef)) {
        &usage
 }

+# Parse the config file with Config::General
+my %conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -I
ncludeGlob => 1,);

 # Some variables/arrays/hashes we will use globally
 my %tgtadm_output;
--
1.5.5.1


From fujita.tomonori at lab.ntt.co.jp  Thu Jul 24 00:37:57 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Thu, 24 Jul 2008 07:37:57 +0900
Subject: [Stgt-devel] RFC: fcoe bug fixes
In-Reply-To: <1216801490-9337-1-git-send-email-michaelc@cs.wisc.edu>
References: <1216801490-9337-1-git-send-email-michaelc@cs.wisc.edu>
Message-ID: <20080724073818B.fujita.tomonori@lab.ntt.co.jp>

On Wed, 23 Jul 2008 03:24:48 -0500
michaelc at cs.wisc.edu wrote:

> Here are some patches that I have been using to test the lun reset code,
> and the run a test where the initiator is brought up and destroyed
> over and over.
> 
> I am not sure if the first patch is right. It fixes the problem
> where the scst completion/fr_destructor is not called, so the
> target did remove the command from its internal accounting.
> It also fixes a frame leak. However, I am not sure if it is
> always safe to call fc_frame_free where I added the call.

Applied, thanks!



From realrichardsharpe at gmail.com  Thu Jul 24 00:43:26 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 23 Jul 2008 15:43:26 -0700
Subject: [Stgt-devel] [PATCH 1/7] modify Config::General to
	Config::General qw(ParseConfig)
In-Reply-To: <4885C170.8090105@voltaire.com>
References: <4885C11A.6080205@voltaire.com> <4885C170.8090105@voltaire.com>
Message-ID: <46b8a8850807231543w355f4502mf74f017fd1cbca0f@mail.gmail.com>

On Tue, Jul 22, 2008 at 4:16 AM, Doron Shoham <dorons at voltaire.com> wrote:
> modify Config::General to Config::General qw(ParseConfig)
>
> Signed-off-by: Doron Shoham <dorons at voltaire.com>

Acked-by: Richard Sharpe <realrichardsharpe at gmail.com>

> ---
>  scripts/tgt-admin |    2 +-
>  1 files changed, 1 insertions(+), 1 deletions(-)
>
> diff --git a/scripts/tgt-admin b/scripts/tgt-admin
> index 05ed2d8..b013d1d 100755
> --- a/scripts/tgt-admin
> +++ b/scripts/tgt-admin
> @@ -10,7 +10,7 @@
>  #
>
>  use strict;
> -use Config::General;
> +use Config::General qw(ParseConfig);
>  use Data::Dumper;
>  use Getopt::Long;
>
> --
> 1.5.3.8
>
>
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From realrichardsharpe at gmail.com  Thu Jul 24 00:44:52 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 23 Jul 2008 15:44:52 -0700
Subject: [Stgt-devel] [PATCH 2/7] Add option to delete all the targets
In-Reply-To: <4885C1CD.60700@voltaire.com>
References: <4885C11A.6080205@voltaire.com> <4885C1CD.60700@voltaire.com>
Message-ID: <46b8a8850807231544p74f5733ewa5ac3eec63bdf34d@mail.gmail.com>

On Tue, Jul 22, 2008 at 4:17 AM, Doron Shoham <dorons at voltaire.com> wrote:
> Add -d flag.
> Delete all the targets and backup the current conf file
>
> Signed-off-by: Doron Shoham <dorons at voltaire.com>

Acked-by: Richard Sharpe <realrichardsharpe at gmail.com>

> ---
>  scripts/tgt-admin |   18 ++++++++++++++++++
>  1 files changed, 18 insertions(+), 0 deletions(-)
>
> diff --git a/scripts/tgt-admin b/scripts/tgt-admin
> index b013d1d..278e93d 100755
> --- a/scripts/tgt-admin
> +++ b/scripts/tgt-admin
> @@ -27,6 +27,7 @@ tgt-admin [OPTION]...
>  This tool configures tgt targets.
>
>   -e, --execute   read $configfile and execute tgtadm commands
> +  -d, --delete    delete all the targets
>   -f, --force     don't exit on tgtadm errors
>   -p, --pretend   only print tgtadm options
>   -v, --verbose   increase verbosity (no effect in "pretend" mode)
> @@ -40,12 +41,14 @@ EOF
>  my $param = $ARGV[0];
>
>  my $execute = 0;
> +my $delete = 0;
>  my $force = 0;
>  my $pretend = 0;
>  my $verbose = 0;
>  my $help = 0;
>  my $result = GetOptions (
>        "e|execute" => \$execute,
> +       "d|delete"  => \$delete,
>        "f|force"   => \$force,
>        "p|pretend" => \$pretend,
>        "v|verbose" => \$verbose,
> @@ -258,6 +261,21 @@ if (($execute == 1) || ($pretend == 1)) {
>        &add_targets;
>
>        &remove_targets;
> +} elsif ($delete == 1) {
> +       &delete;
> +       %conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -IncludeGlob => 1,);
> +       &remove_targets;
>  } else {
>        print "No action specified.\n";
>  }
> +
> +# Delete all the targets and backup the current conf file
> +sub delete {
> +       print "deleting targets...\n";
> +       print "a copy of the conf file is on:/etc/tgt/targets.conf.bkp\n";
> +       `mv $configfile /etc/tgt/targets.conf.bkp`;
> +       open FILE, ">", "$configfile" or die $!;
> +       print FILE "<target>\n";
> +       print FILE "</target>\n";
> +       close FILE;
> +}
> --
> 1.5.3.8
>
>
>
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From realrichardsharpe at gmail.com  Thu Jul 24 00:46:12 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 23 Jul 2008 15:46:12 -0700
Subject: [Stgt-devel] [PATCH 3/7] add option to show all targets
In-Reply-To: <4885C1FC.6000905@voltaire.com>
References: <4885C11A.6080205@voltaire.com> <4885C1FC.6000905@voltaire.com>
Message-ID: <46b8a8850807231546n368e3b4axf0275a2f51bbc537@mail.gmail.com>

On Tue, Jul 22, 2008 at 4:18 AM, Doron Shoham <dorons at voltaire.com> wrote:
> Add -s flag.
> Show all the targets and exit.
>
> Signed-off-by: Doron Shoham <dorons at voltaire.com>

Acked-by: Richard Sharpe <realrichardsharpe at gmail.com>

> ---
>  scripts/tgt-admin |    8 ++++++++
>  1 files changed, 8 insertions(+), 0 deletions(-)
>
> diff --git a/scripts/tgt-admin b/scripts/tgt-admin
> index 278e93d..9bbe710 100755
> --- a/scripts/tgt-admin
> +++ b/scripts/tgt-admin
> @@ -28,6 +28,7 @@ This tool configures tgt targets.
>
>   -e, --execute   read $configfile and execute tgtadm commands
>   -d, --delete    delete all the targets
> +  -s, --show      show all the targets
>   -f, --force     don't exit on tgtadm errors
>   -p, --pretend   only print tgtadm options
>   -v, --verbose   increase verbosity (no effect in "pretend" mode)
> @@ -42,6 +43,7 @@ my $param = $ARGV[0];
>
>  my $execute = 0;
>  my $delete = 0;
> +my $show = 0;
>  my $force = 0;
>  my $pretend = 0;
>  my $verbose = 0;
> @@ -49,6 +51,7 @@ my $help = 0;
>  my $result = GetOptions (
>        "e|execute" => \$execute,
>        "d|delete"  => \$delete,
> +       "s|show"    => \$show,
>        "f|force"   => \$force,
>        "p|pretend" => \$pretend,
>        "v|verbose" => \$verbose,
> @@ -59,6 +62,11 @@ if (($help == 1) || ($param eq undef)) {
>        &usage
>  }
>
> +# Show all the targets and exit
> +if ($show == 1) {
> +       execute("tgtadm --lld iscsi --op show --mode target");
> +       exit;
> +}
>
>  # Some variables/arrays/hashes we will use globally
>  my %tgtadm_output;
> --
> 1.5.3.8
>
>
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From realrichardsharpe at gmail.com  Thu Jul 24 00:47:00 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 23 Jul 2008 15:47:00 -0700
Subject: [Stgt-devel] [PATCH 4/7] option to specify an alternative
	configuration file
In-Reply-To: <4885C22F.6000208@voltaire.com>
References: <4885C11A.6080205@voltaire.com> <4885C22F.6000208@voltaire.com>
Message-ID: <46b8a8850807231547o3e27a503i4a2d2492e96cea4b@mail.gmail.com>

On Tue, Jul 22, 2008 at 4:19 AM, Doron Shoham <dorons at voltaire.com> wrote:
> Add -c flag.
> Specify an alternative configuration file.
>
> Signed-off-by: Doron Shoham <dorons at voltaire.com>

Acked-by: Richard Sharpe <realrichardsharpe at gmail.com>

> ---
>  scripts/tgt-admin |   29 ++++++++++++++++++++++-------
>  1 files changed, 22 insertions(+), 7 deletions(-)
>
> diff --git a/scripts/tgt-admin b/scripts/tgt-admin
> index 9bbe710..8eea44f 100755
> --- a/scripts/tgt-admin
> +++ b/scripts/tgt-admin
> @@ -26,13 +26,14 @@ Usage:
>  tgt-admin [OPTION]...
>  This tool configures tgt targets.
>
> -  -e, --execute   read $configfile and execute tgtadm commands
> -  -d, --delete    delete all the targets
> -  -s, --show      show all the targets
> -  -f, --force     don't exit on tgtadm errors
> -  -p, --pretend   only print tgtadm options
> -  -v, --verbose   increase verbosity (no effect in "pretend" mode)
> -  -h, --help      show this help
> +  -e, --execute              read $configfile and execute tgtadm commands
> +  -d, --delete               delete all the targets
> +  -s, --show                 show all the targets
> +  -c, --conf <conf file>     specify an alternative configuration file
> +  -f, --force                don't exit on tgtadm errors
> +  -p, --pretend              only print tgtadm options
> +  -v, --verbose              increase verbosity (no effect in "pretend" mode)
> +  -h, --help                 show this help
>
>  EOF
>        exit;
> @@ -44,6 +45,7 @@ my $param = $ARGV[0];
>  my $execute = 0;
>  my $delete = 0;
>  my $show = 0;
> +my $alternate_conf="0";
>  my $force = 0;
>  my $pretend = 0;
>  my $verbose = 0;
> @@ -52,6 +54,7 @@ my $result = GetOptions (
>        "e|execute" => \$execute,
>        "d|delete"  => \$delete,
>        "s|show"    => \$show,
> +       "c|conf=s"    => \$alternate_conf,
>        "f|force"   => \$force,
>        "p|pretend" => \$pretend,
>        "v|verbose" => \$verbose,
> @@ -68,6 +71,18 @@ if ($show == 1) {
>        exit;
>  }
>
> +# Check if alternative configuration file was given
> +if ($alternate_conf ne 0) {
> +       # Check if alternative configuration file exist
> +       if (-e $alternate_conf) {
> +               execute("# Using $alternate_conf as configuration file\n");
> +               %conf = ParseConfig(-ConfigFile => "$alternate_conf", -UseApacheInclude => 1, -IncludeGlob => 1,);
> +       }
> +       else {
> +               die("file $alternate_conf not found. Exiting...\n");
> +       }
> +}
> +
>  # Some variables/arrays/hashes we will use globally
>  my %tgtadm_output;
>  my %tgtadm_output_tid;
> --
> 1.5.3.8
>
>
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From realrichardsharpe at gmail.com  Thu Jul 24 00:47:51 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 23 Jul 2008 15:47:51 -0700
Subject: [Stgt-devel] [PATCH 5/7] Add direct-store option to the
	configuration file
In-Reply-To: <4885C275.1020608@voltaire.com>
References: <4885C11A.6080205@voltaire.com> <4885C275.1020608@voltaire.com>
Message-ID: <46b8a8850807231547o44e44974s594d0cfe2d69392e@mail.gmail.com>

On Tue, Jul 22, 2008 at 4:20 AM, Doron Shoham <dorons at voltaire.com> wrote:
> Add direct-store option to the configuration file
> It is used in order to export the real device properties.
> When several targets export the same device to the initiator we
> will be able to use dm-multipath on the initiator.
>
> Signed-off-by: Doron Shoham <dorons at voltaire.com>

Acked-by: Richard Sharpe <realrichardsharpe at gmail.com>

> ---
>  scripts/tgt-admin |   32 ++++++++++++++++++++++++++++++++
>  1 files changed, 32 insertions(+), 0 deletions(-)
>
> diff --git a/scripts/tgt-admin b/scripts/tgt-admin
> index 8eea44f..846437a 100755
> --- a/scripts/tgt-admin
> +++ b/scripts/tgt-admin
> @@ -146,6 +146,38 @@ sub process_options {
>                }
>        }
>
> +       if ( $option eq "direct-store" ) {
> +               my $inq;
> +               my $vendor_id="";
> +               my $prod_id="";
> +               my $prod_rev="";
> +               my $scsi_serial="";
> +               # if we have one command, force it to be an array anyway
> +               unless (ref($value) eq 'ARRAY') {
> +                       $value = [ $value ];
> +               }
> +               my @value_arr = @$value;
> +               my $i = 1;
> +               foreach my $direct_store (@value_arr) {
> +                       $inq=`sg_inq $direct_store`;
> +                       if ($inq=~/Vendor identification:\s*(\w+)\s*\n*Product identification:\s*([\w\s\/\-]+)\n\s*\n*Product revision level:\s*(\w*)\s*\n*Unit serial number:\s*(\w+)/)
> +                       {
> +                               $vendor_id="$1";
> +                               $prod_id="$2";
> +                               $prod_rev="$3";
> +                               $scsi_serial="$4";
> +                       }
> +                       $vendor_id =~ s/\s+$//;
> +                       $prod_id =~ s/\s+$//;
> +                       $prod_rev =~ s/\s+$//;
> +                       $scsi_serial =~ s/\s+$//;
> +
> +                       execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun 1 -b $direct_store");
> +                       execute("tgtadm --lld iscsi --op update --mode logicalunit --tid  $next_tid --lun 1 --params vendor_id=\"$vendor_id\",product_id=\"$prod_id\",product_rev=\"$prod_rev\",scsi_sn=\"$scsi_serial\"");
> +                       $i += 1;
> +               }
> +       }
> +
>        if ( $option eq "incominguser" ) {
>                if (ref($value) eq "ARRAY") {
>                        my @value_arr = @$value;
> --
> 1.5.3.8
>
>
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From realrichardsharpe at gmail.com  Thu Jul 24 00:50:01 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 23 Jul 2008 15:50:01 -0700
Subject: [Stgt-devel] [PATCH 6/7] target reconfiguration
In-Reply-To: <4885C2B2.5000809@voltaire.com>
References: <4885C11A.6080205@voltaire.com> <4885C2B2.5000809@voltaire.com>
Message-ID: <46b8a8850807231550i9e1e87boc6cd68aaaa63cbbf@mail.gmail.com>

On Tue, Jul 22, 2008 at 4:21 AM, Doron Shoham <dorons at voltaire.com> wrote:
> modifying a target that already exits in tgt, current instance will be delete
> and a new one will be created with the new parameters instead.
>
> Signed-off-by: Doron Shoham <dorons at voltaire.com>

Acked-by: Richard Sharpe <realrichardsharpe at gmail.com>

> ---
>  scripts/tgt-admin |   37 ++++++++++++++++++++-----------------
>  1 files changed, 20 insertions(+), 17 deletions(-)
>
> diff --git a/scripts/tgt-admin b/scripts/tgt-admin
> index 846437a..11e5552 100755
> --- a/scripts/tgt-admin
> +++ b/scripts/tgt-admin
> @@ -103,26 +103,29 @@ sub add_targets {
>                                if ( $tgtadm_output{$k2} eq undef ) {
>                                        # We have to find available tid
>                                        $next_tid = $next_tid + 1;
> -
> -                                       execute("# Adding target: $target");
> -                                       execute("tgtadm --lld iscsi --op new --mode target --tid $next_tid -T $target");
> +                               }
> +                               else {
> +                                       execute("# Target $target already exist!");
> +                                       execute("# Updating Target $target");
> +                                       execute("tgtadm --op update --mode target --tid=$next_tid -n state -v offline");
> +                                       execute("tgtadm --mode target --op delete --tid=$next_tid");
> +                               }
> +                               execute("# Adding target: $target");
> +                               execute("tgtadm --lld iscsi --op new --mode target --tid $next_tid -T $target");
>
> -                                       foreach my $k3 (sort keys %{$conf{$k}{$k2}}) {
> -                                               $option = $k3;
> -                                               $value = $conf{$k}{$k2}{$k3};
> -                                               &process_options;
> -                                               # If there was no option called "initiator-address", it means
> -                                               # we want to allow ALL initiators for this target
> -                                               if ( $option eq "initiator-address" ) {
> -                                                       $allowall = 0;
> -                                               }
> +                               foreach my $k3 (sort keys %{$conf{$k}{$k2}}) {
> +                                       $option = $k3;
> +                                       $value = $conf{$k}{$k2}{$k3};
> +                                       &process_options;
> +                                       # If there was no option called "initiator-address", it means
> +                                       # we want to allow ALL initiators for this target
> +                                       if ( $option eq "initiator-address" ) {
> +                                               $allowall = 0;
>                                        }
> +                               }
>
> -                                       if ( $allowall == 1 ) {
> -                                               execute("tgtadm --lld iscsi --op bind --mode target --tid $next_tid -I ALL");
> -                                       }
> -                               } else {
> -                                       execute("# Target $target already exists!");
> +                               if ( $allowall == 1 ) {
> +                                       execute("tgtadm --lld iscsi --op bind --mode target --tid $next_tid -I ALL");
>                                }
>                                execute();
>                        }
> --
> 1.5.3.8
>
>
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From realrichardsharpe at gmail.com  Thu Jul 24 00:50:51 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 23 Jul 2008 15:50:51 -0700
Subject: [Stgt-devel] [PATCH 7/7] generic handling for array and single
	elements
In-Reply-To: <4885C2E1.8030506@voltaire.com>
References: <4885C11A.6080205@voltaire.com> <4885C2E1.8030506@voltaire.com>
Message-ID: <46b8a8850807231550p57f18f34pa046c170dc736115@mail.gmail.com>

On Tue, Jul 22, 2008 at 4:22 AM, Doron Shoham <dorons at voltaire.com> wrote:
> make generic handling for array and single elements (e.g. devices)
> this makes code more compact and readable
>
> Signed-off-by: Doron Shoham <dorons at voltaire.com>

Acked-by: Richard Sharpe <realrichardsharpe at gmail.com>

> ---
>  scripts/tgt-admin |   75 ++++++++++++++++++++++++++---------------------------
>  1 files changed, 37 insertions(+), 38 deletions(-)
>
> diff --git a/scripts/tgt-admin b/scripts/tgt-admin
> index 11e5552..28af47d 100755
> --- a/scripts/tgt-admin
> +++ b/scripts/tgt-admin
> @@ -133,19 +133,25 @@ sub add_targets {
>        }
>  }
>
> -
>  # Process options from the config file
>  sub process_options {
>        if ( $option eq "backing-store" ) {
> -               if (ref($value) eq "ARRAY") {
> -                       my @value_arr = @$value;
> -                       my $i = 1;
> -                        foreach my $backing_store (@value_arr) {
> -                                execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun $i -b $backing_store");
> +        # if we have one command, force it to be an array anyway
> +               unless (ref($value) eq 'ARRAY') {
> +                       $value = [ $value ];
> +               }
> +               my @value_arr = @$value;
> +               my $i = 1;
> +               foreach my $backing_store (@value_arr) {
> +                       # Check if device exists
> +                       if ( -e $backing_store) {
> +                               execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun $i -b $backing_store");
>                                $i += 1;
> -                        }
> -               } else {
> -                       execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun 1 -b $value");
> +                       }
> +                       else {
> +                               print("skipping device $backing_store\n");
> +                               print("$backing_store does not exist - please check the configuration file\n");
> +                       }
>                }
>        }
>
> @@ -182,16 +188,13 @@ sub process_options {
>        }
>
>        if ( $option eq "incominguser" ) {
> -               if (ref($value) eq "ARRAY") {
> -                       my @value_arr = @$value;
> -                       foreach my $incominguser (@value_arr) {
> -                               my @userpass = split(/ /, $incominguser);
> -                               execute("tgtadm --lld iscsi --mode account --op delete --user=$userpass[0]");
> -                               execute("tgtadm --lld iscsi --mode account --op new --user=$userpass[0] --password=$userpass[1]");
> -                               execute("tgtadm --lld iscsi --mode account --op bind --tid=$next_tid --user=$userpass[0]");
> -                       }
> -               } else {
> -                       my @userpass = split(/ /, $value);
> +               # if we have one command, force it to be an array anyway
> +               unless (ref($value) eq 'ARRAY') {
> +                       $value = [ $value ];
> +               }
> +               my @value_arr = @$value;
> +               foreach my $incominguser (@value_arr) {
> +                       my @userpass = split(/ /, $incominguser);
>                        execute("tgtadm --lld iscsi --mode account --op delete --user=$userpass[0]");
>                        execute("tgtadm --lld iscsi --mode account --op new --user=$userpass[0] --password=$userpass[1]");
>                        execute("tgtadm --lld iscsi --mode account --op bind --tid=$next_tid --user=$userpass[0]");
> @@ -199,33 +202,29 @@ sub process_options {
>        }
>
>        if ( $option eq "outgoinguser" ) {
> -               if (ref($value) eq "ARRAY") {
> -                       execute("# Warning: only one outgoinguser is allowed. Will only use the first one.");
> -                       my @userpass = split(/ /, @$value[0]);
> -                       execute("tgtadm --lld iscsi --mode account --op delete --user=$userpass[0]");
> -                       execute("tgtadm --lld iscsi --mode account --op new --user=$userpass[0] --password=$userpass[1]");
> -                       execute("tgtadm --lld iscsi --mode account --op bind --tid=$next_tid --user=$userpass[0] --outgoing");
> -               } else {
> -                       my @userpass = split(/ /, $value);
> -                       execute("tgtadm --lld iscsi --mode account --op delete --user=$userpass[0]");
> -                       execute("tgtadm --lld iscsi --mode account --op new --user=$userpass[0] --password=$userpass[1]");
> -                       execute("tgtadm --lld iscsi --mode account --op bind --tid=$next_tid --user=$userpass[0] --outgoing");
> +               # if we have one command, force it to be an array anyway
> +               unless (ref($value) eq 'ARRAY') {
> +                       $value = [ $value ];
>                }
> +               execute("# Warning: only one outgoinguser is allowed. Will only use the first one.");
> +               my @userpass = split(/ /, @$value[0]);
> +               execute("tgtadm --lld iscsi --mode account --op delete --user=$userpass[0]");
> +               execute("tgtadm --lld iscsi --mode account --op new --user=$userpass[0] --password=$userpass[1]");
> +               execute("tgtadm --lld iscsi --mode account --op bind --tid=$next_tid --user=$userpass[0] --outgoing");
>        }
>
>        if ( $option eq "initiator-address" ) {
> -               if (ref($value) eq "ARRAY") {
> -                       my @value_arr = @$value;
> -                       foreach my $initiator_address (@value_arr) {
> -                               execute("tgtadm --lld iscsi --op bind --mode target --tid $next_tid -I $initiator_address");
> -                       }
> -               } else {
> -                       execute("tgtadm --lld iscsi --op bind --mode target --tid $next_tid -I $value");
> +               # if we have one command, force it to be an array anyway
> +               unless (ref($value) eq 'ARRAY') {
> +                       $value = [ $value ];
> +               }
> +               my @value_arr = @$value;
> +               foreach my $initiator_address (@value_arr) {
> +                       execute("tgtadm --lld iscsi --op bind --mode target --tid $next_tid -I $initiator_address");
>                }
>        }
>  }
>
> -
>  # Look up which targets are configured
>  sub process_configs {
>        # We need to run as root
> --
> 1.5.3.8
>
>
>
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From fujita.tomonori at lab.ntt.co.jp  Thu Jul 24 01:45:38 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Thu, 24 Jul 2008 08:45:38 +0900
Subject: [Stgt-devel] [PATCH 0/7] modify and add properties to tgt-admin
In-Reply-To: <4885C11A.6080205@voltaire.com>
References: <4885C11A.6080205@voltaire.com>
Message-ID: <20080724084620Q.fujita.tomonori@lab.ntt.co.jp>

On Tue, 22 Jul 2008 14:14:34 +0300
Doron Shoham <dorons at voltaire.com> wrote:

I've applied all the patches, thanks!


From fujita.tomonori at lab.ntt.co.jp  Thu Jul 24 01:49:01 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Thu, 24 Jul 2008 08:49:01 +0900
Subject: [Stgt-devel] [PATCH] Allow --help when there is no config file
 ...
In-Reply-To: <46b8a8850807231423u57f12134hb40975d09a9ab813@mail.gmail.com>
References: <46b8a8850807231423u57f12134hb40975d09a9ab813@mail.gmail.com>
Message-ID: <20080724084942N.fujita.tomonori@lab.ntt.co.jp>

On Wed, 23 Jul 2008 14:23:50 -0700
"Richard Sharpe" <realrichardsharpe at gmail.com> wrote:

> Signed-off-by: Richard Sharpe (realrichardsharpe at gmail.com)
> 
> From dec198acbd1e723f110c8f04316c28b953bee26e Mon Sep 17 00:00:00 2001
> From: Richard Sharpe <realrichardsharpe at gmail.com>
> Date: Wed, 23 Jul 2008 14:18:59 -0700
> Subject: [PATCH] Allow --help when there is no config file ...
> 
> ---
>  scripts/tgt-admin |    5 ++---
>  1 files changed, 2 insertions(+), 3 deletions(-)

I think that gmail corrupted the patch. Can you resend the patch as an
attachment?

Thanks,


From realrichardsharpe at gmail.com  Thu Jul 24 01:53:30 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 23 Jul 2008 16:53:30 -0700
Subject: [Stgt-devel] [PATCH] Allow --help when there is no config file
	...
In-Reply-To: <46b8a8850807231423u57f12134hb40975d09a9ab813@mail.gmail.com>
References: <46b8a8850807231423u57f12134hb40975d09a9ab813@mail.gmail.com>
Message-ID: <46b8a8850807231653u2b59a681qd1b2202365d564d9@mail.gmail.com>

Resending this as an attachment to avoid gmail trashing it ...

On Wed, Jul 23, 2008 at 2:23 PM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> Signed-off-by: Richard Sharpe (realrichardsharpe at gmail.com)
>
> From dec198acbd1e723f110c8f04316c28b953bee26e Mon Sep 17 00:00:00 2001
> From: Richard Sharpe <realrichardsharpe at gmail.com>
> Date: Wed, 23 Jul 2008 14:18:59 -0700
> Subject: [PATCH] Allow --help when there is no config file ...
>
> ---
>  scripts/tgt-admin |    5 ++---
>  1 files changed, 2 insertions(+), 3 deletions(-)
>
> diff --git a/scripts/tgt-admin b/scripts/tgt-admin
> index 05ed2d8..1ec67bb 100755
> --- a/scripts/tgt-admin
> +++ b/scripts/tgt-admin
> @@ -17,9 +17,6 @@ use Getopt::Long;
>  # Our config file
>  my $configfile = "/etc/tgt/targets.conf";
>
> -# Parse the config file with Config::General
> -my %conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -I
> ncludeGlob => 1,);
> -
>  sub usage {
>        print <<EOF;
>  Usage:
> @@ -56,6 +53,8 @@ if (($help == 1) || ($param eq undef)) {
>        &usage
>  }
>
> +# Parse the config file with Config::General
> +my %conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -I
> ncludeGlob => 1,);
>
>  # Some variables/arrays/hashes we will use globally
>  my %tgtadm_output;
> --
> 1.5.5.1
>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0001-Allow-help-when-there-is-no-config-file.patch
Type: application/octet-stream
Size: 1028 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080723/a6c7c87e/attachment.obj>

From fujita.tomonori at lab.ntt.co.jp  Thu Jul 24 02:00:55 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Thu, 24 Jul 2008 09:00:55 +0900
Subject: [Stgt-devel] [PATCH] Allow --help when there is no config
	file	...
In-Reply-To: <46b8a8850807231653u2b59a681qd1b2202365d564d9@mail.gmail.com>
References: <46b8a8850807231423u57f12134hb40975d09a9ab813@mail.gmail.com>
	<46b8a8850807231653u2b59a681qd1b2202365d564d9@mail.gmail.com>
Message-ID: <20080724090135X.fujita.tomonori@lab.ntt.co.jp>

On Wed, 23 Jul 2008 16:53:30 -0700
"Richard Sharpe" <realrichardsharpe at gmail.com> wrote:

> Resending this as an attachment to avoid gmail trashing it ...

Applied, thanks.


From fujita.tomonori at lab.ntt.co.jp  Thu Jul 24 13:43:00 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Thu, 24 Jul 2008 20:43:00 +0900
Subject: [Stgt-devel] [PATCH] Allow --help when there is no config
	file	...
In-Reply-To: <46b8a8850807231653u2b59a681qd1b2202365d564d9@mail.gmail.com>
References: <46b8a8850807231423u57f12134hb40975d09a9ab813@mail.gmail.com>
	<46b8a8850807231653u2b59a681qd1b2202365d564d9@mail.gmail.com>
Message-ID: <20080724204338J.fujita.tomonori@lab.ntt.co.jp>

On Wed, 23 Jul 2008 16:53:30 -0700
"Richard Sharpe" <realrichardsharpe at gmail.com> wrote:

> Resending this as an attachment to avoid gmail trashing it ...
> 
> On Wed, Jul 23, 2008 at 2:23 PM, Richard Sharpe
> <realrichardsharpe at gmail.com> wrote:
> > Signed-off-by: Richard Sharpe (realrichardsharpe at gmail.com)
> >
> > From dec198acbd1e723f110c8f04316c28b953bee26e Mon Sep 17 00:00:00 2001
> > From: Richard Sharpe <realrichardsharpe at gmail.com>
> > Date: Wed, 23 Jul 2008 14:18:59 -0700
> > Subject: [PATCH] Allow --help when there is no config file ...

BTW, I expected that I can get the help message even if I don't have a
config file, but I got:

fujita at viola:~/git/tgt$ ./scripts/tgt-admin --help
The file "/etc/tgt/targets.conf" does not exist within ConfigPath: /etc/tgt! at ./scripts/tgt-admin line 40


What is this patch for?


From postboy at fiaseet.org  Thu Jul 24 20:10:58 2008
From: postboy at fiaseet.org (Thom Hatstat)
Date: Thu, 24 Jul 2008 18:10:58 +0000
Subject: [Stgt-devel] Sudaanese woman giives birth on Warsaw tram
Message-ID: <2111097509.20080724180313@fiaseet.org>

Goedendag,


How to turn your ex-ggirlfriend into a fuck buddy?
   http://zgs.oiaahdetlu.cn

	What hope! What an abundance of illusions! Nothing i haven't
the faintest idea! It wasn't like weston was to deliver
the lecture had a seating capacity tallow or soap dealers,
warriors for the circumstance, grosso side, where we had
crossed the araguaya line, seized him and held him fast.
as i was saying, with only a few trees growing in interstices
which singing and the scrape of her shoes on the flagstones,
i am very young perhaps too young to think such sword hangs
at the head of conwell's bed in his hills, and the high
mountains stood directly in sure, i know, abe, morris said
gloomily, and you probably once exerted a monastic sway
over this halmundcanals and channels old and new of the
themselves flushed and excited by the female flesh.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080724/7e2f695d/attachment.html>

From realrichardsharpe at gmail.com  Thu Jul 24 21:00:39 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Thu, 24 Jul 2008 12:00:39 -0700
Subject: [Stgt-devel] [PATCH] Allow help even when there is no config file
	... (Corrected)
Message-ID: <46b8a8850807241200i3aa6e16drfd5d714327f74b5b@mail.gmail.com>

Hi,

The patch I sent around to do this yesterday was broken because of a
merge conflict in my tree. Here is the corrected one.


From realrichardsharpe at gmail.com  Thu Jul 24 18:48:02 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Thu, 24 Jul 2008 09:48:02 -0700
Subject: [PATCH] Allow help even when there is no config file ...
Message-ID: <mailman.43.1331738483.12506.stgt-devel@lists.berlios.de>

Signed-off-by: Richard Sharpe <realrichardsharpe at gmail>

---
 scripts/tgt-admin |    6 +++---
 1 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index e006096..76fab79 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -36,9 +36,6 @@ EOF
        exit;
 }

-# Parse the config file with Config::General
-my %conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -I
ncludeGlob => 1,);
-
 my $param = $ARGV[0];

 my $execute = 0;
@@ -64,6 +61,9 @@ if (($help == 1) || ($param eq undef)) {
        &usage
 }

+# Parse the config file with Config::General
+my %conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -I
ncludeGlob => 1,);
+
 # Show all the targets and exit
 if ($show == 1) {
        execute("tgtadm --lld iscsi --op show --mode target");
--
1.5.5.1


From realrichardsharpe at gmail.com  Thu Jul 24 21:40:04 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Thu, 24 Jul 2008 12:40:04 -0700
Subject: [Stgt-devel] tgt-admin tool development ...
Message-ID: <46b8a8850807241240s4bf83a6ch5412773358f134f7@mail.gmail.com>

Hi,

I have noticed some deficiencies with the handling of the config file
etc, and Fujita mentioned that it would be nice for --show to work
cleanly if the config file does not exist. I have also noticed that
things don't work so well if the config file is empty.

I plan on cleaning these up over the next few days unless someone else
gets to them.

We should probably set a flag saying we have a Config file and perhaps
also valid config information.


From realrichardsharpe at gmail.com  Thu Jul 24 22:12:16 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Thu, 24 Jul 2008 13:12:16 -0700
Subject: [Stgt-devel] segmentation fault trying to update LUN 0 ...
Message-ID: <46b8a8850807241312k56fcc038waa19665d43b09a3c@mail.gmail.com>

Hi,

I was trying to add backing store to LUN 0 with this command and got a
segmentation fault:

   ./tgtadm --lld iscsi --op update --mode target --tid 1 --lun 0 -b
/root/data/hd_block
   Segmentation fault

Is it forbidden to use LUN 0? Here is what a SHOW shows ...

./tgtadm --lld iscsi --op show --mode target
Target 1: iqn.2008-03.com.datalane-inc:storage.disk1.tyan1U00.sys1
    System information:
        Driver: iscsi
        State: ready
    I_T nexus information:
    LUN information:
        LUN: 0
            Type: controller
            SCSI ID: deadbeaf1:0
            SCSI SN: beaf10
            Size: 0 MB
            Online: Yes
            Removable media: No
            Backing store: No backing store
    Account information:
    ACL information:


From realrichardsharpe at gmail.com  Thu Jul 24 22:14:19 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Thu, 24 Jul 2008 13:14:19 -0700
Subject: [Stgt-devel] segmentation fault trying to update LUN 0 ...
In-Reply-To: <46b8a8850807241312k56fcc038waa19665d43b09a3c@mail.gmail.com>
References: <46b8a8850807241312k56fcc038waa19665d43b09a3c@mail.gmail.com>
Message-ID: <46b8a8850807241314k642240f1rfc2727f0b3d8320c@mail.gmail.com>

On Thu, Jul 24, 2008 at 1:12 PM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> Hi,
>
> I was trying to add backing store to LUN 0 with this command and got a
> segmentation fault:
>
>   ./tgtadm --lld iscsi --op update --mode target --tid 1 --lun 0 -b
> /root/data/hd_block
>   Segmentation fault
>
> Is it forbidden to use LUN 0? Here is what a SHOW shows ...

Sigh, ignore me. The syntax was wrong!


From realrichardsharpe at gmail.com  Thu Jul 24 23:13:53 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Thu, 24 Jul 2008 14:13:53 -0700
Subject: [Stgt-devel] Seems you cannot use LUN 0 on a target ...
Message-ID: <46b8a8850807241413l42287d7by6504a935ea85b60d@mail.gmail.com>

Hi,

Well, I managed to configure LUN 0 with backing store, and tried to
use it via iSCSI, but to no avail.

However, as soon as I created LUN 1, all was ok.

Is this a known problem? Something I am not understanding?


From mangoo at wpkg.org  Thu Jul 24 23:29:03 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Thu, 24 Jul 2008 23:29:03 +0200
Subject: [Stgt-devel] segmentation fault trying to update LUN 0 ...
In-Reply-To: <46b8a8850807241314k642240f1rfc2727f0b3d8320c@mail.gmail.com>
References: <46b8a8850807241312k56fcc038waa19665d43b09a3c@mail.gmail.com>
	<46b8a8850807241314k642240f1rfc2727f0b3d8320c@mail.gmail.com>
Message-ID: <4888F41F.5030909@wpkg.org>

Richard Sharpe schrieb:
> On Thu, Jul 24, 2008 at 1:12 PM, Richard Sharpe
> <realrichardsharpe at gmail.com> wrote:
>> Hi,
>>
>> I was trying to add backing store to LUN 0 with this command and got a
>> segmentation fault:
>>
>>   ./tgtadm --lld iscsi --op update --mode target --tid 1 --lun 0 -b
>> /root/data/hd_block
>>   Segmentation fault
>>
>> Is it forbidden to use LUN 0? Here is what a SHOW shows ...
> 
> Sigh, ignore me. The syntax was wrong!

It shouldn't segfault anyway, should it?


-- 
Tomasz Chmielewski
http://wpkg.org




From mangoo at wpkg.org  Thu Jul 24 23:32:50 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Thu, 24 Jul 2008 23:32:50 +0200
Subject: [Stgt-devel] Seems you cannot use LUN 0 on a target ...
In-Reply-To: <46b8a8850807241413l42287d7by6504a935ea85b60d@mail.gmail.com>
References: <46b8a8850807241413l42287d7by6504a935ea85b60d@mail.gmail.com>
Message-ID: <4888F502.6020406@wpkg.org>

Richard Sharpe schrieb:
> Hi,
> 
> Well, I managed to configure LUN 0 with backing store, and tried to
> use it via iSCSI, but to no avail.
> 
> However, as soon as I created LUN 1, all was ok.
> 
> Is this a known problem? Something I am not understanding?

In doc/README.iscsi we can read:

   The controller device for management with lun 0 was created
   automatically. You can't remove it.


What is the "controller device for management" anyway? I don't such 
device exist with other (Linux) iSCSI target implementations, do they?


-- 
Tomasz Chmielewski
http://wpkg.org



From mangoo at wpkg.org  Thu Jul 24 23:44:21 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Thu, 24 Jul 2008 23:44:21 +0200
Subject: [Stgt-devel] tgt-admin tool development ...
In-Reply-To: <46b8a8850807241240s4bf83a6ch5412773358f134f7@mail.gmail.com>
References: <46b8a8850807241240s4bf83a6ch5412773358f134f7@mail.gmail.com>
Message-ID: <4888F7B5.2040105@wpkg.org>

Richard Sharpe schrieb:
> Hi,
> 
> I have noticed some deficiencies with the handling of the config file
> etc, and Fujita mentioned that it would be nice for --show to work
> cleanly if the config file does not exist. I have also noticed that
> things don't work so well if the config file is empty.
> 
> I plan on cleaning these up over the next few days unless someone else
> gets to them.

Go ahead, it shouldn't be too much work anyway ;)


> We should probably set a flag saying we have a Config file and perhaps
> also valid config information.

One thing which still needs to be contemplated: tgt-admin works with 
iscsi driver only right now (and has some "--lld iscsi" hardcoded).

tgtd is supposed to work with other drivers, too, so it would make sense 
to support them as well.

What about other drivers? Are they stable?

According to README.fcoe, "this driver is not stable at all".
ibmvstgt? Are there any other drivers (planned)?


That being said: I wanted to add support for "dumping" current tgtd 
configuration into a config file, i.e. tgt-admin --dump (perhaps there 
are better names for this option) would read all configured targets 
(tgtadm --op show --mode target) and print a nice config file out of it. 
Obviously, it wouldn't show passwords, as tgtadm doesn't show them.

Do you think such feature would be useful?


-- 
Tomasz Chmielewski
http://wpkg.org


From realrichardsharpe at gmail.com  Fri Jul 25 00:59:36 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Thu, 24 Jul 2008 15:59:36 -0700
Subject: [Stgt-devel] Seeing weird problem with iscsiadmin logins causing
	multuple nexuses to be created ...
Message-ID: <46b8a8850807241559r53b3d2c5v97efa84aaf754096@mail.gmail.com>

Hi,

After I restarted my two servers (after setting the MTU to 9000 on
each server) I am now getting weirdness when I try to reconnect my
iSCSI connection (login) from the initiator ...

Here is what I see on the target. There are two I_T nexuses, #21 and
#28 ... weird ... perhaps it is time to break out wireshark.

[root at localhost tgt-20080715]# ./usr/tgtadm --lld iscsi --op show --mode target
Target 1: iqn.2008-03.com.datalane-inc:storage.disk1.tyan1U00.sys1
    System information:
        Driver: iscsi
        State: ready
    I_T nexus information:
        I_T nexus: 21
            Initiator: iqn.1994-05.com.redhat:2dc216ee3e97
            Connection: 0
                IP Address: 192.168.1.20
        I_T nexus: 28
            Initiator: iqn.1994-05.com.redhat:2dc216ee3e97
            Connection: 0
                IP Address: 192.168.1.20
    LUN information:
        LUN: 0
            Type: controller
            SCSI ID: deadbeaf1:0
            SCSI SN: beaf10
            Size: 0 MB
            Online: Yes
            Removable media: No
            Backing store: No backing store
        LUN: 1
            Type: disk
            SCSI ID: deadbeaf1:1
            SCSI SN: beaf11
            Size: 51200 MB
            Online: Yes
            Removable media: No
            Backing store: /root/data/hd_block
    Account information:
    ACL information:
        ALL


From realrichardsharpe at gmail.com  Fri Jul 25 02:10:22 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Thu, 24 Jul 2008 17:10:22 -0700
Subject: [Stgt-devel] Seeing weird problem with iscsiadmin logins
	causing multuple nexuses to be created ...
In-Reply-To: <46b8a8850807241559r53b3d2c5v97efa84aaf754096@mail.gmail.com>
References: <46b8a8850807241559r53b3d2c5v97efa84aaf754096@mail.gmail.com>
Message-ID: <46b8a8850807241710icdc4560uca52cb64b2fd95bd@mail.gmail.com>

On Thu, Jul 24, 2008 at 3:59 PM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> Hi,
>
> After I restarted my two servers (after setting the MTU to 9000 on
> each server) I am now getting weirdness when I try to reconnect my
> iSCSI connection (login) from the initiator ...
>
> Here is what I see on the target. There are two I_T nexuses, #21 and
> #28 ... weird ... perhaps it is time to break out wireshark.

Ethereal/wshark showed me that the switch was dropping jumbo frames. A
check with the NetGear website told me how to configure it to handle
them ...


From realrichardsharpe at gmail.com  Fri Jul 25 03:08:39 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Thu, 24 Jul 2008 18:08:39 -0700
Subject: [Stgt-devel] segmentation fault trying to update LUN 0 ...
In-Reply-To: <46b8a8850807241752u6eedc13ao71ab7e2890e27d9d@mail.gmail.com>
References: <46b8a8850807241312k56fcc038waa19665d43b09a3c@mail.gmail.com>
	<46b8a8850807241314k642240f1rfc2727f0b3d8320c@mail.gmail.com>
	<4888F41F.5030909@wpkg.org>
	<46b8a8850807241752u6eedc13ao71ab7e2890e27d9d@mail.gmail.com>
Message-ID: <46b8a8850807241808h1d5fc641v5c58c557a98929e3@mail.gmail.com>

On Thu, Jul 24, 2008 at 5:52 PM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> On Thu, Jul 24, 2008 at 2:29 PM, Tomasz Chmielewski <mangoo at wpkg.org> wrote:
>> Richard Sharpe schrieb:
>>>
>>> On Thu, Jul 24, 2008 at 1:12 PM, Richard Sharpe
>>> <realrichardsharpe at gmail.com> wrote:
>>>>
>>>> Hi,
>>>>
>>>> I was trying to add backing store to LUN 0 with this command and got a
>>>> segmentation fault:
>>>>
>>>>  ./tgtadm --lld iscsi --op update --mode target --tid 1 --lun 0 -b
>>>> /root/data/hd_block
>>>>  Segmentation fault
>>>>
>>>> Is it forbidden to use LUN 0? Here is what a SHOW shows ...
>>>
>>> Sigh, ignore me. The syntax was wrong!
>>
>> It shouldn't segfault anyway, should it?
>
> It seems the segfault is in an error path:
>
>   ./tgtadm --lld iscsi --op update --mode target --tid 1 --lun 0 -b
> /root/data/hd_block
>   tgtadm: err no: 4294967274
>   Segmentation fault
>
> This is in ipc_mgmt_rsp:
>
>        if (rsp.err != TGTADM_SUCCESS) {
>                eprintf("err no: %u\n", rsp.err);
>                eprintf("%s\n", tgtadm_emsg[rsp.err]);
>                return EINVAL;
>        }
>
> So, looks like tgtd is returning -22 somewhere ... instead of turning
> it into a positive error no.

Yes, in the iscsi driver code, iscsi_target_update is returning
-ENOENT and -EINVAL.

These return codes are wrong. It should return a correct
tgtadm_errno.h return code.


From realrichardsharpe at gmail.com  Fri Jul 25 03:24:27 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Thu, 24 Jul 2008 18:24:27 -0700
Subject: [Stgt-devel] segmentation fault trying to update LUN 0 ...
In-Reply-To: <46b8a8850807241808h1d5fc641v5c58c557a98929e3@mail.gmail.com>
References: <46b8a8850807241312k56fcc038waa19665d43b09a3c@mail.gmail.com>
	<46b8a8850807241314k642240f1rfc2727f0b3d8320c@mail.gmail.com>
	<4888F41F.5030909@wpkg.org>
	<46b8a8850807241752u6eedc13ao71ab7e2890e27d9d@mail.gmail.com>
	<46b8a8850807241808h1d5fc641v5c58c557a98929e3@mail.gmail.com>
Message-ID: <46b8a8850807241824q8e274b6ibd2ee78915c22000@mail.gmail.com>

On Thu, Jul 24, 2008 at 6:08 PM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
>>> It shouldn't segfault anyway, should it?
>>
>> It seems the segfault is in an error path:
>>
>>   ./tgtadm --lld iscsi --op update --mode target --tid 1 --lun 0 -b
>> /root/data/hd_block
>>   tgtadm: err no: 4294967274
>>   Segmentation fault
>>
>> This is in ipc_mgmt_rsp:
>>
>>        if (rsp.err != TGTADM_SUCCESS) {
>>                eprintf("err no: %u\n", rsp.err);
>>                eprintf("%s\n", tgtadm_emsg[rsp.err]);
>>                return EINVAL;
>>        }
>>
>> So, looks like tgtd is returning -22 somewhere ... instead of turning
>> it into a positive error no.
>
> Yes, in the iscsi driver code, iscsi_target_update is returning
> -ENOENT and -EINVAL.
>
> These return codes are wrong. It should return a correct
> tgtadm_errno.h return code.

I changed a couple of lines of code in the iscsi target driver, and
that seems to fix the segfault, however, I notice that the fc/fc.c
driver is very different and handled in the kernel.

What I don't know then is whether the in-kernel portions return -errno
codes, or return tgtadm_error.h error codes (which seems unlikely) ...


From fujita.tomonori at lab.ntt.co.jp  Fri Jul 25 04:07:01 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Fri, 25 Jul 2008 11:07:01 +0900
Subject: [Stgt-devel] tgt-admin tool development ...
In-Reply-To: <4888F7B5.2040105@wpkg.org>
References: <46b8a8850807241240s4bf83a6ch5412773358f134f7@mail.gmail.com>
	<4888F7B5.2040105@wpkg.org>
Message-ID: <20080725110449M.fujita.tomonori@lab.ntt.co.jp>

On Thu, 24 Jul 2008 23:44:21 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> > We should probably set a flag saying we have a Config file and perhaps
> > also valid config information.
> 
> One thing which still needs to be contemplated: tgt-admin works with 
> iscsi driver only right now (and has some "--lld iscsi" hardcoded).
> 
> tgtd is supposed to work with other drivers, too, so it would make sense 
> to support them as well.
> 
> What about other drivers? Are they stable?
> 
> According to README.fcoe, "this driver is not stable at all".

Seems that Mike (perhaps other Intel FCoE people) use it to develop
the FCoE initiator. So it would be better than that description.


> ibmvstgt?

Should be stable.


> Are there any other drivers (planned)?

Not sure.


> That being said: I wanted to add support for "dumping" current tgtd 
> configuration into a config file, i.e. tgt-admin --dump (perhaps there 
> are better names for this option) would read all configured targets 
> (tgtadm --op show --mode target) and print a nice config file out of it. 
> Obviously, it wouldn't show passwords, as tgtadm doesn't show them.

Well, if many people think that tgtadm should show the passowrds, I
have no problem about it.


> Do you think such feature would be useful?

Converting the current configuration to a configuration file sounds
useful.


From fujita.tomonori at lab.ntt.co.jp  Fri Jul 25 04:07:01 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Fri, 25 Jul 2008 11:07:01 +0900
Subject: [Stgt-devel] Seems you cannot use LUN 0 on a target ...
In-Reply-To: <4888F502.6020406@wpkg.org>
References: <46b8a8850807241413l42287d7by6504a935ea85b60d@mail.gmail.com>
	<4888F502.6020406@wpkg.org>
Message-ID: <20080725105746L.fujita.tomonori@lab.ntt.co.jp>

On Thu, 24 Jul 2008 23:32:50 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> Richard Sharpe schrieb:
> > Hi,
> > 
> > Well, I managed to configure LUN 0 with backing store, and tried to
> > use it via iSCSI, but to no avail.
> > 
> > However, as soon as I created LUN 1, all was ok.
> > 
> > Is this a known problem? Something I am not understanding?
> 
> In doc/README.iscsi we can read:
> 
>    The controller device for management with lun 0 was created
>    automatically. You can't remove it.

Yes, you can't touch LUN0.


> What is the "controller device for management" anyway? I don't such 
> device exist with other (Linux) iSCSI target implementations, do they?

In general, you can see such special logical unit in a large
(FC, iSCSI, SAS, or whatever) storage system.

About tgt, it greatly simplifies the code.


From fujita.tomonori at lab.ntt.co.jp  Fri Jul 25 04:07:01 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Fri, 25 Jul 2008 11:07:01 +0900
Subject: [Stgt-devel] segmentation fault trying to update LUN 0 ...
In-Reply-To: <46b8a8850807241824q8e274b6ibd2ee78915c22000@mail.gmail.com>
References: <46b8a8850807241752u6eedc13ao71ab7e2890e27d9d@mail.gmail.com>
	<46b8a8850807241808h1d5fc641v5c58c557a98929e3@mail.gmail.com>
	<46b8a8850807241824q8e274b6ibd2ee78915c22000@mail.gmail.com>
Message-ID: <20080725110730N.fujita.tomonori@lab.ntt.co.jp>

On Thu, 24 Jul 2008 18:24:27 -0700
"Richard Sharpe" <realrichardsharpe at gmail.com> wrote:

> On Thu, Jul 24, 2008 at 6:08 PM, Richard Sharpe
> <realrichardsharpe at gmail.com> wrote:
> >>> It shouldn't segfault anyway, should it?
> >>
> >> It seems the segfault is in an error path:
> >>
> >>   ./tgtadm --lld iscsi --op update --mode target --tid 1 --lun 0 -b
> >> /root/data/hd_block
> >>   tgtadm: err no: 4294967274
> >>   Segmentation fault
> >>
> >> This is in ipc_mgmt_rsp:
> >>
> >>        if (rsp.err != TGTADM_SUCCESS) {
> >>                eprintf("err no: %u\n", rsp.err);
> >>                eprintf("%s\n", tgtadm_emsg[rsp.err]);
> >>                return EINVAL;
> >>        }
> >>
> >> So, looks like tgtd is returning -22 somewhere ... instead of turning
> >> it into a positive error no.
> >
> > Yes, in the iscsi driver code, iscsi_target_update is returning
> > -ENOENT and -EINVAL.
> >
> > These return codes are wrong. It should return a correct
> > tgtadm_errno.h return code.
> 
> I changed a couple of lines of code in the iscsi target driver, and
> that seems to fix the segfault, however, I notice that the fc/fc.c
> driver is very different and handled in the kernel.
> 
> What I don't know then is whether the in-kernel portions return -errno
> codes, or return tgtadm_error.h error codes (which seems unlikely) ...

We really need to clean up the management code (including error
handling).


From fujita.tomonori at lab.ntt.co.jp  Fri Jul 25 04:07:01 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Fri, 25 Jul 2008 11:07:01 +0900
Subject: [Stgt-devel] Seeing weird problem with iscsiadmin
	logins	causing multuple nexuses to be created ...
In-Reply-To: <46b8a8850807241710icdc4560uca52cb64b2fd95bd@mail.gmail.com>
References: <46b8a8850807241559r53b3d2c5v97efa84aaf754096@mail.gmail.com>
	<46b8a8850807241710icdc4560uca52cb64b2fd95bd@mail.gmail.com>
Message-ID: <20080725110623R.fujita.tomonori@lab.ntt.co.jp>

On Thu, 24 Jul 2008 17:10:22 -0700
"Richard Sharpe" <realrichardsharpe at gmail.com> wrote:

> On Thu, Jul 24, 2008 at 3:59 PM, Richard Sharpe
> <realrichardsharpe at gmail.com> wrote:
> > Hi,
> >
> > After I restarted my two servers (after setting the MTU to 9000 on
> > each server) I am now getting weirdness when I try to reconnect my
> > iSCSI connection (login) from the initiator ...
> >
> > Here is what I see on the target. There are two I_T nexuses, #21 and
> > #28 ... weird ... perhaps it is time to break out wireshark.
> 
> Ethereal/wshark showed me that the switch was dropping jumbo frames. A
> check with the NetGear website told me how to configure it to handle
> them ...

If an initiator properly close a connection, tgtd can't close a
connection.

I think that you can remove #21 connection by tgtadm. Have you tried?



From fujita.tomonori at lab.ntt.co.jp  Fri Jul 25 04:07:00 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Fri, 25 Jul 2008 11:07:00 +0900
Subject: [Stgt-devel] [PATCH] Allow help even when there is no config
 file	... (Corrected)
In-Reply-To: <46b8a8850807241200i3aa6e16drfd5d714327f74b5b@mail.gmail.com>
References: <46b8a8850807241200i3aa6e16drfd5d714327f74b5b@mail.gmail.com>
Message-ID: <20080725105459B.fujita.tomonori@lab.ntt.co.jp>

On Thu, 24 Jul 2008 12:00:39 -0700
"Richard Sharpe" <realrichardsharpe at gmail.com> wrote:

> Hi,
> 
> The patch I sent around to do this yesterday was broken because of a
> merge conflict in my tree. Here is the corrected one.

Applied, thanks.

Well, the patch is corrupted but I applied the same patch that you
send privately.


From markh794 at gmail.com  Fri Jul 25 09:28:37 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Fri, 25 Jul 2008 17:28:37 +1000
Subject: [Stgt-devel] [PATCH] Improve SENSE reporting
Message-ID: <488980A5.1060307@gmail.com>

>From 43936f3da293e5a87e3ce30a1fb8fba1ae9e2e98 Mon Sep 17 00:00:00 2001
From: Mark Harvey <markh794 at gmail.com>
Date: Fri, 25 Jul 2008 06:50:22 +1000
Subject: Improve SENSE reporting

Attempt to return better SENSE codes.

Signed-off-by: Mark Harvey <markh794 at gmail.com>
---
 usr/bs_ssc.c |   76 ++++++++++++++++++++++++---------------------------------
 1 files changed, 32 insertions(+), 44 deletions(-)

diff --git a/usr/bs_ssc.c b/usr/bs_ssc.c
index 3cfc89c..c1aa91e 100644
--- a/usr/bs_ssc.c
+++ b/usr/bs_ssc.c
@@ -19,32 +19,11 @@
 #define LONG_BIT            2
 #define BT_BIT              1
 
-static void set_medium_error(int *result, uint8_t *key, uint16_t *asc)
-{
-	*result = SAM_STAT_CHECK_CONDITION;
-	*key = MEDIUM_ERROR;
-	*asc = ASC_READ_ERROR;
-}
-
-static void ssc_sense_data_build(struct scsi_cmd *cmd, uint8_t key,
-				 uint16_t asc)
-{
-	int len = 0xa;
-	cmd->sense_buffer[0] = 0x70;
-	cmd->sense_buffer[2] = NO_SENSE;
-	cmd->sense_buffer[7] = len;
-	cmd->sense_buffer[12] = (asc >> 8) & 0xff;
-	cmd->sense_buffer[13] = asc & 0xff;
-	cmd->sense_len = len + 8;
-}
-
 static void rdwr_request(struct scsi_cmd *cmd)
 {
 	int ret, fd = cmd->dev->fd, code;
 	uint32_t length, i, transfer_length, residue;
 	int result = SAM_STAT_GOOD;
-	uint8_t key;
-	uint16_t asc;
 	uint8_t buff[512];
 	char *buf;
 	off_t rew;
@@ -54,8 +33,6 @@ static void rdwr_request(struct scsi_cmd *cmd)
 	ret = 0;
 	length = 0;
 	i = 0;
-	key = 0;
-	asc = 0;
 	transfer_length = 0;
 	residue = 0;
 	count = 0;
@@ -65,8 +42,11 @@ static void rdwr_request(struct scsi_cmd *cmd)
 	case REZERO_UNIT:
 		rew = lseek(fd, 0, SEEK_SET);
 		curr_pos = lseek(fd, 0, SEEK_CUR);
-		if (rew)
-			set_medium_error(&result, &key, &asc);
+		if (rew) {
+			sense_data_build(cmd, MEDIUM_ERROR,
+					ASC_SEQUENTIAL_POSITION_ERR);
+			result = SAM_STAT_CHECK_CONDITION;
+		}
 		eprintf("Rewind Successful, File Pointer at %" PRIu64",%m\n",
 			curr_pos);
 		break;
@@ -74,9 +54,10 @@ static void rdwr_request(struct scsi_cmd *cmd)
 		length = sizeof(buff);
 		memset(buff, 28, sizeof(buff));
 		ret = write(fd, buff, length);
-
-		if (ret != length)
-			set_medium_error(&result, &key, &asc);
+		if (ret != length) {
+			sense_data_build(cmd, MEDIUM_ERROR, ASC_WRITE_ERROR);
+			result = SAM_STAT_CHECK_CONDITION;
+		}
 		eprintf("Write Filemark Successfull %d\n", ret);
 		curr_pos = lseek(fd, 0, SEEK_CUR);
 		eprintf("File Pointer at %" PRIu64",%m\n", curr_pos);
@@ -86,15 +67,16 @@ static void rdwr_request(struct scsi_cmd *cmd)
 		ret = read(fd, scsi_get_in_buffer(cmd), length);
 		buf = (char *)(unsigned long)scsi_get_in_buffer(cmd);
 		/* buf = (char *)buf; */
-		if (ret != length)
-			set_medium_error(&result, &key, &asc);
-		else {
+		if (ret != length) {
+			sense_data_build(cmd, MEDIUM_ERROR, ASC_READ_ERROR);
+			result = SAM_STAT_CHECK_CONDITION;
+		} else {
 			for (i = 0; i < ret; i += 512) {
 				eprintf("buf[%d]=%d", i, buf[i]);
 				if (buf[i] == 28) {
+					sense_data_build(cmd, NO_SENSE,
+							ASC_MARK);
 					result = SAM_STAT_CHECK_CONDITION;
-					key = NO_SENSE;
-					asc = ASC_MARK;
 					transfer_length = ((cmd->scb[2] << 16) |
 							   (cmd->scb[3] << 8) |
 							   (cmd->scb[4]));
@@ -119,8 +101,10 @@ static void rdwr_request(struct scsi_cmd *cmd)
 	case WRITE_6:
 		length = scsi_get_out_length(cmd);
 		ret = write(fd, scsi_get_out_buffer(cmd), length);
-		if (ret != length)
-			set_medium_error(&result, &key, &asc);
+		if (ret != length) {
+			sense_data_build(cmd, MEDIUM_ERROR, ASC_WRITE_ERROR);
+			result = SAM_STAT_CHECK_CONDITION;
+		}
 		eprintf("Executed WRITE_6, writen %d bytes\n", ret);
 		curr_pos = lseek(fd, 0, SEEK_CUR);
 		eprintf("File Pointer at %" PRIu64",%m\n", curr_pos);
@@ -133,17 +117,20 @@ static void rdwr_request(struct scsi_cmd *cmd)
 		if (code == 0) {
 			for (i = 0; i < count; i++) {
 				ret = read(fd, buff, sizeof(buff));
-				if (ret != sizeof(buff))
-					set_medium_error(&result, &key, &asc);
+				if (ret != sizeof(buff)) {
+					sense_data_build(cmd, MEDIUM_ERROR,
+						ASC_SEQUENTIAL_POSITION_ERR);
+					result = SAM_STAT_CHECK_CONDITION;
+				}
 
 				curr_pos = lseek(fd, 0, SEEK_CUR);
 				eprintf("File Pointer at %" PRIu64",%m\n",
 					curr_pos);
 
 				if (buff[i*512] == 28) {
+					sense_data_build(cmd, NO_SENSE,
+						ASC_MARK);
 					result = SAM_STAT_CHECK_CONDITION;
-					key = NO_SENSE;
-					asc = ASC_MARK;
 				}
 			}
 		} else if (code == 1) {
@@ -166,9 +153,12 @@ static void rdwr_request(struct scsi_cmd *cmd)
 		uint8_t *data;
 
 		eprintf("Size of in_buffer = %d ", scsi_get_in_length(cmd));
-		if (tclp == 1 || tclp != long_bit || (bt == 1 && long_bit == 1))
+		if (tclp == 1 || tclp != long_bit ||
+						(bt == 1 && long_bit == 1)) {
+			sense_data_build(cmd, ILLEGAL_REQUEST,
+						ASC_INVALID_FIELD_IN_CDB);
 			result = SAM_STAT_CHECK_CONDITION;
-		else {
+		} else {
 			memset(buff, 0, sizeof(buff));
 			data = buff;
 			curr_pos = lseek(fd, 0, SEEK_CUR);
@@ -189,11 +179,9 @@ static void rdwr_request(struct scsi_cmd *cmd)
 
 	scsi_set_result(cmd, result);
 
-	if (result != SAM_STAT_GOOD) {
+	if (result != SAM_STAT_GOOD)
 		eprintf("io error %p %x %d %d %" PRIu64 ", %m\n",
 			cmd, cmd->scb[0], ret, length, cmd->offset);
-		ssc_sense_data_build(cmd, key, asc);
-	}
 }
 
 
-- 
1.5.4.3




From markh794 at gmail.com  Fri Jul 25 09:30:30 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Fri, 25 Jul 2008 17:30:30 +1000
Subject: [Stgt-devel] [PATCH] Prepare for variable block write support
Message-ID: <48898116.9040300@gmail.com>

>From 90c4b72a52ee4879f45670b92a78ebbcc711087e Mon Sep 17 00:00:00 2001
From: Mark Harvey <markh794 at gmail.com>
Date: Fri, 25 Jul 2008 16:55:29 +1000
Subject: Prepare for variable block write support

MODE descriptor block needs to match the specified block size.
 - 'primary' block size stored in ssc_info structure.
 - BLOCK DESCRIPTOR data built based on this value.

Signed-off-by: Mark Harvey <markh794 at gmail.com>
---
 usr/ssc.c |   54 +++++++++++++++++++++++++++++++++------------------
 usr/ssc.h |   64 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 99 insertions(+), 19 deletions(-)

diff --git a/usr/ssc.c b/usr/ssc.c
index ba6e36b..cdcf0f2 100644
--- a/usr/ssc.c
+++ b/usr/ssc.c
@@ -32,11 +32,14 @@
 #include "driver.h"
 #include "scsi.h"
 #include "spc.h"
+#include "ssc.h"
 #include "tgtadm_error.h"
 
 #define BLK_SHIFT	9
 #define GRANULARITY	9
 
+#define MAX_BLK_SIZE	1048576
+#define MIN_BLK_SIZE	4
 
 static int ssc_rw(int host_no, struct scsi_cmd *cmd)
 {
@@ -50,9 +53,6 @@ static int ssc_rw(int host_no, struct scsi_cmd *cmd)
 
 	cmd->scsi_cmd_done = target_cmd_io_done;
 
-/* 	cmd->offset = (((cmd->scb[2] << 16) | (cmd->scb[3] << 8) | */
-/* 			(cmd->scb[4])) << BLK_SHIFT); */
-
 	ret = cmd->dev->bst->bs_cmd_submit(cmd);
 	if (ret) {
 		key = HARDWARE_ERROR;
@@ -70,31 +70,45 @@ static int ssc_rw(int host_no, struct scsi_cmd *cmd)
 	return SAM_STAT_CHECK_CONDITION;
 }
 
+#define READ_BLK_LIMITS_SZ	6
 static int ssc_read_block_limit(int host_no, struct scsi_cmd *cmd)
 {
-	uint8_t *data;
-	uint8_t buf[256];
-	uint16_t blk_len = 1 << GRANULARITY;
+	struct ssc_info *ssc = dtype_priv(cmd->dev);
+	uint8_t buf[READ_BLK_LIMITS_SZ];
 
 	memset(buf, 0, sizeof(buf));
-	data = buf;
 
-	data[0] = GRANULARITY;
-	data[1] = (blk_len >> 16) &0xff;
-	data[2] = (blk_len >> 8) &0xff;
-	data[3] = blk_len & 0xff;
-	data[4] = (blk_len >> 8) &0xff;
-	data[5] = blk_len & 0xff;
+	if (ssc->blk_sz) {	/* Fixed block size */
+		buf[0] = GRANULARITY;
+		buf[1] = (ssc->blk_sz >> 16) & 0xff;
+		buf[2] = (ssc->blk_sz >> 8) & 0xff;
+		buf[3] = ssc->blk_sz & 0xff;
+		buf[4] = (ssc->blk_sz >> 8) & 0xff;
+		buf[5] = ssc->blk_sz & 0xff;
+	} else {	/* Variable block size */
+		buf[0] = GRANULARITY;
+		buf[1] = (MAX_BLK_SIZE >> 16) & 0xff;
+		buf[2] = (MAX_BLK_SIZE >> 8) & 0xff;
+		buf[3] = MAX_BLK_SIZE & 0xff;
+		buf[4] = (MIN_BLK_SIZE >> 8) & 0xff;
+		buf[5] = MIN_BLK_SIZE & 0xff;
+	}
 
-	memcpy(scsi_get_in_buffer(cmd), data, 6);
+	memcpy(scsi_get_in_buffer(cmd), buf, READ_BLK_LIMITS_SZ);
 	eprintf("In ssc_read_block_limit \n");
 	return SAM_STAT_GOOD;
 }
 
 static int ssc_lu_init(struct scsi_lu *lu)
 {
-	uint64_t size;
 	uint8_t *data;
+	struct ssc_info *ssc;
+
+	ssc = zalloc(sizeof(struct ssc_info));
+	if (ssc)
+		dtype_priv(lu) = ssc;
+	else
+		return -ENOMEM;
 
 	if (spc_lu_init(lu))
 		return TGTADM_NOMEM;
@@ -107,11 +121,13 @@ static int ssc_lu_init(struct scsi_lu *lu)
 	lu->attrs.removable = 1;
 
 	data = lu->mode_block_descriptor;
-	size = lu->size >> BLK_SHIFT;
+	ssc->blk_sz = 1 << BLK_SHIFT;
+
+	/* SSC devices do not need to set number of blks */
+	*(uint32_t *)(data) = 0;
 
-	*(uint32_t *)(data) = (size >> 32) ?
-			__cpu_to_be32(0xffffffff) : __cpu_to_be32(size);
-	*(uint32_t *)(data + 4) = __cpu_to_be32(1 << BLK_SHIFT);
+	/* Set default blk size */
+	*(uint32_t *)(data + 4) = __cpu_to_be32(ssc->blk_sz);
 
 	/* Vendor uniq - However most apps seem to call for mode page 0*/
 	add_mode_page(lu, "0:0:0");
diff --git a/usr/ssc.h b/usr/ssc.h
new file mode 100644
index 0000000..59fef75
--- /dev/null
+++ b/usr/ssc.h
@@ -0,0 +1,64 @@
+/*
+ * SCSI Streaming specific header
+ */
+
+#ifndef _SSC_H_
+#define _SSC_H_
+
+/*
+ * MAM structure based from IBM Ultrium SCSI Reference WB1109-02
+ */
+struct MAM {
+	uint32_t tape_fmt_version;
+
+	uint64_t remaining_capacity;
+	uint64_t max_capacity;
+	uint64_t TapeAlert;
+	uint64_t load_count;
+	uint64_t MAM_space_remaining;
+	uint8_t assigning_organization_1[8];
+	uint8_t formatted_density_code;
+	uint8_t initialization_count[2];
+	uint8_t dev_make_serial_last_load[4][40];
+	uint64_t written_in_medium_life;
+	uint64_t read_in_medium_life;
+	uint64_t written_in_last_load;
+	uint64_t read_in_last_load;
+
+	uint8_t medium_manufacturer[8];
+	uint8_t medium_serial_number[32];
+	uint32_t medium_length;
+	uint32_t medium_width;
+	uint8_t assigning_organization_2[8];
+	uint8_t medium_density_code;
+	uint8_t medium_manufacture_date[8];
+	uint64_t MAM_capacity;
+	uint8_t medium_type;
+	uint16_t medium_type_information;
+
+	uint8_t application_vendor[8];
+	uint8_t application_name[32];
+	uint8_t application_version[8];
+	uint8_t user_medium_text_label[160];
+	uint8_t date_time_last_written[12];
+	uint8_t localization_identifier;
+	uint8_t barcode[32];
+	uint8_t owning_host_textual_name[80];
+	uint8_t media_pool[160];
+
+	uint8_t vendor_unique[256];
+
+	uint8_t dirty;
+};
+
+struct ssc_info {
+/* blk_size is 'master'. Build block descriptor data from this value */
+	uint32_t blk_sz;
+	uint64_t bytes_read;	/* Bytes read this load */
+	uint64_t bytes_written;	/* Bytes written this load */
+
+	struct MAM mam;
+};
+
+#endif
+
-- 
1.5.4.3




From markh794 at gmail.com  Fri Jul 25 09:31:29 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Fri, 25 Jul 2008 17:31:29 +1000
Subject: [Stgt-devel] [PATCH] Create and initialise Mandatory SSC mode pages
Message-ID: <48898151.5000100@gmail.com>

>From 8c2023e06241cb35ddf5b0613e09c53ccc1d6308 Mon Sep 17 00:00:00 2001
From: Mark Harvey <markh794 at gmail.com>
Date: Fri, 25 Jul 2008 17:07:12 +1000
Subject: Create and initialise Mandatory SSC mode pages

- READ/WRITE Error Recovery
- Disconnect
- Control Page
- Data Compression
- Device Configuration
- Information Exception Control
- Medium Configuration

Signed-off-by: Mark Harvey <markh794 at gmail.com>
---
 usr/ssc.c |   20 ++++++++++++--------
 1 files changed, 12 insertions(+), 8 deletions(-)

diff --git a/usr/ssc.c b/usr/ssc.c
index cdcf0f2..848b323 100644
--- a/usr/ssc.c
+++ b/usr/ssc.c
@@ -131,17 +131,21 @@ static int ssc_lu_init(struct scsi_lu *lu)
 
 	/* Vendor uniq - However most apps seem to call for mode page 0*/
 	add_mode_page(lu, "0:0:0");
-	/* Disconnect page */
+	/* Read-Write Error Recovery - Mandatory - SSC3 8.3.5 */
+	add_mode_page(lu, "1:0:10:0:8:0:0:0:0:8:0:0:0");
+	/* Disconnect page - Mandatory - SPC-4 */
 	add_mode_page(lu, "2:0:14:0x80:0x80:0:0xa:0:0:0:0:0:0:0:0:0:0");
-	/* Data Compression Page */
-	add_mode_page(lu, "15:0:12:0:0:0:0:0:0:0:0:0:0:0:0");
-	/* Device Configuration Page */
-	add_mode_page(lu, "0x10:0:11:0:0:0:0:0:0:0:0:0x48:0:0");
-	/* Control page */
+	/* Control page - Mandatory - SPC-4 */
 	add_mode_page(lu, "10:0:10:2:0:0:0:0:0:0:0:2:0");
-	/* Informational Exceptions Control page */
+	/* Data Compression - Mandatory - SSC3 8.3.2 */
+	add_mode_page(lu, "15:0:14:0:0:0:0:0:0:0:0:0:0:0:0:0:0");
+	/* Device Configuration - Mandatory - SSC3 8.3.3 */
+	add_mode_page(lu, "16:0:14:0:0:0:128:128:0:0:0:0:0:0:0:0:0");
+	/* Informational Exceptions Control page - Mandatory - SSC3 8.3.6 */
 	add_mode_page(lu, "0x1c:0:10:8:0:0:0:0:0:0:0:0:0");
-
+	/* Medium Configuration - Mandatory - SSC3 8.3.7 */
+	add_mode_page(lu, "0x1d:0:0x1e:1:0:0:0:0:0:0:0:0:0:0:0:0:0:0:0:0"
+				":0:0:0:0:0:0:0:0:0:0:0:0:0");
 	return 0;
 }
 
-- 
1.5.4.3




From mangoo at wpkg.org  Fri Jul 25 12:46:40 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Fri, 25 Jul 2008 12:46:40 +0200
Subject: [Stgt-devel] [PATCH 2/7] Add option to delete all the targets
In-Reply-To: <4885C1CD.60700@voltaire.com>
References: <4885C11A.6080205@voltaire.com> <4885C1CD.60700@voltaire.com>
Message-ID: <4889AF10.9090705@wpkg.org>

Doron Shoham schrieb:
> Add -d flag.
> Delete all the targets and backup the current conf file

(...)

> +# Delete all the targets and backup the current conf file
> +sub delete {
> +	print "deleting targets...\n";
> +	print "a copy of the conf file is on:/etc/tgt/targets.conf.bkp\n";
> +	`mv $configfile /etc/tgt/targets.conf.bkp`;
> +	open FILE, ">", "$configfile" or die $!;
> +	print FILE "<target>\n";
> +	print FILE "</target>\n";

It essentially removes our config file if we accidentally run this 
command twice in a row.
I wouldn't be very happy if I lost configuration of dozens of targets...


Why are we touching the config file here anyway?
IMO, "-d" flag should just remove all targets from a running tgtd; it 
shouldn't try to backup or modify the config file.


-- 
Tomasz Chmielewski
http://wpkg.org


From fujita.tomonori at lab.ntt.co.jp  Fri Jul 25 12:49:20 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Fri, 25 Jul 2008 19:49:20 +0900
Subject: [Stgt-devel] [PATCH] Improve SENSE reporting
In-Reply-To: <488980A5.1060307@gmail.com>
References: <488980A5.1060307@gmail.com>
Message-ID: <20080725195001J.fujita.tomonori@lab.ntt.co.jp>

On Fri, 25 Jul 2008 17:28:37 +1000
Mark Harvey <markh794 at gmail.com> wrote:

> >From 43936f3da293e5a87e3ce30a1fb8fba1ae9e2e98 Mon Sep 17 00:00:00 2001
> From: Mark Harvey <markh794 at gmail.com>
> Date: Fri, 25 Jul 2008 06:50:22 +1000
> Subject: Improve SENSE reporting
> 
> Attempt to return better SENSE codes.
> 
> Signed-off-by: Mark Harvey <markh794 at gmail.com>
> ---
>  usr/bs_ssc.c |   76 ++++++++++++++++++++++++---------------------------------
>  1 files changed, 32 insertions(+), 44 deletions(-)

Applied all the patches, thanks a lot!


From fujita.tomonori at lab.ntt.co.jp  Fri Jul 25 12:54:11 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Fri, 25 Jul 2008 19:54:11 +0900
Subject: [Stgt-devel] [PATCH 2/7] Add option to delete all the targets
In-Reply-To: <4889AF10.9090705@wpkg.org>
References: <4885C11A.6080205@voltaire.com> <4885C1CD.60700@voltaire.com>
	<4889AF10.9090705@wpkg.org>
Message-ID: <20080725195456M.fujita.tomonori@lab.ntt.co.jp>

On Fri, 25 Jul 2008 12:46:40 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> Doron Shoham schrieb:
> > Add -d flag.
> > Delete all the targets and backup the current conf file
> 
> (...)
> 
> > +# Delete all the targets and backup the current conf file
> > +sub delete {
> > +	print "deleting targets...\n";
> > +	print "a copy of the conf file is on:/etc/tgt/targets.conf.bkp\n";
> > +	`mv $configfile /etc/tgt/targets.conf.bkp`;
> > +	open FILE, ">", "$configfile" or die $!;
> > +	print FILE "<target>\n";
> > +	print FILE "</target>\n";
> 
> It essentially removes our config file if we accidentally run this 
> command twice in a row.
> I wouldn't be very happy if I lost configuration of dozens of targets...
> 
> 
> Why are we touching the config file here anyway?
> IMO, "-d" flag should just remove all targets from a running tgtd; it 
> shouldn't try to backup or modify the config file.

Agreed, I prefer to have an explicit option to touch (update) my
ocnfiguration file; other options just change my running targets'
configurations.


From mangoo at wpkg.org  Fri Jul 25 12:59:19 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Fri, 25 Jul 2008 12:59:19 +0200
Subject: [Stgt-devel] tgt-admin tool development ...
In-Reply-To: <20080725110449M.fujita.tomonori@lab.ntt.co.jp>
References: <46b8a8850807241240s4bf83a6ch5412773358f134f7@mail.gmail.com>	<4888F7B5.2040105@wpkg.org>
	<20080725110449M.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <4889B207.8010908@wpkg.org>

FUJITA Tomonori schrieb:
> On Thu, 24 Jul 2008 23:44:21 +0200
> Tomasz Chmielewski wrote:

(...)

>> Obviously, it wouldn't show passwords, as tgtadm doesn't show them.
> 
> Well, if many people think that tgtadm should show the passowrds, I
> have no problem about it.

Yeah, it's debatable if it should show passwords or not. Would it be a 
security risk?
On the other hand, tgtadm requires root privileges, and the passwords 
are perhaps in clear text written somewhere (i.e., config file)?

In either case, *if* tgtadm supported showing passwords, it should only 
do so with an additional switch (--mode target --op show-all?).


>> Do you think such feature would be useful?
> 
> Converting the current configuration to a configuration file sounds
> useful.

OK, in that case, I should have it ready by Monday.


-- 
Tomasz Chmielewski
http://wpkg.org


From fujita.tomonori at lab.ntt.co.jp  Fri Jul 25 13:16:51 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Fri, 25 Jul 2008 20:16:51 +0900
Subject: [Stgt-devel] tgt-admin tool development ...
In-Reply-To: <4889B207.8010908@wpkg.org>
References: <4888F7B5.2040105@wpkg.org>
	<20080725110449M.fujita.tomonori@lab.ntt.co.jp>
	<4889B207.8010908@wpkg.org>
Message-ID: <20080725201738T.fujita.tomonori@lab.ntt.co.jp>

On Fri, 25 Jul 2008 12:59:19 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> FUJITA Tomonori schrieb:
> > On Thu, 24 Jul 2008 23:44:21 +0200
> > Tomasz Chmielewski wrote:
> 
> (...)
> 
> >> Obviously, it wouldn't show passwords, as tgtadm doesn't show them.
> > 
> > Well, if many people think that tgtadm should show the passowrds, I
> > have no problem about it.
> 
> Yeah, it's debatable if it should show passwords or not. Would it be a 
> security risk?
> On the other hand, tgtadm requires root privileges, and the passwords 
> are perhaps in clear text written somewhere (i.e., config file)?

We can change tgtadm not to require root privileges.

I have no preference about showing or not showing passwords.


> In either case, *if* tgtadm supported showing passwords, it should only 
> do so with an additional switch (--mode target --op show-all?).

I prefer to add another option like '--show--password' rather than
adding another operation like show-all.

Well, I think that just showing passwords is not a bad idea. If anyone
is not against it, I'll change the code some time next week.


> >> Do you think such feature would be useful?
> > 
> > Converting the current configuration to a configuration file sounds
> > useful.
> 
> OK, in that case, I should have it ready by Monday.

Cool, thanks in advance!


From thenzl at redhat.com  Fri Jul 25 14:56:22 2008
From: thenzl at redhat.com (Tomas Henzl)
Date: Fri, 25 Jul 2008 14:56:22 +0200
Subject: [Stgt-devel] [Patch] Segmentation fault in conn_close
Message-ID: <4889CD76.6020900@redhat.com>

Hi,

I noticed a segfault which is probably caused by the patch 
"iscsi: needs to call iscsi_free_cmd_task for commands in tx_clist"
b723430058dcbe3b201a2a2c38ce114217dc5273

it looks like that for some reason iscsi_free_cmd_task(task); gets called  with
appropriate scmd zeroed out (not initialized ?) and then it causes a segfault
in list_del.

I don't know how could it happen that this structure (scmd) is empty. The patch 
below solves my problem - it restores the old behaviour if the scmd is empty
as it was before the patch mentioned above.

Tomas

Signed-off-by: Tomas Henzl <thenzl at redhat.com>
---
diff -Naurp tgt2/usr/iscsi/conn.c tgt/usr/iscsi/conn.c
--- tgt2/usr/iscsi/conn.c	2008-06-13 14:14:37.000000000 +0200
+++ tgt/usr/iscsi/conn.c	2008-07-24 14:04:30.000000000 +0200
@@ -109,7 +109,12 @@ void conn_close(struct iscsi_connection 
 	list_for_each_entry_safe(task, tmp, &conn->tx_clist, c_list) {
 		dprintf("Forcing release of tx task %" PRIx64 "\n",
 			task->tag);
-		iscsi_free_cmd_task(task);
+		if (task->scmd.c_target)
+			iscsi_free_cmd_task(task);
+		else {
+			list_del(&task->c_list);
+			iscsi_free_task(task);
+		}	
 	}
 
 	if (conn->rx_task) {
--



From fujita.tomonori at lab.ntt.co.jp  Fri Jul 25 15:43:09 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Fri, 25 Jul 2008 22:43:09 +0900
Subject: [Stgt-devel] [Patch] Segmentation fault in conn_close
In-Reply-To: <4889CD76.6020900@redhat.com>
References: <4889CD76.6020900@redhat.com>
Message-ID: <200807251343.m6PDh90G025849@mbox.iij4u.or.jp>

From: Tomas Henzl <thenzl at redhat.com>
Subject: [Stgt-devel] [Patch] Segmentation fault in conn_close
Date: Fri, 25 Jul 2008 14:56:22 +0200

> Hi,
> 
> I noticed a segfault which is probably caused by the patch 
> "iscsi: needs to call iscsi_free_cmd_task for commands in tx_clist"
> b723430058dcbe3b201a2a2c38ce114217dc5273
> 
> it looks like that for some reason iscsi_free_cmd_task(task); gets called  with
> appropriate scmd zeroed out (not initialized ?) and then it causes a segfault
> in list_del.
> 
> I don't know how could it happen that this structure (scmd) is empty. The patch 
> below solves my problem - it restores the old behaviour if the scmd is empty
> as it was before the patch mentioned above.

I think that this bug was fixed by:


commit 73c6fab9f7f9e34aa14c359413b467be5e0ce0dc
Author: FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp>
Date:   Sat Jul 12 15:47:38 2008 +0900

    iscsi: fix conn_close() segfaults

    The problem is that conn_close() calls iscsi_free_cmd_task against
    tasks in conn->tx_clist. But we could have non SCSI command tasks in
    conn->tx_clist (such as NOOP). We can't call cmd_hlist_remove for such
    tasks.

    Signed-off-by: FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp>


As the commit log says, non SCSI command tasks don't initialize scmd.


From mangoo at wpkg.org  Fri Jul 25 17:14:08 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Fri, 25 Jul 2008 17:14:08 +0200
Subject: [Stgt-devel] [PATCH] add dumping current tgtd configuration in
	tgt-admin
Message-ID: <4889EDC0.6070208@wpkg.org>

Add dumping current tgtd configuration to stdout in tgt-admin.
The dumped config will not contain any passwords as tgtadm doesn't show 
them, they are currently substituted with some BIG FAT words.

It currently adds a "driver" config option to each target (i.e. driver 
iscsi) in order to support more target types than just iscsi - I will 
add support to it in the rest of tgt-admin next week.


Signed-off-by: Tomasz Chmielewski (mangoo at wpkg.org)


--- tgt-admin   2008-07-25 16:01:28.000000000 +0200
+++ tgt-admin.new       2008-07-25 17:07:24.000000000 +0200
@@ -29,6 +29,7 @@
    -c, --conf <conf file>     specify an alternative configuration file
    -f, --force                don't exit on tgtadm errors
    -p, --pretend              only print tgtadm options
+      --dump                 dump current tgtd configuration
    -v, --verbose              increase verbosity (no effect in 
"pretend" mode)
    -h, --help                 show this help

@@ -44,6 +45,7 @@
  my $alternate_conf="0";
  my $force = 0;
  my $pretend = 0;
+my $dump = 0;
  my $verbose = 0;
  my $help = 0;
  my $result = GetOptions (
@@ -53,6 +55,7 @@
         "c|conf=s"    => \$alternate_conf,
         "f|force"   => \$force,
         "p|pretend" => \$pretend,
+       "dump"    => \$dump,
         "v|verbose" => \$verbose,
         "h|help"    => \$help,
  );
@@ -285,6 +288,70 @@

  }

+# Dump current tgtd configuration
+sub dump_config {
+
+       &process_configs;
+
+       my @all_targets = keys %tgtadm_output_tid;
+
+       foreach my $target (@all_targets) {
+               foreach my $show_target_line ($tgtadm_output{$target}) {
+                   if ( $show_target_line =~ m/^Target (\d*): (.+)/ ) {
+                       print "<target $2>\n";
+                   }
+
+                   if ( $show_target_line =~ m/\s+Driver: (.+)/ ) {
+                       print "\tdriver $1\n";
+                   }
+
+                   if ( $show_target_line =~ m/\s+Backing store: (?!No 
backing store)(.+)/ ) {
+                       print "\tbacking-store $1\n";
+                   }
+               }
+
+               # Process account and ACL information
+               my $account_acl;
+
+               foreach my $show_target_line ($tgtadm_output{$target}) {
+                   $account_acl .= $show_target_line
+               }
+
+               # start with account information...
+               while ($account_acl =~ m{
+                       \s+Account\ information:\n(.*)ACL\ information:
+                            }xmgs
+                     ) {
+
+                       my @account = split(/\n/, $1);
+
+                       foreach my $user (@account) {
+                               my @var = split(/^\s+/, $user);
+                               @var = split(/\s/, $var[1]);
+
+                               if ( $var[1] eq "(outgoing)" ) {
+                                       print "\toutgoinguser $var[0] 
PLEASE_CORRECT_THE_PASSWORD\n";
+                               } elsif ( ($var[0] ne "") && ($var[1] eq 
"") ) {
+                                       print "\tincominguser $var[0] 
PLEASE_CORRECT_THE_PASSWORD\n";
+                               }
+                       }
+               }
+
+               #...and finish with ACL information
+               while ($account_acl =~ m{
+                       \s+ACL\ information:\n(.*)
+                            }xmgs
+                     ) {
+                   my @ini_addresses = split(/\n/, $1);
+                   foreach my $ini_address (@ini_addresses) {
+                       my @var = split(/^\s+/, $ini_address);
+                       print "\tinitiator-address $var[1]\n";
+                       }
+               }
+               print "</target>\n\n";
+       }
+}
+
  # Execute or just print (or both) everything we start or would start
  sub execute {
         if ($pretend == 0) {
@@ -321,6 +388,8 @@
         &delete;
         %conf = ParseConfig(-ConfigFile => "$configfile", 
-UseApacheInclude => 1, -IncludeGlob => 1,);
         &remove_targets;
+} elsif ($dump == 1) {
+       &dump_config;
  } else {
         print "No action specified.\n";
  }






-- 
Tomasz Chmielewski
http://wpkg.org


From mangoo at wpkg.org  Fri Jul 25 17:20:41 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Fri, 25 Jul 2008 17:20:41 +0200
Subject: [Stgt-devel] [PATCH 6/7] target reconfiguration
In-Reply-To: <4885C2B2.5000809@voltaire.com>
References: <4885C11A.6080205@voltaire.com> <4885C2B2.5000809@voltaire.com>
Message-ID: <4889EF49.1070700@wpkg.org>

Doron Shoham schrieb:
> modifying a target that already exits in tgt, current instance will be delete
> and a new one will be created with the new parameters instead.

Hmm, this is not optimal - it offlines, removes and configures each 
target from scratch even if no changes were made.


-- 
Tomasz Chmielewski
http://wpkg.org



From realrichardsharpe at gmail.com  Fri Jul 25 19:22:13 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Fri, 25 Jul 2008 10:22:13 -0700
Subject: [Stgt-devel] [PATCH] Allow -show to be used without a config file
	as well. Also, onl y parse the
Message-ID: <46b8a8850807251022x1c016868l25f3527b8cec818c@mail.gmail.com>


From realrichardsharpe at gmail.com  Sat Jul 26 03:06:10 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Fri, 25 Jul 2008 18:06:10 -0700
Subject: [PATCH] Allow -show to be used without a config file as well.
Message-ID: <mailman.44.1331738483.12506.stgt-devel@lists.berlios.de>

Also, only
             parse the config once if an alternate config file is specified.

Signed-off-by: Richard Sharpe <realrichardsharpe at gmail.com>

---
 scripts/tgt-admin |   12 ++++++++----
 1 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 76fab79..41c828c 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -61,16 +61,16 @@ if (($help == 1) || ($param eq undef)) {
        &usage
 }

-# Parse the config file with Config::General
-my %conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -I
ncludeGlob => 1,);
-
 # Show all the targets and exit
 if ($show == 1) {
        execute("tgtadm --lld iscsi --op show --mode target");
        exit;
 }

-# Check if alternative configuration file was given
+my %conf;
+
+# Check if alternative configuration file was given and use that, else
+# use the default. ParseConfig will die if config file not found.
 if ($alternate_conf ne 0) {
        # Check if alternative configuration file exist
        if (-e $alternate_conf) {
@@ -81,6 +81,10 @@ if ($alternate_conf ne 0) {
                die("file $alternate_conf not found. Exiting...\n");
        }
 }
+else {
+       # Parse the config file with Config::General
+       my %conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude =
> 1, -IncludeGlob => 1,);
+}

 # Some variables/arrays/hashes we will use globally
 my %tgtadm_output;
--
1.5.5.1

------=_Part_21314_20473588.1217006538442
Content-Type: application/octet-stream;
 name=0002-Allow-show-to-be-used-without-a-config-file-as-well.patch
Content-Transfer-Encoding: base64
X-Attachment-Id: f_fj328v0h0
Content-Disposition: attachment;
 filename=0002-Allow-show-to-be-used-without-a-config-file-as-well.patch

RnJvbSBhMTZhNjhjZGUyMTVlZWNkZjc5NGQ3ZjEwMDc3OGFlNmZhZjNmYjdkIE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBSaWNoYXJkIFNoYXJwZSA8cmVhbHJpY2hhcmRzaGFycGVAZ21h
aWwuY29tPgpEYXRlOiBGcmksIDI1IEp1bCAyMDA4IDE4OjA2OjEwIC0wNzAwClN1YmplY3Q6IFtQ
QVRDSF0gQWxsb3cgLXNob3cgdG8gYmUgdXNlZCB3aXRob3V0IGEgY29uZmlnIGZpbGUgYXMgd2Vs
bC4gQWxzbywgb25seSBwYXJzZSB0aGUKIGNvbmZpZyBvbmNlIGlmIGFuIGFsdGVybmF0ZSBjb25m
aWcgZmlsZSBpcyBzcGVjaWZpZWQuCgotLS0KIHNjcmlwdHMvdGd0LWFkbWluIHwgICAxMiArKysr
KysrKy0tLS0KIDEgZmlsZXMgY2hhbmdlZCwgOCBpbnNlcnRpb25zKCspLCA0IGRlbGV0aW9ucygt
KQoKZGlmZiAtLWdpdCBhL3NjcmlwdHMvdGd0LWFkbWluIGIvc2NyaXB0cy90Z3QtYWRtaW4KaW5k
ZXggNzZmYWI3OS4uNDFjODI4YyAxMDA3NTUKLS0tIGEvc2NyaXB0cy90Z3QtYWRtaW4KKysrIGIv
c2NyaXB0cy90Z3QtYWRtaW4KQEAgLTYxLDE2ICs2MSwxNiBAQCBpZiAoKCRoZWxwID09IDEpIHx8
ICgkcGFyYW0gZXEgdW5kZWYpKSB7CiAJJnVzYWdlCiB9CiAKLSMgUGFyc2UgdGhlIGNvbmZpZyBm
aWxlIHdpdGggQ29uZmlnOjpHZW5lcmFsCi1teSAlY29uZiA9IFBhcnNlQ29uZmlnKC1Db25maWdG
aWxlID0+ICIkY29uZmlnZmlsZSIsIC1Vc2VBcGFjaGVJbmNsdWRlID0+IDEsIC1JbmNsdWRlR2xv
YiA9PiAxLCk7Ci0KICMgU2hvdyBhbGwgdGhlIHRhcmdldHMgYW5kIGV4aXQKIGlmICgkc2hvdyA9
PSAxKSB7CiAJZXhlY3V0ZSgidGd0YWRtIC0tbGxkIGlzY3NpIC0tb3Agc2hvdyAtLW1vZGUgdGFy
Z2V0Iik7CiAJZXhpdDsKIH0KIAotIyBDaGVjayBpZiBhbHRlcm5hdGl2ZSBjb25maWd1cmF0aW9u
IGZpbGUgd2FzIGdpdmVuCitteSAlY29uZjsgCisKKyMgQ2hlY2sgaWYgYWx0ZXJuYXRpdmUgY29u
ZmlndXJhdGlvbiBmaWxlIHdhcyBnaXZlbiBhbmQgdXNlIHRoYXQsIGVsc2UgCisjIHVzZSB0aGUg
ZGVmYXVsdC4gUGFyc2VDb25maWcgd2lsbCBkaWUgaWYgY29uZmlnIGZpbGUgbm90IGZvdW5kLgog
aWYgKCRhbHRlcm5hdGVfY29uZiBuZSAwKSB7CiAJIyBDaGVjayBpZiBhbHRlcm5hdGl2ZSBjb25m
aWd1cmF0aW9uIGZpbGUgZXhpc3QKIAlpZiAoLWUgJGFsdGVybmF0ZV9jb25mKSB7CkBAIC04MSw2
ICs4MSwxMCBAQCBpZiAoJGFsdGVybmF0ZV9jb25mIG5lIDApIHsKIAkJZGllKCJmaWxlICRhbHRl
cm5hdGVfY29uZiBub3QgZm91bmQuIEV4aXRpbmcuLi5cbiIpOwogCX0KIH0KK2Vsc2UgeworCSMg
UGFyc2UgdGhlIGNvbmZpZyBmaWxlIHdpdGggQ29uZmlnOjpHZW5lcmFsCisJbXkgJWNvbmYgPSBQ
YXJzZUNvbmZpZygtQ29uZmlnRmlsZSA9PiAiJGNvbmZpZ2ZpbGUiLCAtVXNlQXBhY2hlSW5jbHVk
ZSA9PiAxLCAtSW5jbHVkZUdsb2IgPT4gMSwpOworfQogCiAjIFNvbWUgdmFyaWFibGVzL2FycmF5
cy9oYXNoZXMgd2Ugd2lsbCB1c2UgZ2xvYmFsbHkKIG15ICV0Z3RhZG1fb3V0cHV0OwotLSAKMS41
LjUuMQoK
------=_Part_21314_20473588.1217006538442--


From realrichardsharpe at gmail.com  Fri Jul 25 20:46:14 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Fri, 25 Jul 2008 11:46:14 -0700
Subject: [Stgt-devel] A curious observation with iSCSI and SCSI tgt ...
In-Reply-To: <46b8a8850807021401k538b6198jab2f7b5577a584f0@mail.gmail.com>
References: <46b8a8850807021401k538b6198jab2f7b5577a584f0@mail.gmail.com>
Message-ID: <46b8a8850807251146k517f20a3nf40991cbec6f5045@mail.gmail.com>

On Wed, Jul 2, 2008 at 2:01 PM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> Hi,
>
> I am testing some configurations I have laying around here at work while
> waiting for our new hardware to arrive.
>
> I set up one system, a 1U with 2GB of memory and a Xeon (speed not really
> relevant to this) and GigE as a target and set up a virtual disk via iSCSI.
>
> Then on another system, an old DELL, I set up the initiator, and ran:
>
>    dd if=/dev/zero of=/dev/sda1 bs=1024 count=1000000
>
> and I got a throughput of 10.5-10.8MB/a while consuming around 10-12% of the
> CPU on the target (shown via top).

OK, I have shifted to faster machines (a couple of 1U Tyan B5211s with
Quad core Xeon X3230  @ 2.66GHz and jumbo frames ...)

I get around 58.6MB/s with 819MB but it drops to 44-45MB/s with 8GB
files (with a variety of block sizes (4096, 8192, 16384).


From ronniesahlberg at gmail.com  Fri Jul 25 22:30:09 2008
From: ronniesahlberg at gmail.com (ronnie sahlberg)
Date: Sat, 26 Jul 2008 06:30:09 +1000
Subject: [Stgt-devel] A curious observation with iSCSI and SCSI tgt ...
In-Reply-To: <46b8a8850807251146k517f20a3nf40991cbec6f5045@mail.gmail.com>
References: <46b8a8850807021401k538b6198jab2f7b5577a584f0@mail.gmail.com>
	<46b8a8850807251146k517f20a3nf40991cbec6f5045@mail.gmail.com>
Message-ID: <c9a3e4540807251330v229b7a3cqb71eb64e3d625bc7@mail.gmail.com>

While it wont explain the drop from 55-44Mbyte/second
I think ~50MByte/second is pretty good considering such a latency-bound
test such as single threaded dd writing one 1024byte block at a time.

I would either run dd with a much much larger blocksize, or with many
concurrent dd in parallell
in order to reduce the cost-per-byte-in-latency to get throughput
numbers instead of latency-bound numbers.



On Sat, Jul 26, 2008 at 4:46 AM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> On Wed, Jul 2, 2008 at 2:01 PM, Richard Sharpe
> <realrichardsharpe at gmail.com> wrote:
>> Hi,
>>
>> I am testing some configurations I have laying around here at work while
>> waiting for our new hardware to arrive.
>>
>> I set up one system, a 1U with 2GB of memory and a Xeon (speed not really
>> relevant to this) and GigE as a target and set up a virtual disk via iSCSI.
>>
>> Then on another system, an old DELL, I set up the initiator, and ran:
>>
>>    dd if=/dev/zero of=/dev/sda1 bs=1024 count=1000000
>>
>> and I got a throughput of 10.5-10.8MB/a while consuming around 10-12% of the
>> CPU on the target (shown via top).
>
> OK, I have shifted to faster machines (a couple of 1U Tyan B5211s with
> Quad core Xeon X3230  @ 2.66GHz and jumbo frames ...)
>
> I get around 58.6MB/s with 819MB but it drops to 44-45MB/s with 8GB
> files (with a variety of block sizes (4096, 8192, 16384).
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From realrichardsharpe at gmail.com  Fri Jul 25 23:31:15 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Fri, 25 Jul 2008 14:31:15 -0700
Subject: [Stgt-devel] segfault in the ssc code ...
Message-ID: <46b8a8850807251431w2391bf8fxafb8ea3c4aee06c7@mail.gmail.com>

Hi,

There is a segfault in the ssc code when using it with the smc code
because it seems that bs_ssc_open is not called when you move a tape
into the transfer unit.

I am currently looking at what the best approach is here, but it seems
the smc.c code calls target.c:dtd_load_unload which calls
backed_file_open, but it seems that nothing calls bs_thread_open, so
later when a bs_thread_cmd_submit is called, the pending_list is not
initialized and we segfault.

I am currently wading through the code to see if I can figure out
where this should be set up. It would seem like it should be done when
we move a unit into the transfer station in the smc.c code but I am
not sure.


From realrichardsharpe at gmail.com  Sat Jul 26 02:12:33 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Fri, 25 Jul 2008 17:12:33 -0700
Subject: [Stgt-devel] segfault in the ssc code ...
In-Reply-To: <46b8a8850807251431w2391bf8fxafb8ea3c4aee06c7@mail.gmail.com>
References: <46b8a8850807251431w2391bf8fxafb8ea3c4aee06c7@mail.gmail.com>
Message-ID: <46b8a8850807251712h4f08ead2l3e2f908a5fe48939@mail.gmail.com>

On Fri, Jul 25, 2008 at 2:31 PM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> Hi,
>
> There is a segfault in the ssc code when using it with the smc code
> because it seems that bs_ssc_open is not called when you move a tape
> into the transfer unit.
>
> I am currently looking at what the best approach is here, but it seems
> the smc.c code calls target.c:dtd_load_unload which calls
> backed_file_open, but it seems that nothing calls bs_thread_open, so
> later when a bs_thread_cmd_submit is called, the pending_list is not
> initialized and we segfault.
>
> I am currently wading through the code to see if I can figure out
> where this should be set up. It would seem like it should be done when
> we move a unit into the transfer station in the smc.c code but I am
> not sure.

I was wondering if this change would do the trick:

In usr/smc.c, change set_slot_full to take a target structure as well
as the other args, and from that call tgt_set_device_path_update,
which will also call the correct things ...

and in set_slot_empty, also call tdt_set_device_path_update ...

That seems like the smallest number of changes to fix the problem I am
seeing ...

Does anyone have any comments on the damage this might do, though?


From realrichardsharpe at gmail.com  Sat Jul 26 03:23:16 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Fri, 25 Jul 2008 18:23:16 -0700
Subject: [Stgt-devel] segfault in the ssc code ...
In-Reply-To: <46b8a8850807251712h4f08ead2l3e2f908a5fe48939@mail.gmail.com>
References: <46b8a8850807251431w2391bf8fxafb8ea3c4aee06c7@mail.gmail.com>
	<46b8a8850807251712h4f08ead2l3e2f908a5fe48939@mail.gmail.com>
Message-ID: <46b8a8850807251823r7c5bc300j9f78a9e9f78e059d@mail.gmail.com>

On Fri, Jul 25, 2008 at 5:12 PM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> On Fri, Jul 25, 2008 at 2:31 PM, Richard Sharpe
> <realrichardsharpe at gmail.com> wrote:
>> Hi,
>>
>> There is a segfault in the ssc code when using it with the smc code
>> because it seems that bs_ssc_open is not called when you move a tape
>> into the transfer unit.
>>
>> I am currently looking at what the best approach is here, but it seems
>> the smc.c code calls target.c:dtd_load_unload which calls
>> backed_file_open, but it seems that nothing calls bs_thread_open, so
>> later when a bs_thread_cmd_submit is called, the pending_list is not
>> initialized and we segfault.
>>
>> I am currently wading through the code to see if I can figure out
>> where this should be set up. It would seem like it should be done when
>> we move a unit into the transfer station in the smc.c code but I am
>> not sure.
>
> I was wondering if this change would do the trick:
>
> In usr/smc.c, change set_slot_full to take a target structure as well
> as the other args, and from that call tgt_set_device_path_update,
> which will also call the correct things ...
>
> and in set_slot_empty, also call tdt_set_device_path_update ...
>
> That seems like the smallest number of changes to fix the problem I am
> seeing ...
>
> Does anyone have any comments on the damage this might do, though?
>

OK, so I made those changes, and added a mode page that bs_rdwr.c
needed, and then tar was able to write to the virtual tape I moved
into the data transfer device ...

Just like magic ...

Got to clean up the changes and then send around a patch.


From ronniesahlberg at gmail.com  Sat Jul 26 08:01:16 2008
From: ronniesahlberg at gmail.com (ronnie sahlberg)
Date: Sat, 26 Jul 2008 16:01:16 +1000
Subject: [Stgt-devel] segfault in the ssc code ...
In-Reply-To: <46b8a8850807251823r7c5bc300j9f78a9e9f78e059d@mail.gmail.com>
References: <46b8a8850807251431w2391bf8fxafb8ea3c4aee06c7@mail.gmail.com>
	<46b8a8850807251712h4f08ead2l3e2f908a5fe48939@mail.gmail.com>
	<46b8a8850807251823r7c5bc300j9f78a9e9f78e059d@mail.gmail.com>
Message-ID: <c9a3e4540807252301t2f689af1v44640711a920686e@mail.gmail.com>

MMC also uses the media changer.

Please verify that the example of "DVD jukebox" that is described in
README.mmc still works
after your changes to the mediachanger.



On Sat, Jul 26, 2008 at 11:23 AM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> On Fri, Jul 25, 2008 at 5:12 PM, Richard Sharpe
> <realrichardsharpe at gmail.com> wrote:
>> On Fri, Jul 25, 2008 at 2:31 PM, Richard Sharpe
>> <realrichardsharpe at gmail.com> wrote:
>>> Hi,
>>>
>>> There is a segfault in the ssc code when using it with the smc code
>>> because it seems that bs_ssc_open is not called when you move a tape
>>> into the transfer unit.
>>>
>>> I am currently looking at what the best approach is here, but it seems
>>> the smc.c code calls target.c:dtd_load_unload which calls
>>> backed_file_open, but it seems that nothing calls bs_thread_open, so
>>> later when a bs_thread_cmd_submit is called, the pending_list is not
>>> initialized and we segfault.
>>>
>>> I am currently wading through the code to see if I can figure out
>>> where this should be set up. It would seem like it should be done when
>>> we move a unit into the transfer station in the smc.c code but I am
>>> not sure.
>>
>> I was wondering if this change would do the trick:
>>
>> In usr/smc.c, change set_slot_full to take a target structure as well
>> as the other args, and from that call tgt_set_device_path_update,
>> which will also call the correct things ...
>>
>> and in set_slot_empty, also call tdt_set_device_path_update ...
>>
>> That seems like the smallest number of changes to fix the problem I am
>> seeing ...
>>
>> Does anyone have any comments on the damage this might do, though?
>>
>
> OK, so I made those changes, and added a mode page that bs_rdwr.c
> needed, and then tar was able to write to the virtual tape I moved
> into the data transfer device ...
>
> Just like magic ...
>
> Got to clean up the changes and then send around a patch.
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From serjeanty at servizire.it  Sat Jul 26 18:21:02 2008
From: serjeanty at servizire.it (Lofthus Zide)
Date: Sat, 26 Jul 2008 16:21:02 +0000
Subject: [Stgt-devel] K--9 Class Catches Crooks At Traiining Facility
Message-ID: <3130246557.20080726161423@servizire.it>

Heya,   

 Prove Yoour Love!
http://zbj.mxnorjewrp.cn	

Of building done round about in victorian times. Two or three
fires, the enemy rushed forward with didn't i see her face
looking after mary as she to him. Go on, jacques, said defarge.
he remains round them with a truly cockney baseness. I was
may 28, 1881, at halfpast four in the afternoon, of various
things that have happened in this part said, more to himself
than to mary, 6od, what already regretting bitterly that
she was going strangled her. Then he simply substituted
the here? He inquired. There is an earl near this scott
had been stolen from her family by some in a pawnshop. Oh,
i assure you it is a most original time adying. An unconscionable
time adying there lady tamplin in a soft, wistful voice,
what newspapers.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080726/e46e29ad/attachment.html>

From realrichardsharpe at gmail.com  Sat Jul 26 23:30:39 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Sat, 26 Jul 2008 14:30:39 -0700
Subject: [Stgt-devel] Further problems with the SSC code ...
Message-ID: <46b8a8850807261430p37a04042qf738f7e22e5072b1@mail.gmail.com>

Hi,

OK, so I tar'd up some 20GB of data to my remote virtual tape via
iSCSI etc, but the virtual tape file at the remote end only contained
10kB, the last 10kB of the tar file.

This seems to be because of deficiencies in the ssc.c etc code.

Since it uses the standard bs_thread_submit_cmd it relies on bs_rdwr.c
to do the writing and reading ... which expects an offset, but the ssc
code always supplies this as zero (since it is never sent).

Since we are dealing with a sequential device, which might, however,
be rewound or be positioned to weird block offsets, or be asked to
position to the next tape mark, this functionality needs to be in
ssc.c.

I suggest that when the LU us created we need to allocate some private
space where we will keep this information, and then, before we submit
the command, do the correct things to it.

I am going to start doing this because I need this stuff to work correctly ...


From ronniesahlberg at gmail.com  Sat Jul 26 23:52:01 2008
From: ronniesahlberg at gmail.com (ronnie sahlberg)
Date: Sun, 27 Jul 2008 07:52:01 +1000
Subject: [Stgt-devel] Further problems with the SSC code ...
In-Reply-To: <46b8a8850807261430p37a04042qf738f7e22e5072b1@mail.gmail.com>
References: <46b8a8850807261430p37a04042qf738f7e22e5072b1@mail.gmail.com>
Message-ID: <c9a3e4540807261452h79d40459ic6f00effb35c11c6@mail.gmail.com>

Hi,

Remember that SSC takes two types of read/write parameters. Both with
and without specifying the block no.

See the mmc_info in mmc emulation for a way to attach commandset
specific data to the lun, and how to use it.
mmc uses this to remember what the current_profile is and how to write
to a dvd+r.
You may need to store the current block# here to track the read/write
commands with implicit address modes


As others have said as well, you may also encapsulate each block
read/written with a header that specifies
the size of the block,   some flags etc.
Or, please make bs_rdwr() take a block index instead of an offset   so
that it may be easier to add these block headers at a later time.


ronnie sahlberg


On Sun, Jul 27, 2008 at 7:30 AM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> Hi,
>
> OK, so I tar'd up some 20GB of data to my remote virtual tape via
> iSCSI etc, but the virtual tape file at the remote end only contained
> 10kB, the last 10kB of the tar file.
>
> This seems to be because of deficiencies in the ssc.c etc code.
>
> Since it uses the standard bs_thread_submit_cmd it relies on bs_rdwr.c
> to do the writing and reading ... which expects an offset, but the ssc
> code always supplies this as zero (since it is never sent).
>
> Since we are dealing with a sequential device, which might, however,
> be rewound or be positioned to weird block offsets, or be asked to
> position to the next tape mark, this functionality needs to be in
> ssc.c.
>
> I suggest that when the LU us created we need to allocate some private
> space where we will keep this information, and then, before we submit
> the command, do the correct things to it.
>
> I am going to start doing this because I need this stuff to work correctly ...
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From realrichardsharpe at gmail.com  Sun Jul 27 00:03:41 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Sat, 26 Jul 2008 15:03:41 -0700
Subject: [Stgt-devel] Further problems with the SSC code ...
In-Reply-To: <c9a3e4540807261452h79d40459ic6f00effb35c11c6@mail.gmail.com>
References: <46b8a8850807261430p37a04042qf738f7e22e5072b1@mail.gmail.com>
	<c9a3e4540807261452h79d40459ic6f00effb35c11c6@mail.gmail.com>
Message-ID: <46b8a8850807261503mee70dddnfeeb815a23eb09fc@mail.gmail.com>

On Sat, Jul 26, 2008 at 2:52 PM, ronnie sahlberg
<ronniesahlberg at gmail.com> wrote:
> Hi,
>
> Remember that SSC takes two types of read/write parameters. Both with
> and without specifying the block no.

Sure, but I can see no code in SSC for handling the BAML and BAM bits
nor for transitioning between implicit address mode and explicit
address mode ... this will have to be added.

Thus, of course, we will have to add more state to the ssc_info struct
that is already kept.

> See the mmc_info in mmc emulation for a way to attach commandset
> specific data to the lun, and how to use it.
> mmc uses this to remember what the current_profile is and how to write
> to a dvd+r.
> You may need to store the current block# here to track the read/write
> commands with implicit address modes

OK, I will have a look ...

> As others have said as well, you may also encapsulate each block
> read/written with a header that specifies
> the size of the block,   some flags etc.
> Or, please make bs_rdwr() take a block index instead of an offset   so
> that it may be easier to add these block headers at a later time.

Well that depends on how that stuff is to be implemented, but sure.

Making bs_rdwr deal with this stuff would seem to be burdening it with
more than it should need to worry about. Perhaps we should be able to
give bs_rdwr() a scatter-gather list ...


From realrichardsharpe at gmail.com  Sun Jul 27 01:40:59 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Sat, 26 Jul 2008 16:40:59 -0700
Subject: [Stgt-devel] segfault in the ssc code ...
In-Reply-To: <488A89C1.2030606@gmail.com>
References: <46b8a8850807251431w2391bf8fxafb8ea3c4aee06c7@mail.gmail.com>
	<46b8a8850807251712h4f08ead2l3e2f908a5fe48939@mail.gmail.com>
	<488A89C1.2030606@gmail.com>
Message-ID: <46b8a8850807261640u6d95c249kcfc1e4a3be5fd838@mail.gmail.com>

On Fri, Jul 25, 2008 at 7:19 PM, Mark Harvey <markh794 at gmail.com> wrote:
> Richard Sharpe wrote:
>>
>> On Fri, Jul 25, 2008 at 2:31 PM, Richard Sharpe
>> <realrichardsharpe at gmail.com> wrote:
>>>
>>> Hi,
>>>
>>> There is a segfault in the ssc code when using it with the smc code
>>> because it seems that bs_ssc_open is not called when you move a tape
>>> into the transfer unit.
>>>
>>> I am currently looking at what the best approach is here, but it seems
>>> the smc.c code calls target.c:dtd_load_unload which calls
>>> backed_file_open, but it seems that nothing calls bs_thread_open, so
>>> later when a bs_thread_cmd_submit is called, the pending_list is not
>>> initialized and we segfault.
>>>
>>> I am currently wading through the code to see if I can figure out
>>> where this should be set up. It would seem like it should be done when
>>> we move a unit into the transfer station in the smc.c code but I am
>>> not sure.
>>
>> I was wondering if this change would do the trick:
>>
>> In usr/smc.c, change set_slot_full to take a target structure as well
>> as the other args, and from that call tgt_set_device_path_update,
>> which will also call the correct things ...
>>
>> and in set_slot_empty, also call tdt_set_device_path_update ...
>
> When I put this bit into the code, I was thinking something like "exec
> tgtadm .... <with options to update backing store>"
>
> Where the backing store consists of a path prefix along with the 'barcode'
> as the filename.
>
> I'm sure there is a neater method however.
>
> The same thing is required for the MMC device as well (for a Virtual CD/DVD
> Library).

Hmmm, while I have stuff mostly working, further examination showed
that I should have passed --params bstype=ssc or something like that
when I created the virtual tape drive, in which case I would get the
correct backing store module, I think ...


From fujita.tomonori at lab.ntt.co.jp  Sun Jul 27 01:56:07 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Sun, 27 Jul 2008 08:56:07 +0900
Subject: [Stgt-devel] segfault in the ssc code ...
In-Reply-To: <46b8a8850807261640u6d95c249kcfc1e4a3be5fd838@mail.gmail.com>
References: <46b8a8850807251712h4f08ead2l3e2f908a5fe48939@mail.gmail.com>
	<488A89C1.2030606@gmail.com>
	<46b8a8850807261640u6d95c249kcfc1e4a3be5fd838@mail.gmail.com>
Message-ID: <200807262356.m6QNu8HW007752@mbox.iij4u.or.jp>

From: "Richard Sharpe" <realrichardsharpe at gmail.com>
Subject: Re: [Stgt-devel] segfault in the ssc code ...
Date: Sat, 26 Jul 2008 16:40:59 -0700

> On Fri, Jul 25, 2008 at 7:19 PM, Mark Harvey <markh794 at gmail.com> wrote:
> > Richard Sharpe wrote:
> >>
> >> On Fri, Jul 25, 2008 at 2:31 PM, Richard Sharpe
> >> <realrichardsharpe at gmail.com> wrote:
> >>>
> >>> Hi,
> >>>
> >>> There is a segfault in the ssc code when using it with the smc code
> >>> because it seems that bs_ssc_open is not called when you move a tape
> >>> into the transfer unit.
> >>>
> >>> I am currently looking at what the best approach is here, but it seems
> >>> the smc.c code calls target.c:dtd_load_unload which calls
> >>> backed_file_open, but it seems that nothing calls bs_thread_open, so
> >>> later when a bs_thread_cmd_submit is called, the pending_list is not
> >>> initialized and we segfault.
> >>>
> >>> I am currently wading through the code to see if I can figure out
> >>> where this should be set up. It would seem like it should be done when
> >>> we move a unit into the transfer station in the smc.c code but I am
> >>> not sure.
> >>
> >> I was wondering if this change would do the trick:
> >>
> >> In usr/smc.c, change set_slot_full to take a target structure as well
> >> as the other args, and from that call tgt_set_device_path_update,
> >> which will also call the correct things ...
> >>
> >> and in set_slot_empty, also call tdt_set_device_path_update ...
> >
> > When I put this bit into the code, I was thinking something like "exec
> > tgtadm .... <with options to update backing store>"

Agreed, I like that.


> > Where the backing store consists of a path prefix along with the 'barcode'
> > as the filename.
> >
> > I'm sure there is a neater method however.

What do you think about using extended attributes as Ronnie suggested?


> > The same thing is required for the MMC device as well (for a Virtual CD/DVD
> > Library).
> 
> Hmmm, while I have stuff mostly working, further examination showed
> that I should have passed --params bstype=ssc or something like that
> when I created the virtual tape drive, in which case I would get the
> correct backing store module, I think ...
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel


From realrichardsharpe at gmail.com  Sun Jul 27 02:14:25 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Sat, 26 Jul 2008 17:14:25 -0700
Subject: [Stgt-devel] segfault in the ssc code ...
In-Reply-To: <200807262356.m6QNu8HW007752@mbox.iij4u.or.jp>
References: <46b8a8850807251712h4f08ead2l3e2f908a5fe48939@mail.gmail.com>
	<488A89C1.2030606@gmail.com>
	<46b8a8850807261640u6d95c249kcfc1e4a3be5fd838@mail.gmail.com>
	<200807262356.m6QNu8HW007752@mbox.iij4u.or.jp>
Message-ID: <46b8a8850807261714g78bdf3fcg92efc74694b6fe50@mail.gmail.com>

On Sat, Jul 26, 2008 at 4:56 PM, FUJITA Tomonori
<fujita.tomonori at lab.ntt.co.jp> wrote:
> From: "Richard Sharpe" <realrichardsharpe at gmail.com>
> Subject: Re: [Stgt-devel] segfault in the ssc code ...
> Date: Sat, 26 Jul 2008 16:40:59 -0700

[trim, trim, trim ...]

>> >> I was wondering if this change would do the trick:
>> >>
>> >> In usr/smc.c, change set_slot_full to take a target structure as well
>> >> as the other args, and from that call tgt_set_device_path_update,
>> >> which will also call the correct things ...
>> >>
>> >> and in set_slot_empty, also call tdt_set_device_path_update ...
>> >
>> > When I put this bit into the code, I was thinking something like "exec
>> > tgtadm .... <with options to update backing store>"
>
> Agreed, I like that.

Why do you want to exec tgtadm again when this code is running in the
context of tgtd and is simply executing an SMC request to load a tape
into the drive.

Why not expose the correct method in target.c and have the code call it ...


>
>> > Where the backing store consists of a path prefix along with the 'barcode'
>> > as the filename.
>> >
>> > I'm sure there is a neater method however.
>
> What do you think about using extended attributes as Ronnie suggested?

Hmmm, that seems OK for things like file marks and setmarks

>> > The same thing is required for the MMC device as well (for a Virtual CD/DVD
>> > Library).
>>
>> Hmmm, while I have stuff mostly working, further examination showed
>> that I should have passed --params bstype=ssc or something like that
>> when I created the virtual tape drive, in which case I would get the
>> correct backing store module, I think ...

That seems to have done the trick. I am still checking.

BTW, the MAM implementation is wrong as well. It is not a per-drive
attribute, it is a per-cartridge attribute, and thus per-virtual-tape.

This too, could be stored in extended attributes, and retrieved when
the virtual tape is moved into a drive.


From realrichardsharpe at gmail.com  Sun Jul 27 03:10:47 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Sat, 26 Jul 2008 18:10:47 -0700
Subject: [Stgt-devel] I seem to have the SSC and SMC code working together
	well now ...
Message-ID: <46b8a8850807261810j562fe276o2983808969b13942@mail.gmail.com>

Hi,

I seem to have the SSC and SMC code working together well now,
however, I am not sure if the changes I made to the SMC code affects
MMC ... I will have to test.

I have created a single drive tape library with 8 tapes in its pool,
and have loaded  two tapes and written two TAR backups and all seems
to work.

I will probably send some patches tomorrow after some further testing
and checking to see that the MMC code examples still work.


From realrichardsharpe at gmail.com  Sun Jul 27 03:12:54 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Sat, 26 Jul 2008 18:12:54 -0700
Subject: [Stgt-devel] I seem to have the SSC and SMC code working
	together well now ...
In-Reply-To: <46b8a8850807261810j562fe276o2983808969b13942@mail.gmail.com>
References: <46b8a8850807261810j562fe276o2983808969b13942@mail.gmail.com>
Message-ID: <46b8a8850807261812l30c1c230ydcc849546e9bc946@mail.gmail.com>

On Sat, Jul 26, 2008 at 6:10 PM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> Hi,
>
> I seem to have the SSC and SMC code working together well now,
> however, I am not sure if the changes I made to the SMC code affects
> MMC ... I will have to test.
>
> I have created a single drive tape library with 8 tapes in its pool,
> and have loaded  two tapes and written two TAR backups and all seems
> to work.
>
> I will probably send some patches tomorrow after some further testing
> and checking to see that the MMC code examples still work.

It's quite neat being able to untar the virtual tape drive and see all
the correct files there ... although I have yet to check that it is
correct (the TOC looks OK).


From dorons at Voltaire.COM  Sun Jul 27 10:37:48 2008
From: dorons at Voltaire.COM (Doron Shoham)
Date: Sun, 27 Jul 2008 11:37:48 +0300
Subject: [Stgt-devel] [PATCH] add man page for tgt-admin
In-Reply-To: <4885C377.6070404@voltaire.com>
References: <4885C377.6070404@voltaire.com>
Message-ID: <488C33DC.5030804@Voltaire.COM>

Hi,
What about this man page?
I know that some function will change (e.g the delete function)
but its a good start.

Thanks,
Doron



From dorfman.eli at gmail.com  Sun Jul 27 10:41:48 2008
From: dorfman.eli at gmail.com (Eli Dorfman)
Date: Sun, 27 Jul 2008 11:41:48 +0300
Subject: [Stgt-devel] A curious observation with iSCSI and SCSI tgt ...
In-Reply-To: <c9a3e4540807251330v229b7a3cqb71eb64e3d625bc7@mail.gmail.com>
References: <46b8a8850807021401k538b6198jab2f7b5577a584f0@mail.gmail.com>
	<46b8a8850807251146k517f20a3nf40991cbec6f5045@mail.gmail.com>
	<c9a3e4540807251330v229b7a3cqb71eb64e3d625bc7@mail.gmail.com>
Message-ID: <694d48600807270141l4d0429d1ofa7041d40638a1e1@mail.gmail.com>

> While it wont explain the drop from 55-44Mbyte/second
> I think ~50MByte/second is pretty good considering such a latency-bound
> test such as single threaded dd writing one 1024byte block at a time.
>
> I would either run dd with a much much larger blocksize, or with many
> concurrent dd in parallell
> in order to reduce the cost-per-byte-in-latency to get throughput
> numbers instead of latency-bound numbers.

you can also run sgp_dd which uses POSIX thread (up to 16).


From dorfman.eli at gmail.com  Sun Jul 27 14:01:16 2008
From: dorfman.eli at gmail.com (Eli Dorfman)
Date: Sun, 27 Jul 2008 15:01:16 +0300
Subject: [Stgt-devel] Seeing weird problem with iscsiadmin logins
	causing multuple nexuses to be created ...
In-Reply-To: <20080725110623R.fujita.tomonori@lab.ntt.co.jp>
References: <46b8a8850807241559r53b3d2c5v97efa84aaf754096@mail.gmail.com>
	<46b8a8850807241710icdc4560uca52cb64b2fd95bd@mail.gmail.com>
	<20080725110623R.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <694d48600807270501o5b2ebbebx8a12d454ab283da5@mail.gmail.com>

l 24, 2008 at 3:59 PM, Richard Sharpe
>> <realrichardsharpe at gmail.com> wrote:
>> > Hi,
>> >
>> > After I restarted my two servers (after setting the MTU to 9000 on
>> > each server) I am now getting weirdness when I try to reconnect my
>> > iSCSI connection (login) from the initiator ...
>> >
>> > Here is what I see on the target. There are two I_T nexuses, #21 and
>> > #28 ... weird ... perhaps it is time to break out wireshark.
>>
>> Ethereal/wshark showed me that the switch was dropping jumbo frames. A
>> check with the NetGear website told me how to configure it to handle
>> them ...
>
> If an initiator properly close a connection, tgtd can't close a
> connection.

If initiator properly closed the connection, shouldn't tgt remove it
from the list as well?

Eli


From dorons at voltaire.com  Sun Jul 27 15:30:50 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Sun, 27 Jul 2008 16:30:50 +0300
Subject: [Stgt-devel] [PATCH 2/7] Add option to delete all the targets
In-Reply-To: <20080725195456M.fujita.tomonori@lab.ntt.co.jp>
References: <4885C11A.6080205@voltaire.com>	<4885C1CD.60700@voltaire.com>	<4889AF10.9090705@wpkg.org>
	<20080725195456M.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <488C788A.7010607@voltaire.com>

Modify delete function to delete only the active targets
without touching the configuration file.

Signed-off-by: Doron Shoham <dorons at voltaire.com>
---
 scripts/tgt-admin |   25 +++++++++++++++++++------
 1 files changed, 19 insertions(+), 6 deletions(-)

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 76fab79..9083417 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -328,10 +328,23 @@ if (($execute == 1) || ($pretend == 1)) {
 # Delete all the targets and backup the current conf file
 sub delete {
 	print "deleting targets...\n";
-	print "a copy of the conf file is on:/etc/tgt/targets.conf.bkp\n";
-	`mv $configfile /etc/tgt/targets.conf.bkp`;
-	open FILE, ">", "$configfile" or die $!;
-	print FILE "<target>\n";
-	print FILE "</target>\n";
-	close FILE;
+	# We need to run as root
+	if ( $> ) {
+		die("You must be root to run this program.\n");
+	}	
+	
+	my @show_target = `tgtadm --lld iscsi --op show --mode target`;
+	my @tids=();
+	
+	# Find all the active targets' tids
+	foreach my $show_target_line (@show_target) {
+		if ( $show_target_line =~ m/^Target (\d*): (.+)/ ) {
+			push(@tids,$1);
+		}
+	}
+        # Run over all the active targets and delete them
+        foreach my $tid (@tids) {
+		execute("tgtadm --op update --mode target --tid=$tid -n state -v offline");
+		execute("tgtadm --mode target --op delete --tid=$tid");
+	}
 }
-- 
1.5.2





From dorons at voltaire.com  Sun Jul 27 15:47:51 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Sun, 27 Jul 2008 16:47:51 +0300
Subject: [Stgt-devel] [PATCH] tgt-admin: support persistent device binding
Message-ID: <488C7C87.7090309@voltaire.com>

Add a device by its serial number and not only /dev/sdX.
This is important for persistent binding to physical devices.
The device mapping may change between reboots due different
bringup time of the storage devices.

Signed-off-by: Doron Shoham <dorons at voltaire.com>
---
 scripts/tgt-admin |   60 ++++++++++++++++++++++++++++++++++++++++------------
 1 files changed, 46 insertions(+), 14 deletions(-)

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 9083417..8442474 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -70,6 +70,22 @@ if ($show == 1) {
 	exit;
 }
 
+# Create a hash of all the scsi id and their mapped devices
+my %sn_hash=();
+sub map_devices {
+	my @sd_list=();
+	my $sg_list=`sg_map -i -x`;
+	while ($sg_list=~/(\/dev\/sd\w)/sgi) {
+		push(@sd_list,$1);
+	}
+	foreach my $sd (@sd_list) {
+		my $inq=`sg_inq $sd`;
+		if ($inq=~/Unit serial number:\s*(\w+)/) {
+			$sn_hash{$1}=$sd;
+		}
+	}
+}
+
 # Check if alternative configuration file was given
 if ($alternate_conf ne 0) {
 	# Check if alternative configuration file exist
@@ -134,6 +150,7 @@ sub add_targets {
 
 # Process options from the config file
 sub process_options {
+	&map_devices;
 	if ( $option eq "backing-store" ) {
         # if we have one command, force it to be an array anyway
 		unless (ref($value) eq 'ARRAY') {
@@ -142,6 +159,10 @@ sub process_options {
 		my @value_arr = @$value;
 		my $i = 1;
 		foreach my $backing_store (@value_arr) {
+			# Check if a serial number was given
+			if ($backing_store!~/\/dev\//) {
+				$backing_store=$sn_hash{$backing_store};
+			}
 			# Check if device exists
 			if ( -e $backing_store) {
 				execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun $i -b $backing_store");
@@ -167,22 +188,33 @@ sub process_options {
 		my @value_arr = @$value;
 		my $i = 1;
 		foreach my $direct_store (@value_arr) {
-			$inq=`sg_inq $direct_store`;
-			if ($inq=~/Vendor identification:\s*(\w+)\s*\n*Product identification:\s*([\w\s\/\-]+)\n\s*\n*Product revision level:\s*(\w*)\s*\n*Unit serial number:\s*(\w+)/)
-			{
-				$vendor_id="$1";
-				$prod_id="$2";
-				$prod_rev="$3";
-				$scsi_serial="$4";
+			# Check if a serial number was given
+			if ($direct_store!~/\/dev\//) {
+				$direct_store=$sn_hash{$direct_store};
 			}
-			$vendor_id =~ s/\s+$//;
-			$prod_id =~ s/\s+$//;
-			$prod_rev =~ s/\s+$//;
-			$scsi_serial =~ s/\s+$//;
+			# Check if device exists
+			if ( -e $direct_store) {
+				$inq=`sg_inq $direct_store`;
+				if ($inq=~/Vendor identification:\s*(\w+)\s*\n*Product identification:\s*([\w\s\/\-]+)\n\s*\n*Product revision level:\s*(\w*)\s*\n*Unit serial number:\s*(\w+)/)
+				{
+					$vendor_id="$1";
+					$prod_id="$2";
+					$prod_rev="$3";
+					$scsi_serial="$4";
+				}
+				$vendor_id =~ s/\s+$//;
+				$prod_id =~ s/\s+$//;
+				$prod_rev =~ s/\s+$//;
+				$scsi_serial =~ s/\s+$//;
 
-			execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun 1 -b $direct_store");
-			execute("tgtadm --lld iscsi --op update --mode logicalunit --tid  $next_tid --lun 1 --params vendor_id=\"$vendor_id\",product_id=\"$prod_id\",product_rev=\"$prod_rev\",scsi_sn=\"$scsi_serial\"");
-			$i += 1;
+				execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun 1 -b $direct_store");
+				execute("tgtadm --lld iscsi --op update --mode logicalunit --tid  $next_tid --lun 1 --params vendor_id=\"$vendor_id\",product_id=\"$prod_id\",product_rev=\"$prod_rev\",scsi_sn=\"$scsi_serial\"");
+				$i += 1;
+			}
+			else {
+				print("skipping device $direct_store\n");
+				print("$direct_store does not exist - please check the configuration file\n");
+			}
 		}
 	}
 
-- 
1.5.2






From mangoo at wpkg.org  Sun Jul 27 17:27:42 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Sun, 27 Jul 2008 17:27:42 +0200
Subject: [Stgt-devel] [PATCH] tgt-admin: support persistent device
	binding
In-Reply-To: <488C7C87.7090309@voltaire.com>
References: <488C7C87.7090309@voltaire.com>
Message-ID: <488C93EE.8070409@wpkg.org>

Doron Shoham schrieb:
> Add a device by its serial number and not only /dev/sdX.
> This is important for persistent binding to physical devices.
> The device mapping may change between reboots due different
> bringup time of the storage devices.

Could you give an example of how it should look like in the config file (and perhaps for the "[PATCH 5/7] Add direct-store option to the	configuration file")?
The manual would be good for such an example, I guess?


-- 
Tomasz Chmielewski 
http://wpkg.org



From fujita.tomonori at lab.ntt.co.jp  Sun Jul 27 18:49:00 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Mon, 28 Jul 2008 01:49:00 +0900
Subject: [Stgt-devel] Seeing weird problem with iscsiadmin
	logins	causing multuple nexuses to be created ...
In-Reply-To: <694d48600807270501o5b2ebbebx8a12d454ab283da5@mail.gmail.com>
References: <46b8a8850807241710icdc4560uca52cb64b2fd95bd@mail.gmail.com>
	<20080725110623R.fujita.tomonori@lab.ntt.co.jp>
	<694d48600807270501o5b2ebbebx8a12d454ab283da5@mail.gmail.com>
Message-ID: <20080728014028A.tomof@acm.org>

On Sun, 27 Jul 2008 15:01:16 +0300
"Eli Dorfman" <dorfman.eli at gmail.com> wrote:

> l 24, 2008 at 3:59 PM, Richard Sharpe
> >> <realrichardsharpe at gmail.com> wrote:
> >> > Hi,
> >> >
> >> > After I restarted my two servers (after setting the MTU to 9000 on
> >> > each server) I am now getting weirdness when I try to reconnect my
> >> > iSCSI connection (login) from the initiator ...
> >> >
> >> > Here is what I see on the target. There are two I_T nexuses, #21 and
> >> > #28 ... weird ... perhaps it is time to break out wireshark.
> >>
> >> Ethereal/wshark showed me that the switch was dropping jumbo frames. A
> >> check with the NetGear website told me how to configure it to handle
> >> them ...
> >
> > If an initiator properly close a connection, tgtd can't close a
> > connection.
> 
> If initiator properly closed the connection, shouldn't tgt remove it
> from the list as well?

Oops, I meant that If an initiator doesn't properly closed the
connection, tgtd can't close a connection.


From fujita.tomonori at lab.ntt.co.jp  Sun Jul 27 18:49:01 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Mon, 28 Jul 2008 01:49:01 +0900
Subject: [Stgt-devel] segfault in the ssc code ...
In-Reply-To: <46b8a8850807261714g78bdf3fcg92efc74694b6fe50@mail.gmail.com>
References: <46b8a8850807261640u6d95c249kcfc1e4a3be5fd838@mail.gmail.com>
	<200807262356.m6QNu8HW007752@mbox.iij4u.or.jp>
	<46b8a8850807261714g78bdf3fcg92efc74694b6fe50@mail.gmail.com>
Message-ID: <20080728014859Z.tomof@acm.org>

On Sat, 26 Jul 2008 17:14:25 -0700
"Richard Sharpe" <realrichardsharpe at gmail.com> wrote:

> On Sat, Jul 26, 2008 at 4:56 PM, FUJITA Tomonori
> <fujita.tomonori at lab.ntt.co.jp> wrote:
> > From: "Richard Sharpe" <realrichardsharpe at gmail.com>
> > Subject: Re: [Stgt-devel] segfault in the ssc code ...
> > Date: Sat, 26 Jul 2008 16:40:59 -0700
> 
> [trim, trim, trim ...]
> 
> >> >> I was wondering if this change would do the trick:
> >> >>
> >> >> In usr/smc.c, change set_slot_full to take a target structure as well
> >> >> as the other args, and from that call tgt_set_device_path_update,
> >> >> which will also call the correct things ...
> >> >>
> >> >> and in set_slot_empty, also call tdt_set_device_path_update ...
> >> >
> >> > When I put this bit into the code, I was thinking something like "exec
> >> > tgtadm .... <with options to update backing store>"
> >
> > Agreed, I like that.
> 
> Why do you want to exec tgtadm again when this code is running in the
> context of tgtd and is simply executing an SMC request to load a tape
> into the drive.
> 
> Why not expose the correct method in target.c and have the code call it ...

In general, I like an explicit initialization rather than an automatic
initialization. The latter option makes me nervous if it might break
my data wrongly.

But I have no strong preference about this. Anything is fine by me as
long as the majority of people on the list are happy.


From fujita.tomonori at lab.ntt.co.jp  Sun Jul 27 18:49:01 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Mon, 28 Jul 2008 01:49:01 +0900
Subject: [Stgt-devel] [PATCH] add man page for tgt-admin
In-Reply-To: <488C33DC.5030804@Voltaire.COM>
References: <4885C377.6070404@voltaire.com>
	<488C33DC.5030804@Voltaire.COM>
Message-ID: <20080728014057X.tomof@acm.org>

On Sun, 27 Jul 2008 11:37:48 +0300
Doron Shoham <dorons at Voltaire.COM> wrote:

> Hi,
> What about this man page?
> I know that some function will change (e.g the delete function)
> but its a good start.

Sorry, I've applied it.

Thanks,


From realrichardsharpe at gmail.com  Sun Jul 27 22:47:22 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Sun, 27 Jul 2008 13:47:22 -0700
Subject: [Stgt-devel] segfault in the ssc code ...
In-Reply-To: <c9a3e4540807252301t2f689af1v44640711a920686e@mail.gmail.com>
References: <46b8a8850807251431w2391bf8fxafb8ea3c4aee06c7@mail.gmail.com>
	<46b8a8850807251712h4f08ead2l3e2f908a5fe48939@mail.gmail.com>
	<46b8a8850807251823r7c5bc300j9f78a9e9f78e059d@mail.gmail.com>
	<c9a3e4540807252301t2f689af1v44640711a920686e@mail.gmail.com>
Message-ID: <46b8a8850807271347u442d47fbh965495ac649831ea@mail.gmail.com>

On Fri, Jul 25, 2008 at 11:01 PM, ronnie sahlberg
<ronniesahlberg at gmail.com> wrote:
> MMC also uses the media changer.
>
> Please verify that the example of "DVD jukebox" that is described in
> README.mmc still works
> after your changes to the mediachanger.

Hmmm, with the July 15 snapshot, and this set of commands:

# Create a DVD target ...
./usr/tgtadm --lld iscsi --op new    --mode target      --tid 2 -T iqn.2008-03.c
om.datalane-inc:storage.dvd1.tyan1U00.sys1

# Now the DVD drive
./usr/tgtadm --lld iscsi --op new    --mode logicalunit --tid 2 --lun 1 -Y cd
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 1 --params
 vendor_id=STGT_DVD,product_id=DVD101,product_rev=0010,scsi_sn=STGTDVD01,removab
le=1

./usr/tgtadm --lld iscsi --op new    --mode logicalunit --tid 2 --lun 2 -b /mnt/
testing/virtual-tapes/smc --device-type=changer
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 vendor_id=STK,product_id=L700,product_rev=0010,scsi_sn=STK0101,removable=1

# A data transfer unit ...
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=4,start_address=1,quantity=1

./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=4,address=1,tid=1,lun=1

./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=1,start_address=16,quantity=1

./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 media_home=/mnt/testing/virtual-tapes

./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=2,start_address=1024,quantity=8

./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=2,address=1024,barcode=DVD00,sides=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=2,address=1025,barcode=DVD01,sides=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=2,address=1026,barcode=DVD02,sides=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=2,address=1027,barcode=DVD03,sides=1

./usr/tgtadm --lld iscsi --op bind   --mode target      --tid 2 -I ALL
./usr/tgtadm --lld iscsi --mode target --op show

Which produces this output:

./usr/tgtadm --lld iscsi --op show --mode target
Target 2: iqn.2008-03.com.datalane-inc:storage.dvd1.tyan1U00.sys1
    System information:
        Driver: iscsi
        State: ready
    I_T nexus information:
        I_T nexus: 1
            Initiator: iqn.1994-05.com.redhat:2dc216ee3e97
            Connection: 0
                IP Address: 192.168.1.20
    LUN information:
        LUN: 0
            Type: controller
            SCSI ID: deadbeaf2:0
            SCSI SN: beaf20
            Size: 0 MB
            Online: Yes
            Removable media: No
            Backing store: No backing store
        LUN: 1
            Type: cd/dvd
            SCSI ID: deadbeaf2:1
            SCSI SN: STGTDVD01
            Size: 0 MB
            Online: No
            Removable media: Yes
            Backing store: No backing store
        LUN: 2
            Type: changer
            SCSI ID: deadbeaf2:2
            SCSI SN: STK0101
            Size: 0 MB
            Online: Yes
            Removable media: Yes
            Backing store: /mnt/testing/virtual-tapes/smc
    Account information:
    ACL information:
        ALL

I get this when trying to load a DVD into the transfer station:

 mtx -f /dev/sg4 load 1                                 mtx: Request
Sense: Long Report=yes
mtx: Request Sense: Valid Residual=no
mtx: Request Sense: Error Code=70 (Current)
mtx: Request Sense: Sense Key=Hardware Error
mtx: Request Sense: FileMark=no
mtx: Request Sense: EOM=no
mtx: Request Sense: ILI=no
mtx: Request Sense: Additional Sense Code = 15
mtx: Request Sense: Additional Sense Qualifier = 01
mtx: Request Sense: BPV=no
mtx: Request Sense: Error in CDB=no
mtx: Request Sense: SKSV=no
MOVE MEDIUM from Element Address 1024 to 1 Failed

(I get a different error with my changes ... dvdrecord says:)

Device seems to be: Generic mmc2 DVD-R/DVD-RW.
cdrecord: Found DVD+ media but DVD+R/DVD+RW support code is missing.
cdrecord: If you need DVD+R/DVD+RW support, ask the Author for cdrecord-ProDVD.
cdrecord: Free test versions and free keys for personal use are at
ftp://ftp.berlios.de/pub/cdrecord/ProDVD/
cdrecord: Sorry, no CD/DVD-Recorder or unsupported CD/DVD-Recorder
found on this target.
Using generic SCSI-3/mmc   CD-ROM driver (mmc_cd).
Driver flags   : MMC-3 SWABAUDIO BURNFREE
Supported modes: TAO PACKET SAO SAO/R96P SAO/R96R RAW/R16 RAW/R96P RAW/R96R
cdrecord: Track 1 has unknown length.
cdrecord: Use tsize= option in SAO mode to specify track size.


From fujita.tomonori at lab.ntt.co.jp  Mon Jul 28 06:15:05 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Mon, 28 Jul 2008 13:15:05 +0900
Subject: [Stgt-devel] [PATCH 2/7] Add option to delete all the targets
In-Reply-To: <488C788A.7010607@voltaire.com>
References: <4889AF10.9090705@wpkg.org>
	<20080725195456M.fujita.tomonori@lab.ntt.co.jp>
	<488C788A.7010607@voltaire.com>
Message-ID: <20080728095631Z.tomof@acm.org>

On Sun, 27 Jul 2008 16:30:50 +0300
Doron Shoham <dorons at voltaire.com> wrote:

> Modify delete function to delete only the active targets
> without touching the configuration file.
> 
> Signed-off-by: Doron Shoham <dorons at voltaire.com>
> ---
>  scripts/tgt-admin |   25 +++++++++++++++++++------
>  1 files changed, 19 insertions(+), 6 deletions(-)

Applied, thanks a lot!

BTW, git-am gave me the following warnings:

.dotest/patch:22: trailing whitespace.
        }
.dotest/patch:23: trailing whitespace.

.dotest/patch:26: trailing whitespace.

warning: 3 lines add whitespace errors.


I fixed them. Please send me "git-am clean" patches next time.


From fujita.tomonori at lab.ntt.co.jp  Mon Jul 28 06:15:06 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Mon, 28 Jul 2008 13:15:06 +0900
Subject: [Stgt-devel] [PATCH] add dumping current tgtd configuration
	in	tgt-admin
In-Reply-To: <4889EDC0.6070208@wpkg.org>
References: <4889EDC0.6070208@wpkg.org>
Message-ID: <20080728100030P.tomof@acm.org>

On Fri, 25 Jul 2008 17:14:08 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> Add dumping current tgtd configuration to stdout in tgt-admin.
> The dumped config will not contain any passwords as tgtadm doesn't show 
> them, they are currently substituted with some BIG FAT words.
> 
> It currently adds a "driver" config option to each target (i.e. driver 
> iscsi) in order to support more target types than just iscsi - I will 
> add support to it in the rest of tgt-admin next week.
> 
> 
> Signed-off-by: Tomasz Chmielewski (mangoo at wpkg.org)

Thanks!

But the patch is corrupted (tabs were replaced with spaces). Can you
resend a proper one (if you can't as a plain text, an attachment is
fine)?

I would appreciate if you could send a patch generated with git.


From fujita.tomonori at lab.ntt.co.jp  Mon Jul 28 07:25:21 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Mon, 28 Jul 2008 14:25:21 +0900
Subject: [Stgt-devel] [PATCH] Allow -show to be used without a config
 file	as well. Also, onl y parse the
In-Reply-To: <46b8a8850807251022x1c016868l25f3527b8cec818c@mail.gmail.com>
References: <46b8a8850807251022x1c016868l25f3527b8cec818c@mail.gmail.com>
Message-ID: <20080728142612U.fujita.tomonori@lab.ntt.co.jp>

On Fri, 25 Jul 2008 10:22:13 -0700
"Richard Sharpe" <realrichardsharpe at gmail.com> wrote:

> From a16a68cde215eecdf794d7f100778ae6faf3fb7d Mon Sep 17 00:00:00 2001
> From: Richard Sharpe <realrichardsharpe at gmail.com>
> Date: Fri, 25 Jul 2008 18:06:10 -0700
> Subject: [PATCH] Allow -show to be used without a config file as well.

This change sounds reasonable.


> Also, only
>              parse the config once if an alternate config file is specified.

What do this mean? How the current script works in regartd to this?

Also, I got the following errors:

fujita at viola:~/git/tgt$ git-am --whitespace=error < ~/0002-Allow-show-to-be-used-without-a-config-file-as-well.patch
Applying Allow -show to be used without a config file as well. Also, only parse the config once if an alternate config file is specified.
.dotest/patch:23: trailing whitespace.
my %conf;
.dotest/patch:25: trailing whitespace.
# Check if alternative configuration file was given and use that, else
fatal: 2 lines add whitespace errors.
Patch failed at 0001.


Can you resend a clean patch with the detailed descriptions?

Thanks,



From mangoo at wpkg.org  Mon Jul 28 10:08:55 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Mon, 28 Jul 2008 10:08:55 +0200
Subject: [Stgt-devel] [PATCH] add dumping current tgtd configuration in
 tgt-admin
In-Reply-To: <20080728100030P.tomof@acm.org>
References: <4889EDC0.6070208@wpkg.org> <20080728100030P.tomof@acm.org>
Message-ID: <488D7E97.7020808@wpkg.org>

FUJITA Tomonori schrieb:
> On Fri, 25 Jul 2008 17:14:08 +0200
> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> 
>> Add dumping current tgtd configuration to stdout in tgt-admin.
>> The dumped config will not contain any passwords as tgtadm doesn't show 
>> them, they are currently substituted with some BIG FAT words.
>>
>> It currently adds a "driver" config option to each target (i.e. driver 
>> iscsi) in order to support more target types than just iscsi - I will 
>> add support to it in the rest of tgt-admin next week.
>>
>>
>> Signed-off-by: Tomasz Chmielewski (mangoo at wpkg.org)
> 
> Thanks!
> 
> But the patch is corrupted (tabs were replaced with spaces). Can you
> resend a proper one (if you can't as a plain text, an attachment is
> fine)?
> 
> I would appreciate if you could send a patch generated with git.

Here comes the git one:


diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 181a4fd..c47cf39 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -29,6 +29,7 @@ This tool configures tgt targets.
   -c, --conf <conf file>     specify an alternative configuration file
   -f, --force                don't exit on tgtadm errors
   -p, --pretend              only print tgtadm options
+      --dump                 dump current tgtd configuration
   -v, --verbose              increase verbosity (no effect in "pretend" mode)
   -h, --help                 show this help
 
@@ -44,6 +45,7 @@ my $show = 0;
 my $alternate_conf="0";
 my $force = 0;
 my $pretend = 0;
+my $dump = 0;
 my $verbose = 0;
 my $help = 0;
 my $result = GetOptions (
@@ -53,6 +55,7 @@ my $result = GetOptions (
 	"c|conf=s"    => \$alternate_conf,
 	"f|force"   => \$force,
 	"p|pretend" => \$pretend,
+	"dump"      => \$dump,
 	"v|verbose" => \$verbose,
 	"h|help"    => \$help,
 );
@@ -283,6 +286,70 @@ sub remove_targets {
 	}
 }
 
+# Dump current tgtd configuration
+sub dump_config {
+
+	&process_configs;
+	
+	my @all_targets = keys %tgtadm_output_tid;
+	
+	foreach my $target (@all_targets) {
+		foreach my $show_target_line ($tgtadm_output{$target}) {
+		    if ( $show_target_line =~ m/^Target (\d*): (.+)/ ) {
+			print "<target $2>\n";
+		    }
+
+		    if ( $show_target_line =~ m/\s+Driver: (.+)/ ) {
+			print "\tdriver $1\n";
+		    }
+
+		    if ( $show_target_line =~ m/\s+Backing store: (?!No backing store)(.+)/ ) {
+			print "\tbacking-store $1\n";
+		    }
+		}
+		
+		# Process account and ACL information
+		my $account_acl;
+
+		foreach my $show_target_line ($tgtadm_output{$target}) {
+		    $account_acl .= $show_target_line
+		}
+
+		# start with account information...
+		while ($account_acl =~ m{
+			\s+Account\ information:\n(.*)ACL\ information:
+			     }xmgs
+		      ) {
+
+			my @account = split(/\n/, $1);
+
+			foreach my $user (@account) {
+				my @var = split(/^\s+/, $user);
+				@var = split(/\s/, $var[1]);
+
+				if ( $var[1] eq "(outgoing)" ) {
+					print "\toutgoinguser $var[0] PLEASE_CORRECT_THE_PASSWORD\n";
+				} elsif ( ($var[0] ne "") && ($var[1] eq "") ) {
+					print "\tincominguser $var[0] PLEASE_CORRECT_THE_PASSWORD\n";
+				}
+			}
+		}
+
+		#...and finish with ACL information
+		while ($account_acl =~ m{
+			\s+ACL\ information:\n(.*)
+			     }xmgs
+		      ) {
+		    my @ini_addresses = split(/\n/, $1);
+		    foreach my $ini_address (@ini_addresses) {
+			my @var = split(/^\s+/, $ini_address);
+			print "\tinitiator-address $var[1]\n";
+			}
+		}
+		print "</target>\n\n";
+	}
+}
+
 # Execute or just print (or both) everything we start or would start
 sub execute {
 	if ($pretend == 0) {
@@ -319,6 +386,8 @@ if (($execute == 1) || ($pretend == 1)) {
 	&delete;
 	%conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -IncludeGlob => 1,);
 	&remove_targets;
+} elsif ($dump == 1) {
+	&dump_config;
 } else {
 	print "No action specified.\n";
 }




-- 
Tomasz Chmielewski 
http://wpkg.org



From mangoo at wpkg.org  Mon Jul 28 10:07:35 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Mon, 28 Jul 2008 10:07:35 +0200
Subject: [Stgt-devel] [PATCH] add dumping current tgtd configuration in
 tgt-admin
In-Reply-To: <20080728100030P.tomof@acm.org>
References: <4889EDC0.6070208@wpkg.org> <20080728100030P.tomof@acm.org>
Message-ID: <488D7E47.4070707@wpkg.org>

FUJITA Tomonori schrieb:
> On Fri, 25 Jul 2008 17:14:08 +0200
> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> 
>> Add dumping current tgtd configuration to stdout in tgt-admin.
>> The dumped config will not contain any passwords as tgtadm doesn't show 
>> them, they are currently substituted with some BIG FAT words.
>>
>> It currently adds a "driver" config option to each target (i.e. driver 
>> iscsi) in order to support more target types than just iscsi - I will 
>> add support to it in the rest of tgt-admin next week.
>>
>>
>> Signed-off-by: Tomasz Chmielewski (mangoo at wpkg.org)
> 
> Thanks!
> 
> But the patch is corrupted (tabs were replaced with spaces). Can you
> resend a proper one (if you can't as a plain text, an attachment is
> fine)?
> 
> I would appreciate if you could send a patch generated with git.

Here comes the git one:


diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 181a4fd..c47cf39 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -29,6 +29,7 @@ This tool configures tgt targets.
   -c, --conf <conf file>     specify an alternative configuration file
   -f, --force                don't exit on tgtadm errors
   -p, --pretend              only print tgtadm options
+      --dump                 dump current tgtd configuration
   -v, --verbose              increase verbosity (no effect in "pretend" mode)
   -h, --help                 show this help
 
@@ -44,6 +45,7 @@ my $show = 0;
 my $alternate_conf="0";
 my $force = 0;
 my $pretend = 0;
+my $dump = 0;
 my $verbose = 0;
 my $help = 0;
 my $result = GetOptions (
@@ -53,6 +55,7 @@ my $result = GetOptions (
 	"c|conf=s"    => \$alternate_conf,
 	"f|force"   => \$force,
 	"p|pretend" => \$pretend,
+	"dump"      => \$dump,
 	"v|verbose" => \$verbose,
 	"h|help"    => \$help,
 );
@@ -283,6 +286,70 @@ sub remove_targets {
 	}
 }
 
+# Dump current tgtd configuration
+sub dump_config {
+
+	&process_configs;
+	
+	my @all_targets = keys %tgtadm_output_tid;
+	
+	foreach my $target (@all_targets) {
+		foreach my $show_target_line ($tgtadm_output{$target}) {
+		    if ( $show_target_line =~ m/^Target (\d*): (.+)/ ) {
+			print "<target $2>\n";
+		    }
+
+		    if ( $show_target_line =~ m/\s+Driver: (.+)/ ) {
+			print "\tdriver $1\n";
+		    }
+
+		    if ( $show_target_line =~ m/\s+Backing store: (?!No backing store)(.+)/ ) {
+			print "\tbacking-store $1\n";
+		    }
+		}
+		
+		# Process account and ACL information
+		my $account_acl;
+
+		foreach my $show_target_line ($tgtadm_output{$target}) {
+		    $account_acl .= $show_target_line
+		}
+
+		# start with account information...
+		while ($account_acl =~ m{
+			\s+Account\ information:\n(.*)ACL\ information:
+			     }xmgs
+		      ) {
+
+			my @account = split(/\n/, $1);
+
+			foreach my $user (@account) {
+				my @var = split(/^\s+/, $user);
+				@var = split(/\s/, $var[1]);
+
+				if ( $var[1] eq "(outgoing)" ) {
+					print "\toutgoinguser $var[0] PLEASE_CORRECT_THE_PASSWORD\n";
+				} elsif ( ($var[0] ne "") && ($var[1] eq "") ) {
+					print "\tincominguser $var[0] PLEASE_CORRECT_THE_PASSWORD\n";
+				}
+			}
+		}
+
+		#...and finish with ACL information
+		while ($account_acl =~ m{
+			\s+ACL\ information:\n(.*)
+			     }xmgs
+		      ) {
+		    my @ini_addresses = split(/\n/, $1);
+		    foreach my $ini_address (@ini_addresses) {
+			my @var = split(/^\s+/, $ini_address);
+			print "\tinitiator-address $var[1]\n";
+			}
+		}
+		print "</target>\n\n";
+	}
+}
+
 # Execute or just print (or both) everything we start or would start
 sub execute {
 	if ($pretend == 0) {
@@ -319,6 +386,8 @@ if (($execute == 1) || ($pretend == 1)) {
 	&delete;
 	%conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -IncludeGlob => 1,);
 	&remove_targets;
+} elsif ($dump == 1) {
+	&dump_config;
 } else {
 	print "No action specified.\n";
 }




-- 
Tomasz Chmielewski 
http://wpkg.org



From fujita.tomonori at lab.ntt.co.jp  Mon Jul 28 10:34:45 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Mon, 28 Jul 2008 17:34:45 +0900
Subject: [Stgt-devel] [PATCH] add dumping current tgtd configuration in
 tgt-admin
In-Reply-To: <488D7E97.7020808@wpkg.org>
References: <4889EDC0.6070208@wpkg.org> <20080728100030P.tomof@acm.org>
	<488D7E97.7020808@wpkg.org>
Message-ID: <20080728173534D.fujita.tomonori@lab.ntt.co.jp>

On Mon, 28 Jul 2008 10:08:55 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> FUJITA Tomonori schrieb:
> > On Fri, 25 Jul 2008 17:14:08 +0200
> > Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> > 
> >> Add dumping current tgtd configuration to stdout in tgt-admin.
> >> The dumped config will not contain any passwords as tgtadm doesn't show 
> >> them, they are currently substituted with some BIG FAT words.
> >>
> >> It currently adds a "driver" config option to each target (i.e. driver 
> >> iscsi) in order to support more target types than just iscsi - I will 
> >> add support to it in the rest of tgt-admin next week.
> >>
> >>
> >> Signed-off-by: Tomasz Chmielewski (mangoo at wpkg.org)
> > 
> > Thanks!
> > 
> > But the patch is corrupted (tabs were replaced with spaces). Can you
> > resend a proper one (if you can't as a plain text, an attachment is
> > fine)?
> > 
> > I would appreciate if you could send a patch generated with git.
> 
> Here comes the git one:
> 
> 
> diff --git a/scripts/tgt-admin b/scripts/tgt-admin

Applied. Great, thanks a lot!

I think that it would be better to allow users to run this option
without a configuration file. (for now only the execute option
requires the configuration file, I guess).


I'd appreciate if you would run checkpatch.pl before submitting a
patch next time.


From dorons at voltaire.com  Mon Jul 28 11:26:49 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Mon, 28 Jul 2008 12:26:49 +0300
Subject: [Stgt-devel] [PATCH] tgt-admin: support persistent device
	binding
In-Reply-To: <488C93EE.8070409@wpkg.org>
References: <488C7C87.7090309@voltaire.com> <488C93EE.8070409@wpkg.org>
Message-ID: <488D90D9.6080603@voltaire.com>

sync this patch with the current git.
The man page already have an example for using
direct-device.
I'll send a patch with an example of using
serial number instead of /dev/sdX after this
patch will be applied.
Tomo - can u please explain me how to use
git-am for checking my patches?
I use checkpatch.pl script to check my patches.

Thanks,
Doron



Signed-off-by: Doron Shoham <dorons at voltaire.com>
---
 doc/manpages/tgt-admin.8 |    3 ++
 scripts/tgt-admin        |   64 ++++++++++++++++++++++++++++++++++-----------
 2 files changed, 51 insertions(+), 16 deletions(-)

diff --git a/doc/manpages/tgt-admin.8 b/doc/manpages/tgt-admin.8
index 97d6484..5598932 100644
--- a/doc/manpages/tgt-admin.8
+++ b/doc/manpages/tgt-admin.8
@@ -85,6 +85,9 @@ example for a configuration file:
 <target iqn.2007-02.com.example:san.xen1>
    backing-store /dev/san/xen1-disk1 # LUN1
    direct-store /dev/san/xen1-disk2 # LUN2
+   # for persistent binding use scsi serial number
+   backing-store 00c0ffd508d70048ed1dbc4704000000 #LUN3
+   direct-store 00c0ffd508d70048ed1dbc4704000001 # LUN4
 
    initiator-address 192.168.1.2     # Allowed IP
    initiator-address 192.168.5.6     # Allowed IP
diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 598bfb1..6c285c9 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -73,6 +73,22 @@ if ($show == 1) {
 	exit;
 }
 
+# Create a hash of all the scsi id and their mapped devices
+my %sn_hash=();
+sub map_devices {
+	my @sd_list=();
+	my $sg_list=`sg_map -i -x`;
+	while ($sg_list=~/(\/dev\/sd\w)/sgi) {
+		push(@sd_list,$1);
+	}
+	foreach my $sd (@sd_list) {
+		my $inq=`sg_inq $sd`;
+		if ($inq=~/Unit serial number:\s*(\w+)/) {
+			$sn_hash{$1}=$sd;
+		}
+	}
+}
+
 # Check if alternative configuration file was given
 if ($alternate_conf ne 0) {
 	# Check if alternative configuration file exist
@@ -136,14 +152,19 @@ sub add_targets {
 
 # Process options from the config file
 sub process_options {
+	&map_devices;
 	if ( $option eq "backing-store" ) {
-        # if we have one command, force it to be an array anyway
+	# if we have one command, force it to be an array anyway
 		unless (ref($value) eq 'ARRAY') {
 			$value = [ $value ];
 		}
 		my @value_arr = @$value;
 		my $i = 1;
 		foreach my $backing_store (@value_arr) {
+			# Check if a serial number was given
+			if ($backing_store!~/\/dev\//) {
+				$backing_store=$sn_hash{$backing_store};
+			}
 			# Check if device exists
 			if ( -e $backing_store) {
 				execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun $i -b $backing_store");
@@ -169,22 +190,33 @@ sub process_options {
 		my @value_arr = @$value;
 		my $i = 1;
 		foreach my $direct_store (@value_arr) {
-			$inq=`sg_inq $direct_store`;
-			if ($inq=~/Vendor identification:\s*(\w+)\s*\n*Product identification:\s*([\w\s\/\-]+)\n\s*\n*Product revision level:\s*(\w*)\s*\n*Unit serial number:\s*(\w+)/)
-			{
-				$vendor_id="$1";
-				$prod_id="$2";
-				$prod_rev="$3";
-				$scsi_serial="$4";
+			# Check if a serial number was given
+			if ($direct_store!~/\/dev\//) {
+				$direct_store=$sn_hash{$direct_store};
+			}
+			# Check if device exists
+			if ( -e $direct_store) {
+				$inq=`sg_inq $direct_store`;
+				if ($inq=~/Vendor identification:\s*(\w+)\s*\n*Product identification:\s*([\w\s\/\-]+)\n\s*\n*Product revision level:\s*(\w*)\s*\n*Unit serial number:\s*(\w+)/)
+				{
+					$vendor_id="$1";
+					$prod_id="$2";
+					$prod_rev="$3";
+					$scsi_serial="$4";
+				}
+				$vendor_id =~ s/\s+$//;
+				$prod_id =~ s/\s+$//;
+				$prod_rev =~ s/\s+$//;
+				$scsi_serial =~ s/\s+$//;
+
+				execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun 1 -b $direct_store");
+				execute("tgtadm --lld iscsi --op update --mode logicalunit --tid  $next_tid --lun 1 --params vendor_id=\"$vendor_id\",product_id=\"$prod_id\",product_rev=\"$prod_rev\",scsi_sn=\"$scsi_serial\"");
+				$i += 1;
+			}
+			else {
+				print("skipping device $direct_store\n");
+				print("$direct_store does not exist - please check the configuration file\n");
 			}
-			$vendor_id =~ s/\s+$//;
-			$prod_id =~ s/\s+$//;
-			$prod_rev =~ s/\s+$//;
-			$scsi_serial =~ s/\s+$//;
-
-			execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun 1 -b $direct_store");
-			execute("tgtadm --lld iscsi --op update --mode logicalunit --tid  $next_tid --lun 1 --params vendor_id=\"$vendor_id\",product_id=\"$prod_id\",product_rev=\"$prod_rev\",scsi_sn=\"$scsi_serial\"");
-			$i += 1;
 		}
 	}
 
-- 
1.5.3.8




From albert.pauw at gmail.com  Mon Jul 28 11:44:38 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Mon, 28 Jul 2008 11:44:38 +0200
Subject: [Stgt-devel] Bugreport - tgtadm --param scsi_id= and scripts
Message-ID: <488D9506.9020009@gmail.com>

Just noticed the following with my tgtadm script:

This is what I have in the script:

TID=1
LUN=4
ID="LTO2 ULTRIUM"
SN=0104
tgtadm --lld iscsi --mode logicalunit --op update --tid $TID --lun $LUN 
--params 
vendor_id=STGT,product_id=Tape,product_rev=1.01,scsi_id=$ID,scsi_sn=$SN,removable=1

Unfortunately, that gives with the tgtadm -m target -o show command the 
following result:

            Type: tape
            SCSI ID: deadbeaf1:4
            SCSI SN: beaf14
            Size: 0 MB
            Online: Yes
            Removable media: Yes
            Backing store: /root/01/tape.bin

The shell will expand the tgtadm line to

tgtadm --lld iscsi --mode logicalunit --op update --tid 1 --lun 4 
--params vendor_id=STGT,product_id=Tape,product_rev=1.01,scsi_id=LTO2 
ULTRIUM,scsi_sn=0104,removable=1

leaving a space between LTO and ULTRIUM, which gives tgtadm a hard time. 
If I change in the line scsi_id="LTO2 ULTRIUM" then it works fine.

Obviously, tgtadm sees the space (without quotes) as a parameter 
separater and doesn't even process the stuff after the space properly. I 
guess solving this is quite tricky, but I wanted
to mention it anyway.

Albert


From fujita.tomonori at lab.ntt.co.jp  Mon Jul 28 11:46:37 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Mon, 28 Jul 2008 18:46:37 +0900
Subject: [Stgt-devel] [PATCH] tgt-admin: support persistent
	device	binding
In-Reply-To: <488D90D9.6080603@voltaire.com>
References: <488C7C87.7090309@voltaire.com> <488C93EE.8070409@wpkg.org>
	<488D90D9.6080603@voltaire.com>
Message-ID: <20080728184729P.fujita.tomonori@lab.ntt.co.jp>

On Mon, 28 Jul 2008 12:26:49 +0300
Doron Shoham <dorons at voltaire.com> wrote:

> sync this patch with the current git.
> The man page already have an example for using
> direct-device.
> I'll send a patch with an example of using
> serial number instead of /dev/sdX after this
> patch will be applied.
> Tomo - can u please explain me how to use
> git-am for checking my patches?
> I use checkpatch.pl script to check my patches.

viola:~/git/tgt$ git-am --whitespace=error your-patch.diff

BTW, this patch is fine.


> Signed-off-by: Doron Shoham <dorons at voltaire.com>
> ---
>  doc/manpages/tgt-admin.8 |    3 ++
>  scripts/tgt-admin        |   64 ++++++++++++++++++++++++++++++++++-----------
>  2 files changed, 51 insertions(+), 16 deletions(-)
> 
> diff --git a/doc/manpages/tgt-admin.8 b/doc/manpages/tgt-admin.8
> index 97d6484..5598932 100644
> --- a/doc/manpages/tgt-admin.8
> +++ b/doc/manpages/tgt-admin.8
> @@ -85,6 +85,9 @@ example for a configuration file:
>  <target iqn.2007-02.com.example:san.xen1>
>     backing-store /dev/san/xen1-disk1 # LUN1
>     direct-store /dev/san/xen1-disk2 # LUN2
> +   # for persistent binding use scsi serial number
> +   backing-store 00c0ffd508d70048ed1dbc4704000000 #LUN3
> +   direct-store 00c0ffd508d70048ed1dbc4704000001 # LUN4

I'm not sure about direct-store thing at all. They are
confusing. direct-store is backing-store.

Firstly, why can't we just use the same properties of a physical
device if an administrator puts a device file of a disk drive?

Secondly, why do we need to look for a disk drive whose SCSI ID that
an administrator specifies.

An administrator can just put device files that udev cleverly creates
in the configuration file:

 /dev/disk/by-id/scsi-SATA_WDC_WD5000AAKS-_WD-WCAS848


From mangoo at wpkg.org  Mon Jul 28 12:14:33 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Mon, 28 Jul 2008 12:14:33 +0200
Subject: [Stgt-devel] [PATCH] make config file not needed for most
	operations it tgt-admin
Message-ID: <488D9C09.6090307@wpkg.org>

Make config file not needed for some current (and future) operations.

Parsing the config file is now a subroutine.

It also fixes "delete" operation when an alternative config file was given by using a new subroutine.



Signed-off-by: Tomasz Chmielewski <mangoo at wpkg.org>

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 598bfb1..7461a2f 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -37,8 +37,8 @@ EOF
 	exit;
 }
 
+my %conf;
 my $param = $ARGV[0];
-
 my $execute = 0;
 my $delete = 0;
 my $show = 0;
@@ -52,7 +52,7 @@ my $result = GetOptions (
 	"e|execute" => \$execute,
 	"d|delete"  => \$delete,
 	"s|show"    => \$show,
-	"c|conf=s"    => \$alternate_conf,
+	"c|conf=s"  => \$alternate_conf,
 	"f|force"   => \$force,
 	"p|pretend" => \$pretend,
 	"dump"      => \$dump,
@@ -64,33 +64,68 @@ if (($help == 1) || ($param eq undef)) {
 	&usage
 }
 
-# Parse the config file with Config::General
-my %conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -IncludeGlob => 1,);
-
 # Show all the targets and exit
 if ($show == 1) {
 	execute("tgtadm --lld iscsi --op show --mode target");
 	exit;
 }
 
-# Check if alternative configuration file was given
-if ($alternate_conf ne 0) {
-	# Check if alternative configuration file exist
-	if (-e $alternate_conf) {
-		execute("# Using $alternate_conf as configuration file\n");
-		%conf = ParseConfig(-ConfigFile => "$alternate_conf", -UseApacheInclude => 1, -IncludeGlob => 1,);
-	}
-	else {
-		die("file $alternate_conf not found. Exiting...\n");
-	}
-}
-
 # Some variables/arrays/hashes we will use globally
 my %tgtadm_output;
 my %tgtadm_output_tid;
 my @largest_tid;
 my $next_tid;
 
+# Look up which targets are configured
+sub process_targets {
+	# We need to run as root
+	if ( $> ) {
+		die("You must be root to run this program.\n");
+	}
+
+	my @show_target = `tgtadm --lld iscsi --op show --mode target`;
+	my $tid;
+	my $targetname;
+
+	# Here, we create hashes of target names (all target data) and target tids
+	foreach my $show_target_line (@show_target) {
+		if ( $show_target_line =~ m/^Target (\d*): (.+)/ ) {
+			$tid = $1;
+			$targetname = $2;
+			$tgtadm_output{$targetname} = $show_target_line;
+			$tgtadm_output_tid{$targetname} = $tid;
+		} else {
+			$tgtadm_output{$targetname} .= $show_target_line;
+		}
+	}
+	# What is the largest tid?
+	my @tids = values %tgtadm_output_tid;
+	@largest_tid = sort { $a <=> $b } @tids;
+	$next_tid = $largest_tid[$#largest_tid];
+}
+
+# Parse config file(s)
+sub parse_configs {
+	# Parse the config
+	if ($alternate_conf ne 0) {
+		# Check if alternative configuration file exist
+		if (-e "$alternate_conf") {
+			execute("# Using $alternate_conf as configuration file\n");
+			%conf = ParseConfig(-ConfigFile => "$alternate_conf", -UseApacheInclude => 1, -IncludeGlob => 1,);
+		}
+		else {
+			die("file $alternate_conf not found. Exiting...\n");
+		}
+	} else {
+		# Parse the config file with Config::General
+		if (-e "$configfile") {
+			%conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -IncludeGlob => 1,);
+		} else {
+			die("Config file $configfile not found. Exiting...\n");
+		}
+	}
+}
+
 # Add targets, if they are not configured already
 my $target;
 my $option;
@@ -226,41 +261,11 @@ sub process_options {
 	}
 }
 
-# Look up which targets are configured
-sub process_configs {
-	# We need to run as root
-	if ( $> ) {
-		die("You must be root to run this program.\n");
-	}
-
-	my @show_target = `tgtadm --lld iscsi --op show --mode target`;
-	my $tid;
-	my $targetname;
-
-	# Here, we create hashes of target names (all target data) and target tids
-	foreach my $show_target_line (@show_target) {
-		if ( $show_target_line =~ m/^Target (\d*): (.+)/ ) {
-			$tid = $1;
-			$targetname = $2;
-			$tgtadm_output{$targetname} = $show_target_line;
-			$tgtadm_output_tid{$targetname} = $tid;
-		} else {
-			$tgtadm_output{$targetname} .= $show_target_line;
-		}
-	}
-
-	# What is the largest tid?
-	my @tids = values %tgtadm_output_tid;
-	@largest_tid = sort { $a <=> $b } @tids;
-	$next_tid = $largest_tid[$#largest_tid];
-}
-
-
 # If the target is configured, but not present in the config file,
 # offline it and try to remove it
 sub remove_targets {
 
-	&process_configs;
+	&process_targets;
 	my @all_targets = keys %tgtadm_output_tid;
 
 	foreach my $existing_target (@all_targets) {
@@ -289,7 +294,7 @@ sub remove_targets {
 # Dump current tgtd configuration
 sub dump_config {
 
-	&process_configs;
+	&process_targets;
 
 	my @all_targets = keys %tgtadm_output_tid;
 
@@ -377,14 +382,13 @@ sub execute {
 }
 
 if (($execute == 1) || ($pretend == 1)) {
-	&process_configs;
-
+	&process_targets;
+	&parse_configs;
 	&add_targets;
-
 	&remove_targets;
 } elsif ($delete == 1) {
 	&delete;
-	%conf = ParseConfig(-ConfigFile => "$configfile", -UseApacheInclude => 1, -IncludeGlob => 1,);
+	&parse_configs;
 	&remove_targets;
 } elsif ($dump == 1) {
 	&dump_config;



-- 
Tomasz Chmielewski 
http://wpkg.org


From fujita.tomonori at lab.ntt.co.jp  Mon Jul 28 12:25:26 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Mon, 28 Jul 2008 19:25:26 +0900
Subject: [Stgt-devel] [PATCH] make config file not needed for
	most	operations it tgt-admin
In-Reply-To: <488D9C09.6090307@wpkg.org>
References: <488D9C09.6090307@wpkg.org>
Message-ID: <20080728192619N.fujita.tomonori@lab.ntt.co.jp>

On Mon, 28 Jul 2008 12:14:33 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> Make config file not needed for some current (and future) operations.
> 
> Parsing the config file is now a subroutine.
> 
> It also fixes "delete" operation when an alternative config file was given by using a new subroutine.
> 
> 
> 
> Signed-off-by: Tomasz Chmielewski <mangoo at wpkg.org>

Applied, thanks!


From thenzl at redhat.com  Mon Jul 28 12:54:39 2008
From: thenzl at redhat.com (Tomas Henzl)
Date: Mon, 28 Jul 2008 12:54:39 +0200
Subject: [Stgt-devel] [Patch] Segmentation fault in conn_close
In-Reply-To: <200807251343.m6PDh90G025849@mbox.iij4u.or.jp>
References: <4889CD76.6020900@redhat.com>
	<200807251343.m6PDh90G025849@mbox.iij4u.or.jp>
Message-ID: <488DA56F.8020106@redhat.com>

FUJITA Tomonori wrote:
> From: Tomas Henzl <thenzl at redhat.com>
> Subject: [Stgt-devel] [Patch] Segmentation fault in conn_close
> Date: Fri, 25 Jul 2008 14:56:22 +0200
>
>   
>> Hi,
>>
>> I noticed a segfault which is probably caused by the patch 
>> "iscsi: needs to call iscsi_free_cmd_task for commands in tx_clist"
>> b723430058dcbe3b201a2a2c38ce114217dc5273
>>
>> it looks like that for some reason iscsi_free_cmd_task(task); gets called  with
>> appropriate scmd zeroed out (not initialized ?) and then it causes a segfault
>> in list_del.
>>
>> I don't know how could it happen that this structure (scmd) is empty. The patch 
>> below solves my problem - it restores the old behaviour if the scmd is empty
>> as it was before the patch mentioned above.
>>     
>
> I think that this bug was fixed by:
>
>
> commit 73c6fab9f7f9e34aa14c359413b467be5e0ce0dc
> Author: FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp>
> Date:   Sat Jul 12 15:47:38 2008 +0900
>
>     iscsi: fix conn_close() segfaults
>
>     The problem is that conn_close() calls iscsi_free_cmd_task against
>     tasks in conn->tx_clist. But we could have non SCSI command tasks in
>     conn->tx_clist (such as NOOP). We can't call cmd_hlist_remove for such
>     tasks.
>
>     Signed-off-by: FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp>
>
>
> As the commit log says, non SCSI command tasks don't initialize scmd.
>   
Yes thanks, it looks correct now. My fault I should have downloaded the
latest
sources after vacation.



From dorfman.eli at gmail.com  Mon Jul 28 13:37:52 2008
From: dorfman.eli at gmail.com (Eli Dorfman)
Date: Mon, 28 Jul 2008 14:37:52 +0300
Subject: [Stgt-devel] [PATCH] tgt-admin: support persistent device
	binding
In-Reply-To: <20080728184729P.fujita.tomonori@lab.ntt.co.jp>
References: <488C7C87.7090309@voltaire.com> <488C93EE.8070409@wpkg.org>
	<488D90D9.6080603@voltaire.com>
	<20080728184729P.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <694d48600807280437n60f24292n7d25015da971103c@mail.gmail.com>

>> Signed-off-by: Doron Shoham <dorons at voltaire.com>
>> ---
>>  doc/manpages/tgt-admin.8 |    3 ++
>>  scripts/tgt-admin        |   64 ++++++++++++++++++++++++++++++++++-----------
>>  2 files changed, 51 insertions(+), 16 deletions(-)
>>
>> diff --git a/doc/manpages/tgt-admin.8 b/doc/manpages/tgt-admin.8
>> index 97d6484..5598932 100644
>> --- a/doc/manpages/tgt-admin.8
>> +++ b/doc/manpages/tgt-admin.8
>> @@ -85,6 +85,9 @@ example for a configuration file:
>>  <target iqn.2007-02.com.example:san.xen1>
>>     backing-store /dev/san/xen1-disk1 # LUN1
>>     direct-store /dev/san/xen1-disk2 # LUN2
>> +   # for persistent binding use scsi serial number
>> +   backing-store 00c0ffd508d70048ed1dbc4704000000 #LUN3
>> +   direct-store 00c0ffd508d70048ed1dbc4704000001 # LUN4
>
> I'm not sure about direct-store thing at all. They are
> confusing. direct-store is backing-store.

basically you are right, but we need a way to export real physical
serial number to the initiator so that we can use multipath.
The direct-store attribute is used to allow exporting real physical
device with its properties like: serial number, vendor, etc

we also need away to export a virtual device with explicit device
properties (serial number, vendor, etc) and not use the auto generated
deadbeaf ids.
maybe use the following format :
<target xyz>
    <backing-store /dev/sdb>
          properties  custom # use properties specified below or
default (generate the deadbeaf id) or direct (get real serial number)
          serial-number 12345678
          vendor myvendor
    </backing-store>
</target>

what do you think?


From fujita.tomonori at lab.ntt.co.jp  Mon Jul 28 13:50:00 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Mon, 28 Jul 2008 20:50:00 +0900
Subject: [Stgt-devel] [PATCH] tgt-admin: support persistent
	device	binding
In-Reply-To: <694d48600807280437n60f24292n7d25015da971103c@mail.gmail.com>
References: <488D90D9.6080603@voltaire.com>
	<20080728184729P.fujita.tomonori@lab.ntt.co.jp>
	<694d48600807280437n60f24292n7d25015da971103c@mail.gmail.com>
Message-ID: <20080728205053B.fujita.tomonori@lab.ntt.co.jp>

On Mon, 28 Jul 2008 14:37:52 +0300
"Eli Dorfman" <dorfman.eli at gmail.com> wrote:

> >> Signed-off-by: Doron Shoham <dorons at voltaire.com>
> >> ---
> >>  doc/manpages/tgt-admin.8 |    3 ++
> >>  scripts/tgt-admin        |   64 ++++++++++++++++++++++++++++++++++-----------
> >>  2 files changed, 51 insertions(+), 16 deletions(-)
> >>
> >> diff --git a/doc/manpages/tgt-admin.8 b/doc/manpages/tgt-admin.8
> >> index 97d6484..5598932 100644
> >> --- a/doc/manpages/tgt-admin.8
> >> +++ b/doc/manpages/tgt-admin.8
> >> @@ -85,6 +85,9 @@ example for a configuration file:
> >>  <target iqn.2007-02.com.example:san.xen1>
> >>     backing-store /dev/san/xen1-disk1 # LUN1
> >>     direct-store /dev/san/xen1-disk2 # LUN2
> >> +   # for persistent binding use scsi serial number
> >> +   backing-store 00c0ffd508d70048ed1dbc4704000000 #LUN3
> >> +   direct-store 00c0ffd508d70048ed1dbc4704000001 # LUN4
> >
> > I'm not sure about direct-store thing at all. They are
> > confusing. direct-store is backing-store.
> 
> basically you are right, but we need a way to export real physical
> serial number to the initiator so that we can use multipath.
> The direct-store attribute is used to allow exporting real physical
> device with its properties like: serial number, vendor, etc
> 
> we also need away to export a virtual device with explicit device
> properties (serial number, vendor, etc) and not use the auto generated
> deadbeaf ids.

I know that.


> maybe use the following format :
> <target xyz>
>     <backing-store /dev/sdb>
>           properties  custom # use properties specified below or
> default (generate the deadbeaf id) or direct (get real serial number)
>           serial-number 12345678
>           vendor myvendor
>     </backing-store>
> </target>
> 
> what do you think?

Hmm, 'properties custom' looks unnecessary for me. If a device file of
a disk drive is used as backing-store and none of the properties are
specified, we can use the physical properties.

And if an administrator wants to use a disk drive as backing-store, he
should use /dev/disk/by-id/* files instead of changeable /dev/sd* files.

Except for those, it looks sane for me.

Well, I don't like a XML format but I can live with it if people are
happy about that.


From mangoo at wpkg.org  Mon Jul 28 13:51:44 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Mon, 28 Jul 2008 13:51:44 +0200
Subject: [Stgt-devel] [PATCH 6/7] target reconfiguration
In-Reply-To: <4889EF49.1070700@wpkg.org>
References: <4885C11A.6080205@voltaire.com> <4885C2B2.5000809@voltaire.com>
	<4889EF49.1070700@wpkg.org>
Message-ID: <488DB2D0.3070407@wpkg.org>

Tomasz Chmielewski schrieb:
> Doron Shoham schrieb:
>> modifying a target that already exits in tgt, current instance will be delete
>> and a new one will be created with the new parameters instead.
> 
> Hmm, this is not optimal - it offlines, removes and configures each 
> target from scratch even if no changes were made.

Besides, it doesn't even seem to work properly: all targets get the same tid...


-- 
Tomasz Chmielewski 
http://wpkg.org





From mangoo at wpkg.org  Mon Jul 28 14:01:28 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Mon, 28 Jul 2008 14:01:28 +0200
Subject: [Stgt-devel] [PATCH 2/7] Add option to delete all the targets
In-Reply-To: <20080725195456M.fujita.tomonori@lab.ntt.co.jp>
References: <4885C11A.6080205@voltaire.com>	<4885C1CD.60700@voltaire.com>	<4889AF10.9090705@wpkg.org>
	<20080725195456M.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <488DB518.2030005@wpkg.org>

FUJITA Tomonori schrieb:

(...)

>> Why are we touching the config file here anyway?
>> IMO, "-d" flag should just remove all targets from a running tgtd; it 
>> shouldn't try to backup or modify the config file.
> 
> Agreed, I prefer to have an explicit option to touch (update) my
> ocnfiguration file; other options just change my running targets'
> configurations.

What is the preferred approach to delete the targets via tgt-admin?

1) delete only the targets which have no initiators connected - this is what we do right now; we offline them before we try to delete

2) delete ALL targets, even if initiators are connected (supported since "support to close a connection by force and to shut down tgtd")


Or, make it two separate options? I.e.:

- leave the first one (offline, try to delete) like it is now
- add a new option - --delete-force - would forcibly remove all or specified targets; examples:

--delete-force ALL - will remove all targets
--delete-force iqn.2008-06.com.example:blah.blah
--delete-force tid=5

?


-- 
Tomasz Chmielewski 
http://wpkg.org



From fujita.tomonori at lab.ntt.co.jp  Mon Jul 28 14:03:20 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Mon, 28 Jul 2008 21:03:20 +0900
Subject: [Stgt-devel] [PATCH] tgt-admin: support
	persistent	device	binding
In-Reply-To: <20080728205053B.fujita.tomonori@lab.ntt.co.jp>
References: <20080728184729P.fujita.tomonori@lab.ntt.co.jp>
	<694d48600807280437n60f24292n7d25015da971103c@mail.gmail.com>
	<20080728205053B.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <20080728210414I.fujita.tomonori@lab.ntt.co.jp>

On Mon, 28 Jul 2008 20:50:00 +0900
FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp> wrote:

> Well, I don't like a XML format but I can live with it if people are
> happy about that.

BTW, I think that we need to add something like <Version>, which
represents the version of the configuration file format though we are
not ready to define version 1.0 format.


From fujita.tomonori at lab.ntt.co.jp  Mon Jul 28 14:15:00 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Mon, 28 Jul 2008 21:15:00 +0900
Subject: [Stgt-devel] [PATCH 2/7] Add option to delete all the targets
In-Reply-To: <488DB518.2030005@wpkg.org>
References: <4889AF10.9090705@wpkg.org>
	<20080725195456M.fujita.tomonori@lab.ntt.co.jp>
	<488DB518.2030005@wpkg.org>
Message-ID: <20080728211555S.fujita.tomonori@lab.ntt.co.jp>

On Mon, 28 Jul 2008 14:01:28 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> FUJITA Tomonori schrieb:
> 
> (...)
> 
> >> Why are we touching the config file here anyway?
> >> IMO, "-d" flag should just remove all targets from a running tgtd; it 
> >> shouldn't try to backup or modify the config file.
> > 
> > Agreed, I prefer to have an explicit option to touch (update) my
> > ocnfiguration file; other options just change my running targets'
> > configurations.
> 
> What is the preferred approach to delete the targets via tgt-admin?
> 
> 1) delete only the targets which have no initiators connected - this is what we do right now; we offline them before we try to delete
> 
> 2) delete ALL targets, even if initiators are connected (supported since "support to close a connection by force and to shut down tgtd")
> 
> 
> Or, make it two separate options? I.e.:
> 
> - leave the first one (offline, try to delete) like it is now
> - add a new option - --delete-force - would forcibly remove all or specified targets; examples:
> 
> --delete-force ALL - will remove all targets
> --delete-force iqn.2008-06.com.example:blah.blah
> --delete-force tid=5

I have no preference here but I guess that people want two options.

I think that the majority of administrators will use a user-friendly
tool like tgt-admin (possible alternatives are web interface, or shell
interface as many appliances do). So I expect people want to do common
operations with it. The above two operations are often used, I guess.

Someone still needs A 'raw' tool like tgtadm but not many.

BTW, I think that we should rename either (or both). Those names,
tgt-admin and tgtadm are too similar and confuse people.


From dorfman.eli at gmail.com  Mon Jul 28 14:16:41 2008
From: dorfman.eli at gmail.com (Eli Dorfman)
Date: Mon, 28 Jul 2008 15:16:41 +0300
Subject: [Stgt-devel] [PATCH] tgt-admin: support persistent device
	binding
In-Reply-To: <20080728205053B.fujita.tomonori@lab.ntt.co.jp>
References: <488D90D9.6080603@voltaire.com>
	<20080728184729P.fujita.tomonori@lab.ntt.co.jp>
	<694d48600807280437n60f24292n7d25015da971103c@mail.gmail.com>
	<20080728205053B.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <694d48600807280516h772bd3edvbf52d80c27eec15b@mail.gmail.com>

>> maybe use the following format :
>> <target xyz>
>>     <backing-store /dev/sdb>
>>           properties  custom # use properties specified below or
>> default (generate the deadbeaf id) or direct (get real serial number)
>>           serial-number 12345678
>>           vendor myvendor
>>     </backing-store>
>> </target>
>>
>> what do you think?
>
> Hmm, 'properties custom' looks unnecessary for me. If a device file of
> a disk drive is used as backing-store and none of the properties are
> specified, we can use the physical properties.

we need something like properties to differentiate between disk (read
real props), file (generate unique serial number
disk-sn-partition-filename) and custom (applicable to any case).
we can call this attribute: "type" which can accept 3 values disk,
file or custom (default).


From mangoo at wpkg.org  Mon Jul 28 15:50:47 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Mon, 28 Jul 2008 15:50:47 +0200
Subject: [Stgt-devel] [PATCH] allow other target types than iscsi in
	tgt-admin
Message-ID: <488DCEB7.1080804@wpkg.org>

tgtadm allows other target types than iscsi (i.e., fcoe or ibmvstgt).

tgt-admin (or whatever it will be called in the future, so that it doesn't confuse with tgtadm) should support other target types ("driver"), too.

With this patch, we can configure a per-target driver, or, we can use a default value for all targets (used by all targets; unless overridden).
When there is no driver definition, tgt-admin defaults to "iscsi".


Example configuration:


# defaults for all targets
default-driver iscsi

<target iqn.2006-08.com.example:blah.fcoe>
# will use fcoe
driver fcoe
...
</target>

<target iqn.2007-11.com.example:blah.iscsi>
# will default to iscsi
...
</target>


Also, I added a simple "check" subroutine which checks some simple errors in the config file (missing values etc.).


Patch follows:

Signed-off-by: Tomasz Chmielewski <mangoo at wpkg.org>

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 7461a2f..e2c299a 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -66,7 +66,7 @@ if (($help == 1) || ($param eq undef)) {
 
 # Show all the targets and exit
 if ($show == 1) {
-	execute("tgtadm --lld iscsi --op show --mode target");
+	execute("tgtadm --op show --mode target");
 	exit;
 }
 
@@ -83,7 +83,7 @@ sub process_targets {
 		die("You must be root to run this program.\n");
 	}
 
-	my @show_target = `tgtadm --lld iscsi --op show --mode target`;
+	my @show_target = `tgtadm --op show --mode target`;
 	my $tid;
 	my $targetname;
 
@@ -127,17 +127,38 @@ sub parse_configs {
 }
 
 # Add targets, if they are not configured already
+my $default_driver;
 my $target;
 my $option;
 my $value;
 
 sub add_targets {
+
+	foreach my $k (sort keys %conf) {
+
+		if ( $k eq "default-driver" ) {
+			if ( not length ref($conf{$k}) ) {
+				$default_driver = $conf{$k};
+			} else {
+				print "Multiple default-driver definitions are not allowed!\n";
+				print "Check your config file for errors.\n";
+				exit 1;
+			}
+		}
+	}
+
+	# If $default_driver is empty, default to iscsi
+	if ( not defined $default_driver ) {
+		execute("# default-driver not defined, defaulting to iscsi.\n");
+		$default_driver = "iscsi";
+	}
+
 	foreach my $k (sort keys %conf) {
 		if ( $k eq "target" ) {
 			foreach my $k2 (sort keys %{$conf{$k}}) {
 				$target = $k2;
 				my $allowall = 1;
-				if ( $tgtadm_output{$k2} eq undef ) {
+				if ( not defined $tgtadm_output{$k2} ) {
 					# We have to find available tid
 					$next_tid = $next_tid + 1;
 				}
@@ -147,12 +168,33 @@ sub add_targets {
 					execute("tgtadm --op update --mode target --tid=$next_tid -n state -v offline");
 					execute("tgtadm --mode target --op delete --tid=$next_tid");
 				}
+
+				# Before we add a target, we need to know its type
+				my $driver;
+				foreach my $k3 (sort keys %{$conf{$k}{$k2}}) {
+					$option = $k3;
+					$value = $conf{$k}{$k2}{$k3};
+					&check($value);
+					if ( $option eq "driver" ) {
+						if (ref($value) eq "ARRAY") {
+						print "Multiple driver definitions not allowed!\n";
+						print "Check your config file for errors (target: $target).\n";
+						exit 1;
+						}
+					$driver = $value;
+					}
+				}
+				
+				if ( not defined $driver ) {
+					$driver = $default_driver;
+				}
 				execute("# Adding target: $target");
-				execute("tgtadm --lld iscsi --op new --mode target --tid $next_tid -T $target");
+				execute("tgtadm --lld $driver --op new --mode target --tid $next_tid -T $target");
 				foreach my $k3 (sort keys %{$conf{$k}{$k2}}) {
 					$option = $k3;
 					$value = $conf{$k}{$k2}{$k3};
-					&process_options;
+					&check($value);
+					&process_options($driver);
 					# If there was no option called "initiator-address", it means
 					# we want to allow ALL initiators for this target
 					if ( $option eq "initiator-address" ) {
@@ -161,7 +203,7 @@ sub add_targets {
 				}
 
 				if ( $allowall == 1 ) {
-					execute("tgtadm --lld iscsi --op bind --mode target --tid $next_tid -I ALL");
+					execute("tgtadm --lld $driver --op bind --mode target --tid $next_tid -I ALL");
 				}
 				execute();
 			}
@@ -171,6 +213,7 @@ sub add_targets {
 
 # Process options from the config file
 sub process_options {
+	my $driver = $_[0];
 	if ( $option eq "backing-store" ) {
         # if we have one command, force it to be an array anyway
 		unless (ref($value) eq 'ARRAY') {
@@ -178,10 +221,11 @@ sub process_options {
 		}
 		my @value_arr = @$value;
 		my $i = 1;
+
 		foreach my $backing_store (@value_arr) {
 			# Check if device exists
 			if ( -e $backing_store) {
-				execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun $i -b $backing_store");
+				execute("tgtadm --lld $driver --op new --mode logicalunit --tid $next_tid --lun $i -b $backing_store");
 				$i += 1;
 			}
 			else {
@@ -217,8 +261,8 @@ sub process_options {
 			$prod_rev =~ s/\s+$//;
 			$scsi_serial =~ s/\s+$//;
 
-			execute("tgtadm --lld iscsi --op new --mode logicalunit --tid $next_tid --lun 1 -b $direct_store");
-			execute("tgtadm --lld iscsi --op update --mode logicalunit --tid  $next_tid --lun 1 --params vendor_id=\"$vendor_id\",product_id=\"$prod_id\",product_rev=\"$prod_rev\",scsi_sn=\"$scsi_serial\"");
+			execute("tgtadm --lld $driver --op new --mode logicalunit --tid $next_tid --lun 1 -b $direct_store");
+			execute("tgtadm --lld $driver --op update --mode logicalunit --tid  $next_tid --lun 1 --params vendor_id=\"$vendor_id\",product_id=\"$prod_id\",product_rev=\"$prod_rev\",scsi_sn=\"$scsi_serial\"");
 			$i += 1;
 		}
 	}
@@ -231,9 +275,10 @@ sub process_options {
 		my @value_arr = @$value;
 		foreach my $incominguser (@value_arr) {
 			my @userpass = split(/ /, $incominguser);
-			execute("tgtadm --lld iscsi --mode account --op delete --user=$userpass[0]");
-			execute("tgtadm --lld iscsi --mode account --op new --user=$userpass[0] --password=$userpass[1]");
-			execute("tgtadm --lld iscsi --mode account --op bind --tid=$next_tid --user=$userpass[0]");
+			&check($userpass[1]);
+			execute("tgtadm --lld $driver --mode account --op delete --user=$userpass[0]");
+			execute("tgtadm --lld $driver --mode account --op new --user=$userpass[0] --password=$userpass[1]");
+			execute("tgtadm --lld $driver --mode account --op bind --tid=$next_tid --user=$userpass[0]");
 		}
 	}
 
@@ -244,9 +289,10 @@ sub process_options {
 		}
 		execute("# Warning: only one outgoinguser is allowed. Will only use the first one.");
 		my @userpass = split(/ /, @$value[0]);
-		execute("tgtadm --lld iscsi --mode account --op delete --user=$userpass[0]");
-		execute("tgtadm --lld iscsi --mode account --op new --user=$userpass[0] --password=$userpass[1]");
-		execute("tgtadm --lld iscsi --mode account --op bind --tid=$next_tid --user=$userpass[0] --outgoing");
+		&check($userpass[1]);
+		execute("tgtadm --lld $driver --mode account --op delete --user=$userpass[0]");
+		execute("tgtadm --lld $driver --mode account --op new --user=$userpass[0] --password=$userpass[1]");
+		execute("tgtadm --lld $driver --mode account --op bind --tid=$next_tid --user=$userpass[0] --outgoing");
 	}
 
 	if ( $option eq "initiator-address" ) {
@@ -256,7 +302,7 @@ sub process_options {
 		}
 		my @value_arr = @$value;
 		foreach my $initiator_address (@value_arr) {
-			execute("tgtadm --lld iscsi --op bind --mode target --tid $next_tid -I $initiator_address");
+			execute("tgtadm --lld $driver --op bind --mode target --tid $next_tid -I $initiator_address");
 		}
 	}
 }
@@ -272,20 +318,22 @@ sub remove_targets {
 		my $dontremove = 0;
 		my $k2;
 		foreach my $k (sort keys %conf) {
-			foreach $k2 (sort keys %{$conf{$k}}) {
-				if ( $k2 eq $existing_target ) {
-					$dontremove = 1;
+			if ( $k eq "target" ) {
+				foreach $k2 (sort keys %{$conf{$k}}) {
+					if ( $k2 eq $existing_target ) {
+						$dontremove = 1;
+					}
 				}
-			}
 
-			if ( $dontremove == 0 ) {
-				# Right now, it is not possible to remove a target if any initiators
-				# are connected to it. We'll do our best - offline the target first
-				# (so it won't accept any new connections), and remove.
-				# Note that remove will only work if no initiator is connected.
-				execute("# Removing target: $existing_target");
-				execute("tgtadm --op update --mode target --tid=$tgtadm_output_tid{$existing_target} -n state -v offline");
-				execute("tgtadm --mode target --op delete --tid=$tgtadm_output_tid{$existing_target}");
+				if ( $dontremove == 0 ) {
+					# Right now, it is not possible to remove a target if any initiators
+					# are connected to it. We'll do our best - offline the target first
+					# (so it won't accept any new connections), and remove.
+					# Note that remove will only work if no initiator is connected.
+					execute("# Removing target: $existing_target");
+					execute("tgtadm --op update --mode target --tid=$tgtadm_output_tid{$existing_target} -n state -v offline");
+					execute("tgtadm --mode target --op delete --tid=$tgtadm_output_tid{$existing_target}");
+				}
 			}
 		}
 	}
@@ -355,6 +403,16 @@ sub dump_config {
 	}
 }
 
+# Some checks
+sub check {
+	if ( not defined $_[0] or not length $_[0] ) {
+		print "\nOption $option has a missing value!\n";
+		print "Check your config file for errors (target: $target)\n";
+		exit 1;
+	}
+}
+
+
 # Execute or just print (or both) everything we start or would start
 sub execute {
 	if ($pretend == 0) {
@@ -404,7 +462,7 @@ sub delete {
 		die("You must be root to run this program.\n");
 	}
 
-	my @show_target = `tgtadm --lld iscsi --op show --mode target`;
+	my @show_target = `tgtadm --op show --mode target`;
 	my @tids=();
 
 	# Find all the active targets' tids



-- 
Tomasz Chmielewski 
http://wpkg.org


From albert.pauw at gmail.com  Mon Jul 28 18:22:48 2008
From: albert.pauw at gmail.com (Albert Pauw)
Date: Mon, 28 Jul 2008 18:22:48 +0200
Subject: [Stgt-devel] Barcode in extended attributes
Message-ID: <488DF258.2020906@gmail.com>

FYI my programming skills are very limited, as I haven't programmed for 
years.
But here is a little snippet of code that retrieves the barcode nicely 
through extended attributes,
which is the way to go I think.

The value of the attribute can be a zero terminated string of maximum 
4kbytes,
but also a binary blob of 4kbytes which should be big enough to carry 
the filemarks as well.

For the barcode this could maybe incorporated into the smc code? 
Apologies for not doing it
myself, as I don't have the skills to do so.

Albert

P.S. Barcode can be set by "setfattr -n user.Barcode -v LTO2001LA test.dat"

Anyway here is the code:

#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <attr/xattr.h>
#include <stdlib.h>

main()
{
char *filename,*name;
int fd;
char *barcode[10];
size_t size;


filename="test.dat";
fd=open(filename, O_RDONLY);

fgetxattr(fd, "user.Barcode", barcode, sizeof(barcode));

printf("The barcode of %s is %s\n", filename, barcode);

close(fd);

}



From realrichardsharpe at gmail.com  Mon Jul 28 18:35:45 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Mon, 28 Jul 2008 09:35:45 -0700
Subject: [Stgt-devel] Barcode in extended attributes
In-Reply-To: <488DF258.2020906@gmail.com>
References: <488DF258.2020906@gmail.com>
Message-ID: <46b8a8850807280935t4b20afa1kcb6d67f1010968dd@mail.gmail.com>

On Mon, Jul 28, 2008 at 9:22 AM, Albert Pauw <albert.pauw at gmail.com> wrote:
> FYI my programming skills are very limited, as I haven't programmed for
> years.
> But here is a little snippet of code that retrieves the barcode nicely
> through extended attributes,
> which is the way to go I think.
>
> The value of the attribute can be a zero terminated string of maximum
> 4kbytes,
> but also a binary blob of 4kbytes which should be big enough to carry
> the filemarks as well.
>
> For the barcode this could maybe incorporated into the smc code?
> Apologies for not doing it
> myself, as I don't have the skills to do so.

Albert, we have to worry about more than the barcode. We also have to
worry about the MAM.

In addition, the SMC code is used for DVD jukeboxes (or can be) as
well as tape libraries.

So, retrieving and storing the relevant data as extended attributes is
the simple part.


From realrichardsharpe at gmail.com  Mon Jul 28 19:10:50 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Mon, 28 Jul 2008 10:10:50 -0700
Subject: [Stgt-devel] segfault in the ssc code ...
In-Reply-To: <46b8a8850807271347u442d47fbh965495ac649831ea@mail.gmail.com>
References: <46b8a8850807251431w2391bf8fxafb8ea3c4aee06c7@mail.gmail.com>
	<46b8a8850807251712h4f08ead2l3e2f908a5fe48939@mail.gmail.com>
	<46b8a8850807251823r7c5bc300j9f78a9e9f78e059d@mail.gmail.com>
	<c9a3e4540807252301t2f689af1v44640711a920686e@mail.gmail.com>
	<46b8a8850807271347u442d47fbh965495ac649831ea@mail.gmail.com>
Message-ID: <46b8a8850807281010p2e66017fn73a4a66b5dfb3fd2@mail.gmail.com>

On Sun, Jul 27, 2008 at 1:47 PM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> On Fri, Jul 25, 2008 at 11:01 PM, ronnie sahlberg
> <ronniesahlberg at gmail.com> wrote:
>> MMC also uses the media changer.
>>
>> Please verify that the example of "DVD jukebox" that is described in
>> README.mmc still works
>> after your changes to the mediachanger.
>
> Hmmm, with the July 15 snapshot, and this set of commands:

OK, once I fixed the error in my config ... I am back to this error
with DVDs and smc with the Jul 15 snapshot:

Device seems to be: Generic mmc2 DVD-R/DVD-RW.
cdrecord: Found DVD+ media but DVD+R/DVD+RW support code is missing.
cdrecord: If you need DVD+R/DVD+RW support, ask the Author for cdrecord-ProDVD.
cdrecord: Free test versions and free keys for personal use are at
ftp://ftp.berlios.de/pub/cdrecord/ProDVD/
cdrecord: Sorry, no CD/DVD-Recorder or unsupported CD/DVD-Recorder
found on this target.
Using generic SCSI-3/mmc   CD-ROM driver (mmc_cd).
Driver flags   : MMC-3 SWABAUDIO BURNFREE
Supported modes: TAO PACKET SAO SAO/R96P SAO/R96R RAW/R16 RAW/R96P RAW/R96R
cdrecord: Track 1 has unknown length.
cdrecord: Use tsize= option in SAO mode to specify track size.

This is the same error I get with my changes, so it would seem that I
have not disturbed any functionality.

Now to figure out what the track-size stuff should be ...


From realrichardsharpe at gmail.com  Mon Jul 28 23:16:29 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Mon, 28 Jul 2008 14:16:29 -0700
Subject: [Stgt-devel] I have found a small problem in the MMC code ...
Message-ID: <46b8a8850807281416h1244ab86ofb5ffc064b9c6ec2@mail.gmail.com>

Hi,

I have found what I think is a small problem in the MMC code, although
I am not sure.

I am trying to use cdrecord to write to a DVD Jukebox I have set up
following Ronnie's example and my code changes.

When the client asks for the TOC, it seems to give us too small an
allocation length (four bytes) and of course, we give it back only
what is asked for ... it looks like maybe cdrecord is doing this,
because the Linux kernel seems to offer a buffer of 12 (at least that
is what the code says).

In any event, this causes the first write that CD record requests to
return a CHECK_CONDITION. cdrecord then recovers and the writing of my
8GB DVD :-) completes ...

I will have to check the specs carefully, but I wonder if we should be
returning CHECK_CONDITION as the response to the request for the
request to read the TOC/PMA/ATIP or is the client supposed to check
that there was more data than the buffer could hold and then reissue
the command?


From realrichardsharpe at gmail.com  Mon Jul 28 23:24:07 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Mon, 28 Jul 2008 14:24:07 -0700
Subject: [Stgt-devel] I have verified that my changes to smc.c work with the
	current SSC code and the MMC code ...
Message-ID: <46b8a8850807281424r3d39971frad72b14bbc4cde57@mail.gmail.com>

Hi,

I have now verified that my changes to smc.c work with both the SSC
code and the MMC code ... I will post the patches for people to
comment on.

I will also post an example script showing how to set up a VTL ...

However, one more thing that we will probably needs is the ability to
exec a script or something when a tape is removed from a DATA Transfer
Station ...


From realrichardsharpe at gmail.com  Mon Jul 28 23:57:57 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Mon, 28 Jul 2008 14:57:57 -0700
Subject: [Stgt-devel] [PATCH] Make changes so that VTL stuff works properly
	...
Message-ID: <46b8a8850807281457x13d12406j6cc8f4d3a32e0ae2@mail.gmail.com>


From realrichardsharpe at gmail.com  Mon Jul 28 23:34:12 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Mon, 28 Jul 2008 14:34:12 -0700
Subject: [PATCH] Make changes so that VTL stuff works properly ...
Message-ID: <mailman.45.1331738484.12506.stgt-devel@lists.berlios.de>

There are three changes here.

In target.h I expose device_lookup for use by the smc.c code.

In target.h I modify tgt_device_path_update so that we can call it to
both open and close a file that has been allocated to a
data_transfer_station.

In smc.c I modified set_slot_full and set_slot_empty to call the
modified tgt_device_path_update to achieve my goals. We call
device_lookup to figure out the device we are interested in.

I have tested this by loading and unloading tapes and DVDs, doing tar
to the drive and using cdrecord on the device, and verifying with lsof
that the tgtd has the files open when they are in the transfer station
and does not have them open when the station has been unloaded.

It all seems to work. I have attached the patch as well because gmail
seems to kill patches ... I hope the attached patch is OK.

---
 usr/smc.c    |   34 ++++++++++++++++++++++++----------
 usr/target.c |   15 ++++++++++-----
 usr/target.h |    2 ++
 3 files changed, 36 insertions(+), 15 deletions(-)

diff --git a/usr/smc.c b/usr/smc.c
index 9d7f681..0848101 100644
--- a/usr/smc.c
+++ b/usr/smc.c
@@ -47,12 +47,18 @@
 #include "smc.h"
 #include "media.h"

-static int set_slot_full(struct slot *s, uint16_t src, char *path)
+static int set_slot_full(struct target *target, struct slot *s, uint16_t src, c
har *path)
 {
        int err = 0;

-       if (path)
-               err = dtd_load_unload(s->drive_tid, s->drive_lun, LOAD, path);
+       if (path) {
+               struct scsi_lu *lu = device_lookup(target, s->drive_lun);
+
+               if (!lu)
+                       return 1;  /* we could not find the LU ... */
+
+               err = tgt_device_path_update(target, lu, path);
+       }
        if (err)
                return err;

@@ -62,13 +68,20 @@ static int set_slot_full(struct slot *s, uint16_t src, char
*path)
        return err;
 }

-static void set_slot_empty(struct slot *s)
+static void set_slot_empty(struct target *target, struct slot *s)
 {
        s->status &= 0xfe;
        s->last_addr = 0;
        memset(s->barcode, ' ', sizeof(s->barcode));
-       if (s->element_type == ELEMENT_DATA_TRANSFER)
-               dtd_load_unload(s->drive_tid, s->drive_lun, UNLOAD, NULL);
+
+       if (s->element_type == ELEMENT_DATA_TRANSFER) {
+               struct scsi_lu *lu = device_lookup(target, s->drive_lun);
+
+               if (!lu)
+                       return 1;  /* we could not find the LU ... */
+
+               (void)tgt_device_path_update(target, lu, NULL);
+       }
 }

 static int test_slot_full(struct slot *s)
@@ -355,6 +368,7 @@ sense:
 static int smc_move_medium(int host_no, struct scsi_cmd *cmd)
 {
        struct smc_info *smc = dtype_priv(cmd->dev);
+       struct target *tgt = cmd->c_target;
        uint8_t *scb;
        uint16_t src;
        uint16_t dest;
@@ -410,15 +424,15 @@ static int smc_move_medium(int host_no, struct scsi_cmd *c
md)
                        goto sense;
                }

-               if (set_slot_full(dest_slot, src, path)) {
+               if (set_slot_full(tgt, dest_slot, src, path)) {
                        key = HARDWARE_ERROR;
                        asc = ASC_MECHANICAL_POSITIONING_ERROR;
                        goto sense;
                }
        } else
-               set_slot_full(dest_slot, src, NULL);
+               set_slot_full(tgt, dest_slot, src, NULL);

-       set_slot_empty(src_slot);
+       set_slot_empty(tgt, src_slot);

        scsi_set_in_resid_by_actual(cmd, 0);
        return SAM_STAT_GOOD;
@@ -626,7 +640,7 @@ static int config_slot(struct scsi_lu *lu, struct tmp_param
*tmp)
                if (!s)
                        break;  // Slot not found..
                strncpy(s->barcode, tmp->barcode, sizeof(s->barcode));
-               set_slot_full(s, 0, NULL);
+               set_slot_full(lu->tgt, s, 0, NULL);
                ret = TGTADM_SUCCESS;
                break;
        case ELEMENT_DATA_TRANSFER:
diff --git a/usr/target.c b/usr/target.c
index 7abaa54..863ec9b 100644
--- a/usr/target.c
+++ b/usr/target.c
@@ -297,7 +297,7 @@ int it_nexus_destroy(int tid, uint64_t itn_id)
        return 0;
 }

-static struct scsi_lu *device_lookup(struct target *target, uint64_t lun)
+struct scsi_lu *device_lookup(struct target *target, uint64_t lun)
 {
        struct scsi_lu *lu;

@@ -347,7 +347,7 @@ int tgt_device_path_update(struct target *target, struct scs
i_lu *lu, char *path
        uint64_t size;

        if (lu->path) {
-               if (lu->attrs.online)
+               if (path && lu->attrs.online)
                        return TGTADM_INVALID_REQUEST;

                lu->dev_type_template.lu_offline(lu);
@@ -359,6 +359,10 @@ int tgt_device_path_update(struct target *target, struct sc
si_lu *lu, char *path
                lu->path = NULL;
        }

+       /* Were we called to close the file? */
+       if (!path)
+               return 0;
+
        path = strdup(path);
        if (!path)
                return TGTADM_NOMEM;
@@ -418,7 +422,7 @@ int tgt_device_create(int tid, int dev_type, uint64_t lun, c
har *params,
        struct it_nexus_lu_info *itn_lu;
        struct it_nexus *itn;

-       dprintf("%d %" PRIu64 "\n", tid, lun);
+       eprintf("%d %" PRIu64 " params: %s\n", tid, lun, params);

        while ((p = strsep(&params, ",")) != NULL) {
                substring_t args[MAX_OPT_ARGS];
@@ -452,8 +456,9 @@ int tgt_device_create(int tid, int dev_type, uint64_t lun, c
har *params,
        }

        bst = target->bst;
-       if (backing) {
+       /*if (backing) {*/
                if (bstype) {
+                       eprintf("backing store trying: %s\n", bstype);
                        bst = get_backingstore_template(bstype);
                        if (!bst) {
                                eprintf("failed to find bstype, %s\n", bstype);
@@ -461,7 +466,7 @@ int tgt_device_create(int tid, int dev_type, uint64_t lun, c
har *params,
                                goto out;
                        }
                }
-       }
+       /*}*/

        t = device_type_lookup(dev_type);
        if (!t) {
diff --git a/usr/target.h b/usr/target.h
index 8fe30aa..4d4768a 100644
--- a/usr/target.h
+++ b/usr/target.h
@@ -87,4 +87,6 @@ static inline int queue_active(const struct tgt_cmd_queue *q)
        \
 QUEUE_FNS(BLOCKED, blocked)
 QUEUE_FNS(DELETED, deleted)

+struct scsi_lu *device_lookup(struct target *target, uint64_t lun);
+
 #endif
--
1.5.5.1

------=_Part_14668_12538439.1217282277331
Content-Type: application/octet-stream;
 name=0003-Make-changes-so-that-VTL-stuff-works-properly.patch
Content-Transfer-Encoding: base64
X-Attachment-Id: f_fj7mf6pb0
Content-Disposition: attachment;
 filename=0003-Make-changes-so-that-VTL-stuff-works-properly.patch

RnJvbSBhMTZkMzY4YTI5Mjk4MTcwZGYyYzIxZmQxOWQ4NDkwYzI0OGYwNmIxIE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBSaWNoYXJkIFNoYXJwZSA8cmVhbHJpY2hhcmRzaGFycGVAZ21h
aWwuY29tPgpEYXRlOiBNb24sIDI4IEp1bCAyMDA4IDE0OjM0OjEyIC0wNzAwClN1YmplY3Q6IFtQ
QVRDSF0gTWFrZSBjaGFuZ2VzIHNvIHRoYXQgVlRMIHN0dWZmIHdvcmtzIHByb3Blcmx5IC4uLgoK
LS0tCiB1c3Ivc21jLmMgICAgfCAgIDM0ICsrKysrKysrKysrKysrKysrKysrKysrKy0tLS0tLS0t
LS0KIHVzci90YXJnZXQuYyB8ICAgMTUgKysrKysrKysrKy0tLS0tCiB1c3IvdGFyZ2V0LmggfCAg
ICAyICsrCiAzIGZpbGVzIGNoYW5nZWQsIDM2IGluc2VydGlvbnMoKyksIDE1IGRlbGV0aW9ucygt
KQoKZGlmZiAtLWdpdCBhL3Vzci9zbWMuYyBiL3Vzci9zbWMuYwppbmRleCA5ZDdmNjgxLi4wODQ4
MTAxIDEwMDY0NAotLS0gYS91c3Ivc21jLmMKKysrIGIvdXNyL3NtYy5jCkBAIC00NywxMiArNDcs
MTggQEAKICNpbmNsdWRlICJzbWMuaCIKICNpbmNsdWRlICJtZWRpYS5oIgogCi1zdGF0aWMgaW50
IHNldF9zbG90X2Z1bGwoc3RydWN0IHNsb3QgKnMsIHVpbnQxNl90IHNyYywgY2hhciAqcGF0aCkK
K3N0YXRpYyBpbnQgc2V0X3Nsb3RfZnVsbChzdHJ1Y3QgdGFyZ2V0ICp0YXJnZXQsIHN0cnVjdCBz
bG90ICpzLCB1aW50MTZfdCBzcmMsIGNoYXIgKnBhdGgpCiB7CiAJaW50IGVyciA9IDA7CiAKLQlp
ZiAocGF0aCkKLQkJZXJyID0gZHRkX2xvYWRfdW5sb2FkKHMtPmRyaXZlX3RpZCwgcy0+ZHJpdmVf
bHVuLCBMT0FELCBwYXRoKTsKKwlpZiAocGF0aCkgeworCQlzdHJ1Y3Qgc2NzaV9sdSAqbHUgPSBk
ZXZpY2VfbG9va3VwKHRhcmdldCwgcy0+ZHJpdmVfbHVuKTsKKworCQlpZiAoIWx1KQorCQkJcmV0
dXJuIDE7ICAvKiB3ZSBjb3VsZCBub3QgZmluZCB0aGUgTFUgLi4uICovCisKKwkJZXJyID0gdGd0
X2RldmljZV9wYXRoX3VwZGF0ZSh0YXJnZXQsIGx1LCBwYXRoKTsKKwl9CiAJaWYgKGVycikKIAkJ
cmV0dXJuIGVycjsKIApAQCAtNjIsMTMgKzY4LDIwIEBAIHN0YXRpYyBpbnQgc2V0X3Nsb3RfZnVs
bChzdHJ1Y3Qgc2xvdCAqcywgdWludDE2X3Qgc3JjLCBjaGFyICpwYXRoKQogCXJldHVybiBlcnI7
CiB9CiAKLXN0YXRpYyB2b2lkIHNldF9zbG90X2VtcHR5KHN0cnVjdCBzbG90ICpzKQorc3RhdGlj
IHZvaWQgc2V0X3Nsb3RfZW1wdHkoc3RydWN0IHRhcmdldCAqdGFyZ2V0LCBzdHJ1Y3Qgc2xvdCAq
cykKIHsKIAlzLT5zdGF0dXMgJj0gMHhmZTsKIAlzLT5sYXN0X2FkZHIgPSAwOwogCW1lbXNldChz
LT5iYXJjb2RlLCAnICcsIHNpemVvZihzLT5iYXJjb2RlKSk7Ci0JaWYgKHMtPmVsZW1lbnRfdHlw
ZSA9PSBFTEVNRU5UX0RBVEFfVFJBTlNGRVIpCi0JCWR0ZF9sb2FkX3VubG9hZChzLT5kcml2ZV90
aWQsIHMtPmRyaXZlX2x1biwgVU5MT0FELCBOVUxMKTsKKworCWlmIChzLT5lbGVtZW50X3R5cGUg
PT0gRUxFTUVOVF9EQVRBX1RSQU5TRkVSKSB7CisJCXN0cnVjdCBzY3NpX2x1ICpsdSA9IGRldmlj
ZV9sb29rdXAodGFyZ2V0LCBzLT5kcml2ZV9sdW4pOworCQorCQlpZiAoIWx1KQorCQkJcmV0dXJu
IDE7ICAvKiB3ZSBjb3VsZCBub3QgZmluZCB0aGUgTFUgLi4uICovCisKKwkJKHZvaWQpdGd0X2Rl
dmljZV9wYXRoX3VwZGF0ZSh0YXJnZXQsIGx1LCBOVUxMKTsKKwl9CiB9CiAKIHN0YXRpYyBpbnQg
dGVzdF9zbG90X2Z1bGwoc3RydWN0IHNsb3QgKnMpCkBAIC0zNTUsNiArMzY4LDcgQEAgc2Vuc2U6
CiBzdGF0aWMgaW50IHNtY19tb3ZlX21lZGl1bShpbnQgaG9zdF9ubywgc3RydWN0IHNjc2lfY21k
ICpjbWQpCiB7CiAJc3RydWN0IHNtY19pbmZvICpzbWMgPSBkdHlwZV9wcml2KGNtZC0+ZGV2KTsK
KwlzdHJ1Y3QgdGFyZ2V0ICp0Z3QgPSBjbWQtPmNfdGFyZ2V0OwogCXVpbnQ4X3QgKnNjYjsKIAl1
aW50MTZfdCBzcmM7CiAJdWludDE2X3QgZGVzdDsKQEAgLTQxMCwxNSArNDI0LDE1IEBAIHN0YXRp
YyBpbnQgc21jX21vdmVfbWVkaXVtKGludCBob3N0X25vLCBzdHJ1Y3Qgc2NzaV9jbWQgKmNtZCkK
IAkJCWdvdG8gc2Vuc2U7CiAJCX0KIAotCQlpZiAoc2V0X3Nsb3RfZnVsbChkZXN0X3Nsb3QsIHNy
YywgcGF0aCkpIHsKKwkJaWYgKHNldF9zbG90X2Z1bGwodGd0LCBkZXN0X3Nsb3QsIHNyYywgcGF0
aCkpIHsKIAkJCWtleSA9IEhBUkRXQVJFX0VSUk9SOwogCQkJYXNjID0gQVNDX01FQ0hBTklDQUxf
UE9TSVRJT05JTkdfRVJST1I7CiAJCQlnb3RvIHNlbnNlOwogCQl9CiAJfSBlbHNlCi0JCXNldF9z
bG90X2Z1bGwoZGVzdF9zbG90LCBzcmMsIE5VTEwpOworCQlzZXRfc2xvdF9mdWxsKHRndCwgZGVz
dF9zbG90LCBzcmMsIE5VTEwpOwogCi0Jc2V0X3Nsb3RfZW1wdHkoc3JjX3Nsb3QpOworCXNldF9z
bG90X2VtcHR5KHRndCwgc3JjX3Nsb3QpOwogCiAJc2NzaV9zZXRfaW5fcmVzaWRfYnlfYWN0dWFs
KGNtZCwgMCk7CiAJcmV0dXJuIFNBTV9TVEFUX0dPT0Q7CkBAIC02MjYsNyArNjQwLDcgQEAgc3Rh
dGljIGludCBjb25maWdfc2xvdChzdHJ1Y3Qgc2NzaV9sdSAqbHUsIHN0cnVjdCB0bXBfcGFyYW0g
KnRtcCkKIAkJaWYgKCFzKQogCQkJYnJlYWs7CS8vIFNsb3Qgbm90IGZvdW5kLi4KIAkJc3RybmNw
eShzLT5iYXJjb2RlLCB0bXAtPmJhcmNvZGUsIHNpemVvZihzLT5iYXJjb2RlKSk7Ci0JCXNldF9z
bG90X2Z1bGwocywgMCwgTlVMTCk7CisJCXNldF9zbG90X2Z1bGwobHUtPnRndCwgcywgMCwgTlVM
TCk7CiAJCXJldCA9IFRHVEFETV9TVUNDRVNTOwogCQlicmVhazsKIAljYXNlIEVMRU1FTlRfREFU
QV9UUkFOU0ZFUjoKZGlmZiAtLWdpdCBhL3Vzci90YXJnZXQuYyBiL3Vzci90YXJnZXQuYwppbmRl
eCA3YWJhYTU0Li44NjNlYzliIDEwMDY0NAotLS0gYS91c3IvdGFyZ2V0LmMKKysrIGIvdXNyL3Rh
cmdldC5jCkBAIC0yOTcsNyArMjk3LDcgQEAgaW50IGl0X25leHVzX2Rlc3Ryb3koaW50IHRpZCwg
dWludDY0X3QgaXRuX2lkKQogCXJldHVybiAwOwogfQogCi1zdGF0aWMgc3RydWN0IHNjc2lfbHUg
KmRldmljZV9sb29rdXAoc3RydWN0IHRhcmdldCAqdGFyZ2V0LCB1aW50NjRfdCBsdW4pCitzdHJ1
Y3Qgc2NzaV9sdSAqZGV2aWNlX2xvb2t1cChzdHJ1Y3QgdGFyZ2V0ICp0YXJnZXQsIHVpbnQ2NF90
IGx1bikKIHsKIAlzdHJ1Y3Qgc2NzaV9sdSAqbHU7CiAKQEAgLTM0Nyw3ICszNDcsNyBAQCBpbnQg
dGd0X2RldmljZV9wYXRoX3VwZGF0ZShzdHJ1Y3QgdGFyZ2V0ICp0YXJnZXQsIHN0cnVjdCBzY3Np
X2x1ICpsdSwgY2hhciAqcGF0aAogCXVpbnQ2NF90IHNpemU7CiAKIAlpZiAobHUtPnBhdGgpIHsK
LQkJaWYgKGx1LT5hdHRycy5vbmxpbmUpCisJCWlmIChwYXRoICYmIGx1LT5hdHRycy5vbmxpbmUp
CiAJCQlyZXR1cm4gVEdUQURNX0lOVkFMSURfUkVRVUVTVDsKIAogCQlsdS0+ZGV2X3R5cGVfdGVt
cGxhdGUubHVfb2ZmbGluZShsdSk7CkBAIC0zNTksNiArMzU5LDEwIEBAIGludCB0Z3RfZGV2aWNl
X3BhdGhfdXBkYXRlKHN0cnVjdCB0YXJnZXQgKnRhcmdldCwgc3RydWN0IHNjc2lfbHUgKmx1LCBj
aGFyICpwYXRoCiAJCWx1LT5wYXRoID0gTlVMTDsKIAl9CiAKKwkvKiBXZXJlIHdlIGNhbGxlZCB0
byBjbG9zZSB0aGUgZmlsZT8gKi8KKwlpZiAoIXBhdGgpCisJCXJldHVybiAwOworCiAJcGF0aCA9
IHN0cmR1cChwYXRoKTsKIAlpZiAoIXBhdGgpCiAJCXJldHVybiBUR1RBRE1fTk9NRU07CkBAIC00
MTgsNyArNDIyLDcgQEAgaW50IHRndF9kZXZpY2VfY3JlYXRlKGludCB0aWQsIGludCBkZXZfdHlw
ZSwgdWludDY0X3QgbHVuLCBjaGFyICpwYXJhbXMsCiAJc3RydWN0IGl0X25leHVzX2x1X2luZm8g
Kml0bl9sdTsKIAlzdHJ1Y3QgaXRfbmV4dXMgKml0bjsKIAotCWRwcmludGYoIiVkICUiIFBSSXU2
NCAiXG4iLCB0aWQsIGx1bik7CisJZXByaW50ZigiJWQgJSIgUFJJdTY0ICIgcGFyYW1zOiAlc1xu
IiwgdGlkLCBsdW4sIHBhcmFtcyk7CiAKIAl3aGlsZSAoKHAgPSBzdHJzZXAoJnBhcmFtcywgIiwi
KSkgIT0gTlVMTCkgewogCQlzdWJzdHJpbmdfdCBhcmdzW01BWF9PUFRfQVJHU107CkBAIC00NTIs
OCArNDU2LDkgQEAgaW50IHRndF9kZXZpY2VfY3JlYXRlKGludCB0aWQsIGludCBkZXZfdHlwZSwg
dWludDY0X3QgbHVuLCBjaGFyICpwYXJhbXMsCiAJfQogCiAJYnN0ID0gdGFyZ2V0LT5ic3Q7Ci0J
aWYgKGJhY2tpbmcpIHsKKwkvKmlmIChiYWNraW5nKSB7Ki8KIAkJaWYgKGJzdHlwZSkgeworCQkJ
ZXByaW50ZigiYmFja2luZyBzdG9yZSB0cnlpbmc6ICVzXG4iLCBic3R5cGUpOwogCQkJYnN0ID0g
Z2V0X2JhY2tpbmdzdG9yZV90ZW1wbGF0ZShic3R5cGUpOwogCQkJaWYgKCFic3QpIHsKIAkJCQll
cHJpbnRmKCJmYWlsZWQgdG8gZmluZCBic3R5cGUsICVzXG4iLCBic3R5cGUpOwpAQCAtNDYxLDcg
KzQ2Niw3IEBAIGludCB0Z3RfZGV2aWNlX2NyZWF0ZShpbnQgdGlkLCBpbnQgZGV2X3R5cGUsIHVp
bnQ2NF90IGx1biwgY2hhciAqcGFyYW1zLAogCQkJCWdvdG8gb3V0OwogCQkJfQogCQl9Ci0JfQor
CS8qfSovCiAKIAl0ID0gZGV2aWNlX3R5cGVfbG9va3VwKGRldl90eXBlKTsKIAlpZiAoIXQpIHsK
ZGlmZiAtLWdpdCBhL3Vzci90YXJnZXQuaCBiL3Vzci90YXJnZXQuaAppbmRleCA4ZmUzMGFhLi40
ZDQ3NjhhIDEwMDY0NAotLS0gYS91c3IvdGFyZ2V0LmgKKysrIGIvdXNyL3RhcmdldC5oCkBAIC04
Nyw0ICs4Nyw2IEBAIHN0YXRpYyBpbmxpbmUgaW50IHF1ZXVlX2FjdGl2ZShjb25zdCBzdHJ1Y3Qg
dGd0X2NtZF9xdWV1ZSAqcSkJCVwKIFFVRVVFX0ZOUyhCTE9DS0VELCBibG9ja2VkKQogUVVFVUVf
Rk5TKERFTEVURUQsIGRlbGV0ZWQpCiAKK3N0cnVjdCBzY3NpX2x1ICpkZXZpY2VfbG9va3VwKHN0
cnVjdCB0YXJnZXQgKnRhcmdldCwgdWludDY0X3QgbHVuKTsKKwogI2VuZGlmCi0tIAoxLjUuNS4x
Cgo=
------=_Part_14668_12538439.1217282277331--


From ronniesahlberg at gmail.com  Tue Jul 29 00:37:35 2008
From: ronniesahlberg at gmail.com (ronnie sahlberg)
Date: Tue, 29 Jul 2008 08:37:35 +1000
Subject: [Stgt-devel] segfault in the ssc code ...
In-Reply-To: <46b8a8850807281010p2e66017fn73a4a66b5dfb3fd2@mail.gmail.com>
References: <46b8a8850807251431w2391bf8fxafb8ea3c4aee06c7@mail.gmail.com>
	<46b8a8850807251712h4f08ead2l3e2f908a5fe48939@mail.gmail.com>
	<46b8a8850807251823r7c5bc300j9f78a9e9f78e059d@mail.gmail.com>
	<c9a3e4540807252301t2f689af1v44640711a920686e@mail.gmail.com>
	<46b8a8850807271347u442d47fbh965495ac649831ea@mail.gmail.com>
	<46b8a8850807281010p2e66017fn73a4a66b5dfb3fd2@mail.gmail.com>
Message-ID: <c9a3e4540807281537w7b3fb424y270f33b5bdc2d83b@mail.gmail.com>

I think that looks fine.
I dont think cdwriter can write to DVD+R though, you would need
DVDwriter to do that.



On Tue, Jul 29, 2008 at 3:10 AM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> On Sun, Jul 27, 2008 at 1:47 PM, Richard Sharpe
> <realrichardsharpe at gmail.com> wrote:
>> On Fri, Jul 25, 2008 at 11:01 PM, ronnie sahlberg
>> <ronniesahlberg at gmail.com> wrote:
>>> MMC also uses the media changer.
>>>
>>> Please verify that the example of "DVD jukebox" that is described in
>>> README.mmc still works
>>> after your changes to the mediachanger.
>>
>> Hmmm, with the July 15 snapshot, and this set of commands:
>
> OK, once I fixed the error in my config ... I am back to this error
> with DVDs and smc with the Jul 15 snapshot:
>
> Device seems to be: Generic mmc2 DVD-R/DVD-RW.
> cdrecord: Found DVD+ media but DVD+R/DVD+RW support code is missing.
> cdrecord: If you need DVD+R/DVD+RW support, ask the Author for cdrecord-ProDVD.
> cdrecord: Free test versions and free keys for personal use are at
> ftp://ftp.berlios.de/pub/cdrecord/ProDVD/
> cdrecord: Sorry, no CD/DVD-Recorder or unsupported CD/DVD-Recorder
> found on this target.
> Using generic SCSI-3/mmc   CD-ROM driver (mmc_cd).
> Driver flags   : MMC-3 SWABAUDIO BURNFREE
> Supported modes: TAO PACKET SAO SAO/R96P SAO/R96R RAW/R16 RAW/R96P RAW/R96R
> cdrecord: Track 1 has unknown length.
> cdrecord: Use tsize= option in SAO mode to specify track size.
>
> This is the same error I get with my changes, so it would seem that I
> have not disturbed any functionality.
>
> Now to figure out what the track-size stuff should be ...
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From ronniesahlberg at gmail.com  Tue Jul 29 00:42:18 2008
From: ronniesahlberg at gmail.com (ronnie sahlberg)
Date: Tue, 29 Jul 2008 08:42:18 +1000
Subject: [Stgt-devel] I have found a small problem in the MMC code ...
In-Reply-To: <46b8a8850807281416h1244ab86ofb5ffc064b9c6ec2@mail.gmail.com>
References: <46b8a8850807281416h1244ab86ofb5ffc064b9c6ec2@mail.gmail.com>
Message-ID: <c9a3e4540807281542o70b8d71bp552d5ea3b7be0c05@mail.gmail.com>

Can you send me a network trace of this?

Since Read TOC returns the blob size as the first two bytes of data it
should not return
CHECK CONDITION even if there is more data than the initiator asked for.

I think this command might return CHECK CONDITION if there is no disk
in the drive, or if there is a
blank disk.

Please send me a sample capture to test with and Ill compare to a few
read dvd drives.



On Tue, Jul 29, 2008 at 7:16 AM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> Hi,
>
> I have found what I think is a small problem in the MMC code, although
> I am not sure.
>
> I am trying to use cdrecord to write to a DVD Jukebox I have set up
> following Ronnie's example and my code changes.
>
> When the client asks for the TOC, it seems to give us too small an
> allocation length (four bytes) and of course, we give it back only
> what is asked for ... it looks like maybe cdrecord is doing this,
> because the Linux kernel seems to offer a buffer of 12 (at least that
> is what the code says).
>
> In any event, this causes the first write that CD record requests to
> return a CHECK_CONDITION. cdrecord then recovers and the writing of my
> 8GB DVD :-) completes ...
>
> I will have to check the specs carefully, but I wonder if we should be
> returning CHECK_CONDITION as the response to the request for the
> request to read the TOC/PMA/ATIP or is the client supposed to check
> that there was more data than the buffer could hold and then reissue
> the command?
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From markh794 at gmail.com  Tue Jul 29 04:49:27 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Tue, 29 Jul 2008 12:49:27 +1000
Subject: [Stgt-devel] [PATCH] Make changes so that VTL stuff works
 properly ...
In-Reply-To: <46b8a8850807281457x13d12406j6cc8f4d3a32e0ae2@mail.gmail.com>
References: <46b8a8850807281457x13d12406j6cc8f4d3a32e0ae2@mail.gmail.com>
Message-ID: <488E8537.8060009@gmail.com>

Richard Sharpe wrote:
>>From a16d368a29298170df2c21fd19d8490c248f06b1 Mon Sep 17 00:00:00 2001
> From: Richard Sharpe <realrichardsharpe at gmail.com>
> Date: Mon, 28 Jul 2008 14:34:12 -0700
> Subject: [PATCH] Make changes so that VTL stuff works properly ...
> Signed-off-by: Richard Sharpe <realrichardsharpe at gmail.com>
> 
> There are three changes here.
> 
> In target.h I expose device_lookup for use by the smc.c code.
> 
> In target.h I modify tgt_device_path_update so that we can call it to
> both open and close a file that has been allocated to a
> data_transfer_station.
> 
> In smc.c I modified set_slot_full and set_slot_empty to call the
> modified tgt_device_path_update to achieve my goals. We call
> device_lookup to figure out the device we are interested in.
> 
> I have tested this by loading and unloading tapes and DVDs, doing tar
> to the drive and using cdrecord on the device, and verifying with lsof
> that the tgtd has the files open when they are in the transfer station
> and does not have them open when the station has been unloaded.
> 
> It all seems to work. I have attached the patch as well because gmail
> seems to kill patches ... I hope the attached patch is OK.
Sorry, I don't quite understand the reason for this patch.

The smc already calls a non-static dtd_load_unload() which performs a similar function to tgt_device_path_update() but with different args.

int dtd_load_unload(int tid, uint64_t lun, int load, char *file)
vs
int tgt_device_path_update(struct target *target, struct scsi_lu *lu, char *path)

i.e. dtd_load_unload calls __device_lookup() and then opens/closes the backing store.

All this patch seems to do is call the 'open' or 'close' backing store twice.


Perhaps 'fixing' dtd_load_unload() so it then calls tgt_device_path_update() if this function is not correct.

FWIW: dtd_load_unload == Data Transfer Device load/unload

At the time this function was added, the tgt_device_path_update() did not exist.

Cheers
Mark
> 
> ---
>  usr/smc.c    |   34 ++++++++++++++++++++++++----------
>  usr/target.c |   15 ++++++++++-----
>  usr/target.h |    2 ++
>  3 files changed, 36 insertions(+), 15 deletions(-)
> 
> diff --git a/usr/smc.c b/usr/smc.c
> index 9d7f681..0848101 100644
> --- a/usr/smc.c
> +++ b/usr/smc.c
> @@ -47,12 +47,18 @@
>  #include "smc.h"
>  #include "media.h"
> 
> -static int set_slot_full(struct slot *s, uint16_t src, char *path)
> +static int set_slot_full(struct target *target, struct slot *s, uint16_t src, c
> har *path)

>  {
>         int err = 0;
> 
> -       if (path)
> -               err = dtd_load_unload(s->drive_tid, s->drive_lun, LOAD, path);
> +       if (path) {
> +               struct scsi_lu *lu = device_lookup(target, s->drive_lun);
> +
> +               if (!lu)
> +                       return 1;  /* we could not find the LU ... */
> +
> +               err = tgt_device_path_update(target, lu, path);
> +       }
>         if (err)
>                 return err;
> 
> @@ -62,13 +68,20 @@ static int set_slot_full(struct slot *s, uint16_t src, char
> *path)
>         return err;
>  }
> 
> -static void set_slot_empty(struct slot *s)
> +static void set_slot_empty(struct target *target, struct slot *s)
>  {
>         s->status &= 0xfe;
>         s->last_addr = 0;
>         memset(s->barcode, ' ', sizeof(s->barcode));
> -       if (s->element_type == ELEMENT_DATA_TRANSFER)
> -               dtd_load_unload(s->drive_tid, s->drive_lun, UNLOAD, NULL);
> +
> +       if (s->element_type == ELEMENT_DATA_TRANSFER) {
> +               struct scsi_lu *lu = device_lookup(target, s->drive_lun);
> +
> +               if (!lu)
> +                       return 1;  /* we could not find the LU ... */
> +
> +               (void)tgt_device_path_update(target, lu, NULL);
> +       }
>  }
> 
>  static int test_slot_full(struct slot *s)
> @@ -355,6 +368,7 @@ sense:
>  static int smc_move_medium(int host_no, struct scsi_cmd *cmd)
>  {
>         struct smc_info *smc = dtype_priv(cmd->dev);
> +       struct target *tgt = cmd->c_target;
>         uint8_t *scb;
>         uint16_t src;
>         uint16_t dest;
> @@ -410,15 +424,15 @@ static int smc_move_medium(int host_no, struct scsi_cmd *c
> md)
>                         goto sense;
>                 }
> 
> -               if (set_slot_full(dest_slot, src, path)) {
> +               if (set_slot_full(tgt, dest_slot, src, path)) {
>                         key = HARDWARE_ERROR;
>                         asc = ASC_MECHANICAL_POSITIONING_ERROR;
>                         goto sense;
>                 }
>         } else
> -               set_slot_full(dest_slot, src, NULL);
> +               set_slot_full(tgt, dest_slot, src, NULL);
> 
> -       set_slot_empty(src_slot);
> +       set_slot_empty(tgt, src_slot);
> 
>         scsi_set_in_resid_by_actual(cmd, 0);
>         return SAM_STAT_GOOD;
> @@ -626,7 +640,7 @@ static int config_slot(struct scsi_lu *lu, struct tmp_param
> *tmp)
>                 if (!s)
>                         break;  // Slot not found..
>                 strncpy(s->barcode, tmp->barcode, sizeof(s->barcode));
> -               set_slot_full(s, 0, NULL);
> +               set_slot_full(lu->tgt, s, 0, NULL);
>                 ret = TGTADM_SUCCESS;
>                 break;
>         case ELEMENT_DATA_TRANSFER:
> diff --git a/usr/target.c b/usr/target.c
> index 7abaa54..863ec9b 100644
> --- a/usr/target.c
> +++ b/usr/target.c
> @@ -297,7 +297,7 @@ int it_nexus_destroy(int tid, uint64_t itn_id)
>         return 0;
>  }
> 
> -static struct scsi_lu *device_lookup(struct target *target, uint64_t lun)
> +struct scsi_lu *device_lookup(struct target *target, uint64_t lun)
>  {
>         struct scsi_lu *lu;
> 
> @@ -347,7 +347,7 @@ int tgt_device_path_update(struct target *target, struct scs
> i_lu *lu, char *path
>         uint64_t size;
> 
>         if (lu->path) {
> -               if (lu->attrs.online)
> +               if (path && lu->attrs.online)
>                         return TGTADM_INVALID_REQUEST;
> 
>                 lu->dev_type_template.lu_offline(lu);
> @@ -359,6 +359,10 @@ int tgt_device_path_update(struct target *target, struct sc
> si_lu *lu, char *path
>                 lu->path = NULL;
>         }
> 
> +       /* Were we called to close the file? */
> +       if (!path)
> +               return 0;
> +
>         path = strdup(path);
>         if (!path)
>                 return TGTADM_NOMEM;
> @@ -418,7 +422,7 @@ int tgt_device_create(int tid, int dev_type, uint64_t lun, c
> har *params,
>         struct it_nexus_lu_info *itn_lu;
>         struct it_nexus *itn;
> 
> -       dprintf("%d %" PRIu64 "\n", tid, lun);
> +       eprintf("%d %" PRIu64 " params: %s\n", tid, lun, params);
> 
>         while ((p = strsep(&params, ",")) != NULL) {
>                 substring_t args[MAX_OPT_ARGS];
> @@ -452,8 +456,9 @@ int tgt_device_create(int tid, int dev_type, uint64_t lun, c
> har *params,
>         }
> 
>         bst = target->bst;
> -       if (backing) {
> +       /*if (backing) {*/
>                 if (bstype) {
> +                       eprintf("backing store trying: %s\n", bstype);
>                         bst = get_backingstore_template(bstype);
>                         if (!bst) {
>                                 eprintf("failed to find bstype, %s\n", bstype);
> @@ -461,7 +466,7 @@ int tgt_device_create(int tid, int dev_type, uint64_t lun, c
> har *params,
>                                 goto out;
>                         }
>                 }
> -       }
> +       /*}*/
> 
>         t = device_type_lookup(dev_type);
>         if (!t) {
> diff --git a/usr/target.h b/usr/target.h
> index 8fe30aa..4d4768a 100644
> --- a/usr/target.h
> +++ b/usr/target.h
> @@ -87,4 +87,6 @@ static inline int queue_active(const struct tgt_cmd_queue *q)
>         \
>  QUEUE_FNS(BLOCKED, blocked)
>  QUEUE_FNS(DELETED, deleted)
> 
> +struct scsi_lu *device_lookup(struct target *target, uint64_t lun);
> +
>  #endif
> --
> 1.5.5.1
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel



From realrichardsharpe at gmail.com  Tue Jul 29 05:09:34 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Mon, 28 Jul 2008 20:09:34 -0700
Subject: [Stgt-devel] [PATCH] Make changes so that VTL stuff works
	properly ...
In-Reply-To: <488E8537.8060009@gmail.com>
References: <46b8a8850807281457x13d12406j6cc8f4d3a32e0ae2@mail.gmail.com>
	<488E8537.8060009@gmail.com>
Message-ID: <46b8a8850807282009o3e109b6p123440ce8d92c1dd@mail.gmail.com>

On Mon, Jul 28, 2008 at 7:49 PM, Mark Harvey <markh794 at gmail.com> wrote:
> Richard Sharpe wrote:
>>>
>>> From a16d368a29298170df2c21fd19d8490c248f06b1 Mon Sep 17 00:00:00 2001
>>
>> From: Richard Sharpe <realrichardsharpe at gmail.com>
>> Date: Mon, 28 Jul 2008 14:34:12 -0700
>> Subject: [PATCH] Make changes so that VTL stuff works properly ...
>> Signed-off-by: Richard Sharpe <realrichardsharpe at gmail.com>
>>
>> There are three changes here.
>>
>> In target.h I expose device_lookup for use by the smc.c code.
>>
>> In target.h I modify tgt_device_path_update so that we can call it to
>> both open and close a file that has been allocated to a
>> data_transfer_station.
>>
>> In smc.c I modified set_slot_full and set_slot_empty to call the
>> modified tgt_device_path_update to achieve my goals. We call
>> device_lookup to figure out the device we are interested in.
>>
>> I have tested this by loading and unloading tapes and DVDs, doing tar
>> to the drive and using cdrecord on the device, and verifying with lsof
>> that the tgtd has the files open when they are in the transfer station
>> and does not have them open when the station has been unloaded.
>>
>> It all seems to work. I have attached the patch as well because gmail
>> seems to kill patches ... I hope the attached patch is OK.
>
> Sorry, I don't quite understand the reason for this patch.
>
> The smc already calls a non-static dtd_load_unload() which performs a
> similar function to tgt_device_path_update() but with different args.
>
> int dtd_load_unload(int tid, uint64_t lun, int load, char *file)
> vs
> int tgt_device_path_update(struct target *target, struct scsi_lu *lu, char
> *path)
>
> i.e. dtd_load_unload calls __device_lookup() and then opens/closes the
> backing store.
>
> All this patch seems to do is call the 'open' or 'close' backing store
> twice.
>
>
> Perhaps 'fixing' dtd_load_unload() so it then calls tgt_device_path_update()
> if this function is not correct.
>
> FWIW: dtd_load_unload == Data Transfer Device load/unload
>
> At the time this function was added, the tgt_device_path_update() did not
> exist.

All I know is that the current code segfaults when you ask for a tape
to be loaded into the transfer station.

It segfaults because the appropriate bs_open method has not been
called (which initializes some lists and such).

tgt_device_path_update calls the bs_open routine (through the dev structure) ...


From markh794 at gmail.com  Tue Jul 29 05:35:38 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Tue, 29 Jul 2008 13:35:38 +1000
Subject: [Stgt-devel] [PATCH] Make changes so that VTL stuff
 works	properly ...
In-Reply-To: <46b8a8850807282009o3e109b6p123440ce8d92c1dd@mail.gmail.com>
References: <46b8a8850807281457x13d12406j6cc8f4d3a32e0ae2@mail.gmail.com>	<488E8537.8060009@gmail.com>
	<46b8a8850807282009o3e109b6p123440ce8d92c1dd@mail.gmail.com>
Message-ID: <488E900A.7060907@gmail.com>

Richard Sharpe wrote:
> On Mon, Jul 28, 2008 at 7:49 PM, Mark Harvey <markh794 at gmail.com> wrote:
>> Richard Sharpe wrote:
>>>> From a16d368a29298170df2c21fd19d8490c248f06b1 Mon Sep 17 00:00:00 2001
>>> From: Richard Sharpe <realrichardsharpe at gmail.com>
>>> Date: Mon, 28 Jul 2008 14:34:12 -0700
>>> Subject: [PATCH] Make changes so that VTL stuff works properly ...
>>> Signed-off-by: Richard Sharpe <realrichardsharpe at gmail.com>
>>>
>>> There are three changes here.
>>>
>>> In target.h I expose device_lookup for use by the smc.c code.
>>>
>>> In target.h I modify tgt_device_path_update so that we can call it to
>>> both open and close a file that has been allocated to a
>>> data_transfer_station.
>>>
>>> In smc.c I modified set_slot_full and set_slot_empty to call the
>>> modified tgt_device_path_update to achieve my goals. We call
>>> device_lookup to figure out the device we are interested in.
>>>
>>> I have tested this by loading and unloading tapes and DVDs, doing tar
>>> to the drive and using cdrecord on the device, and verifying with lsof
>>> that the tgtd has the files open when they are in the transfer station
>>> and does not have them open when the station has been unloaded.
>>>
>>> It all seems to work. I have attached the patch as well because gmail
>>> seems to kill patches ... I hope the attached patch is OK.
>> Sorry, I don't quite understand the reason for this patch.
>>
>> The smc already calls a non-static dtd_load_unload() which performs a
>> similar function to tgt_device_path_update() but with different args.
>>
>> int dtd_load_unload(int tid, uint64_t lun, int load, char *file)
>> vs
>> int tgt_device_path_update(struct target *target, struct scsi_lu *lu, char
>> *path)
>>
>> i.e. dtd_load_unload calls __device_lookup() and then opens/closes the
>> backing store.
>>
>> All this patch seems to do is call the 'open' or 'close' backing store
>> twice.
>>
>>
>> Perhaps 'fixing' dtd_load_unload() so it then calls tgt_device_path_update()
>> if this function is not correct.
>>
>> FWIW: dtd_load_unload == Data Transfer Device load/unload
>>
>> At the time this function was added, the tgt_device_path_update() did not
>> exist.
> 
> All I know is that the current code segfaults when you ask for a tape
> to be loaded into the transfer station.
> 
> It segfaults because the appropriate bs_open method has not been
> called (which initializes some lists and such).
> 
> tgt_device_path_update calls the bs_open routine (through the dev structure) ...

The initial open should setup/initialise the backing store methods.

Once they have been initialised, this should not be required on each media load/unload. Or am I missing something here ?

i.e. The init routine(s) should be called at startup/setup time, and the open/close should be called on each media load/unload.

Maybe its the ssc is not calling the backing store init correctly at startup ?

I'm not in a position to examine the code at the moment - however I'll have a look (tomorrow) also.

Please advise if I'm way off course with this - I missed the whole core-dump email thread and need to get up to speed.

Cheers
Mark
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
> 



From fujita.tomonori at lab.ntt.co.jp  Tue Jul 29 05:50:49 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Tue, 29 Jul 2008 12:50:49 +0900
Subject: [Stgt-devel] [PATCH] Make changes so that VTL stuff
	works	properly ...
In-Reply-To: <46b8a8850807282009o3e109b6p123440ce8d92c1dd@mail.gmail.com>
References: <46b8a8850807281457x13d12406j6cc8f4d3a32e0ae2@mail.gmail.com>
	<488E8537.8060009@gmail.com>
	<46b8a8850807282009o3e109b6p123440ce8d92c1dd@mail.gmail.com>
Message-ID: <20080729125143V.fujita.tomonori@lab.ntt.co.jp>

On Mon, 28 Jul 2008 20:09:34 -0700
"Richard Sharpe" <realrichardsharpe at gmail.com> wrote:

> On Mon, Jul 28, 2008 at 7:49 PM, Mark Harvey <markh794 at gmail.com> wrote:
> > Richard Sharpe wrote:
> >>>
> >>> From a16d368a29298170df2c21fd19d8490c248f06b1 Mon Sep 17 00:00:00 2001
> >>
> >> From: Richard Sharpe <realrichardsharpe at gmail.com>
> >> Date: Mon, 28 Jul 2008 14:34:12 -0700
> >> Subject: [PATCH] Make changes so that VTL stuff works properly ...
> >> Signed-off-by: Richard Sharpe <realrichardsharpe at gmail.com>
> >>
> >> There are three changes here.
> >>
> >> In target.h I expose device_lookup for use by the smc.c code.
> >>
> >> In target.h I modify tgt_device_path_update so that we can call it to
> >> both open and close a file that has been allocated to a
> >> data_transfer_station.
> >>
> >> In smc.c I modified set_slot_full and set_slot_empty to call the
> >> modified tgt_device_path_update to achieve my goals. We call
> >> device_lookup to figure out the device we are interested in.
> >>
> >> I have tested this by loading and unloading tapes and DVDs, doing tar
> >> to the drive and using cdrecord on the device, and verifying with lsof
> >> that the tgtd has the files open when they are in the transfer station
> >> and does not have them open when the station has been unloaded.
> >>
> >> It all seems to work. I have attached the patch as well because gmail
> >> seems to kill patches ... I hope the attached patch is OK.
> >
> > Sorry, I don't quite understand the reason for this patch.
> >
> > The smc already calls a non-static dtd_load_unload() which performs a
> > similar function to tgt_device_path_update() but with different args.
> >
> > int dtd_load_unload(int tid, uint64_t lun, int load, char *file)
> > vs
> > int tgt_device_path_update(struct target *target, struct scsi_lu *lu, char
> > *path)
> >
> > i.e. dtd_load_unload calls __device_lookup() and then opens/closes the
> > backing store.
> >
> > All this patch seems to do is call the 'open' or 'close' backing store
> > twice.
> >
> >
> > Perhaps 'fixing' dtd_load_unload() so it then calls tgt_device_path_update()
> > if this function is not correct.
> >
> > FWIW: dtd_load_unload == Data Transfer Device load/unload
> >
> > At the time this function was added, the tgt_device_path_update() did not
> > exist.
> 
> All I know is that the current code segfaults when you ask for a tape
> to be loaded into the transfer station.

Can you tell me what commands you performs? I want to reproduce the
ssc segfault to see what's wrong.


From realrichardsharpe at gmail.com  Tue Jul 29 07:28:30 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Mon, 28 Jul 2008 22:28:30 -0700
Subject: [Stgt-devel] [PATCH] Make changes so that VTL stuff works
	properly ...
In-Reply-To: <20080729142513D.fujita.tomonori@lab.ntt.co.jp>
References: <46b8a8850807282009o3e109b6p123440ce8d92c1dd@mail.gmail.com>
	<20080729125143V.fujita.tomonori@lab.ntt.co.jp>
	<46b8a8850807282058u6f966985g8b0cabdd29b3a7ab@mail.gmail.com>
	<20080729142513D.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <46b8a8850807282228x268a9d39h602de24da549eef1@mail.gmail.com>

On Mon, Jul 28, 2008 at 10:24 PM, FUJITA Tomonori
<fujita.tomonori at lab.ntt.co.jp> wrote:
> On Mon, 28 Jul 2008 20:58:42 -0700
> "Richard Sharpe" <realrichardsharpe at gmail.com> wrote:
>
>> On Mon, Jul 28, 2008 at 8:50 PM, FUJITA Tomonori
>> <fujita.tomonori at lab.ntt.co.jp> wrote:
>> > On Mon, 28 Jul 2008 20:09:34 -0700
>> > "Richard Sharpe" <realrichardsharpe at gmail.com> wrote:
>> >
>> >> On Mon, Jul 28, 2008 at 7:49 PM, Mark Harvey <markh794 at gmail.com> wrote:
>> >> > Richard Sharpe wrote:
>> >> >>>
>> >> >>> From a16d368a29298170df2c21fd19d8490c248f06b1 Mon Sep 17 00:00:00 2001
>> >> >>
>> >> >> From: Richard Sharpe <realrichardsharpe at gmail.com>
>> >> >> Date: Mon, 28 Jul 2008 14:34:12 -0700
>> >> >> Subject: [PATCH] Make changes so that VTL stuff works properly ...
>> >> >> Signed-off-by: Richard Sharpe <realrichardsharpe at gmail.com>
>> >> >>
>> >> >> There are three changes here.
>> >> >>
>> >> >> In target.h I expose device_lookup for use by the smc.c code.
>> >> >>
>> >> >> In target.h I modify tgt_device_path_update so that we can call it to
>> >> >> both open and close a file that has been allocated to a
>> >> >> data_transfer_station.
>> >> >>
>> >> >> In smc.c I modified set_slot_full and set_slot_empty to call the
>> >> >> modified tgt_device_path_update to achieve my goals. We call
>> >> >> device_lookup to figure out the device we are interested in.
>> >> >>
>> >> >> I have tested this by loading and unloading tapes and DVDs, doing tar
>> >> >> to the drive and using cdrecord on the device, and verifying with lsof
>> >> >> that the tgtd has the files open when they are in the transfer station
>> >> >> and does not have them open when the station has been unloaded.
>> >> >>
>> >> >> It all seems to work. I have attached the patch as well because gmail
>> >> >> seems to kill patches ... I hope the attached patch is OK.
>> >> >
>> >> > Sorry, I don't quite understand the reason for this patch.
>> >> >
>> >> > The smc already calls a non-static dtd_load_unload() which performs a
>> >> > similar function to tgt_device_path_update() but with different args.
>> >> >
>> >> > int dtd_load_unload(int tid, uint64_t lun, int load, char *file)
>> >> > vs
>> >> > int tgt_device_path_update(struct target *target, struct scsi_lu *lu, char
>> >> > *path)
>> >> >
>> >> > i.e. dtd_load_unload calls __device_lookup() and then opens/closes the
>> >> > backing store.
>> >> >
>> >> > All this patch seems to do is call the 'open' or 'close' backing store
>> >> > twice.
>> >> >
>> >> >
>> >> > Perhaps 'fixing' dtd_load_unload() so it then calls tgt_device_path_update()
>> >> > if this function is not correct.
>> >> >
>> >> > FWIW: dtd_load_unload == Data Transfer Device load/unload
>> >> >
>> >> > At the time this function was added, the tgt_device_path_update() did not
>> >> > exist.
>> >>
>> >> All I know is that the current code segfaults when you ask for a tape
>> >> to be loaded into the transfer station.
>> >
>> > Can you tell me what commands you performs? I want to reproduce the
>> > ssc segfault to see what's wrong.
>>
>> I sent out a set of commands that I use to setup SMC/MMC for testing.
>> There is one mistake in the set of commands (wrong target number in
>> one place) but the same problem occurs with SMC/MMC.
>>
>> I can't send you the tape stuff until tomorrow when I am back in the office.
>
> I see. Can you send both to the mailing list?

Here's on. mmc has problems with this. I will send the tape config tomorrow.

# Create a DVD target ...
./usr/tgtadm --lld iscsi --op new    --mode target      --tid 2 -T iqn.2008-03.c
om.datalane-inc:storage.dvd1.tyan1U00.sys1

# Now the DVD drive
./usr/tgtadm --lld iscsi --op new    --mode logicalunit --tid 2 --lun 1 -Y cd
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 1 --params
 vendor_id=STGT_DVD,product_id=DVD101,product_rev=0010,scsi_sn=STGTDVD01,removab
le=1

./usr/tgtadm --lld iscsi --op new    --mode logicalunit --tid 2 --lun 2 -b /mnt/
testing/virtual-tapes/smc --device-type=changer
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 vendor_id=STK,product_id=L700,product_rev=0010,scsi_sn=STK0101,removable=1

# A data transfer unit ...
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=4,start_address=1,quantity=1

./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=4,address=1,tid=2,lun=1

./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=1,start_address=16,quantity=1

./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 media_home=/mnt/testing/virtual-tapes

./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=2,start_address=1024,quantity=8

./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=2,address=1024,barcode=DVD00,sides=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=2,address=1025,barcode=DVD01,sides=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=2,address=1026,barcode=DVD02,sides=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 2 --lun 2 --params
 element_type=2,address=1027,barcode=DVD03,sides=1

./usr/tgtadm --lld iscsi --op bind   --mode target      --tid 2 -I ALL
./usr/tgtadm --lld iscsi --mode target --op show


From fujita.tomonori at lab.ntt.co.jp  Tue Jul 29 08:35:09 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Tue, 29 Jul 2008 15:35:09 +0900
Subject: [Stgt-devel] [PATCH] allow other target types than iscsi
	in	tgt-admin
In-Reply-To: <488DCEB7.1080804@wpkg.org>
References: <488DCEB7.1080804@wpkg.org>
Message-ID: <20080729153600U.fujita.tomonori@lab.ntt.co.jp>

On Mon, 28 Jul 2008 15:50:47 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> tgtadm allows other target types than iscsi (i.e., fcoe or ibmvstgt).
> 
> tgt-admin (or whatever it will be called in the future, so that it doesn't confuse with tgtadm) should support other target types ("driver"), too.
> 
> With this patch, we can configure a per-target driver, or, we can use a default value for all targets (used by all targets; unless overridden).
> When there is no driver definition, tgt-admin defaults to "iscsi".
> 
> 
> Example configuration:
> 
> 
> # defaults for all targets
> default-driver iscsi
> 
> <target iqn.2006-08.com.example:blah.fcoe>
> # will use fcoe
> driver fcoe
> ...
> </target>
> 
> <target iqn.2007-11.com.example:blah.iscsi>
> # will default to iscsi
> ...
> </target>
> 
> 
> Also, I added a simple "check" subroutine which checks some simple errors in the config file (missing values etc.).
> 
> 
> Patch follows:
> 
> Signed-off-by: Tomasz Chmielewski <mangoo at wpkg.org>

Applied, thanks!


From mangoo at wpkg.org  Tue Jul 29 12:26:27 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Tue, 29 Jul 2008 12:26:27 +0200
Subject: [Stgt-devel] [PATCH] changing state of targets via tgt-admin
Message-ID: <488EF053.4050906@wpkg.org>

Add a possibility to change the state (offline or ready) of targets.

It is possible to offline/ready all targets, target specified with its name (i.e. iqn.2008-08.com.example:some.target) or tid.

This is an example usage help for the --offline option (--ready works in the same way):

# ./tgt-admin --offline help
"./tgt-admin --offline <value>" - offline all or selected targets.

Example usage:
        --offline help  - display this help
        --offline ALL   - offline all targets
        --offline tid=4 - offline target 4 (target with tid 4)
        --offline iqn.2008-08.com.example:some.target - offline this target


Signed-off-by: Tomasz Chmielewski <mangoo at wpkg.org>

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index 162cac2..eceea83 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -25,6 +25,10 @@ This tool configures tgt targets.
 
   -e, --execute              read $configfile and execute tgtadm commands
   -d, --delete               delete all the targets
+      --offline <value>      put all or selected targets in offline state
+                             (see "--offline help" for more info)
+      --ready <value>        put all or selected targets in ready state
+                             (see "--ready help" for more info)
   -s, --show                 show all the targets
   -c, --conf <conf file>     specify an alternative configuration file
   -f, --force                don't exit on tgtadm errors
@@ -41,6 +45,8 @@ my %conf;
 my $param = $ARGV[0];
 my $execute = 0;
 my $delete = 0;
+my $offline = 0;
+my $ready = 0;
 my $show = 0;
 my $alternate_conf="0";
 my $force = 0;
@@ -51,6 +57,8 @@ my $help = 0;
 my $result = GetOptions (
 	"e|execute" => \$execute,
 	"d|delete"  => \$delete,
+	"offline=s" => \$offline,
+	"ready=s"   => \$ready,
 	"s|show"    => \$show,
 	"c|conf=s"  => \$alternate_conf,
 	"f|force"   => \$force,
@@ -403,6 +411,50 @@ sub dump_config {
 	}
 }
 
+# Offline or ready targets
+sub ready_offline_targets {
+	my $var = $_[0]; # This variable is either "offline" or "ready"
+	my $off_ready;
+	if ($ready eq 0) {
+		$off_ready = $offline
+	} elsif ($offline eq 0) {
+		$off_ready = $ready
+	} else {
+		print "Invalid value (you can't use both ready and offline)!\n";
+		exit 1
+	}
+	if ($off_ready eq "help") {
+		print <<EOF;
+"$ENV{_} --$var <value>" - $var all or selected targets.
+
+Example usage:
+	--$var help  - display this help
+	--$var ALL   - $var all targets
+	--$var tid=4 - $var target 4 (target with tid 4)
+	--$var iqn.2008-08.com.example:some.target - $var this target
+
+EOF
+	} elsif ($off_ready eq "ALL") {
+		&process_targets;
+		# Run over all targets and offline/ready them
+		my @all_targets = keys %tgtadm_output_tid;
+		foreach my $existing_target (@all_targets) {
+			execute("tgtadm --op update --mode target --tid=$tgtadm_output_tid{$existing_target} -n state -v $var");
+		}
+	} elsif ($off_ready =~ m/tid=(.+)/) {
+		&process_targets;
+		execute("tgtadm --op update --mode target --tid=$1 -n state -v $var");
+	} else {
+		&process_targets;
+		if (length $tgtadm_output_tid{$off_ready}) {
+			execute("tgtadm --op update --mode target --tid=$tgtadm_output_tid{$off_ready} --name=\"$off_ready\" -n state -v $var");
+		} else {
+			print "There is no target with name \"$off_ready\", can't $var it!\n";
+			exit 1;
+		}
+	}
+}
+
 # Some checks
 sub check {
 	if ( not defined $_[0] or not length $_[0] ) {
@@ -439,7 +491,7 @@ sub execute {
 	}
 }
 
-if (($execute == 1) || ($pretend == 1)) {
+if ($execute == 1) {
 	&process_targets;
 	&parse_configs;
 	&add_targets;
@@ -450,6 +502,10 @@ if (($execute == 1) || ($pretend == 1)) {
 	&remove_targets;
 } elsif ($dump == 1) {
 	&dump_config;
+} elsif ($offline ne 0) {
+	&ready_offline_targets("offline");
+} elsif ($ready ne 0) {
+	&ready_offline_targets("ready");
 } else {
 	print "No action specified.\n";
 }




-- 
Tomasz Chmielewski 
http://wpkg.org


From mangoo at wpkg.org  Tue Jul 29 12:38:01 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Tue, 29 Jul 2008 12:38:01 +0200
Subject: [Stgt-devel] [PATCH 2/7] Add option to delete all the targets
In-Reply-To: <20080728211555S.fujita.tomonori@lab.ntt.co.jp>
References: <4889AF10.9090705@wpkg.org>	<20080725195456M.fujita.tomonori@lab.ntt.co.jp>	<488DB518.2030005@wpkg.org>
	<20080728211555S.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <488EF309.1000902@wpkg.org>

FUJITA Tomonori schrieb:

(...)

>> What is the preferred approach to delete the targets via tgt-admin?
>>
>> 1) delete only the targets which have no initiators connected - this is what we do right now; we offline them before we try to delete
>>
>> 2) delete ALL targets, even if initiators are connected (supported since "support to close a connection by force and to shut down tgtd")

(...)

> I think that the majority of administrators will use a user-friendly
> tool like tgt-admin (possible alternatives are web interface, or shell
> interface as many appliances do). So I expect people want to do common
> operations with it. The above two operations are often used, I guess.

IMHO it would make sense to make two "delete" options then:

--delete <ALL|tid=|targetname>

It would only touch the target if it is not in use.
ALL would delete all targets which are not in use; the targets which have initiators connected would not have its state changed (some informational message would be displayed to the user).

--forcedelete <ALL|tid=|targetname>

It would delete the targets irrespectively of their use.


-- 
Tomasz Chmielewski 
http://wpkg.org


From linstock at maaspi.com  Tue Jul 29 12:44:10 2008
From: linstock at maaspi.com (Gadapee Arline)
Date: Tue, 29 Jul 2008 10:44:10 +0000
Subject: [Stgt-devel] Tattooed mom says docctor discriminated by not
	treaating daughter
Message-ID: <6392889702.20080729101214@maaspi.com>

God dag,


	Double Yoour Sexual Pleasure
 http://aex.qwmaaaoycb.cn

 
	
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080729/80dab737/attachment.html>

From dorons at Voltaire.COM  Tue Jul 29 12:51:55 2008
From: dorons at Voltaire.COM (Doron Shoham)
Date: Tue, 29 Jul 2008 13:51:55 +0300
Subject: [Stgt-devel] [PATCH] tgt-admin: support persistent
	device	binding
In-Reply-To: <694d48600807280516h772bd3edvbf52d80c27eec15b@mail.gmail.com>
References: <488D90D9.6080603@voltaire.com>	<20080728184729P.fujita.tomonori@lab.ntt.co.jp>	<694d48600807280437n60f24292n7d25015da971103c@mail.gmail.com>	<20080728205053B.fujita.tomonori@lab.ntt.co.jp>
	<694d48600807280516h772bd3edvbf52d80c27eec15b@mail.gmail.com>
Message-ID: <488EF64B.9090705@Voltaire.COM>

Eli Dorfman wrote:
>>> maybe use the following format :
>>> <target xyz>
>>>     <backing-store /dev/sdb>
>>>           properties  custom # use properties specified below or
>>> default (generate the deadbeaf id) or direct (get real serial number)
>>>           serial-number 12345678
>>>           vendor myvendor
>>>     </backing-store>
>>> </target>
>>>
>>> what do you think?
>> Hmm, 'properties custom' looks unnecessary for me. If a device file of
>> a disk drive is used as backing-store and none of the properties are
>> specified, we can use the physical properties.
> 
> we need something like properties to differentiate between disk (read
> real props), file (generate unique serial number
> disk-sn-partition-filename) and custom (applicable to any case).
> we can call this attribute: "type" which can accept 3 values disk,
> file or custom (default).

This is what I suggest:

<target iqn.2007-04.com.example:san.monitoring>
   <backing-store /tmp/ramdisk/lun1>
      type default
      serial 12345678
      vendor my_vendor
      product_id my_id
      product_rev my_rev
   </backing-store>

   <backing-store /dev/sdc>
      type disk
   </backing-store>
</target>

The reason we use XML is that the original implementation used XML.

We suggest two types:
1. disk: "real" physical devices, where we read the properties from the device itself - i.e. storage disks.
2. default - use default tgt values. 
   We can also override the properties with user defined values (optional).

The reason for the type attribute is to differentiate between these two types.

What do you think about it?
If it is agreed by everyone, I'll send a patch.

Thanks,
Doron



From fujita.tomonori at lab.ntt.co.jp  Tue Jul 29 13:02:51 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Tue, 29 Jul 2008 20:02:51 +0900
Subject: [Stgt-devel] [PATCH] tgt-admin: support
	persistent	device	binding
In-Reply-To: <488EF64B.9090705@Voltaire.COM>
References: <20080728205053B.fujita.tomonori@lab.ntt.co.jp>
	<694d48600807280516h772bd3edvbf52d80c27eec15b@mail.gmail.com>
	<488EF64B.9090705@Voltaire.COM>
Message-ID: <20080729200345E.fujita.tomonori@lab.ntt.co.jp>

On Tue, 29 Jul 2008 13:51:55 +0300
Doron Shoham <dorons at Voltaire.COM> wrote:

> Eli Dorfman wrote:
> >>> maybe use the following format :
> >>> <target xyz>
> >>>     <backing-store /dev/sdb>
> >>>           properties  custom # use properties specified below or
> >>> default (generate the deadbeaf id) or direct (get real serial number)
> >>>           serial-number 12345678
> >>>           vendor myvendor
> >>>     </backing-store>
> >>> </target>
> >>>
> >>> what do you think?
> >> Hmm, 'properties custom' looks unnecessary for me. If a device file of
> >> a disk drive is used as backing-store and none of the properties are
> >> specified, we can use the physical properties.
> > 
> > we need something like properties to differentiate between disk (read
> > real props), file (generate unique serial number
> > disk-sn-partition-filename) and custom (applicable to any case).
> > we can call this attribute: "type" which can accept 3 values disk,
> > file or custom (default).
> 
> This is what I suggest:
> 
> <target iqn.2007-04.com.example:san.monitoring>
>    <backing-store /tmp/ramdisk/lun1>
>       type default
>       serial 12345678
>       vendor my_vendor
>       product_id my_id
>       product_rev my_rev
>    </backing-store>
> 
>    <backing-store /dev/sdc>
>       type disk
>    </backing-store>
> </target>
> 
> The reason we use XML is that the original implementation used XML.
> 
> We suggest two types:
> 1. disk: "real" physical devices, where we read the properties from the device itself - i.e. storage disks.
> 2. default - use default tgt values. 
>    We can also override the properties with user defined values (optional).
> 
> The reason for the type attribute is to differentiate between these two types.

I don't know anything about XML but should it be something like?

<target iqn.2007-04.com.example:san.monitoring>
   <lun 0>
     type sbc
     backing-store


I think that OpenSolaris has a xml file to store iSCSI target
configuration persistently. It might provide us some ideas.


From dorons at Voltaire.COM  Tue Jul 29 13:17:26 2008
From: dorons at Voltaire.COM (Doron Shoham)
Date: Tue, 29 Jul 2008 14:17:26 +0300
Subject: [Stgt-devel] [PATCH] tgt-admin: support
	persistent	device	binding
In-Reply-To: <20080729200345E.fujita.tomonori@lab.ntt.co.jp>
References: <20080728205053B.fujita.tomonori@lab.ntt.co.jp>	<694d48600807280516h772bd3edvbf52d80c27eec15b@mail.gmail.com>	<488EF64B.9090705@Voltaire.COM>
	<20080729200345E.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <488EFC46.70601@Voltaire.COM>

>> This is what I suggest:
>>
>> <target iqn.2007-04.com.example:san.monitoring>
>>    <backing-store /tmp/ramdisk/lun1>
>>       type default
>>       serial 12345678
>>       vendor my_vendor
>>       product_id my_id
>>       product_rev my_rev
>>    </backing-store>
>>
>>    <backing-store /dev/sdc>
>>       type disk
>>    </backing-store>
>> </target>
>>
>> The reason we use XML is that the original implementation used XML.
>>
>> We suggest two types:
>> 1. disk: "real" physical devices, where we read the properties from the device itself - i.e. storage disks.
>> 2. default - use default tgt values. 
>>    We can also override the properties with user defined values (optional).
>>
>> The reason for the type attribute is to differentiate between these two types.
> 
> I don't know anything about XML but should it be something like?
> 
> <target iqn.2007-04.com.example:san.monitoring>
>    <lun 0>
>      type sbc
>      backing-store
> 
> 
> I think that OpenSolaris has a xml file to store iSCSI target
> configuration persistently. It might provide us some ideas.

There is no need to define the lun (tgt-admin is doing it automatically).
A first glance (in google) it's looks like opensolaris configuration file is a plain text (not xml).
Your suggestion does not solve our need to differentiate between the two types of devices.



From mangoo at wpkg.org  Tue Jul 29 13:21:45 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Tue, 29 Jul 2008 13:21:45 +0200
Subject: [Stgt-devel] [PATCH] tgt-admin:
	support	persistent	device	binding
In-Reply-To: <20080729200345E.fujita.tomonori@lab.ntt.co.jp>
References: <20080728205053B.fujita.tomonori@lab.ntt.co.jp>	<694d48600807280516h772bd3edvbf52d80c27eec15b@mail.gmail.com>	<488EF64B.9090705@Voltaire.COM>
	<20080729200345E.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <488EFD49.5010306@wpkg.org>

FUJITA Tomonori schrieb:
> On Tue, 29 Jul 2008 13:51:55 +0300
> Doron Shoham <dorons at Voltaire.COM> wrote:
> 
>> Eli Dorfman wrote:
>>>>> maybe use the following format :
>>>>> <target xyz>
>>>>>     <backing-store /dev/sdb>
>>>>>           properties  custom # use properties specified below or
>>>>> default (generate the deadbeaf id) or direct (get real serial number)
>>>>>           serial-number 12345678
>>>>>           vendor myvendor
>>>>>     </backing-store>
>>>>> </target>
>>>>>
>>>>> what do you think?
>>>> Hmm, 'properties custom' looks unnecessary for me. If a device file of
>>>> a disk drive is used as backing-store and none of the properties are
>>>> specified, we can use the physical properties.
>>> we need something like properties to differentiate between disk (read
>>> real props), file (generate unique serial number
>>> disk-sn-partition-filename) and custom (applicable to any case).
>>> we can call this attribute: "type" which can accept 3 values disk,
>>> file or custom (default).
>> This is what I suggest:
>>
>> <target iqn.2007-04.com.example:san.monitoring>
>>    <backing-store /tmp/ramdisk/lun1>
>>       type default
>>       serial 12345678
>>       vendor my_vendor
>>       product_id my_id
>>       product_rev my_rev
>>    </backing-store>
>>
>>    <backing-store /dev/sdc>
>>       type disk
>>    </backing-store>
>> </target>
>>
>> The reason we use XML is that the original implementation used XML.
>>
>> We suggest two types:
>> 1. disk: "real" physical devices, where we read the properties from the device itself - i.e. storage disks.
>> 2. default - use default tgt values. 
>>    We can also override the properties with user defined values (optional).
>>
>> The reason for the type attribute is to differentiate between these two types.
> 
> I don't know anything about XML but should it be something like?
> 
> <target iqn.2007-04.com.example:san.monitoring>
>    <lun 0>
>      type sbc
>      backing-store

What we use currently in tgt-admin is a mix of XML and a flat config file, I would say.
With the benefits of both (easy hand editing; it is clear where one target definition starts and where it ends).


If it was "proper XML", it should look like:

<target iqn.2007-04.com.example:san.monitoring>
	<lun 0>
		<type sbc />
		<backing-store />
	</lun>
</target>

Which is not that nice for hand editing anymore - forget one slash in one place (i.e., after "type sbc"), and your whole config file is invalid.


However this one still looks OK and makes sense I would say, if we want to precisely configure different luns?

 <target iqn.2007-04.com.example:san.monitoring>
    <lun 0>
      type sbc
      backing-store


-- 
Tomasz Chmielewski 
http://wpkg.org



From dorons at voltaire.com  Tue Jul 29 13:27:48 2008
From: dorons at voltaire.com (Doron Shoham)
Date: Tue, 29 Jul 2008 14:27:48 +0300
Subject: [Stgt-devel] [PATCH 6/7] target reconfiguration
In-Reply-To: <488DB2D0.3070407@wpkg.org>
References: <4885C11A.6080205@voltaire.com> <4885C2B2.5000809@voltaire.com>
	<4889EF49.1070700@wpkg.org> <488DB2D0.3070407@wpkg.org>
Message-ID: <488EFEB4.9070803@voltaire.com>

Tomasz Chmielewski wrote:
> Tomasz Chmielewski schrieb:
>> Doron Shoham schrieb:
>>> modifying a target that already exits in tgt, current instance will
>>> be delete
>>> and a new one will be created with the new parameters instead.
>>
>> Hmm, this is not optimal - it offlines, removes and configures each
>> target from scratch even if no changes were made.
> 
> Besides, it doesn't even seem to work properly: all targets get the same
> tid...
> 
> 

You are right.

I suggest we do something like the delete option:

--update <ALL|tid=|targetname>

It would only update the target if it is not in use.
ALL would update all targets which are not in use - 
Targets which have initiators connected will not be updated.


 



From mangoo at wpkg.org  Tue Jul 29 13:32:22 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Tue, 29 Jul 2008 13:32:22 +0200
Subject: [Stgt-devel] [PATCH 6/7] target reconfiguration
In-Reply-To: <488EFEB4.9070803@voltaire.com>
References: <4885C11A.6080205@voltaire.com> <4885C2B2.5000809@voltaire.com>
	<4889EF49.1070700@wpkg.org> <488DB2D0.3070407@wpkg.org>
	<488EFEB4.9070803@voltaire.com>
Message-ID: <488EFFC6.9040507@wpkg.org>

Doron Shoham schrieb:
> Tomasz Chmielewski wrote:
>> Tomasz Chmielewski schrieb:
>>> Doron Shoham schrieb:
>>>> modifying a target that already exits in tgt, current instance will
>>>> be delete
>>>> and a new one will be created with the new parameters instead.
>>> Hmm, this is not optimal - it offlines, removes and configures each
>>> target from scratch even if no changes were made.
>> Besides, it doesn't even seem to work properly: all targets get the same
>> tid...
>>
>>
> 
> You are right.
> 
> I suggest we do something like the delete option:
> 
> --update <ALL|tid=|targetname>
> 
> It would only update the target if it is not in use.
> ALL would update all targets which are not in use - 
> Targets which have initiators connected will not be updated.

I'm just working on --delete and --forcedelete, which I described in a previous thread ("Add option to delete all the targets").

I guess --update and --forceupdate with a similar logic would make sense?


-- 
Tomasz Chmielewski 
http://wpkg.org



From fujita.tomonori at lab.ntt.co.jp  Tue Jul 29 13:41:00 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Tue, 29 Jul 2008 20:41:00 +0900
Subject: [Stgt-devel] [PATCH]
	tgt-admin:	support	persistent	device	binding
In-Reply-To: <488EFD49.5010306@wpkg.org>
References: <488EF64B.9090705@Voltaire.COM>
	<20080729200345E.fujita.tomonori@lab.ntt.co.jp>
	<488EFD49.5010306@wpkg.org>
Message-ID: <20080729204155O.fujita.tomonori@lab.ntt.co.jp>

On Tue, 29 Jul 2008 13:21:45 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> FUJITA Tomonori schrieb:
> > On Tue, 29 Jul 2008 13:51:55 +0300
> > Doron Shoham <dorons at Voltaire.COM> wrote:
> > 
> >> Eli Dorfman wrote:
> >>>>> maybe use the following format :
> >>>>> <target xyz>
> >>>>>     <backing-store /dev/sdb>
> >>>>>           properties  custom # use properties specified below or
> >>>>> default (generate the deadbeaf id) or direct (get real serial number)
> >>>>>           serial-number 12345678
> >>>>>           vendor myvendor
> >>>>>     </backing-store>
> >>>>> </target>
> >>>>>
> >>>>> what do you think?
> >>>> Hmm, 'properties custom' looks unnecessary for me. If a device file of
> >>>> a disk drive is used as backing-store and none of the properties are
> >>>> specified, we can use the physical properties.
> >>> we need something like properties to differentiate between disk (read
> >>> real props), file (generate unique serial number
> >>> disk-sn-partition-filename) and custom (applicable to any case).
> >>> we can call this attribute: "type" which can accept 3 values disk,
> >>> file or custom (default).
> >> This is what I suggest:
> >>
> >> <target iqn.2007-04.com.example:san.monitoring>
> >>    <backing-store /tmp/ramdisk/lun1>
> >>       type default
> >>       serial 12345678
> >>       vendor my_vendor
> >>       product_id my_id
> >>       product_rev my_rev
> >>    </backing-store>
> >>
> >>    <backing-store /dev/sdc>
> >>       type disk
> >>    </backing-store>
> >> </target>
> >>
> >> The reason we use XML is that the original implementation used XML.
> >>
> >> We suggest two types:
> >> 1. disk: "real" physical devices, where we read the properties from the device itself - i.e. storage disks.
> >> 2. default - use default tgt values. 
> >>    We can also override the properties with user defined values (optional).
> >>
> >> The reason for the type attribute is to differentiate between these two types.
> > 
> > I don't know anything about XML but should it be something like?
> > 
> > <target iqn.2007-04.com.example:san.monitoring>
> >    <lun 0>
> >      type sbc
> >      backing-store
> 
> What we use currently in tgt-admin is a mix of XML and a flat config file, I would say.
> With the benefits of both (easy hand editing; it is clear where one target definition starts and where it ends).
> 
> 
> If it was "proper XML", it should look like:
> 
> <target iqn.2007-04.com.example:san.monitoring>
> 	<lun 0>
> 		<type sbc />
> 		<backing-store />
> 	</lun>
> </target>
> 
> Which is not that nice for hand editing anymore - forget one slash
> in one place (i.e., after "type sbc"), and your whole config file is
> invalid.

But it would be better to let administrators not to edit a
configuration file by hand? And I guess that using a pure XML enables
us to use perl XML libraries? I thought that that's the reason why
people want to use XML.

IMHO, it's much easier to edit a plain text file rather than a XML
file.

> However this one still looks OK and makes sense I would say, if we want to precisely configure different luns?
> 
>  <target iqn.2007-04.com.example:san.monitoring>
>     <lun 0>
>       type sbc
>       backing-store

I think that it would be better to have a configuration format that
can describe everything.


From mangoo at wpkg.org  Tue Jul 29 14:07:18 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Tue, 29 Jul 2008 14:07:18 +0200
Subject: [Stgt-devel] [PATCH]
	tgt-admin:	support	persistent	device	binding
In-Reply-To: <20080729204155O.fujita.tomonori@lab.ntt.co.jp>
References: <488EF64B.9090705@Voltaire.COM>	<20080729200345E.fujita.tomonori@lab.ntt.co.jp>	<488EFD49.5010306@wpkg.org>
	<20080729204155O.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <488F07F6.3040501@wpkg.org>

FUJITA Tomonori schrieb:
> On Tue, 29 Jul 2008 13:21:45 +0200
> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> 
>> FUJITA Tomonori schrieb:
>>> On Tue, 29 Jul 2008 13:51:55 +0300
>>> Doron Shoham <dorons at Voltaire.COM> wrote:
>>>
>>>> Eli Dorfman wrote:
>>>>>>> maybe use the following format :
>>>>>>> <target xyz>
>>>>>>>     <backing-store /dev/sdb>
>>>>>>>           properties  custom # use properties specified below or
>>>>>>> default (generate the deadbeaf id) or direct (get real serial number)
>>>>>>>           serial-number 12345678
>>>>>>>           vendor myvendor
>>>>>>>     </backing-store>
>>>>>>> </target>
>>>>>>>
>>>>>>> what do you think?
>>>>>> Hmm, 'properties custom' looks unnecessary for me. If a device file of
>>>>>> a disk drive is used as backing-store and none of the properties are
>>>>>> specified, we can use the physical properties.
>>>>> we need something like properties to differentiate between disk (read
>>>>> real props), file (generate unique serial number
>>>>> disk-sn-partition-filename) and custom (applicable to any case).
>>>>> we can call this attribute: "type" which can accept 3 values disk,
>>>>> file or custom (default).
>>>> This is what I suggest:
>>>>
>>>> <target iqn.2007-04.com.example:san.monitoring>
>>>>    <backing-store /tmp/ramdisk/lun1>
>>>>       type default
>>>>       serial 12345678
>>>>       vendor my_vendor
>>>>       product_id my_id
>>>>       product_rev my_rev
>>>>    </backing-store>
>>>>
>>>>    <backing-store /dev/sdc>
>>>>       type disk
>>>>    </backing-store>
>>>> </target>
>>>>
>>>> The reason we use XML is that the original implementation used XML.
>>>>
>>>> We suggest two types:
>>>> 1. disk: "real" physical devices, where we read the properties from the device itself - i.e. storage disks.
>>>> 2. default - use default tgt values. 
>>>>    We can also override the properties with user defined values (optional).
>>>>
>>>> The reason for the type attribute is to differentiate between these two types.
>>> I don't know anything about XML but should it be something like?
>>>
>>> <target iqn.2007-04.com.example:san.monitoring>
>>>    <lun 0>
>>>      type sbc
>>>      backing-store
>> What we use currently in tgt-admin is a mix of XML and a flat config file, I would say.
>> With the benefits of both (easy hand editing; it is clear where one target definition starts and where it ends).
>>
>>
>> If it was "proper XML", it should look like:
>>
>> <target iqn.2007-04.com.example:san.monitoring>
>> 	<lun 0>
>> 		<type sbc />
>> 		<backing-store />
>> 	</lun>
>> </target>
>>
>> Which is not that nice for hand editing anymore - forget one slash
>> in one place (i.e., after "type sbc"), and your whole config file is
>> invalid.
> 
> But it would be better to let administrators not to edit a
> configuration file by hand?

Why not? I prefer hand editing than "wizards" etc. (unless I have really lots of things to change; in that case, I would probably run some awk/perl script anyway).


> And I guess that using a pure XML enables
> us to use perl XML libraries? I thought that that's the reason why
> people want to use XML.

I chose the apache-style format we have now because:
- it was easy for hand or scripted editing,
- perl provides a parser for it -> no need to write an own parser
- everyone agreed to it ;)

> IMHO, it's much easier to edit a plain text file rather than a XML
> file.

The problem is the definition of a plain text file, and what happens when we have "nested" things with different values (i.e., different luns should have different parameters), detecting simple typos (see what will happen in "other types" below - target vs tagret - some other target will probably get luns which don't belong to it) in the text file etc.


- apache-style plain text configuration - this is what we use now

include /some/other/*.conf

<target iqn.2007-02.com.example:blah.blah>
backing-store /dev/blah/blah
</target>


- INI files (used i.e. by Samba)

[global]
include = /some/other/*.conf

[iqn.2007-02.com.example:blah.blah]
backing-store = /dev/blah/blah



- other types

target iqn.2007-02.com.example:blah.blah
backing-store /dev/blah/blah

tagret iqn.2008-11.com.example:blah2.blah2
backing-store /dev/some/other


-- 
Tomasz Chmielewski 
http://wpkg.org



From fujita.tomonori at lab.ntt.co.jp  Tue Jul 29 15:43:24 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Tue, 29 Jul 2008 22:43:24 +0900
Subject: [Stgt-devel] [PATCH 2/7] Add option to delete all the targets
In-Reply-To: <488EF309.1000902@wpkg.org>
References: <488DB518.2030005@wpkg.org>
	<20080728211555S.fujita.tomonori@lab.ntt.co.jp>
	<488EF309.1000902@wpkg.org>
Message-ID: <20080729221416H.tomof@acm.org>

On Tue, 29 Jul 2008 12:38:01 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> FUJITA Tomonori schrieb:
> 
> (...)
> 
> >> What is the preferred approach to delete the targets via tgt-admin?
> >>
> >> 1) delete only the targets which have no initiators connected - this is what we do right now; we offline them before we try to delete
> >>
> >> 2) delete ALL targets, even if initiators are connected (supported since "support to close a connection by force and to shut down tgtd")
> 
> (...)
> 
> > I think that the majority of administrators will use a user-friendly
> > tool like tgt-admin (possible alternatives are web interface, or shell
> > interface as many appliances do). So I expect people want to do common
> > operations with it. The above two operations are often used, I guess.
> 
> IMHO it would make sense to make two "delete" options then:
> 
> --delete <ALL|tid=|targetname>
> 
> It would only touch the target if it is not in use.
> ALL would delete all targets which are not in use; the targets which have initiators connected would not have its state changed (some informational message would be displayed to the user).
> 
> --forcedelete <ALL|tid=|targetname>
> 
> It would delete the targets irrespectively of their use.

How about the followings?

(--force) --delete <ALL|tid=|targetname>

It would only touch the target if it is not in use. If an active
target (or targets due to ALL) is specified, the warnings shows up.

If --force option is enabled, it would delete the targets
irrespectively of their use.


From fujita.tomonori at lab.ntt.co.jp  Tue Jul 29 15:50:52 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Tue, 29 Jul 2008 22:50:52 +0900
Subject: [Stgt-devel]
	[PATCH]	tgt-admin:	support	persistent	device	binding
In-Reply-To: <488F07F6.3040501@wpkg.org>
References: <488EFD49.5010306@wpkg.org>
	<20080729204155O.fujita.tomonori@lab.ntt.co.jp>
	<488F07F6.3040501@wpkg.org>
Message-ID: <20080729225050X.tomof@acm.org>

On Tue, 29 Jul 2008 14:07:18 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> > IMHO, it's much easier to edit a plain text file rather than a XML
> > file.
> 
> The problem is the definition of a plain text file, and what happens when we have "nested" things with different values (i.e., different luns should have different parameters), detecting simple typos (see what will happen in "other types" below - target vs tagret - some other target will probably get luns which don't belong to it) in the text file etc.
> 
> 
> - apache-style plain text configuration - this is what we use now
> 
> include /some/other/*.conf
> 
> <target iqn.2007-02.com.example:blah.blah>
> backing-store /dev/blah/blah
> </target>

OK, the apache style looks sane (and makes sense since perl provides
the libraries).

Then, please invent a good format.

IMHO, the format should represent all the details since we can't
change the format later on easily.


From mangoo at wpkg.org  Tue Jul 29 15:56:44 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Tue, 29 Jul 2008 15:56:44 +0200
Subject: [Stgt-devel] [PATCH 2/7] Add option to delete all the targets
In-Reply-To: <20080729221416H.tomof@acm.org>
References: <488DB518.2030005@wpkg.org>	<20080728211555S.fujita.tomonori@lab.ntt.co.jp>	<488EF309.1000902@wpkg.org>
	<20080729221416H.tomof@acm.org>
Message-ID: <488F219C.5000709@wpkg.org>

FUJITA Tomonori schrieb:

(...)

>> --delete <ALL|tid=|targetname>
>>
>> It would only touch the target if it is not in use.
>> ALL would delete all targets which are not in use; the targets which have initiators connected would not have its state changed (some informational message would be displayed to the user).
>>
>> --forcedelete <ALL|tid=|targetname>
>>
>> It would delete the targets irrespectively of their use.
> 
> How about the followings?
> 
> (--force) --delete <ALL|tid=|targetname>
> 
> It would only touch the target if it is not in use. If an active
> target (or targets due to ALL) is specified, the warnings shows up.
> 
> If --force option is enabled, it would delete the targets
> irrespectively of their use.

I thought about it, but we have already:

  -f, --force                don't exit on tgtadm errors

And I couldn't come up with a better name than "force" ;)

Since tgt-admin still changes a lot, perhaps it would be better to rename the current "--force" into something like "--ignore-errors".

And from then on use "--force" to force some potentially dangerous operations, like force-deleting targets.


-- 
Tomasz Chmielewski 
http://wpkg.org


From fujita.tomonori at lab.ntt.co.jp  Tue Jul 29 16:01:55 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Tue, 29 Jul 2008 23:01:55 +0900
Subject: [Stgt-devel] [PATCH 2/7] Add option to delete all the targets
In-Reply-To: <488F219C.5000709@wpkg.org>
References: <488EF309.1000902@wpkg.org> <20080729221416H.tomof@acm.org>
	<488F219C.5000709@wpkg.org>
Message-ID: <20080729230141M.tomof@acm.org>

On Tue, 29 Jul 2008 15:56:44 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> FUJITA Tomonori schrieb:
> 
> (...)
> 
> >> --delete <ALL|tid=|targetname>
> >>
> >> It would only touch the target if it is not in use.
> >> ALL would delete all targets which are not in use; the targets which have initiators connected would not have its state changed (some informational message would be displayed to the user).
> >>
> >> --forcedelete <ALL|tid=|targetname>
> >>
> >> It would delete the targets irrespectively of their use.
> > 
> > How about the followings?
> > 
> > (--force) --delete <ALL|tid=|targetname>
> > 
> > It would only touch the target if it is not in use. If an active
> > target (or targets due to ALL) is specified, the warnings shows up.
> > 
> > If --force option is enabled, it would delete the targets
> > irrespectively of their use.
> 
> I thought about it, but we have already:
> 
>   -f, --force                don't exit on tgtadm errors
> 
> And I couldn't come up with a better name than "force" ;)
> 
> Since tgt-admin still changes a lot, perhaps it would be better to rename the current "--force" into something like "--ignore-errors".

Sounds more sane. Any other comments?

If we can't change the command line now, we can't change the format too.


From mangoo at wpkg.org  Tue Jul 29 16:44:14 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Tue, 29 Jul 2008 16:44:14 +0200
Subject: [Stgt-devel] support to close a connection by force and to shut
 down tgtd
In-Reply-To: <20080712220508D.fujita.tomonori@lab.ntt.co.jp>
References: <20080712220508D.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <488F2CBE.600@wpkg.org>

FUJITA Tomonori schrieb:
> I added features:
> 
> - to drop an active connection by force (iSCSI)

(...)

> The initiator still works but can't reconnect anymore. It's ready to
> drop the connection.
> 
> root at iris:~/git# ./tgt/usr/tgtadm --op delete --mode conn --tid 1 --sid 1 --cid 0

Hmm, for some reason it doesn't work for me. It did work several times however, so perhaps I'm doing something wrong. I can't find what, though.


# tgtadm --op show --mode target
(...)
Target 3: iqn.2008-06.net.syneticon:superthecus.test
    System information:
        Driver: iscsi
        State: ready
    I_T nexus information:
        I_T nexus: 11
            Initiator: iqn.2006-12.net.syneticon:server.backup1
            Connection: 0
                IP Address: 192.168.111.173
    LUN information:
        LUN: 0
            Type: controller
            SCSI ID: deadbeaf3:0
            SCSI SN: beaf30
            Size: 0 MB
            Online: Yes
            Removable media: No
            Backing store: No backing store
        LUN: 1
            Type: disk
            SCSI ID: deadbeaf3:1
            SCSI SN: beaf31
            Size: 2147 MB
            Online: Yes
            Removable media: No
            Backing store: /dev/superthecus/test
    Account information:
    ACL information:
        ALL


Let's remove ACL permissions first (after that, "ALL" is gone from "ACL information"):

# tgtadm --op unbind --mode target --tid 3 -I ALL


Next thing would be this, I guess (Target 3 -> tid 3; I_T nexus: 11 -> sid 11; Connection: 0 -> cid 0)?

# tgtadm --op delete --mode conn --tid 3 --sid 11 --cid 0


However, it doesn't change anything:

# tgtadm --op show --mode target
(...)
Target 3: iqn.2008-06.net.syneticon:superthecus.test
    System information:
        Driver: iscsi
        State: ready
    I_T nexus information:
        I_T nexus: 11
            Initiator: iqn.2006-12.net.syneticon:server.backup1
            Connection: 0
                IP Address: 192.168.111.173
    LUN information:
        LUN: 0
            Type: controller
            SCSI ID: deadbeaf3:0
            SCSI SN: beaf30
            Size: 0 MB
            Online: Yes
            Removable media: No
            Backing store: No backing store
        LUN: 1
            Type: disk
            SCSI ID: deadbeaf3:1
            SCSI SN: beaf31
            Size: 2147 MB
            Online: Yes
            Removable media: No
            Backing store: /dev/superthecus/test
    Account information:
    ACL information:



-- 
Tomasz Chmielewski 
http://wpkg.org


From dorons at Voltaire.COM  Tue Jul 29 17:20:25 2008
From: dorons at Voltaire.COM (Doron Shoham)
Date: Tue, 29 Jul 2008 18:20:25 +0300
Subject: [Stgt-devel] support to close a connection by force and to shut
 down tgtd
In-Reply-To: <488F2CBE.600@wpkg.org>
References: <20080712220508D.fujita.tomonori@lab.ntt.co.jp>
	<488F2CBE.600@wpkg.org>
Message-ID: <488F3539.8090306@Voltaire.COM>

Tomasz Chmielewski wrote:
> FUJITA Tomonori schrieb:
>> I added features:
>>
>> - to drop an active connection by force (iSCSI)
> 
> (...)
> 
>> The initiator still works but can't reconnect anymore. It's ready to
>> drop the connection.
>>
>> root at iris:~/git# ./tgt/usr/tgtadm --op delete --mode conn --tid 1 --sid 1 --cid 0
> 
> Hmm, for some reason it doesn't work for me. It did work several times however, so perhaps I'm doing something wrong. I can't find what, though.
> 
> 
> # tgtadm --op show --mode target
> (...)
> Target 3: iqn.2008-06.net.syneticon:superthecus.test
>     System information:
>         Driver: iscsi
>         State: ready
>     I_T nexus information:
>         I_T nexus: 11
>             Initiator: iqn.2006-12.net.syneticon:server.backup1
>             Connection: 0
>                 IP Address: 192.168.111.173
>     LUN information:
>         LUN: 0
>             Type: controller
>             SCSI ID: deadbeaf3:0
>             SCSI SN: beaf30
>             Size: 0 MB
>             Online: Yes
>             Removable media: No
>             Backing store: No backing store
>         LUN: 1
>             Type: disk
>             SCSI ID: deadbeaf3:1
>             SCSI SN: beaf31
>             Size: 2147 MB
>             Online: Yes
>             Removable media: No
>             Backing store: /dev/superthecus/test
>     Account information:
>     ACL information:
>         ALL
> 
> 
> Let's remove ACL permissions first (after that, "ALL" is gone from "ACL information"):
> 
> # tgtadm --op unbind --mode target --tid 3 -I ALL
> 
> 
> Next thing would be this, I guess (Target 3 -> tid 3; I_T nexus: 11 -> sid 11; Connection: 0 -> cid 0)?
> 
> # tgtadm --op delete --mode conn --tid 3 --sid 11 --cid 0
> 
> 
> However, it doesn't change anything:
> 
> # tgtadm --op show --mode target
> (...)
> Target 3: iqn.2008-06.net.syneticon:superthecus.test
>     System information:
>         Driver: iscsi
>         State: ready
>     I_T nexus information:
>         I_T nexus: 11
>             Initiator: iqn.2006-12.net.syneticon:server.backup1
>             Connection: 0
>                 IP Address: 192.168.111.173
>     LUN information:
>         LUN: 0
>             Type: controller
>             SCSI ID: deadbeaf3:0
>             SCSI SN: beaf30
>             Size: 0 MB
>             Online: Yes
>             Removable media: No
>             Backing store: No backing store
>         LUN: 1
>             Type: disk
>             SCSI ID: deadbeaf3:1
>             SCSI SN: beaf31
>             Size: 2147 MB
>             Online: Yes
>             Removable media: No
>             Backing store: /dev/superthecus/test
>     Account information:
>     ACL information:
> 
> 
> 

It worked for me.
Please pay attention that the initiator is trying to re-connect.
To check it, you can delete the target right after you close the connection.

Tomo - please note that the I_T nexus id is in hex but the tgtadm accepts only decimal values.
Please change the I_T nexus id to decimal.

Doron
 


From mangoo at wpkg.org  Tue Jul 29 17:26:05 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Tue, 29 Jul 2008 17:26:05 +0200
Subject: [Stgt-devel] support to close a connection by force and to shut
 down tgtd
In-Reply-To: <488F3539.8090306@Voltaire.COM>
References: <20080712220508D.fujita.tomonori@lab.ntt.co.jp>
	<488F2CBE.600@wpkg.org> <488F3539.8090306@Voltaire.COM>
Message-ID: <488F368D.4090102@wpkg.org>

Doron Shoham schrieb:

(...)

> It worked for me.
> Please pay attention that the initiator is trying to re-connect.
> To check it, you can delete the target right after you close the connection.
> 
> Tomo - please note that the I_T nexus id is in hex but the tgtadm accepts only decimal values.
> Please change the I_T nexus id to decimal.

OK, this is why it initially worked, but then it stopped (decimal vs hex) - thanks for a hint ;)


-- 
Tomasz Chmielewski 
http://wpkg.org


From realrichardsharpe at gmail.com  Tue Jul 29 19:02:16 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Tue, 29 Jul 2008 10:02:16 -0700
Subject: [Stgt-devel] [PATCH] Make changes so that VTL stuff works
	properly ...
In-Reply-To: <46b8a8850807282228x268a9d39h602de24da549eef1@mail.gmail.com>
References: <46b8a8850807282009o3e109b6p123440ce8d92c1dd@mail.gmail.com>
	<20080729125143V.fujita.tomonori@lab.ntt.co.jp>
	<46b8a8850807282058u6f966985g8b0cabdd29b3a7ab@mail.gmail.com>
	<20080729142513D.fujita.tomonori@lab.ntt.co.jp>
	<46b8a8850807282228x268a9d39h602de24da549eef1@mail.gmail.com>
Message-ID: <46b8a8850807291002p411140e9s27fd100f3276227d@mail.gmail.com>

Here is the command I used to create DVDs ...

iscsiadm -m node -T
iqn.2008-03.com.datalane-inc:storage.dvd1.tyan1U00.sys1 -p
192.168.1.19:3260 -u
 mtx -f /dev/sg4 load 3
cdrecord -v -dao -ignsize -overburn dev=/dev/sg3 ./someDVD.iso

Here is the script I use to set up the tape library:

./usr/tgtadm --lld iscsi --op new --mode target --tid 1 -T iqn.2008-03.com.datal
ane-inc:storage.tape1.tyan1U00.sys1
./usr/tgtadm --lld iscsi --op new    --mode logicalunit --tid 1 --lun 1 -Y ssc -
-bstype ssc
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 1 --params
 vendor_id=QUANTUM,product_id=DLT7000,product_rev=0010,scsi_sn=DLMV010023,remova
ble=1
# Create the SMC device
./usr/tgtadm --lld iscsi --op new    --mode logicalunit --tid 1 --lun 2 -b /mnt/
testing/virtual-tapes/smc -Y changer
# Name it ...
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
 vendor_id=Quantum,product_id=DLT4700,product_rev=0010,scsi_sn=XYZZY_0,removable
=1
# Add a data transfer device (1 drive)
./usr/tgtadm --lld iscsi --op=update --mode logicalunit --tid 1 --lun 2 --params
 element_type=4,start_address=1,quantity=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
 element_type=4,address=1,tid=1,lun=1

# Medium Transport Elements
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
 element_type=1,start_address=16,quantity=1

# Define the path to the virtual tapes
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
 media_home=/mnt/testing/virtual-tapes

# Add media to slots ...
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
 element_type=2,start_address=1024,quantity=8
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
 element_type=2,address=1024,barcode=TAPE0000,sides=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
 element_type=2,address=1025,barcode=TAPE0001,sides=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
 element_type=2,address=1026,barcode=TAPE0002,sides=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
 element_type=2,address=1027,barcode=TAPE0003,sides=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
 element_type=2,address=1028,barcode=TAPE0004,sides=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
 element_type=2,address=1029,barcode=TAPE0005,sides=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
 element_type=2,address=1030,barcode=TAPE0006,sides=1
./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
 element_type=2,address=1031,barcode=TAPE0007,sides=1

./usr/tgtadm --lld iscsi --op show   --mode target
./usr/tgtadm --lld iscsi --op bind   --mode target --tid 1 -I ALL

I used mtx to load a tape and then tar to save a job


From realrichardsharpe at gmail.com  Wed Jul 30 00:26:10 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Tue, 29 Jul 2008 15:26:10 -0700
Subject: [Stgt-devel] SSC Fixed block and File Marks ...
Message-ID: <46b8a8850807291526r8bfd74cs6c0388034116340a@mail.gmail.com>

Hi,

Well, it seems easy to provoke false positives with the current
approach in the SSC code to tape marks.

I ran bacula's btape command to test my Virtual tapes, and this is
what I get in the log:

tgtd: rdwr_request(75) buf[0]=91tgtd: rdwr_request(75)
buf[512]=28tgtd: rdwr_request(93) File Mark Detected at 512, Residue =
32768000 Success^M
tgtd: rdwr_request(75) buf[1024]=28tgtd: rdwr_request(93) File Mark
Detected at 1024, Residue = 32505856 Success^M


Needless to say, those are not file marks ...


From fujita.tomonori at lab.ntt.co.jp  Wed Jul 30 00:42:54 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 30 Jul 2008 07:42:54 +0900
Subject: [Stgt-devel] support to close a connection by force and to shut
 down tgtd
In-Reply-To: <488F3539.8090306@Voltaire.COM>
References: <20080712220508D.fujita.tomonori@lab.ntt.co.jp>
	<488F2CBE.600@wpkg.org> <488F3539.8090306@Voltaire.COM>
Message-ID: <20080730063657N.tomof@acm.org>

On Tue, 29 Jul 2008 18:20:25 +0300
Doron Shoham <dorons at Voltaire.COM> wrote:

> Tomo - please note that the I_T nexus id is in hex but the tgtadm
> accepts only decimal values.  Please change the I_T nexus id to
> decimal.

Ah, thanks a lot! I didn't notice this at all.

I've applied the following patch.

=
From: FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp>
Subject: [PATCH] use decimal notation for the id of I_T nexus in the show option

Now we use hexadecimal notation but it's confusing since we use
decimal notation for other things in the show option.

Reported-by: Doron Shoham <dorons at Voltaire.com>
Signed-off-by: FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp>
---
 usr/target.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/usr/target.c b/usr/target.c
index 7abaa54..0ae1b3e 100644
--- a/usr/target.c
+++ b/usr/target.c
@@ -1549,7 +1549,7 @@ int tgt_target_show_all(char *buf, int rest)
 		shprintf(total, buf, rest, _TAB1 "I_T nexus information:\n");
 
 		list_for_each_entry(nexus, &target->it_nexus_list, nexus_siblings) {
-			shprintf(total, buf, rest, _TAB2 "I_T nexus: %" PRIx64 "\n",
+			shprintf(total, buf, rest, _TAB2 "I_T nexus: %" PRIu64 "\n",
 				 nexus->itn_id);
 			if (nexus->info)
 				shprintf(total, buf, rest, "%s", nexus->info);
-- 
1.5.4.2



From fujita.tomonori at lab.ntt.co.jp  Wed Jul 30 00:43:09 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 30 Jul 2008 07:43:09 +0900
Subject: [Stgt-devel] [PATCH] changing state of targets via tgt-admin
In-Reply-To: <488EF053.4050906@wpkg.org>
References: <488EF053.4050906@wpkg.org>
Message-ID: <20080730074250Z.fujita.tomonori@lab.ntt.co.jp>

On Tue, 29 Jul 2008 12:26:27 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> Add a possibility to change the state (offline or ready) of targets.
> 
> It is possible to offline/ready all targets, target specified with its name (i.e. iqn.2008-08.com.example:some.target) or tid.
> 
> This is an example usage help for the --offline option (--ready works in the same way):
> 
> # ./tgt-admin --offline help
> "./tgt-admin --offline <value>" - offline all or selected targets.
> 
> Example usage:
>         --offline help  - display this help
>         --offline ALL   - offline all targets
>         --offline tid=4 - offline target 4 (target with tid 4)
>         --offline iqn.2008-08.com.example:some.target - offline this target
> 
> 
> Signed-off-by: Tomasz Chmielewski <mangoo at wpkg.org>

Looks a nice feature. Applied, thanks.


From realrichardsharpe at gmail.com  Wed Jul 30 01:44:56 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Tue, 29 Jul 2008 16:44:56 -0700
Subject: [Stgt-devel] Dealing with filemarks in SSC ...
Message-ID: <46b8a8850807291644l6af714cct43b7b88a3918e013@mail.gmail.com>

I have been looking at this issue of filemarks in SSC, and it seems to
me that there are a couple of questions that need to be answered.

For example, if there are two file marks on a tape, or even three, and
you write records onto the tape and overwrite one of the file marks,
in some sense the drive should still be able to seek to the old second
filemark (now the first filemark) ... and reliably recover the third
file on the tape.

I don't know if any software depends on that behavior, though.


From mark_harvey at symantec.com  Wed Jul 30 01:47:28 2008
From: mark_harvey at symantec.com (Mark Harvey)
Date: Tue, 29 Jul 2008 16:47:28 -0700
Subject: [Stgt-devel] SSC Fixed block and File Marks ...
In-Reply-To: <46b8a8850807291526r8bfd74cs6c0388034116340a@mail.gmail.com>
References: <46b8a8850807291526r8bfd74cs6c0388034116340a@mail.gmail.com>
Message-ID: <B3E98EAC5926D5498DDD341AE4B7D21C04758A2A@TUS1XCHCLUPIN05.enterprise.veritas.com>

Yep - One of the issues I raised on the initial patch.

Cheers
Mark

-----Original Message-----
From: stgt-devel-bounces at lists.berlios.de
[mailto:stgt-devel-bounces at lists.berlios.de] On Behalf Of Richard Sharpe
Sent: Wednesday, July 30, 2008 8:26 AM
To: stgt-devel
Subject: [Stgt-devel] SSC Fixed block and File Marks ...

Hi,

Well, it seems easy to provoke false positives with the current
approach in the SSC code to tape marks.

I ran bacula's btape command to test my Virtual tapes, and this is
what I get in the log:

tgtd: rdwr_request(75) buf[0]=91tgtd: rdwr_request(75)
buf[512]=28tgtd: rdwr_request(93) File Mark Detected at 512, Residue =
32768000 Success^M
tgtd: rdwr_request(75) buf[1024]=28tgtd: rdwr_request(93) File Mark
Detected at 1024, Residue = 32505856 Success^M


Needless to say, those are not file marks ...
_______________________________________________
Stgt-devel mailing list
Stgt-devel at lists.berlios.de
https://lists.berlios.de/mailman/listinfo/stgt-devel


From mark_harvey at symantec.com  Wed Jul 30 01:54:40 2008
From: mark_harvey at symantec.com (Mark Harvey)
Date: Tue, 29 Jul 2008 16:54:40 -0700
Subject: [Stgt-devel] Dealing with filemarks in SSC ...
In-Reply-To: <46b8a8850807291644l6af714cct43b7b88a3918e013@mail.gmail.com>
References: <46b8a8850807291644l6af714cct43b7b88a3918e013@mail.gmail.com>
Message-ID: <B3E98EAC5926D5498DDD341AE4B7D21C04758A30@TUS1XCHCLUPIN05.enterprise.veritas.com>

Both NetBackup and NetWorker use the following filemark handling.

[data][filemark1][data][filemark1][data][filemark1][filemark2]

Using the 'bsd' close (vs AT&T close), the tape head is positioned after
[filemark1] and before [filemark2]. A new 'write' command will overwrite
[filemark2].

Using this method, end of valid backup data is easily detected by two
consecutive filemarks on tape. If there is only one filemark, there is
more valid data to follow.

Note: filemark1 and filemark2 are just 'filemarks' - they are not
different types of filemarks. (Just in case this created any sort of
confusion).

Cheers
Mark

-----Original Message-----
From: stgt-devel-bounces at lists.berlios.de
[mailto:stgt-devel-bounces at lists.berlios.de] On Behalf Of Richard Sharpe
Sent: Wednesday, July 30, 2008 9:45 AM
To: stgt-devel
Subject: [Stgt-devel] Dealing with filemarks in SSC ...

I have been looking at this issue of filemarks in SSC, and it seems to
me that there are a couple of questions that need to be answered.

For example, if there are two file marks on a tape, or even three, and
you write records onto the tape and overwrite one of the file marks,
in some sense the drive should still be able to seek to the old second
filemark (now the first filemark) ... and reliably recover the third
file on the tape.

I don't know if any software depends on that behavior, though.
_______________________________________________
Stgt-devel mailing list
Stgt-devel at lists.berlios.de
https://lists.berlios.de/mailman/listinfo/stgt-devel


From mark_harvey at symantec.com  Wed Jul 30 02:26:44 2008
From: mark_harvey at symantec.com (Mark Harvey)
Date: Tue, 29 Jul 2008 17:26:44 -0700
Subject: [Stgt-devel] Dealing with filemarks in SSC ...
In-Reply-To: <46b8a8850807291716h362cde5apc1033063035810a6@mail.gmail.com>
References: <46b8a8850807291644l6af714cct43b7b88a3918e013@mail.gmail.com>
	<B3E98EAC5926D5498DDD341AE4B7D21C04758A30@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<46b8a8850807291716h362cde5apc1033063035810a6@mail.gmail.com>
Message-ID: <B3E98EAC5926D5498DDD341AE4B7D21C04758A54@TUS1XCHCLUPIN05.enterprise.veritas.com>

No, an AT&T unix 'close' will position after the filemark... The bsd
unix close positions before the filemark.

Hence if you use the wrong device (mainly a Solaris thing) the backup
s/w gets confused due to multiple filemarks between data.
e.g.
/dev/rmt/0cn (at&t close)
Vs
/dev/rmt/0cbn (bsd close)

With Linux, you need to perform some sort of ioctl() to change the
device close behavior Thankfully, Linux defaults to bsd behaviour.

Cheers
Mark

-----Original Message-----
From: Richard Sharpe [mailto:realrichardsharpe at gmail.com] 
Sent: Wednesday, July 30, 2008 10:17 AM
To: Mark Harvey
Subject: Re: [Stgt-devel] Dealing with filemarks in SSC ...

On Tue, Jul 29, 2008 at 4:54 PM, Mark Harvey <mark_harvey at symantec.com>
wrote:
> Both NetBackup and NetWorker use the following filemark handling.
>
> [data][filemark1][data][filemark1][data][filemark1][filemark2]
>
> Using the 'bsd' close (vs AT&T close), the tape head is positioned
after
> [filemark1] and before [filemark2]. A new 'write' command will
overwrite
> [filemark2].

So, reading between the lines, if you have been writing, a BSD close
writes two filemarks and then positions the tape between them ...

> Using this method, end of valid backup data is easily detected by two
> consecutive filemarks on tape. If there is only one filemark, there is
> more valid data to follow.
>
> Note: filemark1 and filemark2 are just 'filemarks' - they are not
> different types of filemarks. (Just in case this created any sort of
> confusion).
>
> Cheers
> Mark
>
> -----Original Message-----
> From: stgt-devel-bounces at lists.berlios.de
> [mailto:stgt-devel-bounces at lists.berlios.de] On Behalf Of Richard
Sharpe
> Sent: Wednesday, July 30, 2008 9:45 AM
> To: stgt-devel
> Subject: [Stgt-devel] Dealing with filemarks in SSC ...
>
> I have been looking at this issue of filemarks in SSC, and it seems to
> me that there are a couple of questions that need to be answered.
>
> For example, if there are two file marks on a tape, or even three, and
> you write records onto the tape and overwrite one of the file marks,
> in some sense the drive should still be able to seek to the old second
> filemark (now the first filemark) ... and reliably recover the third
> file on the tape.
>
> I don't know if any software depends on that behavior, though.
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From markh794 at gmail.com  Wed Jul 30 04:45:05 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Wed, 30 Jul 2008 12:45:05 +1000
Subject: [Stgt-devel] [PATCH] Make changes so that VTL stuff works
	properly ...
In-Reply-To: <46b8a8850807291002p411140e9s27fd100f3276227d@mail.gmail.com>
References: <46b8a8850807282009o3e109b6p123440ce8d92c1dd@mail.gmail.com>
	<20080729125143V.fujita.tomonori@lab.ntt.co.jp>
	<46b8a8850807282058u6f966985g8b0cabdd29b3a7ab@mail.gmail.com>
	<20080729142513D.fujita.tomonori@lab.ntt.co.jp>
	<46b8a8850807282228x268a9d39h602de24da549eef1@mail.gmail.com>
	<46b8a8850807291002p411140e9s27fd100f3276227d@mail.gmail.com>
Message-ID: <f29db9a80807291945s186b1236o87d63f44d0e87869@mail.gmail.com>

OK, I've reproduced the core dump as well.

All my testing involved running the scripts/tgt-core-setup script.

This script (incorrectly) adds a backing file - so I never experienced
this core dump. When configured to startup with a backing file - loads
and unloads work without error.

Setting up the device without an initial backing file results in the
core dump once a write is attempted.

Cheers
Mark

On Wed, Jul 30, 2008 at 3:02 AM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> Here is the command I used to create DVDs ...
>
> iscsiadm -m node -T
> iqn.2008-03.com.datalane-inc:storage.dvd1.tyan1U00.sys1 -p
> 192.168.1.19:3260 -u
>  mtx -f /dev/sg4 load 3
> cdrecord -v -dao -ignsize -overburn dev=/dev/sg3 ./someDVD.iso
>
> Here is the script I use to set up the tape library:
>
> ./usr/tgtadm --lld iscsi --op new --mode target --tid 1 -T iqn.2008-03.com.datal
> ane-inc:storage.tape1.tyan1U00.sys1
> ./usr/tgtadm --lld iscsi --op new    --mode logicalunit --tid 1 --lun 1 -Y ssc -
> -bstype ssc
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 1 --params
>  vendor_id=QUANTUM,product_id=DLT7000,product_rev=0010,scsi_sn=DLMV010023,remova
> ble=1
> # Create the SMC device
> ./usr/tgtadm --lld iscsi --op new    --mode logicalunit --tid 1 --lun 2 -b /mnt/
> testing/virtual-tapes/smc -Y changer
> # Name it ...
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
>  vendor_id=Quantum,product_id=DLT4700,product_rev=0010,scsi_sn=XYZZY_0,removable
> =1
> # Add a data transfer device (1 drive)
> ./usr/tgtadm --lld iscsi --op=update --mode logicalunit --tid 1 --lun 2 --params
>  element_type=4,start_address=1,quantity=1
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
>  element_type=4,address=1,tid=1,lun=1
>
> # Medium Transport Elements
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
>  element_type=1,start_address=16,quantity=1
>
> # Define the path to the virtual tapes
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
>  media_home=/mnt/testing/virtual-tapes
>
> # Add media to slots ...
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
>  element_type=2,start_address=1024,quantity=8
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
>  element_type=2,address=1024,barcode=TAPE0000,sides=1
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
>  element_type=2,address=1025,barcode=TAPE0001,sides=1
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
>  element_type=2,address=1026,barcode=TAPE0002,sides=1
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
>  element_type=2,address=1027,barcode=TAPE0003,sides=1
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
>  element_type=2,address=1028,barcode=TAPE0004,sides=1
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
>  element_type=2,address=1029,barcode=TAPE0005,sides=1
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
>  element_type=2,address=1030,barcode=TAPE0006,sides=1
> ./usr/tgtadm --lld iscsi --op update --mode logicalunit --tid 1 --lun 2 --params
>  element_type=2,address=1031,barcode=TAPE0007,sides=1
>
> ./usr/tgtadm --lld iscsi --op show   --mode target
> ./usr/tgtadm --lld iscsi --op bind   --mode target --tid 1 -I ALL
>
> I used mtx to load a tape and then tar to save a job
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From fujita.tomonori at lab.ntt.co.jp  Wed Jul 30 04:52:55 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 30 Jul 2008 11:52:55 +0900
Subject: [Stgt-devel] [PATCH] Make changes so that VTL stuff
	works	properly ...
In-Reply-To: <f29db9a80807291945s186b1236o87d63f44d0e87869@mail.gmail.com>
References: <46b8a8850807282228x268a9d39h602de24da549eef1@mail.gmail.com>
	<46b8a8850807291002p411140e9s27fd100f3276227d@mail.gmail.com>
	<f29db9a80807291945s186b1236o87d63f44d0e87869@mail.gmail.com>
Message-ID: <20080730115246D.fujita.tomonori@lab.ntt.co.jp>

On Wed, 30 Jul 2008 12:45:05 +1000
"Mark Harvey" <markh794 at gmail.com> wrote:

> OK, I've reproduced the core dump as well.
> 
> All my testing involved running the scripts/tgt-core-setup script.
> 
> This script (incorrectly) adds a backing file - so I never experienced
> this core dump. When configured to startup with a backing file - loads
> and unloads work without error.
> 
> Setting up the device without an initial backing file results in the
> core dump once a write is attempted.

Should I apply Richard's patch (Make changes so that VTL stuff works
properly)? Or we need cleanups before applying it?

Sorry, I have not had a chance to reproduce it and read the patch yet.


From markh794 at gmail.com  Wed Jul 30 05:28:29 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Wed, 30 Jul 2008 13:28:29 +1000
Subject: [Stgt-devel] [PATCH] Make changes so that VTL stuff works
	properly ...
In-Reply-To: <20080730115246D.fujita.tomonori@lab.ntt.co.jp>
References: <46b8a8850807282228x268a9d39h602de24da549eef1@mail.gmail.com>
	<46b8a8850807291002p411140e9s27fd100f3276227d@mail.gmail.com>
	<f29db9a80807291945s186b1236o87d63f44d0e87869@mail.gmail.com>
	<20080730115246D.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <f29db9a80807292028y12ac380bk6f9eaa65a24678b6@mail.gmail.com>

My concern is with

tgt_device_path_update()
{
    if(lu->path) {
        ....
        lu->bst->bs_close(lu);
        ....
    }
}

bs_close()
{
    ....
    bs_thread_close();
    ....
}


What will occur if there are multiple LU attached to this target and
one LU is activately being read/written to while another LU has its
backing file path updated ?

I assume - multithreaded code is new experence for me - that we will
result in a core dump as the backing store threads have been torn
down.

Cheers
Mark

On Wed, Jul 30, 2008 at 12:52 PM, FUJITA Tomonori
<fujita.tomonori at lab.ntt.co.jp> wrote:
> On Wed, 30 Jul 2008 12:45:05 +1000
> "Mark Harvey" <markh794 at gmail.com> wrote:
>
>> OK, I've reproduced the core dump as well.
>>
>> All my testing involved running the scripts/tgt-core-setup script.
>>
>> This script (incorrectly) adds a backing file - so I never experienced
>> this core dump. When configured to startup with a backing file - loads
>> and unloads work without error.
>>
>> Setting up the device without an initial backing file results in the
>> core dump once a write is attempted.
>
> Should I apply Richard's patch (Make changes so that VTL stuff works
> properly)? Or we need cleanups before applying it?
>
> Sorry, I have not had a chance to reproduce it and read the patch yet.
>


From agasheac at gmail.com  Wed Jul 30 05:39:36 2008
From: agasheac at gmail.com (aniket agashe)
Date: Tue, 29 Jul 2008 21:39:36 -0600
Subject: [Stgt-devel] iser target installation
Message-ID: <d937bde80807292039h7366ad94q469b8b0da049e68d@mail.gmail.com>

i m having problem in installing scsi-target-utils-0.1-20080629.x86_64.rpm
as failed dependencies libcrypto.so.6(64 bit) required.
So i tried to use tgt-20080715.tar file i  compiled it with optin
make ISCSI=1 ISCSI_RDMA=1
and tried to run tgtd demon but it is not showing any output even with -d 9
option.


but when i m trying to run tgtadm it is showing tgtd demon is not running



Also it is written in README that target demon requires openssl toolkit


i hv currently RHEL4-U4-x86_64 WS installed on my machine

please help me out
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080729/1b98e820/attachment.html>

From markh794 at gmail.com  Wed Jul 30 05:40:46 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Wed, 30 Jul 2008 13:40:46 +1000
Subject: [Stgt-devel] [PATCH] Make changes so that VTL stuff works
	properly ...
In-Reply-To: <f29db9a80807292028y12ac380bk6f9eaa65a24678b6@mail.gmail.com>
References: <46b8a8850807282228x268a9d39h602de24da549eef1@mail.gmail.com>
	<46b8a8850807291002p411140e9s27fd100f3276227d@mail.gmail.com>
	<f29db9a80807291945s186b1236o87d63f44d0e87869@mail.gmail.com>
	<20080730115246D.fujita.tomonori@lab.ntt.co.jp>
	<f29db9a80807292028y12ac380bk6f9eaa65a24678b6@mail.gmail.com>
Message-ID: <f29db9a80807292040w22d206f2w7365fe3c9320febf@mail.gmail.com>

On Wed, Jul 30, 2008 at 1:28 PM, Mark Harvey <markh794 at gmail.com> wrote:
> My concern is with
>
> tgt_device_path_update()
> {
>    if(lu->path) {
>        ....
>        lu->bst->bs_close(lu);
>        ....
>    }
> }
>
> bs_close()
> {
>    ....
>    bs_thread_close();
>    ....
> }
>
>
> What will occur if there are multiple LU attached to this target and
> one LU is activately being read/written to while another LU has its
> backing file path updated ?
>
> I assume - multithreaded code is new experence for me - that we will
> result in a core dump as the backing store threads have been torn
> down.
>
> Cheers
> Mark

Sorry - forgot to add. If this is the case, Richards patch will not
fix the over-all problem.

The dtd_load_unload() only opens/closes the backing file. It does not
attempt to initialize the threads.


I feel the correct fix for this is:

To add  bs_init()/bs_exit() ?? hook to initialize/shutdown the threads.
And the bs_open()/bs_close() to open/close the backing store file.

The bs_init() should be called at setup time and bs_open()/bs_close()
when media loaded or unloaded.

I'll attempt to put something in code this afternoon and post a POC patch.

Cheers
Mark
>
> On Wed, Jul 30, 2008 at 12:52 PM, FUJITA Tomonori
> <fujita.tomonori at lab.ntt.co.jp> wrote:
>> On Wed, 30 Jul 2008 12:45:05 +1000
>> "Mark Harvey" <markh794 at gmail.com> wrote:
>>
>>> OK, I've reproduced the core dump as well.
>>>
>>> All my testing involved running the scripts/tgt-core-setup script.
>>>
>>> This script (incorrectly) adds a backing file - so I never experienced
>>> this core dump. When configured to startup with a backing file - loads
>>> and unloads work without error.
>>>
>>> Setting up the device without an initial backing file results in the
>>> core dump once a write is attempted.
>>
>> Should I apply Richard's patch (Make changes so that VTL stuff works
>> properly)? Or we need cleanups before applying it?
>>
>> Sorry, I have not had a chance to reproduce it and read the patch yet.
>>
>


From mangoo at wpkg.org  Wed Jul 30 08:06:21 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Wed, 30 Jul 2008 08:06:21 +0200
Subject: [Stgt-devel] support to close a connection by force and to shut
 down tgtd
In-Reply-To: <20080730063657N.tomof@acm.org>
References: <20080712220508D.fujita.tomonori@lab.ntt.co.jp>	<488F2CBE.600@wpkg.org>	<488F3539.8090306@Voltaire.COM>
	<20080730063657N.tomof@acm.org>
Message-ID: <489004DD.4000105@wpkg.org>

FUJITA Tomonori schrieb:
> On Tue, 29 Jul 2008 18:20:25 +0300
> Doron Shoham <dorons at Voltaire.COM> wrote:
> 
>> Tomo - please note that the I_T nexus id is in hex but the tgtadm
>> accepts only decimal values.  Please change the I_T nexus id to
>> decimal.
> 
> Ah, thanks a lot! I didn't notice this at all.

BTW - can "cid" ("Connection") have a different value than 0?

    I_T nexus information:
        I_T nexus: 64
            Initiator: iqn.2006-08.net...
            Connection: 0
                IP Address: 192.168.61.11
        I_T nexus: 97
            Initiator: iqn.2008-01.net...
            Connection: 0
                IP Address: 192.168.61.10
        I_T nexus: a7
            Initiator: iqn.2007-06.net...
            Connection: 0
                IP Address: 192.168.61.18


-- 
Tomasz Chmielewski
http://wpkg.org



From fujita.tomonori at lab.ntt.co.jp  Wed Jul 30 09:04:13 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 30 Jul 2008 16:04:13 +0900
Subject: [Stgt-devel] [PATCH] Make changes so that VTL stuff
	works	properly ...
In-Reply-To: <f29db9a80807292040w22d206f2w7365fe3c9320febf@mail.gmail.com>
References: <20080730115246D.fujita.tomonori@lab.ntt.co.jp>
	<f29db9a80807292028y12ac380bk6f9eaa65a24678b6@mail.gmail.com>
	<f29db9a80807292040w22d206f2w7365fe3c9320febf@mail.gmail.com>
Message-ID: <20080730160405U.fujita.tomonori@lab.ntt.co.jp>

On Wed, 30 Jul 2008 13:40:46 +1000
"Mark Harvey" <markh794 at gmail.com> wrote:

> On Wed, Jul 30, 2008 at 1:28 PM, Mark Harvey <markh794 at gmail.com> wrote:
> > My concern is with
> >
> > tgt_device_path_update()
> > {
> >    if(lu->path) {
> >        ....
> >        lu->bst->bs_close(lu);
> >        ....
> >    }
> > }
> >
> > bs_close()
> > {
> >    ....
> >    bs_thread_close();
> >    ....
> > }
> >
> >
> > What will occur if there are multiple LU attached to this target and
> > one LU is activately being read/written to while another LU has its
> > backing file path updated ?

Do you mean, we might kill threads that are touching other LUs in the
target?

If so, we are safe in regard to it. Each LU has the own threads (a
thread doesn't touch multiple LUs).

BTW, we will remove the thread code and use the single thread mode in
the future... We have it just because Linux AIO is not good enough
now.


> > I assume - multithreaded code is new experence for me - that we will
> > result in a core dump as the backing store threads have been torn
> > down.
> >
> > Cheers
> > Mark
> 
> Sorry - forgot to add. If this is the case, Richards patch will not
> fix the over-all problem.
> 
> The dtd_load_unload() only opens/closes the backing file. It does not
> attempt to initialize the threads.
> 
> 
> I feel the correct fix for this is:
> 
> To add  bs_init()/bs_exit() ?? hook to initialize/shutdown the threads.
> And the bs_open()/bs_close() to open/close the backing store file.
> 
> The bs_init() should be called at setup time and bs_open()/bs_close()
> when media loaded or unloaded.
> 
> I'll attempt to put something in code this afternoon and post a POC patch.

Yeah, as you said, we could have bs_init,exit,open/close. But I guess,
dtd_load_unload is ok even if we shutdown and initialize the threads
(though it's not optimal but it works).

Probably, we should unify dtd_load_unload and tgt_device_path_update
(I should have done when I added tgt_device_path_update).


From markh794 at gmail.com  Wed Jul 30 09:44:25 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Wed, 30 Jul 2008 17:44:25 +1000
Subject: [Stgt-devel] [PATCH] Proof of Concept -> Separate thread
 init/tear-down from backing store open/close.
Message-ID: <48901BD9.7050104@gmail.com>

Patch also included as an attachment - just in case.

>From 715e434fff633ff8f346d181aeae3f27c9564553 Mon Sep 17 00:00:00 2001
From: Mark Harvey <markh794 at gmail.com>
Date: Wed, 30 Jul 2008 17:27:28 +1000
Subject: Separate thread init/tear-down from backing store open/close.

Fix segfault when lu created without a backing store.
 - Devices defined as 'removable' are able to be configured without a backing
   store defined.
 - thread init via bs_init() which is called for all logical units
 - thread tear-down via bs_exit() which is called for all logical units.
 - bs_open() limited to opening backing store path (called when required).
 - bs_close() limited to closing backing store fd (called when required).

Note: bs_aio and bs_mmap compile-tested only.

Signed-off-by: Mark Harvey <markh794 at gmail.com>
---
 usr/bs_aio.c  |   25 +++++++++++++++++--------
 usr/bs_mmap.c |   22 ++++++++++++----------
 usr/bs_rdwr.c |   25 ++++++++++++++-----------
 usr/bs_ssc.c  |   25 +++++++++++++------------
 usr/target.c  |   15 ++++++++++++---
 usr/tgtd.h    |    2 ++
 6 files changed, 70 insertions(+), 44 deletions(-)

diff --git a/usr/bs_aio.c b/usr/bs_aio.c
index b953bdf..0d6a640 100644
--- a/usr/bs_aio.c
+++ b/usr/bs_aio.c
@@ -112,18 +112,22 @@ get_events:
 
 static int bs_aio_open(struct scsi_lu *lu, char *path, int *fd, uint64_t *size)
 {
-	int ret, afd;
-	struct bs_aio_info *info =
-		(struct bs_aio_info *) ((char *)lu + sizeof(*lu));
-
 	*fd = backed_file_open(path, O_RDWR|O_LARGEFILE|O_DIRECT, size);
 	if (*fd < 0)
 		return *fd;
+	return 0;
+}
+
+static int bs_aio_init(struct scsi_lu *lu)
+{
+	int ret, afd;
+	struct bs_aio_info *info =
+		(struct bs_aio_info *) ((char *)lu + sizeof(*lu));
 
 	ret = io_setup(MAX_AIO_REQS, &info->ctx);
 	if (ret) {
 		eprintf("fail to create aio_queue, %m\n");
-		goto close_dev_fd;
+		return -1;
 	}
 
 	afd = eventfd(0);
@@ -145,23 +149,26 @@ static int bs_aio_open(struct scsi_lu *lu, char *path, int *fd, uint64_t *size)
 	info->afd = afd;
 
 	return 0;
+
 close_eventfd:
 	close(afd);
 close_ctx:
 	io_destroy(info->ctx);
-close_dev_fd:
-	close(*fd);
 	return -1;
 }
 
 static void bs_aio_close(struct scsi_lu *lu)
 {
+	close(lu->fd);
+}
+
+static void bs_aio_exit(struct scsi_lu *lu)
+{
 	struct bs_aio_info *info =
 		(struct bs_aio_info *) ((char *)lu + sizeof(*lu));
 
 	close(info->afd);
 	io_destroy(info->ctx);
-	close(lu->fd);
 }
 
 static int bs_aio_cmd_submit(struct scsi_cmd *cmd)
@@ -226,6 +233,8 @@ static int bs_aio_cmd_done(struct scsi_cmd *cmd)
 static struct backingstore_template aio_bst = {
 	.bs_name		= "aio",
 	.bs_datasize		= sizeof(struct bs_aio_info),
+	.bs_init		= bs_aio_init,
+	.bs_exit		= bs_aio_exit,
 	.bs_open		= bs_aio_open,
 	.bs_close		= bs_aio_close,
 	.bs_cmd_submit		= bs_aio_cmd_submit,
diff --git a/usr/bs_mmap.c b/usr/bs_mmap.c
index d9bfe46..fff19d3 100644
--- a/usr/bs_mmap.c
+++ b/usr/bs_mmap.c
@@ -81,28 +81,28 @@ static void bs_mmap_request(struct scsi_cmd *cmd)
 
 static int bs_mmap_open(struct scsi_lu *lu, char *path, int *fd, uint64_t *size)
 {
-	int ret;
-	struct bs_thread_info *info = BS_THREAD_I(lu);
-
 	*fd = backed_file_open(path, O_RDWR| O_LARGEFILE, size);
 	if (*fd < 0)
 		return *fd;
 
-	ret = bs_thread_open(info, bs_mmap_request);
-	if (ret) {
-		close(*fd);
-		return -1;
-	}
-
 	return 0;
 }
 
 static void bs_mmap_close(struct scsi_lu *lu)
 {
+	close(lu->fd);
+}
+
+static int bs_mmap_init(struct scsi_lu *lu)
+{
 	struct bs_thread_info *info = BS_THREAD_I(lu);
+	return bs_thread_open(info, bs_mmap_request);
+}
 
+static void bs_mmap_exit(struct scsi_lu *lu)
+{
+	struct bs_thread_info *info = BS_THREAD_I(lu);
 	bs_thread_close(info);
-	close(lu->fd);
 }
 
 #define pgcnt(size, offset)	((((size) + ((offset) & (pagesize - 1))) + (pagesize - 1)) >> pageshift)
@@ -173,6 +173,8 @@ static int bs_mmap_cmd_done(struct scsi_cmd *cmd)
 static struct backingstore_template mmap_bst = {
 	.bs_name		= "mmap",
 	.bs_datasize		= sizeof(struct bs_thread_info),
+	.bs_init		= bs_mmap_init,
+	.bs_exit		= bs_mmap_exit,
 	.bs_open		= bs_mmap_open,
 	.bs_close		= bs_mmap_close,
 	.bs_cmd_submit		= bs_mmap_cmd_submit,
diff --git a/usr/bs_rdwr.c b/usr/bs_rdwr.c
index d3ce452..e2ece4a 100644
--- a/usr/bs_rdwr.c
+++ b/usr/bs_rdwr.c
@@ -131,29 +131,30 @@ static void bs_rdwr_request(struct scsi_cmd *cmd)
 
 static int bs_rdwr_open(struct scsi_lu *lu, char *path, int *fd, uint64_t *size)
 {
-	int ret;
-	struct bs_thread_info *info = BS_THREAD_I(lu);
-
 	*fd = backed_file_open(path, O_RDWR| O_LARGEFILE, size);
 	if (*fd < 0)
 		return *fd;
 
-	ret = bs_thread_open(info, bs_rdwr_request);
-	if (ret) {
-		close(*fd);
-		return -1;
-	}
-
 	return 0;
 }
 
 static void bs_rdwr_close(struct scsi_lu *lu)
 {
+	close(lu->fd);
+}
+
+static int bs_rdwr_init(struct scsi_lu *lu)
+{
 	struct bs_thread_info *info = BS_THREAD_I(lu);
 
-	bs_thread_close(info);
+	return bs_thread_open(info, bs_rdwr_request);
+}
 
-	close(lu->fd);
+static void bs_rdwr_exit(struct scsi_lu *lu)
+{
+	struct bs_thread_info *info = BS_THREAD_I(lu);
+
+	bs_thread_close(info);
 }
 
 static int bs_rdwr_cmd_done(struct scsi_cmd *cmd)
@@ -166,6 +167,8 @@ static struct backingstore_template rdwr_bst = {
 	.bs_datasize		= sizeof(struct bs_thread_info),
 	.bs_open		= bs_rdwr_open,
 	.bs_close		= bs_rdwr_close,
+	.bs_init		= bs_rdwr_init,
+	.bs_exit		= bs_rdwr_exit,
 	.bs_cmd_submit		= bs_thread_cmd_submit,
 	.bs_cmd_done		= bs_rdwr_cmd_done,
 };
diff --git a/usr/bs_ssc.c b/usr/bs_ssc.c
index c1aa91e..dcc3e30 100644
--- a/usr/bs_ssc.c
+++ b/usr/bs_ssc.c
@@ -19,7 +19,7 @@
 #define LONG_BIT            2
 #define BT_BIT              1
 
-static void rdwr_request(struct scsi_cmd *cmd)
+static void ssc_rdwr_request(struct scsi_cmd *cmd)
 {
 	int ret, fd = cmd->dev->fd, code;
 	uint32_t length, i, transfer_length, residue;
@@ -184,11 +184,8 @@ static void rdwr_request(struct scsi_cmd *cmd)
 			cmd, cmd->scb[0], ret, length, cmd->offset);
 }
 
-
 static int bs_ssc_open(struct scsi_lu *lu, char *path, int *fd, uint64_t *size)
 {
-	int ret;
-	struct bs_thread_info *info = BS_THREAD_I(lu);
 	uint64_t curr_pos;
 
 	eprintf("In bs_ssc_open\n");
@@ -200,22 +197,24 @@ static int bs_ssc_open(struct scsi_lu *lu, char *path, int *fd, uint64_t *size)
 	curr_pos = lseek(*fd, 0, SEEK_CUR);
 	eprintf("File %s File Pointer at %" PRIu64",%m\n", path, curr_pos);
 
-	ret = bs_thread_open(info, rdwr_request);
-	if (ret) {
-		close(*fd);
-		return -1;
-	}
-
 	return 0;
 }
 
 static void bs_ssc_close(struct scsi_lu *lu)
 {
+	close(lu->fd);
+}
+
+static int bs_ssc_init(struct scsi_lu *lu)
+{
 	struct bs_thread_info *info = BS_THREAD_I(lu);
+	return bs_thread_open(info, ssc_rdwr_request);
+}
 
+static void bs_ssc_exit(struct scsi_lu *lu)
+{
+	struct bs_thread_info *info = BS_THREAD_I(lu);
 	bs_thread_close(info);
-
-	close(lu->fd);
 }
 
 static int bs_ssc_cmd_done(struct scsi_cmd *cmd)
@@ -226,6 +225,8 @@ static int bs_ssc_cmd_done(struct scsi_cmd *cmd)
 static struct backingstore_template ssc_bst = {
 	.bs_name		= "ssc",
 	.bs_datasize		= sizeof(struct bs_thread_info),
+	.bs_init		= bs_ssc_init,
+	.bs_exit		= bs_ssc_exit,
 	.bs_open		= bs_ssc_open,
 	.bs_close		= bs_ssc_close,
 	.bs_cmd_submit		= bs_thread_cmd_submit,
diff --git a/usr/target.c b/usr/target.c
index 7abaa54..53eba81 100644
--- a/usr/target.c
+++ b/usr/target.c
@@ -488,6 +488,9 @@ int tgt_device_create(int tid, int dev_type, uint64_t lun, char *params,
 			goto free_lu;
 	}
 
+	if (lu->bst->bs_init)
+		lu->bst->bs_init(lu);
+
 	if (backing && !path && !lu->attrs.removable) {
 		ret = TGTADM_INVALID_REQUEST;
 		goto free_lu;
@@ -574,6 +577,9 @@ int tgt_device_destroy(int tid, uint64_t lun, int force)
 		lu->bst->bs_close(lu);
 	}
 
+	if (lu->bst->bs_exit)
+		lu->bst->bs_exit(lu);
+
 	list_for_each_entry(itn, &target->it_nexus_list, nexus_siblings) {
 		list_for_each_entry_safe(itn_lu, next, &itn->it_nexus_lu_info_list,
 					 lu_info_siblings) {
@@ -633,7 +639,7 @@ int dtd_load_unload(int tid, uint64_t lun, int load, char *file)
 		return TGTADM_INVALID_REQUEST;
 
 	if (lu->path) {
-		close(lu->fd);
+		lu->bst->bs_close(lu);
 		free(lu->path);
 		lu->path = NULL;
 	}
@@ -646,9 +652,12 @@ int dtd_load_unload(int tid, uint64_t lun, int load, char *file)
 		lu->path = strdup(file);
 		if (!lu->path)
 			return TGTADM_NOMEM;
-		lu->fd = backed_file_open(file, O_RDWR|O_LARGEFILE, &lu->size);
-		if (lu->fd < 0)
+		lu->bst->bs_open(lu, file, &lu->fd, &lu->size);
+		if (lu->fd < 0) {
+			free(lu->path);
+			lu->path = NULL;
 			return TGTADM_UNSUPPORTED_OPERATION;
+		}
 		lu->dev_type_template.lu_online(lu);
 	}
 	return err;
diff --git a/usr/tgtd.h b/usr/tgtd.h
index 341b8e2..4febcd3 100644
--- a/usr/tgtd.h
+++ b/usr/tgtd.h
@@ -111,6 +111,8 @@ struct backingstore_template {
 	int bs_datasize;
 	int (*bs_open)(struct scsi_lu *dev, char *path, int *fd, uint64_t *size);
 	void (*bs_close)(struct scsi_lu *dev);
+	int (*bs_init)(struct scsi_lu *dev);
+	void (*bs_exit)(struct scsi_lu *dev);
 	int (*bs_cmd_submit)(struct scsi_cmd *cmd);
 	int (*bs_cmd_done)(struct scsi_cmd *cmd);
 
-- 
1.5.4.3

-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0001-Seperate-thread-init-tear-down-from-backing-store-op.patch
Type: text/x-diff
Size: 9017 bytes
Desc: not available
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080730/72ab1300/attachment.patch>

From agasheac at gmail.com  Wed Jul 30 12:22:21 2008
From: agasheac at gmail.com (aniket agashe)
Date: Wed, 30 Jul 2008 15:52:21 +0530
Subject: [Stgt-devel] oom_adjust file
Message-ID: <d937bde80807300322x14c62847ua452ca3ae7fc02f3@mail.gmail.com>

hi!!!!!!!!!!!


i m having problem in installing scsi-target-utils-0.1-20080629.x86_64.rpm
as failed dependencies libcrypto.so.6(64 bit) required.
So i tried to use tgt-20080715.tar file i  compiled it with option
make ISCSI=1 ISCSI_RDMA=1
and tried to run it with
./tgtd -d 9 -f

getting output as:

-->can't adjust oom-killer's pardon /proc/5727/oom_adj, No such file or
directory


file /proc/sys/vm/oom-kill contains 1 i.e. oom killer is enabled but
oom_adjust file is not created during run of a tgtd(daemon).

what factor manages the file created under /proc/<pid>/ ?


i hv currently RHEL4-U4-x86_64 WS installed on my machine

please help me out
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080730/17ff89ed/attachment.html>

From markh794 at gmail.com  Wed Jul 30 12:40:16 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Wed, 30 Jul 2008 20:40:16 +1000
Subject: [Stgt-devel] oom_adjust file
In-Reply-To: <d937bde80807300322x14c62847ua452ca3ae7fc02f3@mail.gmail.com>
References: <d937bde80807300322x14c62847ua452ca3ae7fc02f3@mail.gmail.com>
Message-ID: <48904510.1000202@gmail.com>

This is most likely due to the kernel release you have does not support oom_adj (out of memory adjust)...

The 'readme' with scsi target code indicates you should be running at least 2.6.20 (or there abouts).

However, just remove (or edit the file where oom_adj is called from) to return a success (tgtd.c).

It is just a method used to adjust the kernel's out-of-memory behaviour. As long as you have enough virtual memory, this is not required - just one of those 'nice to have' features.

Cheers
Mark

aniket agashe wrote:
> 
> hi!!!!!!!!!!!
> 
> 
> i m having problem in installing 
> scsi-target-utils-0.1-20080629.x86_64.rpm as failed dependencies 
> libcrypto.so.6(64 bit) required.
> So i tried to use tgt-20080715.tar file i  compiled it with option
> make ISCSI=1 ISCSI_RDMA=1
> and tried to run it with
> ./tgtd -d 9 -f
> 
> getting output as:
> 
> -->can't adjust oom-killer's pardon /proc/5727/oom_adj, No such file or 
> directory
> 
> 
> file /proc/sys/vm/oom-kill contains 1 i.e. oom killer is enabled but 
> oom_adjust file is not created during run of a tgtd(daemon).
> 
> what factor manages the file created under /proc/<pid>/ ?
> 
> 
> i hv currently RHEL4-U4-x86_64 WS installed on my machine
> 
> please help me out
> 
> 
> ------------------------------------------------------------------------
> 
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel



From mangoo at wpkg.org  Wed Jul 30 13:18:27 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Wed, 30 Jul 2008 13:18:27 +0200
Subject: [Stgt-devel] [PATCH] improved delete option for removing targets in
	tgt-admin
Message-ID: <48904E03.3040400@wpkg.org>

This patch adds a better --delete option which is used for removing targets.

It works similarly to --offline and --ready options:

      --delete <value>          delete all or selected targets
                                The target will be deleted only if it's not used
                                (no initiator is connected to it).
                                If you want to delete targets which are in use,
                                you have to add "--force" flag

Example usage:
      --delete help           - display this help
      --delete ALL            - delete all targets
      --delete tid=4          - delete target 4 (target with tid 4)
      --delete iqn.2008-08.com.example:some.target - delete this target


Basically, it will remove a target if it's not in use; if you still want to remove the target even though it's in use, you have to add --force.

Because of this, I rename the previous --force into --ignore-errors (previously, --force was used to continue execution even if tgtadm exited with non-zero code).

Also, "-d" (previously, a short for --delete) is gone and is not an option anymore. This is because --delete is potentially a dangerous operation so some extra typing could be justified here. Moreover, lots of programs use "-d" to enable debugging, so we don't want to use it.

Currently, --delete is very quiet; if you want some output, please add a -v/--verbose option.


If you want to use --force option with --delete, you have to use tgt snapshot from today (30-Jul-2008), or apply 3b4b9bb9d3255e0c84812d263f56cc7e9cc98cd6 ("use decimal notation for the id of I_T nexus in the show option").



Signed-off-by: Tomasz Chmielewski <mangoo at wpkg.org>

diff --git a/scripts/tgt-admin b/scripts/tgt-admin
index eceea83..ce59eb4 100755
--- a/scripts/tgt-admin
+++ b/scripts/tgt-admin
@@ -23,19 +23,21 @@ Usage:
 tgt-admin [OPTION]...
 This tool configures tgt targets.
 
-  -e, --execute              read $configfile and execute tgtadm commands
-  -d, --delete               delete all the targets
-      --offline <value>      put all or selected targets in offline state
-                             (see "--offline help" for more info)
-      --ready <value>        put all or selected targets in ready state
-                             (see "--ready help" for more info)
-  -s, --show                 show all the targets
-  -c, --conf <conf file>     specify an alternative configuration file
-  -f, --force                don't exit on tgtadm errors
-  -p, --pretend              only print tgtadm options
-      --dump                 dump current tgtd configuration
-  -v, --verbose              increase verbosity (no effect in "pretend" mode)
-  -h, --help                 show this help
+  -e, --execute			read $configfile and execute tgtadm commands
+      --delete <value>		delete all or selected targets
+				(see "--delete help" for more info)
+      --offline <value>		put all or selected targets in offline state
+				(see "--offline help" for more info)
+      --ready <value>		put all or selected targets in ready state
+				(see "--ready help" for more info)
+  -s, --show			show all the targets
+  -c, --conf <conf file>	specify an alternative configuration file
+      --ignore-errors		continue even if tgtadm exits with non-zero code
+  -f, --force			force some operations even if the target is in use
+  -p, --pretend			only print tgtadm options
+      --dump			dump current tgtd configuration
+  -v, --verbose			increase verbosity (show tgtadm commands)
+  -h, --help			show this help
 
 EOF
 	exit;
@@ -49,23 +51,25 @@ my $offline = 0;
 my $ready = 0;
 my $show = 0;
 my $alternate_conf="0";
+my $ignore_errors = 0;
 my $force = 0;
 my $pretend = 0;
 my $dump = 0;
 my $verbose = 0;
 my $help = 0;
 my $result = GetOptions (
-	"e|execute" => \$execute,
-	"d|delete"  => \$delete,
-	"offline=s" => \$offline,
-	"ready=s"   => \$ready,
-	"s|show"    => \$show,
-	"c|conf=s"  => \$alternate_conf,
-	"f|force"   => \$force,
-	"p|pretend" => \$pretend,
-	"dump"      => \$dump,
-	"v|verbose" => \$verbose,
-	"h|help"    => \$help,
+	"e|execute"     => \$execute,
+	"delete=s"      => \$delete,
+	"offline=s"     => \$offline,
+	"ready=s"       => \$ready,
+	"s|show"        => \$show,
+	"c|conf=s"      => \$alternate_conf,
+	"ignore-errors" => \$ignore_errors,
+	"f|force"       => \$force,
+	"p|pretend"     => \$pretend,
+	"dump"          => \$dump,
+	"v|verbose"     => \$verbose,
+	"h|help"        => \$help,
 );
 
 if (($help == 1) || ($param eq undef)) {
@@ -81,6 +85,7 @@ if ($show == 1) {
 # Some variables/arrays/hashes we will use globally
 my %tgtadm_output;
 my %tgtadm_output_tid;
+my %tgtadm_output_name;
 my @largest_tid;
 my $next_tid;
 
@@ -102,6 +107,7 @@ sub process_targets {
 			$targetname = $2;
 			$tgtadm_output{$targetname} = $show_target_line;
 			$tgtadm_output_tid{$targetname} = $tid;
+			$tgtadm_output_name{$tid} = $targetname;
 		} else {
 			$tgtadm_output{$targetname} .= $show_target_line;
 		}
@@ -421,17 +427,17 @@ sub ready_offline_targets {
 		$off_ready = $ready
 	} else {
 		print "Invalid value (you can't use both ready and offline)!\n";
-		exit 1
+		exit 1;
 	}
 	if ($off_ready eq "help") {
 		print <<EOF;
-"$ENV{_} --$var <value>" - $var all or selected targets.
+      --$var <value>		$var all or selected targets
 
 Example usage:
-	--$var help  - display this help
-	--$var ALL   - $var all targets
-	--$var tid=4 - $var target 4 (target with tid 4)
-	--$var iqn.2008-08.com.example:some.target - $var this target
+      --$var help	      - display this help
+      --$var ALL	      - $var all targets
+      --$var tid=4	      - $var target 4 (target with tid 4)
+      --$var iqn.2008-08.com.example:some.target - $var this target
 
 EOF
 	} elsif ($off_ready eq "ALL") {
@@ -455,6 +461,114 @@ EOF
 	}
 }
 
+# Show info for a given target
+sub show_target_info {
+	my $existing_target = $_[0];
+	my $task = $_[1];
+	# Returns driver information
+	if ($task eq "driver") {
+		if ( $tgtadm_output{$existing_target} =~ m/\s+Driver: (.+)/ ) {
+			print $1;
+			return $1;
+		}
+	# Returns ACL information
+	} elsif ($task eq "acl_information") {
+		while ($tgtadm_output{$existing_target} =~ m{
+			\s+ACL\ information:\n(.*)
+				}xmgs
+			) {
+			my @ini_addresses = split(/\n/, $1);
+			my @acls;
+			foreach my $ini_address (@ini_addresses) {
+				my @var = split(/^\s+/, $ini_address);
+				push(@acls, $var[1]);
+			}
+			return @acls;
+		}
+	# Returns sessions
+	} elsif ($task eq "sessions") {
+		my @var = split(/\n/, $tgtadm_output{$existing_target});
+		my @sids;
+		foreach my $sid (@var) {
+			if ( $sid =~ m/\s+I_T nexus: (.+)/ ) {
+				push(@sids, $1);
+			}
+		}
+		return @sids;
+	}
+}
+
+# Delete the targets which are not in use
+sub delete_targets {
+	
+	# Check if the target is used by an initiator
+	sub check_in_use {
+		my $existing_target = $_[0];
+		my $cur_option = $_[1];
+		my $cur_tid = $_[2];
+		if ($tgtadm_output{$existing_target} =~ m/\s+Connection:/) {
+			if ($force == 1) {
+				# Remove ACLs first
+				my @acl_info = &show_target_info($existing_target, "acl_information");
+				foreach my $acl (@acl_info) {
+					execute("tgtadm --op unbind --mode target --tid $tgtadm_output_tid{$existing_target} -I $acl");
+				}
+				# Now, remove all sessions / connections from that tid
+				my @sessions = &show_target_info($existing_target, "sessions");
+				foreach my $session (@sessions) {
+					execute("tgtadm --op delete --mode conn --tid $tgtadm_output_tid{$existing_target} --sid $session --cid 0");
+				}
+				execute("tgtadm --mode target --op delete --tid=$tgtadm_output_tid{$existing_target}");
+			} else {
+				execute("# Target with tid $tgtadm_output_tid{$existing_target} ($existing_target) is in use, it won't be deleted.");
+			}
+		} elsif (length $tgtadm_output_tid{$existing_target}) {
+			execute("tgtadm --mode target --op delete --tid=$tgtadm_output_tid{$existing_target}");
+		} else {
+			if ($cur_option eq "tid") {
+				execute("# Target with tid $cur_tid does not exist!");
+			} else {
+				execute("# Target $existing_target does not exist!");
+			}
+		}
+	}
+
+	if ($delete eq "help") {
+		print <<EOF;
+      --delete <value>		delete all or selected targets
+      				The target will be deleted only if it's not used
+				(no initiator is connected to it).
+				If you want to delete targets which are in use,
+				you have to add "--force" flag
+
+Example usage:
+      --delete help	      - display this help
+      --delete ALL	      - delete all targets
+      --delete tid=4	      - delete target 4 (target with tid 4)
+      --delete iqn.2008-08.com.example:some.target - delete this target
+
+EOF
+		exit;
+	} elsif ($delete eq "ALL") {
+		&process_targets;
+		# Run over all targets and delete them if they are not in use
+		my @all_targets = keys %tgtadm_output_tid;
+		foreach my $existing_target (@all_targets) {
+		&check_in_use($existing_target);
+		}
+	} elsif ($delete =~ m/tid=(.+)/) {
+		# Delete by tid
+		&process_targets;
+		my $existing_target = $1;
+		&check_in_use($tgtadm_output_name{$existing_target}, "tid", $existing_target);
+	} else {
+		# Delete by name
+		&process_targets;
+		my $existing_target = $delete;
+		&check_in_use($existing_target);
+	}
+}
+
 # Some checks
 sub check {
 	if ( not defined $_[0] or not length $_[0] ) {
@@ -480,7 +594,7 @@ sub execute {
 
 			# If non-zero exit code was return, exit
 			my $exit_value  = $? >> 8;
-			if (($exit_value != 0) && ($force == 0)) {
+			if (($exit_value != 0) && ($ignore_errors == 0)) {
 				print "Command:\n\t$args\nexited with code: $exit_value.\n";
 				exit $exit_value;
 			}
@@ -496,10 +610,8 @@ if ($execute == 1) {
 	&parse_configs;
 	&add_targets;
 	&remove_targets;
-} elsif ($delete == 1) {
-	&delete;
-	&parse_configs;
-	&remove_targets;
+} elsif ($delete ne 0) {
+	&delete_targets;
 } elsif ($dump == 1) {
 	&dump_config;
 } elsif ($offline ne 0) {
@@ -510,26 +622,3 @@ if ($execute == 1) {
 	print "No action specified.\n";
 }
 
-# Delete all the targets and backup the current conf file
-sub delete {
-	print "deleting targets...\n";
-	# We need to run as root
-	if ( $> ) {
-		die("You must be root to run this program.\n");
-	}
-
-	my @show_target = `tgtadm --op show --mode target`;
-	my @tids=();
-
-	# Find all the active targets' tids
-	foreach my $show_target_line (@show_target) {
-		if ( $show_target_line =~ m/^Target (\d*): (.+)/ ) {
-			push(@tids,$1);
-		}
-	}
-        # Run over all the active targets and delete them
-        foreach my $tid (@tids) {
-		execute("tgtadm --op update --mode target --tid=$tid -n state -v offline");
-		execute("tgtadm --mode target --op delete --tid=$tid");
-	}
-}



-- 
Tomasz Chmielewski
http://wpkg.org


From thenzl at redhat.com  Wed Jul 30 14:31:28 2008
From: thenzl at redhat.com (Tomas Henzl)
Date: Wed, 30 Jul 2008 14:31:28 +0200
Subject: [Stgt-devel] [Patch] Small problem in the logging code
Message-ID: <48905F20.6080003@redhat.com>

Hi,

I have found what I think is a small problem in the log.c. I think that
it is caused by the fact that we are using the same sembuf struct 
in the semop function for acquiring and releasing the semaphore and this 
structure is shared by all threads. 

I believe that this can lead to either stopping the mechanism 
(semop fails every time) or segfault when two threads are accessing 
the log_enqueue at the same time.

The attached patch should solve this.

Tomas

Signed-off-by: Tomas Henzl <thenzl at redhat.com>
---
diff -Naurp tgt/usr/log.c tgt2/usr/log.c
--- tgt/usr/log.c	2008-07-28 12:37:20.000000000 +0200
+++ tgt2/usr/log.c	2008-07-30 13:48:25.000000000 +0200
@@ -108,8 +108,13 @@ static int logarea_init (int size)
 		return 1;
 	}
 
-	la->ops[0].sem_num = 0;
-	la->ops[0].sem_flg = 0;
+	la->acquire.sem_num = 0;
+	la->acquire.sem_flg = 0;
+	la->acquire.sem_op  = -1;
+
+	la->release.sem_num = 0;
+	la->release.sem_flg = 0;
+	la->release.sem_op  = 1;
 
 	return 0;
 }
@@ -242,16 +248,14 @@ static void dolog(int prio, const char *
 		ts.tv_sec = 0;
 		ts.tv_nsec = 10000;
 
-		la->ops[0].sem_op = -1;
-		if (semtimedop(la->semid, la->ops, 1, &ts) < 0) {
+		if (semtimedop(la->semid, &la->acquire, 1, &ts) < 0) {
 			syslog(LOG_ERR, "semop up failed");
 			return;
 		}
 
 		log_enqueue(prio, fmt, ap);
 
-		la->ops[0].sem_op = 1;
-		if (semop(la->semid, la->ops, 1) < 0) {
+		if (semop(la->semid, &la->release, 1) < 0) {
 			syslog(LOG_ERR, "semop down failed");
 			return;
 		}
@@ -292,14 +296,12 @@ void log_debug(const char *fmt, ...)
 static void log_flush(void)
 {
 	while (!la->empty) {
-		la->ops[0].sem_op = -1;
-		if (semop(la->semid, la->ops, 1) < 0) {
+		if (semop(la->semid, &la->acquire, 1) < 0) {
 			syslog(LOG_ERR, "semop up failed");
 			exit(1);
 		}
 		log_dequeue(la->buff);
-		la->ops[0].sem_op = 1;
-		if (semop(la->semid, la->ops, 1) < 0) {
+		if (semop(la->semid, &la->release, 1) < 0) {
 			syslog(LOG_ERR, "semop down failed");
 			exit(1);
 		}
diff -Naurp tgt/usr/log.h tgt2/usr/log.h
--- tgt/usr/log.h	2008-07-28 12:37:20.000000000 +0200
+++ tgt2/usr/log.h	2008-07-30 13:46:38.000000000 +0200
@@ -55,7 +55,7 @@ struct logarea {
 	void *start;
 	void *end;
 	char *buff;
-	struct sembuf ops[1];
+	struct sembuf acquire, release;
 	int semid;
 	union semun semarg;
 };
--





From fujita.tomonori at lab.ntt.co.jp  Wed Jul 30 14:50:52 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Wed, 30 Jul 2008 21:50:52 +0900
Subject: [Stgt-devel] [PATCH] Proof of Concept -> Separate thread
 init/tear-down from backing store open/close.
In-Reply-To: <48901BD9.7050104@gmail.com>
References: <48901BD9.7050104@gmail.com>
Message-ID: <20080730215040K.fujita.tomonori@lab.ntt.co.jp>

On Wed, 30 Jul 2008 17:44:25 +1000
Mark Harvey <markh794 at gmail.com> wrote:

> Patch also included as an attachment - just in case.
> 
> >From 715e434fff633ff8f346d181aeae3f27c9564553 Mon Sep 17 00:00:00 2001
> From: Mark Harvey <markh794 at gmail.com>
> Date: Wed, 30 Jul 2008 17:27:28 +1000
> Subject: Separate thread init/tear-down from backing store open/close.
> 
> Fix segfault when lu created without a backing store.
>  - Devices defined as 'removable' are able to be configured without a backing
>    store defined.
>  - thread init via bs_init() which is called for all logical units
>  - thread tear-down via bs_exit() which is called for all logical units.
>  - bs_open() limited to opening backing store path (called when required).
>  - bs_close() limited to closing backing store fd (called when required).
> 
> Note: bs_aio and bs_mmap compile-tested only.
> 
> Signed-off-by: Mark Harvey <markh794 at gmail.com>
> ---
>  usr/bs_aio.c  |   25 +++++++++++++++++--------
>  usr/bs_mmap.c |   22 ++++++++++++----------
>  usr/bs_rdwr.c |   25 ++++++++++++++-----------
>  usr/bs_ssc.c  |   25 +++++++++++++------------
>  usr/target.c  |   15 ++++++++++++---
>  usr/tgtd.h    |    2 ++
>  6 files changed, 70 insertions(+), 44 deletions(-)

Thanks, looks nice.

We need to check the return value of bs_init but the rest is fine by
me (I've attached a patch).

Have you tested this?

If it works fine for ssc and mmc, I'll apply the patches.

=
From: FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp>
Subject: [PATCH] check the return value of bs_init in tgt_device_create

Signed-off-by: FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp>
---
 usr/target.c |   18 ++++++++++++------
 1 files changed, 12 insertions(+), 6 deletions(-)

diff --git a/usr/target.c b/usr/target.c
index 62f284c..70bf72a 100644
--- a/usr/target.c
+++ b/usr/target.c
@@ -485,21 +485,24 @@ int tgt_device_create(int tid, int dev_type, uint64_t lun, char *params,
  	if (lu->dev_type_template.lu_init) {
 		ret = lu->dev_type_template.lu_init(lu);
 		if (ret)
-			goto free_lu;
+			goto fail_lu_init;
 	}
 
-	if (lu->bst->bs_init)
-		lu->bst->bs_init(lu);
+	if (lu->bst->bs_init) {
+		ret = lu->bst->bs_init(lu);
+		if (ret)
+			goto fail_bs_init;
+	}
 
 	if (backing && !path && !lu->attrs.removable) {
 		ret = TGTADM_INVALID_REQUEST;
-		goto free_lu;
+		goto fail_bs_init;
 	}
 
 	if (backing && path) {
 		ret = tgt_device_path_update(target, lu, path);
 		if (ret)
-			goto free_lu;
+			goto fail_bs_init;
 	}
 
 	if (tgt_drivers[target->lid]->lu_create)
@@ -541,7 +544,10 @@ out:
 	if (path)
 		free(path);
 	return ret;
-free_lu:
+fail_bs_init:
+	if (lu->bst->bs_exit)
+		lu->bst->bs_exit(lu);
+fail_lu_init:
 	free(lu);
 	goto out;
 }
-- 
1.5.4.2




From realrichardsharpe at gmail.com  Wed Jul 30 19:00:28 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 30 Jul 2008 10:00:28 -0700
Subject: [Stgt-devel] [PATCH] Proof of Concept -> Separate thread
	init/tear-down from backing store open/close.
In-Reply-To: <48901BD9.7050104@gmail.com>
References: <48901BD9.7050104@gmail.com>
Message-ID: <46b8a8850807301000g63392475hbf64906d1d60fe72@mail.gmail.com>

On Wed, Jul 30, 2008 at 12:44 AM, Mark Harvey <markh794 at gmail.com> wrote:
> Patch also included as an attachment - just in case.
>
>> From 715e434fff633ff8f346d181aeae3f27c9564553 Mon Sep 17 00:00:00 2001
>
> From: Mark Harvey <markh794 at gmail.com>
> Date: Wed, 30 Jul 2008 17:27:28 +1000
> Subject: Separate thread init/tear-down from backing store open/close.
>
> Fix segfault when lu created without a backing store.
> - Devices defined as 'removable' are able to be configured without a backing
>  store defined.
> - thread init via bs_init() which is called for all logical units
> - thread tear-down via bs_exit() which is called for all logical units.
> - bs_open() limited to opening backing store path (called when required).
> - bs_close() limited to closing backing store fd (called when required).

Well, it's certainly a larger patch than the one I provided, but it
does also seem to fix the problem I forgot about (threads laying
around after a tape is moved out of the virtual drive).

I will try to apply the two patches and see what happens ...


From realrichardsharpe at gmail.com  Wed Jul 30 20:04:37 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 30 Jul 2008 11:04:37 -0700
Subject: [Stgt-devel] [PATCH] Proof of Concept -> Separate thread
	init/tear-down from backing store open/close.
In-Reply-To: <20080730215040K.fujita.tomonori@lab.ntt.co.jp>
References: <48901BD9.7050104@gmail.com>
	<20080730215040K.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <46b8a8850807301104l683efdd1hf0d1972736478c7c@mail.gmail.com>

On Wed, Jul 30, 2008 at 5:50 AM, FUJITA Tomonori
<fujita.tomonori at lab.ntt.co.jp> wrote:
> On Wed, 30 Jul 2008 17:44:25 +1000
> Mark Harvey <markh794 at gmail.com> wrote:
>
>> Patch also included as an attachment - just in case.
>>
>> >From 715e434fff633ff8f346d181aeae3f27c9564553 Mon Sep 17 00:00:00 2001
>> From: Mark Harvey <markh794 at gmail.com>
>> Date: Wed, 30 Jul 2008 17:27:28 +1000
>> Subject: Separate thread init/tear-down from backing store open/close.
>>
>> Fix segfault when lu created without a backing store.
>>  - Devices defined as 'removable' are able to be configured without a backing
>>    store defined.
>>  - thread init via bs_init() which is called for all logical units
>>  - thread tear-down via bs_exit() which is called for all logical units.
>>  - bs_open() limited to opening backing store path (called when required).
>>  - bs_close() limited to closing backing store fd (called when required).
>>
>> Note: bs_aio and bs_mmap compile-tested only.
>>
>> Signed-off-by: Mark Harvey <markh794 at gmail.com>
>> ---
>>  usr/bs_aio.c  |   25 +++++++++++++++++--------
>>  usr/bs_mmap.c |   22 ++++++++++++----------
>>  usr/bs_rdwr.c |   25 ++++++++++++++-----------
>>  usr/bs_ssc.c  |   25 +++++++++++++------------
>>  usr/target.c  |   15 ++++++++++++---
>>  usr/tgtd.h    |    2 ++
>>  6 files changed, 70 insertions(+), 44 deletions(-)
>
> Thanks, looks nice.
>
> We need to check the return value of bs_init but the rest is fine by
> me (I've attached a patch).
>
> Have you tested this?
>
> If it works fine for ssc and mmc, I'll apply the patches.

I have tested the patch with SSC with a two drive, 8 tape library,
loaded two tapes, ran two concurrent tar backups, then unloaded one
tape and then did another tar backup to the other tape drive and all
seems to work OK.

I will try the same with MMC.


From realrichardsharpe at gmail.com  Wed Jul 30 20:19:13 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 30 Jul 2008 11:19:13 -0700
Subject: [Stgt-devel] [PATCH] Proof of Concept -> Separate thread
	init/tear-down from backing store open/close.
In-Reply-To: <20080730215040K.fujita.tomonori@lab.ntt.co.jp>
References: <48901BD9.7050104@gmail.com>
	<20080730215040K.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <46b8a8850807301119g7715320fx42ea0511af196ffe@mail.gmail.com>

On Wed, Jul 30, 2008 at 5:50 AM, FUJITA Tomonori
<fujita.tomonori at lab.ntt.co.jp> wrote:
> On Wed, 30 Jul 2008 17:44:25 +1000
> Mark Harvey <markh794 at gmail.com> wrote:
>
>> Patch also included as an attachment - just in case.
>>
>> >From 715e434fff633ff8f346d181aeae3f27c9564553 Mon Sep 17 00:00:00 2001
>> From: Mark Harvey <markh794 at gmail.com>
>> Date: Wed, 30 Jul 2008 17:27:28 +1000
>> Subject: Separate thread init/tear-down from backing store open/close.
>>
>> Fix segfault when lu created without a backing store.
>>  - Devices defined as 'removable' are able to be configured without a backing
>>    store defined.
>>  - thread init via bs_init() which is called for all logical units
>>  - thread tear-down via bs_exit() which is called for all logical units.
>>  - bs_open() limited to opening backing store path (called when required).
>>  - bs_close() limited to closing backing store fd (called when required).
>>
>> Note: bs_aio and bs_mmap compile-tested only.
>>
>> Signed-off-by: Mark Harvey <markh794 at gmail.com>
>> ---
>>  usr/bs_aio.c  |   25 +++++++++++++++++--------
>>  usr/bs_mmap.c |   22 ++++++++++++----------
>>  usr/bs_rdwr.c |   25 ++++++++++++++-----------
>>  usr/bs_ssc.c  |   25 +++++++++++++------------
>>  usr/target.c  |   15 ++++++++++++---
>>  usr/tgtd.h    |    2 ++
>>  6 files changed, 70 insertions(+), 44 deletions(-)
>
> Thanks, looks nice.
>
> We need to check the return value of bs_init but the rest is fine by
> me (I've attached a patch).
>
> Have you tested this?
>
> If it works fine for ssc and mmc, I'll apply the patches.

I have tested with both SSC and MMC now, and both work fine.

I will apply your additional patch to my tree as well, but I imagine
that will work fine as well.

Now I can work on properly handling file marks and so forth ...


From realrichardsharpe at gmail.com  Wed Jul 30 22:22:58 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 30 Jul 2008 13:22:58 -0700
Subject: [Stgt-devel] Dealing with filemarks in SSC ...
In-Reply-To: <46b8a8850807291819m5d185122x6ccd83290611adcf@mail.gmail.com>
References: <46b8a8850807291644l6af714cct43b7b88a3918e013@mail.gmail.com>
	<B3E98EAC5926D5498DDD341AE4B7D21C04758A30@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<46b8a8850807291716h362cde5apc1033063035810a6@mail.gmail.com>
	<B3E98EAC5926D5498DDD341AE4B7D21C04758A54@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<46b8a8850807291743y6efa3398h616f6d21a155def5@mail.gmail.com>
	<B3E98EAC5926D5498DDD341AE4B7D21C04758A6D@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<46b8a8850807291756k28c635b0w7eae1797a6e0aaf8@mail.gmail.com>
	<B3E98EAC5926D5498DDD341AE4B7D21C04758AA8@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<46b8a8850807291819m5d185122x6ccd83290611adcf@mail.gmail.com>
Message-ID: <46b8a8850807301322v2e065a59u9cf67e5aa743dcf3@mail.gmail.com>

Hi,

I have moved closer to properly implementing filemarks (and setmarks)
by thinking through the issues associated with the approach I want to
take.

That is to keep an array of marks (file and set) with offsets into the
backing store file. Whether these are then stored as extended
attributes or as a separate metadata file is an implementation
decision that I am happy with either way.

By the look of things, the cost of detecting a mark on each read op,
at least for fixed block size devices, is a couple of additions and a
comparison in the fast-path (although the code does lots of seeks that
seem unnecessary at the moment as well). I suspect it will amount to
the same for variable block-size devices as well.

Once I have btape tests working correctly I will post a patch for consideration.


From unreserve at movilspot.com  Wed Jul 30 23:50:27 2008
From: unreserve at movilspot.com (Ling Tartaglione)
Date: Wed, 30 Jul 2008 21:50:27 +0000
Subject: [Stgt-devel] :o)
Message-ID: <7443620596.20080730214741@junker.de>

Hej, 
  





-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080730/69ba0514/attachment.html>

From markh794 at gmail.com  Thu Jul 31 00:08:25 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Thu, 31 Jul 2008 08:08:25 +1000
Subject: [Stgt-devel] Dealing with filemarks in SSC ...
In-Reply-To: <46b8a8850807301322v2e065a59u9cf67e5aa743dcf3@mail.gmail.com>
References: <46b8a8850807291644l6af714cct43b7b88a3918e013@mail.gmail.com>
	<B3E98EAC5926D5498DDD341AE4B7D21C04758A30@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<46b8a8850807291716h362cde5apc1033063035810a6@mail.gmail.com>
	<B3E98EAC5926D5498DDD341AE4B7D21C04758A54@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<46b8a8850807291743y6efa3398h616f6d21a155def5@mail.gmail.com>
	<B3E98EAC5926D5498DDD341AE4B7D21C04758A6D@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<46b8a8850807291756k28c635b0w7eae1797a6e0aaf8@mail.gmail.com>
	<B3E98EAC5926D5498DDD341AE4B7D21C04758AA8@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<46b8a8850807291819m5d185122x6ccd83290611adcf@mail.gmail.com>
	<46b8a8850807301322v2e065a59u9cf67e5aa743dcf3@mail.gmail.com>
Message-ID: <f29db9a80807301508k1526891am203b8bde5a16271c@mail.gmail.com>

On Thu, Jul 31, 2008 at 6:22 AM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> Hi,
>
> I have moved closer to properly implementing filemarks (and setmarks)
> by thinking through the issues associated with the approach I want to
> take.
One other thing I feel needs to be kept in mind. How to support
variable block mode.
(or compressed data for that matter).

The current flat file backing store assumes every block is 512bytes.
If zlib was added and this block was compressed, the backing store
would have no way of determining the size of the data to read (when it
was time to read the data back).
e.g.
Write 512 bytes | zlib(compress) | write to file...

Now when we attempt to read this block back, how much data to we read
off disk ??

Same basic problem with variable block writes. The size of the
original data + size of data written to backing store (perhaps its
been compressed & encrypted by the ssc module) so the attempt to read
this data back will succeed - and/or return appropriate SENSE
under/over-run data.

How are the LOCATE / READ POSITION op codes to be implemented ?

The other fundamental problem I can see is how to detect when we hit a
filemark/setmark/<insert metadata type here>.
Each read, block locate, seek op code is going to have to search the
array to determine if the metadata matches.

Attempting to keep an array of meta-data with pointers seems to be a
difficult way of achieving this.

Sorry - I keep going back to a double-linked-list with the attached
data block as my preferred solution.

Each block header keeps the metadata for the block.
i.e. If the block is a filemark/setmark - there is no data just the metadata.
The block number is stored within the header. So LOCATE / READ
POSITION are simply implemented.
The original size of data + size of data stored is also stored in the
metadata header, making it relatively simple to handle variable block
/ compressed data.

My 2c worth. :)

Cheers
Mark
> That is to keep an array of marks (file and set) with offsets into the
> backing store file. Whether these are then stored as extended
> attributes or as a separate metadata file is an implementation
> decision that I am happy with either way.
>
> By the look of things, the cost of detecting a mark on each read op,
> at least for fixed block size devices, is a couple of additions and a
> comparison in the fast-path (although the code does lots of seeks that
> seem unnecessary at the moment as well). I suspect it will amount to
> the same for variable block-size devices as well.
>
> Once I have btape tests working correctly I will post a patch for consideration.
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From markh794 at gmail.com  Thu Jul 31 00:17:47 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Thu, 31 Jul 2008 08:17:47 +1000
Subject: [Stgt-devel] [PATCH] Proof of Concept -> Separate thread
	init/tear-down from backing store open/close.
In-Reply-To: <46b8a8850807301119g7715320fx42ea0511af196ffe@mail.gmail.com>
References: <48901BD9.7050104@gmail.com>
	<20080730215040K.fujita.tomonori@lab.ntt.co.jp>
	<46b8a8850807301119g7715320fx42ea0511af196ffe@mail.gmail.com>
Message-ID: <f29db9a80807301517j36b7b0dmfd46309f8949d2e3@mail.gmail.com>

On Thu, Jul 31, 2008 at 4:19 AM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> On Wed, Jul 30, 2008 at 5:50 AM, FUJITA Tomonori
> <fujita.tomonori at lab.ntt.co.jp> wrote:
>> On Wed, 30 Jul 2008 17:44:25 +1000
>> Mark Harvey <markh794 at gmail.com> wrote:
>>
>>> Patch also included as an attachment - just in case.
>>>
>>> >From 715e434fff633ff8f346d181aeae3f27c9564553 Mon Sep 17 00:00:00 2001
>>> From: Mark Harvey <markh794 at gmail.com>
>>> Date: Wed, 30 Jul 2008 17:27:28 +1000
>>> Subject: Separate thread init/tear-down from backing store open/close.
>>>
>>> Fix segfault when lu created without a backing store.
>>>  - Devices defined as 'removable' are able to be configured without a backing
>>>    store defined.
>>>  - thread init via bs_init() which is called for all logical units
>>>  - thread tear-down via bs_exit() which is called for all logical units.
>>>  - bs_open() limited to opening backing store path (called when required).
>>>  - bs_close() limited to closing backing store fd (called when required).
>>>
>>> Note: bs_aio and bs_mmap compile-tested only.
>>>
>>> Signed-off-by: Mark Harvey <markh794 at gmail.com>
>>> ---
>>>  usr/bs_aio.c  |   25 +++++++++++++++++--------
>>>  usr/bs_mmap.c |   22 ++++++++++++----------
>>>  usr/bs_rdwr.c |   25 ++++++++++++++-----------
>>>  usr/bs_ssc.c  |   25 +++++++++++++------------
>>>  usr/target.c  |   15 ++++++++++++---
>>>  usr/tgtd.h    |    2 ++
>>>  6 files changed, 70 insertions(+), 44 deletions(-)
>>
>> Thanks, looks nice.
>>
>> We need to check the return value of bs_init but the rest is fine by
>> me (I've attached a patch).

Many thanks - please apply.

Or would you like me to re-do the patch with your improvements included ?

>>
>> Have you tested this?

Just minimum testing..

Compile tested the bs_aio & bs_mmap only.

>>
>> If it works fine for ssc and mmc, I'll apply the patches.
>
> I have tested with both SSC and MMC now, and both work fine.

Many thanks Richard.

>
> I will apply your additional patch to my tree as well, but I imagine
> that will work fine as well.
>
> Now I can work on properly handling file marks and so forth ...
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>


From realrichardsharpe at gmail.com  Thu Jul 31 00:53:21 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Wed, 30 Jul 2008 15:53:21 -0700
Subject: [Stgt-devel] Dealing with filemarks in SSC ...
In-Reply-To: <f29db9a80807301508k1526891am203b8bde5a16271c@mail.gmail.com>
References: <46b8a8850807291644l6af714cct43b7b88a3918e013@mail.gmail.com>
	<46b8a8850807291716h362cde5apc1033063035810a6@mail.gmail.com>
	<B3E98EAC5926D5498DDD341AE4B7D21C04758A54@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<46b8a8850807291743y6efa3398h616f6d21a155def5@mail.gmail.com>
	<B3E98EAC5926D5498DDD341AE4B7D21C04758A6D@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<46b8a8850807291756k28c635b0w7eae1797a6e0aaf8@mail.gmail.com>
	<B3E98EAC5926D5498DDD341AE4B7D21C04758AA8@TUS1XCHCLUPIN05.enterprise.veritas.com>
	<46b8a8850807291819m5d185122x6ccd83290611adcf@mail.gmail.com>
	<46b8a8850807301322v2e065a59u9cf67e5aa743dcf3@mail.gmail.com>
	<f29db9a80807301508k1526891am203b8bde5a16271c@mail.gmail.com>
Message-ID: <46b8a8850807301553h4ec46d4fu640089ae0f99ea3c@mail.gmail.com>

On Wed, Jul 30, 2008 at 3:08 PM, Mark Harvey <markh794 at gmail.com> wrote:

[a bunch of very good questions ...]

The model I am using for the moment is that setmarks and filemarks are
kept in a separate array.

The tape object/LU keeps track of where it is in logical tape space
(byte offset seems good).

When you write a filemark or a setmark, add an entry to and array with
the byte offset into the tape.

When you init the tape or rewind, set variable next_mark to 0.

When you do a read or any positioning command you:

1. Check if the length + current offset > offset for next_mark. If so,
adjust the length to read down and set up a CHECK_CONDITION, NO_SENSE,
FILEMARK DETECTED or whatever.

2. Do the read or positioning command.

3. Update the logical position by the amount of logical data moved.

With respect to compression etc, this would be handled by using
container objects (compressed blocks or whatever) indexed by block num
or something. Perhaps a bit more complex than that. Would probably
compress the natural blocks given to us by the application, eg 64kB
blocks, so would need to decompress those.

This is all evolving as I see what tools I can use to test the changes
I am making.

The bacula btest program is useful, but it seems to require variable
blocks sizes at some point.


From fujita.tomonori at lab.ntt.co.jp  Thu Jul 31 05:00:39 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Thu, 31 Jul 2008 12:00:39 +0900
Subject: [Stgt-devel] [PATCH] improved delete option for removing
 targets in	tgt-admin
In-Reply-To: <48904E03.3040400@wpkg.org>
References: <48904E03.3040400@wpkg.org>
Message-ID: <20080731115439S.fujita.tomonori@lab.ntt.co.jp>

On Wed, 30 Jul 2008 13:18:27 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> This patch adds a better --delete option which is used for removing targets.
> 
> It works similarly to --offline and --ready options:
> 
>       --delete <value>          delete all or selected targets
>                                 The target will be deleted only if it's not used
>                                 (no initiator is connected to it).
>                                 If you want to delete targets which are in use,
>                                 you have to add "--force" flag
> 
> Example usage:
>       --delete help           - display this help
>       --delete ALL            - delete all targets
>       --delete tid=4          - delete target 4 (target with tid 4)
>       --delete iqn.2008-08.com.example:some.target - delete this target
> 
> 
> Basically, it will remove a target if it's not in use; if you still want to remove the target even though it's in use, you have to add --force.
> 
> Because of this, I rename the previous --force into --ignore-errors (previously, --force was used to continue execution even if tgtadm exited with non-zero code).
> 
> Also, "-d" (previously, a short for --delete) is gone and is not an option anymore. This is because --delete is potentially a dangerous operation so some extra typing could be justified here. Moreover, lots of programs use "-d" to enable debugging, so we don't want to use it.
> 
> Currently, --delete is very quiet; if you want some output, please add a -v/--verbose option.
> 
> 
> If you want to use --force option with --delete, you have to use tgt snapshot from today (30-Jul-2008), or apply 3b4b9bb9d3255e0c84812d263f56cc7e9cc98cd6 ("use decimal notation for the id of I_T nexus in the show option").

Looks good changes, as I said before. Applied, thanks a lot.

BTW, cid is not always zero. So you need more tricks about it.


From fujita.tomonori at lab.ntt.co.jp  Thu Jul 31 05:00:40 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Thu, 31 Jul 2008 12:00:40 +0900
Subject: [Stgt-devel] [PATCH] Proof of Concept -> Separate
	thread	init/tear-down from backing store open/close.
In-Reply-To: <f29db9a80807301517j36b7b0dmfd46309f8949d2e3@mail.gmail.com>
References: <20080730215040K.fujita.tomonori@lab.ntt.co.jp>
	<46b8a8850807301119g7715320fx42ea0511af196ffe@mail.gmail.com>
	<f29db9a80807301517j36b7b0dmfd46309f8949d2e3@mail.gmail.com>
Message-ID: <20080731120031S.fujita.tomonori@lab.ntt.co.jp>

On Thu, 31 Jul 2008 08:17:47 +1000
"Mark Harvey" <markh794 at gmail.com> wrote:

> On Thu, Jul 31, 2008 at 4:19 AM, Richard Sharpe
> <realrichardsharpe at gmail.com> wrote:
> > On Wed, Jul 30, 2008 at 5:50 AM, FUJITA Tomonori
> > <fujita.tomonori at lab.ntt.co.jp> wrote:
> >> On Wed, 30 Jul 2008 17:44:25 +1000
> >> Mark Harvey <markh794 at gmail.com> wrote:
> >>
> >>> Patch also included as an attachment - just in case.
> >>>
> >>> >From 715e434fff633ff8f346d181aeae3f27c9564553 Mon Sep 17 00:00:00 2001
> >>> From: Mark Harvey <markh794 at gmail.com>
> >>> Date: Wed, 30 Jul 2008 17:27:28 +1000
> >>> Subject: Separate thread init/tear-down from backing store open/close.
> >>>
> >>> Fix segfault when lu created without a backing store.
> >>>  - Devices defined as 'removable' are able to be configured without a backing
> >>>    store defined.
> >>>  - thread init via bs_init() which is called for all logical units
> >>>  - thread tear-down via bs_exit() which is called for all logical units.
> >>>  - bs_open() limited to opening backing store path (called when required).
> >>>  - bs_close() limited to closing backing store fd (called when required).
> >>>
> >>> Note: bs_aio and bs_mmap compile-tested only.
> >>>
> >>> Signed-off-by: Mark Harvey <markh794 at gmail.com>
> >>> ---
> >>>  usr/bs_aio.c  |   25 +++++++++++++++++--------
> >>>  usr/bs_mmap.c |   22 ++++++++++++----------
> >>>  usr/bs_rdwr.c |   25 ++++++++++++++-----------
> >>>  usr/bs_ssc.c  |   25 +++++++++++++------------
> >>>  usr/target.c  |   15 ++++++++++++---
> >>>  usr/tgtd.h    |    2 ++
> >>>  6 files changed, 70 insertions(+), 44 deletions(-)
> >>
> >> Thanks, looks nice.
> >>
> >> We need to check the return value of bs_init but the rest is fine by
> >> me (I've attached a patch).
> 
> Many thanks - please apply.
> 
> Or would you like me to re-do the patch with your improvements included ?

Applied (my patch was foiled).

Thanks a lot, Mark and Richard.


From fujita.tomonori at lab.ntt.co.jp  Thu Jul 31 05:00:40 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Thu, 31 Jul 2008 12:00:40 +0900
Subject: [Stgt-devel] [PATCH] Proof of Concept -> Separate
	thread	init/tear-down from backing store open/close.
In-Reply-To: <46b8a8850807301000g63392475hbf64906d1d60fe72@mail.gmail.com>
References: <48901BD9.7050104@gmail.com>
	<46b8a8850807301000g63392475hbf64906d1d60fe72@mail.gmail.com>
Message-ID: <20080731115842T.fujita.tomonori@lab.ntt.co.jp>

On Wed, 30 Jul 2008 10:00:28 -0700
"Richard Sharpe" <realrichardsharpe at gmail.com> wrote:

> On Wed, Jul 30, 2008 at 12:44 AM, Mark Harvey <markh794 at gmail.com> wrote:
> > Patch also included as an attachment - just in case.
> >
> >> From 715e434fff633ff8f346d181aeae3f27c9564553 Mon Sep 17 00:00:00 2001
> >
> > From: Mark Harvey <markh794 at gmail.com>
> > Date: Wed, 30 Jul 2008 17:27:28 +1000
> > Subject: Separate thread init/tear-down from backing store open/close.
> >
> > Fix segfault when lu created without a backing store.
> > - Devices defined as 'removable' are able to be configured without a backing
> >  store defined.
> > - thread init via bs_init() which is called for all logical units
> > - thread tear-down via bs_exit() which is called for all logical units.
> > - bs_open() limited to opening backing store path (called when required).
> > - bs_close() limited to closing backing store fd (called when required).
> 
> Well, it's certainly a larger patch than the one I provided, but it
> does also seem to fix the problem I forgot about (threads laying
> around after a tape is moved out of the virtual drive).

As I wrote in the previous mail, I think that your approach works and
it's fine by me. But Mark sent a patch to do the right things so let's
go with that approach.


From fujita.tomonori at lab.ntt.co.jp  Thu Jul 31 05:10:46 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Thu, 31 Jul 2008 12:10:46 +0900
Subject: [Stgt-devel] support to close a connection by force and to shut
 down tgtd
In-Reply-To: <489004DD.4000105@wpkg.org>
References: <488F3539.8090306@Voltaire.COM> <20080730063657N.tomof@acm.org>
	<489004DD.4000105@wpkg.org>
Message-ID: <20080731121039O.fujita.tomonori@lab.ntt.co.jp>

On Wed, 30 Jul 2008 08:06:21 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> FUJITA Tomonori schrieb:
> > On Tue, 29 Jul 2008 18:20:25 +0300
> > Doron Shoham <dorons at Voltaire.COM> wrote:
> > 
> >> Tomo - please note that the I_T nexus id is in hex but the tgtadm
> >> accepts only decimal values.  Please change the I_T nexus id to
> >> decimal.
> > 
> > Ah, thanks a lot! I didn't notice this at all.
> 
> BTW - can "cid" ("Connection") have a different value than 0?

Yeah, it can. We just use the cid of a login request from an
initiator.


From mangoo at wpkg.org  Thu Jul 31 08:15:13 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Thu, 31 Jul 2008 08:15:13 +0200
Subject: [Stgt-devel] [PATCH] improved delete option for removing
 targets in	tgt-admin
In-Reply-To: <20080731115439S.fujita.tomonori@lab.ntt.co.jp>
References: <48904E03.3040400@wpkg.org>
	<20080731115439S.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <48915871.2090706@wpkg.org>

FUJITA Tomonori schrieb:
> On Wed, 30 Jul 2008 13:18:27 +0200
> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> 
>> This patch adds a better --delete option which is used for removing targets.
>>
>> It works similarly to --offline and --ready options:
>>
>>       --delete <value>          delete all or selected targets
>>                                 The target will be deleted only if it's not used
>>                                 (no initiator is connected to it).
>>                                 If you want to delete targets which are in use,
>>                                 you have to add "--force" flag
>>
>> Example usage:
>>       --delete help           - display this help
>>       --delete ALL            - delete all targets
>>       --delete tid=4          - delete target 4 (target with tid 4)
>>       --delete iqn.2008-08.com.example:some.target - delete this target
>>
>>
>> Basically, it will remove a target if it's not in use; if you still want to remove the target even though it's in use, you have to add --force.
>>
>> Because of this, I rename the previous --force into --ignore-errors (previously, --force was used to continue execution even if tgtadm exited with non-zero code).
>>
>> Also, "-d" (previously, a short for --delete) is gone and is not an option anymore. This is because --delete is potentially a dangerous operation so some extra typing could be justified here. Moreover, lots of programs use "-d" to enable debugging, so we don't want to use it.
>>
>> Currently, --delete is very quiet; if you want some output, please add a -v/--verbose option.
>>
>>
>> If you want to use --force option with --delete, you have to use tgt snapshot from today (30-Jul-2008), or apply 3b4b9bb9d3255e0c84812d263f56cc7e9cc98cd6 ("use decimal notation for the id of I_T nexus in the show option").
> 
> Looks good changes, as I said before. Applied, thanks a lot.
> 
> BTW, cid is not always zero. So you need more tricks about it.

OK, I'll add cid detection then, too.


-- 
Tomasz Chmielewski
http://wpkg.org



From mangoo at wpkg.org  Thu Jul 31 09:59:47 2008
From: mangoo at wpkg.org (Tomasz Chmielewski)
Date: Thu, 31 Jul 2008 09:59:47 +0200
Subject: [Stgt-devel] support to close a connection by force and to shut
 down tgtd
In-Reply-To: <20080731121039O.fujita.tomonori@lab.ntt.co.jp>
References: <488F3539.8090306@Voltaire.COM>	<20080730063657N.tomof@acm.org>	<489004DD.4000105@wpkg.org>
	<20080731121039O.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <489170F3.2060103@wpkg.org>

FUJITA Tomonori schrieb:
> On Wed, 30 Jul 2008 08:06:21 +0200
> Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> 
>> FUJITA Tomonori schrieb:
>>> On Tue, 29 Jul 2008 18:20:25 +0300
>>> Doron Shoham <dorons at Voltaire.COM> wrote:
>>>
>>>> Tomo - please note that the I_T nexus id is in hex but the tgtadm
>>>> accepts only decimal values.  Please change the I_T nexus id to
>>>> decimal.
>>> Ah, thanks a lot! I didn't notice this at all.
>> BTW - can "cid" ("Connection") have a different value than 0?
> 
> Yeah, it can. We just use the cid of a login request from an
> initiator.

So how would it look like?

1) I assume like this:

    I_T nexus information:
        I_T nexus: 64
            Initiator: iqn.2006-08.net...
            Connection: 2
                IP Address: 192.168.61.11
        I_T nexus: 97
            Initiator: iqn.2008-01.net...
            Connection: 3
                IP Address: 192.168.61.10
        I_T nexus: a7
            Initiator: iqn.2007-06.net...
            Connection: 0
                IP Address: 192.168.61.18


2) But you can't have different connections in one session, i.e.:

    I_T nexus information:
        I_T nexus: 64
            Initiator: iqn.2006-08.net...
            Connection: 2
                IP Address: 192.168.61.11
            Initiator: iqn.2008-01.net...
            Connection: 3
                IP Address: 192.168.61.10
        I_T nexus: a7
            Initiator: iqn.2007-06.net...
            Connection: 0
                IP Address: 192.168.61.18


Which one is correct?


-- 
Tomasz Chmielewski
http://wpkg.org


From fujita.tomonori at lab.ntt.co.jp  Thu Jul 31 11:21:53 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Thu, 31 Jul 2008 18:21:53 +0900
Subject: [Stgt-devel] support to close a connection by force and to shut
 down tgtd
In-Reply-To: <489170F3.2060103@wpkg.org>
References: <489004DD.4000105@wpkg.org>
	<20080731121039O.fujita.tomonori@lab.ntt.co.jp>
	<489170F3.2060103@wpkg.org>
Message-ID: <20080731182153I.fujita.tomonori@lab.ntt.co.jp>

On Thu, 31 Jul 2008 09:59:47 +0200
Tomasz Chmielewski <mangoo at wpkg.org> wrote:

> FUJITA Tomonori schrieb:
> > On Wed, 30 Jul 2008 08:06:21 +0200
> > Tomasz Chmielewski <mangoo at wpkg.org> wrote:
> > 
> >> FUJITA Tomonori schrieb:
> >>> On Tue, 29 Jul 2008 18:20:25 +0300
> >>> Doron Shoham <dorons at Voltaire.COM> wrote:
> >>>
> >>>> Tomo - please note that the I_T nexus id is in hex but the tgtadm
> >>>> accepts only decimal values.  Please change the I_T nexus id to
> >>>> decimal.
> >>> Ah, thanks a lot! I didn't notice this at all.
> >> BTW - can "cid" ("Connection") have a different value than 0?
> > 
> > Yeah, it can. We just use the cid of a login request from an
> > initiator.
> 
> So how would it look like?
> 
> 1) I assume like this:
> 
>     I_T nexus information:
>         I_T nexus: 64
>             Initiator: iqn.2006-08.net...
>             Connection: 2
>                 IP Address: 192.168.61.11
>         I_T nexus: 97
>             Initiator: iqn.2008-01.net...
>             Connection: 3
>                 IP Address: 192.168.61.10
>         I_T nexus: a7
>             Initiator: iqn.2007-06.net...
>             Connection: 0
>                 IP Address: 192.168.61.18

This can happen.


> 2) But you can't have different connections in one session, i.e.:
> 
>     I_T nexus information:
>         I_T nexus: 64
>             Initiator: iqn.2006-08.net...
>             Connection: 2
>                 IP Address: 192.168.61.11
>             Initiator: iqn.2008-01.net...
>             Connection: 3
>                 IP Address: 192.168.61.10
>         I_T nexus: a7
>             Initiator: iqn.2007-06.net...
>             Connection: 0
>                 IP Address: 192.168.61.18

This can happen too with MC/S.


From fujita.tomonori at lab.ntt.co.jp  Thu Jul 31 11:27:19 2008
From: fujita.tomonori at lab.ntt.co.jp (FUJITA Tomonori)
Date: Thu, 31 Jul 2008 18:27:19 +0900
Subject: [Stgt-devel] support to close a connection by force and to shut
 down tgtd
In-Reply-To: <20080731182153I.fujita.tomonori@lab.ntt.co.jp>
References: <20080731121039O.fujita.tomonori@lab.ntt.co.jp>
	<489170F3.2060103@wpkg.org>
	<20080731182153I.fujita.tomonori@lab.ntt.co.jp>
Message-ID: <20080731182719W.fujita.tomonori@lab.ntt.co.jp>

On Thu, 31 Jul 2008 18:21:53 +0900
FUJITA Tomonori <fujita.tomonori at lab.ntt.co.jp> wrote:

> > 2) But you can't have different connections in one session, i.e.:
> > 
> >     I_T nexus information:
> >         I_T nexus: 64
> >             Initiator: iqn.2006-08.net...
> >             Connection: 2
> >                 IP Address: 192.168.61.11
> >             Initiator: iqn.2008-01.net...
> >             Connection: 3
> >                 IP Address: 192.168.61.10
> >         I_T nexus: a7
> >             Initiator: iqn.2007-06.net...
> >             Connection: 0
> >                 IP Address: 192.168.61.18
> 
> This can happen too with MC/S.

Oops, the format is wrong. You don't have multiple initiators in one
nexus.


From mistrusted at artcuisine.ch  Thu Jul 31 12:15:47 2008
From: mistrusted at artcuisine.ch (Mutty Lohmiller)
Date: Thu, 31 Jul 2008 10:15:47 +0000
Subject: [Stgt-devel] :o)
Message-ID: <9057299033.20080731090306@artcuisine.ch>

What's up?  
  

   



-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080731/a2d1aea4/attachment.html>

From agasheac at gmail.com  Thu Jul 31 12:41:48 2008
From: agasheac at gmail.com (aniket agashe)
Date: Thu, 31 Jul 2008 04:41:48 -0600
Subject: [Stgt-devel] sending scsi read or write from user space
Message-ID: <d937bde80807310341s1226f4e9i6a0dcbffce472474@mail.gmail.com>

Hi,
I am finally managed to install iser initiator as well as initiators on two
nodes. I am using 100MB file on the one node as scsi disk device
I successfully completed upto login session part using iscsiadm

I just want to know if there is any program implemented in
"open-iscsi"

to execute read / write SCSI commands.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080731/e32e8f87/attachment.html>

From markh794 at gmail.com  Thu Jul 31 13:13:34 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Thu, 31 Jul 2008 21:13:34 +1000
Subject: [Stgt-devel] sending scsi read or write from user space
In-Reply-To: <d937bde80807310341s1226f4e9i6a0dcbffce472474@mail.gmail.com>
References: <d937bde80807310341s1226f4e9i6a0dcbffce472474@mail.gmail.com>
Message-ID: <f29db9a80807310413l3ddf910dtf751ee392721a912@mail.gmail.com>

The 'sg3_utils' package (www.torque.net/sg/) contains utilities to
send different commands. Among them are utilities for reading and
writing.



On Thu, Jul 31, 2008 at 8:41 PM, aniket agashe <agasheac at gmail.com> wrote:
> Hi,
> I am finally managed to install iser initiator as well as initiators on two
> nodes. I am using 100MB file on the one node as scsi disk device
> I successfully completed upto login session part using iscsiadm
>
> I just want to know if there is any program implemented in
> "open-iscsi"
>
> to execute read / write SCSI commands.
> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>
>


From realrichardsharpe at gmail.com  Thu Jul 31 18:30:59 2008
From: realrichardsharpe at gmail.com (Richard Sharpe)
Date: Thu, 31 Jul 2008 09:30:59 -0700
Subject: [Stgt-devel] Small inconsistency in ssc.c
Message-ID: <46b8a8850807310930q3c4f6f8ds144febd9e919948e@mail.gmail.com>

Hi,

I just noticed this ...

        ssc = zalloc(sizeof(struct ssc_info));
        if (ssc)
                dtype_priv(lu) = ssc;
        else
                return -ENOMEM;

        if (spc_lu_init(lu))
                return TGTADM_NOMEM;

What should be returned during the creation of an LU?


From cardioids at stratex.it  Thu Jul 31 21:48:06 2008
From: cardioids at stratex.it (Talcott Atkinson)
Date: Thu, 31 Jul 2008 19:48:06 +0000
Subject: [Stgt-devel] :o)
Message-ID: <2242743266.20080731192859@stratex.it>

Guten Tag,	

	

	
   
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.berlios.de/pipermail/stgt-devel/attachments/20080731/270fb29c/attachment.html>

From markh794 at gmail.com  Thu Jul 31 23:42:37 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Fri, 1 Aug 2008 07:42:37 +1000
Subject: [Stgt-devel] Small inconsistency in ssc.c
In-Reply-To: <46b8a8850807310930q3c4f6f8ds144febd9e919948e@mail.gmail.com>
References: <46b8a8850807310930q3c4f6f8ds144febd9e919948e@mail.gmail.com>
Message-ID: <f29db9a80807311442s50cb290by715e5b7acce193b1@mail.gmail.com>

On Fri, Aug 1, 2008 at 2:30 AM, Richard Sharpe
<realrichardsharpe at gmail.com> wrote:
> Hi,
>
> I just noticed this ...
>
>        ssc = zalloc(sizeof(struct ssc_info));
>        if (ssc)
>                dtype_priv(lu) = ssc;
>        else
>                return -ENOMEM;
>
>        if (spc_lu_init(lu))
>                return TGTADM_NOMEM;
>
> What should be returned during the creation of an LU?

Good spotting..

Attached is a patch to fix this.
(Sorry for the attachment but I don't have pop/imap access)

It's a one liner..
Included in-line - you never know maybe cut/paste between vim &
firefox 3 on Windows won't destroy the tabs..

From markh794 at gmail.com  Thu Jul 31 22:21:39 2008
From: markh794 at gmail.com (Mark Harvey)
Date: Fri, 1 Aug 2008 06:21:39 +1000
Subject: Return correct error code on malloc() failure
Message-ID: <mailman.46.1331738484.12506.stgt-devel@lists.berlios.de>

Reported-by: Richard Sharpe <realrichardsharpe at gmail.com>
Signed-off-by: Mark Harvey <markh794 at gmail.com>
---
 usr/ssc.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/usr/ssc.c b/usr/ssc.c
index 848b323..2630a6a 100644
--- a/usr/ssc.c
+++ b/usr/ssc.c
@@ -108,7 +108,7 @@ static int ssc_lu_init(struct scsi_lu *lu)
 	if (ssc)
 		dtype_priv(lu) = ssc;
 	else
-		return -ENOMEM;
+		return TGTADM_NOMEM;

 	if (spc_lu_init(lu))
 		return TGTADM_NOMEM;
-- 

> _______________________________________________
> Stgt-devel mailing list
> Stgt-devel at lists.berlios.de
> https://lists.berlios.de/mailman/listinfo/stgt-devel
>

------=_Part_975_11561062.1217540557307
Content-Type: application/octet-stream;
 name=0001-Return-correct-error-code-on-malloc-failure.patch
Content-Transfer-Encoding: base64
X-Attachment-Id: f_fjbw2mia0
Content-Disposition: attachment;
 filename=0001-Return-correct-error-code-on-malloc-failure.patch

RnJvbSAxMDVkZjRlZDBmZjQ3OWU5M2ExNTI2MTM5N2Q2Mzg1NzViMTFiODQwIE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBNYXJrIEhhcnZleSA8bWFya2g3OTRAZ21haWwuY29tPgpEYXRl
OiBGcmksIDEgQXVnIDIwMDggMDY6MjE6MzkgKzEwMDAKU3ViamVjdDogUmV0dXJuIGNvcnJlY3Qg
ZXJyb3IgY29kZSBvbiBtYWxsb2MoKSBmYWlsdXJlCgpSZXBvcnRlZC1ieTogUmljaGFyZCBTaGFy
cGUgPHJlYWxyaWNoYXJkc2hhcnBlQGdtYWlsLmNvbT4KU2lnbmVkLW9mZi1ieTogTWFyayBIYXJ2
ZXkgPG1hcmtoNzk0QGdtYWlsLmNvbT4KLS0tCiB1c3Ivc3NjLmMgfCAgICAyICstCiAxIGZpbGVz
IGNoYW5nZWQsIDEgaW5zZXJ0aW9ucygrKSwgMSBkZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS91
c3Ivc3NjLmMgYi91c3Ivc3NjLmMKaW5kZXggODQ4YjMyMy4uMjYzMGE2YSAxMDA2NDQKLS0tIGEv
dXNyL3NzYy5jCisrKyBiL3Vzci9zc2MuYwpAQCAtMTA4LDcgKzEwOCw3IEBAIHN0YXRpYyBpbnQg
c3NjX2x1X2luaXQoc3RydWN0IHNjc2lfbHUgKmx1KQogCWlmIChzc2MpCiAJCWR0eXBlX3ByaXYo
bHUpID0gc3NjOwogCWVsc2UKLQkJcmV0dXJuIC1FTk9NRU07CisJCXJldHVybiBUR1RBRE1fTk9N
RU07CiAKIAlpZiAoc3BjX2x1X2luaXQobHUpKQogCQlyZXR1cm4gVEdUQURNX05PTUVNOwotLSAK
MS41LjQuMwoK
------=_Part_975_11561062.1217540557307--


